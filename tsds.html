<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Time series data stream (TSDS) | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Time series data stream (TSDS) | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="data-streams.html" title="Data streams"/>
<link rel="prev" href="modify-data-streams.html" title="Modify a data stream"/>
<link rel="next" href="ingest.html" title="Ingest pipelines"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="data-streams.html">Data streams</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="modify-data-streams.html">« Modify a data stream</a>
</span>
<span class="next">
<a href="ingest.html">Ingest pipelines »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="tsds"></a>Time series data stream (TSDS)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h2>
</div></div></div>
<p>A time series data stream (TSDS) models timestamped metrics data as one or
more time series.</p>
<p>You can use a TSDS to store metrics data more efficiently. In our benchmarks,
metrics data stored in a TSDS used 70% less disk space than a regular data
stream. The exact impact will vary per data set.</p>
<h3><a id="when-to-use-tsds"></a>When to use a TSDS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h3>
<p>Both a <a class="xref" href="data-streams.html" title="Data streams">regular data stream</a> and a TSDS can store timestamped
metrics data. Only use a TSDS if you typically add metrics data to Elasticsearch in near
real-time and <code class="literal">@timestamp</code> order.</p>
<p>A TSDS is only intended for metrics data. For other timestamped data, such as
logs or traces, use a regular data stream.</p>
<h3><a id="differences-from-regular-data-stream"></a>Differences from a regular data stream<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h3>
<p>A TSDS works like a regular data stream with some key differences:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The matching index template for a TSDS requires a <code class="literal">data_stream</code> object with
the <a class="xref" href="tsds.html#time-series-mode" title="Time series mode"><code class="literal">index.mode: time_series</code></a> option. This option enables
most TSDS-related functionality.
</li>
<li class="listitem">
<p>In addition to a <code class="literal">@timestamp</code>, each document in a TSDS must contain one or
more <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">dimension fields</a>. The matching index template for
a TSDS must contain mappings for at least one <code class="literal">keyword</code> dimension.</p>
<p>TSDS documents also typically
contain one or more <a class="xref" href="tsds.html#time-series-metric" title="Metrics">metric fields</a>.</p>
</li>
<li class="listitem">
Elasticsearch generates a hidden <a class="xref" href="tsds.html#tsid" title="_tsid metadata field"><code class="literal">_tsid</code></a> metadata field for each document in a
TSDS.
</li>
<li class="listitem">
A TSDS uses <a class="xref" href="tsds.html#time-bound-indices" title="Time-bound indices">time-bound backing indices</a> to store data
from the same time period in the same backing index.
</li>
<li class="listitem">
The matching index template for a TSDS must contain the <code class="literal">index.routing_path</code>
index setting. A TSDS uses this setting to perform
<a class="xref" href="tsds.html#dimension-based-routing" title="Dimension-based routing">dimension-based routing</a>.
</li>
<li class="listitem">
A TSDS uses internal <a class="xref" href="index-modules-index-sorting.html" title="Index Sorting">index sorting</a> to order
shard segments by <code class="literal">_tsid</code> and <code class="literal">@timestamp</code>.
</li>
<li class="listitem">
TSDS documents only support auto-generated document <code class="literal">_id</code> values. For TSDS
documents, the document <code class="literal">_id</code> is a hash of the document&#8217;s dimensions and
<code class="literal">@timestamp</code>. A TSDS doesn&#8217;t support custom document <code class="literal">_id</code> values.
</li>
<li class="listitem">
A TSDS uses <a class="xref" href="mapping-fields.html#synthetic-source" title="Synthetic _source">synthetic <code class="literal">_source</code></a>, and as a result is
subject to a number of <a class="xref" href="mapping-fields.html#synthetic-source-restrictions" title="Synthetic _source restrictions">restrictions</a>.
</li>
</ul>
</div>
<h3><a id="time-series"></a>What is a time series?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h3>
<p>A time series is a sequence of observations for a specific entity. Together,
these observations let you track changes to the entity over time. For example, a
time series can track:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
CPU and disk usage for a computer
</li>
<li class="listitem">
The price of a stock
</li>
<li class="listitem">
Temperature and humidity readings from a weather sensor.
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-chart.svg" alt="time series chart">
</div>
<div class="title">Figure 1. Time series of weather sensor readings plotted as a graph</div>
</div>
<p>In a TSDS, each Elasticsearch document represents an observation, or data point, in a
specific time series. Although a TSDS can contain multiple time series, a
document can only belong to one time series. A time series can&#8217;t span multiple
data streams.</p>
<h4><a id="time-series-dimension"></a>Dimensions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>Dimensions are field names and values that, in combination, identify a
document&#8217;s time series. In most cases, a dimension describes some aspect of the
entity you&#8217;re measuring. For example, documents related to the same weather
sensor may always have the same <code class="literal">sensor_id</code> and <code class="literal">location</code> values.</p>
<p>A TSDS document is uniquely identified by its time series and timestamp, both of
which are used to generate the document <code class="literal">_id</code>. So, two documents with the same
dimensions and the same timestamp are considered to be duplicates. When you use
the <code class="literal">_bulk</code> endpoint to add documents to a TSDS, a second document with the same
timestamp and dimensions overwrites the first. When you use the
<code class="literal">PUT /&lt;target&gt;/_create/&lt;_id&gt;</code> format to add an individual document and a document
with the same <code class="literal">_id</code> already exists, an error is generated.</p>
<p>You mark a field as a dimension using the boolean <code class="literal">time_series_dimension</code>
mapping parameter. The following field types support the <code class="literal">time_series_dimension</code>
parameter:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="mapping-types.html#keyword-field-type" title="Keyword field type"><code class="literal">keyword</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#ip" title="IP field type"><code class="literal">ip</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#number" title="Numeric field types"><code class="literal">byte</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#number" title="Numeric field types"><code class="literal">short</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#number" title="Numeric field types"><code class="literal">integer</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#number" title="Numeric field types"><code class="literal">long</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#number" title="Numeric field types"><code class="literal">unsigned_long</code></a>
</li>
</ul>
</div>
<p>For a flattened field, use the <code class="literal">time_series_dimensions</code> parameter to configure an array of fields as dimensions. For details refer to <a class="xref" href="mapping-types.html#flattened-params" title="Parameters for flattened object fields"><code class="literal">flattened</code></a>.</p>
<div class="sidebar">
<a id="dimension-limits"></a>
<div class="titlepage"><div><div>
<p class="title"><strong>Dimension limits</strong></p>
</div></div></div>
<p>In a TSDS, Elasticsearch uses dimensions to
generate the document <code class="literal">_id</code> and <a class="xref" href="tsds.html#tsid" title="_tsid metadata field"><code class="literal">_tsid</code></a> values. The resulting <code class="literal">_id</code> is
always a short encoded hash. To prevent the <code class="literal">_tsid</code> value from being overly
large, Elasticsearch limits the number of dimensions for an index using the
<a class="xref" href="tsds.html#index-mapping-dimension-fields-limit"><code class="literal">index.mapping.dimension_fields.limit</code></a>
index setting. While you can increase this limit, the resulting document <code class="literal">_tsid</code>
value can&#8217;t exceed 32KB. Additionally the field name of a dimension cannot be
longer than 512 bytes and the each dimension value can&#8217;t exceed 1kb.</p>
</div>
<h4><a id="time-series-metric"></a>Metrics<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>Metrics are fields that contain numeric measurements, as well as aggregations
and/or downsampling values based off of those measurements. While not required,
documents in a TSDS typically contain one or more metric fields.</p>
<p>Metrics differ from dimensions in that while dimensions generally remain
constant, metrics are expected to change over time, even if rarely or slowly.</p>
<p>To mark a field as a metric, you must specify a metric type using the
<code class="literal">time_series_metric</code> mapping parameter. The following field types support the
<code class="literal">time_series_metric</code> parameter:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="mapping-types.html#aggregate-metric-double" title="Aggregate metric field type"><code class="literal">aggregate_metric_double</code></a>
</li>
<li class="listitem">
<a class="xref" href="mapping-types.html#histogram" title="Histogram field type"><code class="literal">histogram</code></a>
</li>
<li class="listitem">
All <a class="xref" href="mapping-types.html#number" title="Numeric field types">numeric field types</a>
</li>
</ul>
</div>
<p>Accepted metric types vary based on the field type:</p>
<details open>
<summary class="title">Valid values for <code class="literal">time_series_metric</code></summary>
<div class="content">
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">counter</code>
</span>
</dt>
<dd>
<p>
A cumulative metric that only monotonically increases or resets to <code class="literal">0</code> (zero). For
example, a count of errors or completed tasks.
</p>
<p>A counter field has additional semantic meaning, because it represents a cumulative counter. This works well with
the <code class="literal">rate</code> aggregation, since a rate can be derived from a cumulative monotonically increasing counter. However a number
of aggregations (for example <code class="literal">sum</code>) compute results that don&#8217;t make sense for a counter field, because of its cumulative nature.</p>
<p>Only numeric and <code class="literal">aggregate_metric_double</code> fields support the <code class="literal">counter</code> metric type.</p>
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Due to the cumulative nature of counter fields, the following aggregations are supported and expected to provide meaningful results with the <code class="literal">counter</code> field: <code class="literal">rate</code>, <code class="literal">histogram</code>, <code class="literal">range</code>, <code class="literal">min</code>, <code class="literal">max</code>, <code class="literal">top_metrics</code> and <code class="literal">variable_width_histogram</code>. In order to prevent issues with existing integrations and custom dashboards, we also allow the following aggregations, even if the result might be meaningless on counters: <code class="literal">avg</code>, <code class="literal">box plot</code>, <code class="literal">cardinality</code>, <code class="literal">extended stats</code>, <code class="literal">median absolute deviation</code>, <code class="literal">percentile ranks</code>, <code class="literal">percentiles</code>, <code class="literal">stats</code>, <code class="literal">sum</code> and <code class="literal">value count</code>.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">gauge</code>
</span>
</dt>
<dd>
<p>
A metric that represents a single numeric that can arbitrarily increase or decrease. For example, a temperature or
available disk space.
</p>
<p>Only numeric and <code class="literal">aggregate_metric_double</code> fields support the <code class="literal">gauge</code> metric
type.</p>
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">null</code> (Default)
</span>
</dt>
<dd>
Not a time series metric.
</dd>
</dl>
</div>
</div>
</details>
<h3><a id="time-series-mode"></a>Time series mode<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h3>
<p>The matching index template for a TSDS must contain a <code class="literal">data_stream</code> object with
the <code class="literal">index_mode: time_series</code> option. This option ensures the TSDS creates
backing indices with an <a class="xref" href="tsds.html#index-mode"><code class="literal">index.mode</code></a> setting of <code class="literal">time_series</code>.
This setting enables most TSDS-related functionality in the backing indices.</p>
<p>If you convert an existing data stream to a TSDS, only backing indices created
after the conversion have an <code class="literal">index.mode</code> of <code class="literal">time_series</code>. You can&#8217;t
change the <code class="literal">index.mode</code> of an existing backing index.</p>
<h4><a id="tsid"></a><code class="literal">_tsid</code> metadata field<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>When you add a document to a TSDS, Elasticsearch automatically generates a <code class="literal">_tsid</code>
metadata field for the document. The <code class="literal">_tsid</code> is an object containing the
document&#8217;s dimensions. Documents in the same TSDS with the same <code class="literal">_tsid</code> are part
of the same time series.</p>
<p>The <code class="literal">_tsid</code> field is not queryable or updatable. You also can&#8217;t retrieve a
document&#8217;s <code class="literal">_tsid</code> using a <a class="xref" href="docs.html#docs-get" title="Get API">get document</a> request. However, you can
use the <code class="literal">_tsid</code> field in aggregations and retrieve the <code class="literal">_tsid</code> value in searches
using the <a class="xref" href="search-fields.html#search-fields-param" title="The fields option"><code class="literal">fields</code> parameter</a>.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>The format of the <code class="literal">_tsid</code> field shouldn&#8217;t be relied upon. It may change
from version to version.</p>
</div>
</div>
<h4><a id="time-bound-indices"></a>Time-bound indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>In a TSDS, each backing index, including the most recent backing index, has a
range of accepted <code class="literal">@timestamp</code> values. This range is defined by the
<a class="xref" href="tsds.html#index-time-series-start-time"><code class="literal">index.time_series.start_time</code></a> and
<a class="xref" href="tsds.html#index-time-series-end-time"><code class="literal">index.time_series.end_time</code></a> index settings.</p>
<p>When you add a document to a TSDS, Elasticsearch adds the document to the appropriate
backing index based on its <code class="literal">@timestamp</code> value. As a result, a TSDS can add
documents to any TSDS backing index that can receive writes. This applies even
if the index isn&#8217;t the most recent backing index.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-bound-indices.svg" alt="time bound indices">
</div>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Some ILM actions, such as <a class="xref" href="ilm-actions.html#ilm-forcemerge" title="Force merge"><code class="literal">forcemerge</code></a>,
<a class="xref" href="ilm-actions.html#ilm-shrink" title="Shrink"><code class="literal">shrink</code></a>, and <a class="xref" href="ilm-actions.html#ilm-searchable-snapshot" title="Searchable snapshot"><code class="literal">searchable_snapshot</code></a>,
make a backing index read-only. You cannot add documents to read-only indices.
Keep this in mind when defining the index lifecycle policy for your TSDS.</p>
</div>
</div>
<p>If no backing index can accept a document&#8217;s <code class="literal">@timestamp</code> value, Elasticsearch rejects the
document.</p>
<p>Elasticsearch automatically configures <code class="literal">index.time_series.start_time</code> and
<code class="literal">index.time_series.end_time</code> settings as part of the index creation and rollover
process.</p>
<h4><a id="tsds-look-ahead-time"></a>Look-ahead time<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>Use the <a class="xref" href="tsds.html#index-look-ahead-time"><code class="literal">index.look_ahead_time</code></a> index setting to
configure how far into the future you can add documents to an index. When you
create a new write index for a TSDS, Elasticsearch calculates the index&#8217;s
<code class="literal">index.time_series.end_time</code> value as:</p>
<p><code class="literal">now + index.look_ahead_time</code></p>
<p>At the time series poll interval (controlled via <code class="literal">time_series.poll_interval</code> setting),
Elasticsearch checks if the write index has met the rollover criteria in its index
lifecycle policy. If not, Elasticsearch refreshes the <code class="literal">now</code> value and updates the write
index&#8217;s <code class="literal">index.time_series.end_time</code> to:</p>
<p><code class="literal">now + index.look_ahead_time + time_series.poll_interval</code></p>
<p>This process continues until the write index rolls over. When the index rolls
over, Elasticsearch sets a final <code class="literal">index.time_series.end_time</code> value for the index. This
value borders the <code class="literal">index.time_series.start_time</code> for the new write index. This
ensures the <code class="literal">@timestamp</code> ranges for neighboring backing indices always border
but never overlap.</p>
<h4><a id="tsds-accepted-time-range"></a>Accepted time range for adding data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>A TSDS is designed to ingest current metrics data. When the TSDS is first
created the initial backing index has:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
an <code class="literal">index.time_series.start_time</code> value set to <code class="literal">now - index.look_ahead_time</code>
</li>
<li class="listitem">
an <code class="literal">index.time_series.end_time</code> value set to <code class="literal">now + index.look_ahead_time</code>
</li>
</ul>
</div>
<p>Only data that falls inside that range can be indexed.</p>
<p>In our <a class="xref" href="tsds.html#tsds-create-index-settings-component-template" title="Create an index settings component template">TSDS example</a>,
<code class="literal">index.look_ahead_time</code> is set to three hours, so only documents with a
<code class="literal">@timestamp</code> value that is within three hours previous or subsequent to the
present time are accepted for indexing.</p>
<p>You can use the <a class="xref" href="data-stream-apis.html#indices-get-data-stream" title="Get data stream API">get data stream API</a> to check the
accepted time range for writing to any TSDS.</p>
<h4><a id="dimension-based-routing"></a>Dimension-based routing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>Within each TSDS backing index, Elasticsearch uses the
<a class="xref" href="tsds.html#index-routing-path"><code class="literal">index.routing_path</code></a> index setting to route documents
with the same dimensions to the same shards.</p>
<p>When you create the matching index template for a TSDS, you must specify one or
more dimensions in the <code class="literal">index.routing_path</code> setting. Each document in a TSDS
must contain one or more dimensions that match the <code class="literal">index.routing_path</code> setting.</p>
<p>Dimensions in the <code class="literal">index.routing_path</code> setting must be plain <code class="literal">keyword</code> fields.
The <code class="literal">index.routing_path</code> setting accepts wildcard patterns (for example <code class="literal">dim.*</code>)
and can dynamically match new fields. However, Elasticsearch will reject any mapping
updates that add scripted, runtime, or non-dimension, non-<code class="literal">keyword</code> fields that
match the <code class="literal">index.routing_path</code> value.</p>
<p>TSDS documents don&#8217;t support a custom <code class="literal">_routing</code> value. Similarly, you can&#8217;t
require a <code class="literal">_routing</code> value in mappings for a TSDS.</p>
<h4><a id="tsds-index-sorting"></a>Index sorting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h4>
<p>Elasticsearch uses <a class="xref" href="index-modules.html#index-codec">compression algorithms</a> to compress repeated values.
This compression works best when repeated values are stored near each other — in
the same index, on the same shard, and side-by-side in the same shard segment.</p>
<p>Most time series data contains repeated values. Dimensions are repeated across
documents in the same time series. The metric values of a time series may also
change slowly over time.</p>
<p>Internally, each TSDS backing index uses <a class="xref" href="index-modules-index-sorting.html" title="Index Sorting">index
sorting</a> to order its shard segments by <code class="literal">_tsid</code> and <code class="literal">@timestamp</code>. This makes it
more likely that these repeated values are stored near each other for better
compression. A TSDS doesn&#8217;t support any
<a class="xref" href="index-modules-index-sorting.html" title="Index Sorting"><code class="literal">index.sort.*</code></a> index settings.</p>
<h3><a id="tsds-whats-next"></a>What&#8217;s next?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds.asciidoc">edit</a></h3>
<p>Now that you know the basics, you&#8217;re ready to <a class="xref" href="tsds.html#set-up-tsds" title="Set up a time series data stream (TSDS)">create a TSDS</a> or
<a class="xref" href="tsds.html#set-up-tsds" title="Set up a time series data stream (TSDS)">convert an existing data stream to a TSDS</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="set-up-tsds"></a>Set up a time series data stream (TSDS)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h2>
</div></div></div>

<p>To set up a <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">time series data stream (TSDS)</a>, follow these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Check the <a class="xref" href="tsds.html#tsds-prereqs" title="Prerequisites">prerequisites</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#tsds-ilm-policy" title="Create an index lifecycle policy">Create an index lifecycle policy</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#tsds-create-mappings-component-template" title="Create a mappings component template">Create a mappings component template</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#tsds-create-index-settings-component-template" title="Create an index settings component template">Create an index settings component template</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#create-tsds-index-template" title="Create an index template">Create an index template</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#create-tsds" title="Create the TSDS">Create the TSDS</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#secure-tsds" title="Secure the TSDS">Secure the TSDS</a>.
</li>
</ol>
</div>
<h4><a id="tsds-prereqs"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Before you create a TSDS, you should be familiar with <a class="xref" href="data-streams.html" title="Data streams">data
streams</a> and <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">TSDS concepts</a>.
</li>
<li class="listitem">
<p>To follow this tutorial, you must have the following permissions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="authorization.html#privileges-list-cluster" title="Cluster privileges">Cluster privileges</a>: <code class="literal">manage_ilm</code> and
<code class="literal">manage_index_templates</code>.
</li>
<li class="listitem">
<a class="xref" href="authorization.html#privileges-list-indices" title="Indices privileges">Index privileges</a>: <code class="literal">create_doc</code> and <code class="literal">create_index</code>
for any TSDS you create or convert. To roll over a TSDS, you must have the
<code class="literal">manage</code> privilege.
</li>
</ul>
</div>
</li>
</ul>
</div>
<h4><a id="tsds-ilm-policy"></a>Create an index lifecycle policy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>While optional, we recommend using ILM to automate the management of your
TSDS&#8217;s backing indices. ILM requires an index lifecycle policy.</p>
<p>We recommend you specify a <code class="literal">max_age</code> criteria for the <code class="literal">rollover</code> action in the
policy. This ensures the <a class="xref" href="tsds.html#time-bound-indices" title="Time-bound indices"><code class="literal">@timestamp</code> ranges</a> for the
TSDS&#8217;s backing indices are consistent. For example, setting a <code class="literal">max_age</code> of <code class="literal">1d</code>
for the <code class="literal">rollover</code> action ensures your backing indices consistently contain one
day&#8217;s worth of data.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ilm/policy/my-weather-sensor-lifecycle-policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_age": "1d",
            "max_primary_shard_size": "50gb"
          }
        }
      },
      "warm": {
        "min_age": "30d",
        "actions": {
          "shrink": {
            "number_of_shards": 1
          },
          "forcemerge": {
            "max_num_segments": 1
          }
        }
      },
      "cold": {
        "min_age": "60d",
        "actions": {
          "searchable_snapshot": {
            "snapshot_repository": "found-snapshots"
          }
        }
      },
      "frozen": {
        "min_age": "90d",
        "actions": {
          "searchable_snapshot": {
            "snapshot_repository": "found-snapshots"
          }
        }
      },
      "delete": {
        "min_age": "735d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/645.console"></div>
<h4><a id="tsds-create-mappings-component-template"></a>Create a mappings component template<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>A TSDS requires a matching index template. In most cases, you compose this index
template using one or more component templates. You typically use separate
component templates for mappings and index settings. This lets you reuse the
component templates in multiple index templates.</p>
<p>For a TSDS, the mappings component template must include mappings for:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
One or more <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">dimension fields</a> with a
<code class="literal">time_series_dimension</code> value of <code class="literal">true</code>. At least one of these dimensions must
be a plain <code class="literal">keyword</code> field.
</li>
</ul>
</div>
<p>Optionally, the template can also include mappings for:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
One or more <a class="xref" href="tsds.html#time-series-metric" title="Metrics">metric fields</a>, marked using the
<code class="literal">time_series_metric</code> mapping parameter.
</li>
<li class="listitem">
A <code class="literal">date</code> or <code class="literal">date_nanos</code> mapping for the <code class="literal">@timestamp</code> field. If you don’t
specify a mapping, Elasticsearch maps <code class="literal">@timestamp</code> as a <code class="literal">date</code> field with
default options.
</li>
</ul>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _component_template/my-weather-sensor-mappings
{
  "template": {
    "mappings": {
      "properties": {
        "sensor_id": {
          "type": "keyword",
          "time_series_dimension": true
        },
        "location": {
          "type": "keyword",
          "time_series_dimension": true
        },
        "temperature": {
          "type": "half_float",
          "time_series_metric": "gauge"
        },
        "humidity": {
          "type": "half_float",
          "time_series_metric": "gauge"
        },
        "@timestamp": {
          "type": "date",
          "format": "strict_date_optional_time"
        }
      }
    }
  },
  "_meta": {
    "description": "Mappings for weather sensor data"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/646.console"></div>
<h4><a id="tsds-create-index-settings-component-template"></a>Create an index settings component template<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>Optionally, the index settings component template for a TSDS can include:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Your lifecycle policy in the <code class="literal">index.lifecycle.name</code> index setting.
</li>
<li class="listitem">
The <a class="xref" href="tsds.html#tsds-look-ahead-time" title="Look-ahead time"><code class="literal">index.look_ahead_time</code></a> index setting.
</li>
<li class="listitem">
Other index settings, such as <a class="xref" href="index-modules.html#index-codec"><code class="literal">index.codec</code></a>, for your TSDS&#8217;s
backing indices.
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t specify the <code class="literal">index.routing_path</code> index setting in a component
template. If you choose, you can configure <code class="literal">index.routing_path</code> directly in the
index template, as shown in the following step.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _component_template/my-weather-sensor-settings
{
  "template": {
    "settings": {
      "index.lifecycle.name": "my-lifecycle-policy",
      "index.look_ahead_time": "3h",
      "index.codec": "best_compression"
    }
  },
  "_meta": {
    "description": "Index settings for weather sensor data"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/647.console"></div>
<h4><a id="create-tsds-index-template"></a>Create an index template<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>Use your component templates to create an index template. In the index template,
specify:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
One or more index patterns that match the TSDS&#8217;s name. We recommend
using our <a href="https://www.elastic.co/guide/en/fleet/8.9/data-streams.html#data-streams-naming-scheme" class="ulink" target="_top">data stream
naming scheme</a>.
</li>
<li class="listitem">
That the template is data stream enabled.
</li>
<li class="listitem">
An <code class="literal">index.mode</code> object set to <code class="literal">time_series</code>.
</li>
<li class="listitem">
Optional: The <code class="literal">index.routing_path</code> index setting. The setting value should
only match plain <code class="literal">keyword</code> dimension fields and should be set directly in the
index template. When not defined explicitly, the <code class="literal">index.routing_path</code> setting is
generated from the mapping using all mappings that are set with
<code class="literal">time_series_dimension</code> set to <code class="literal">true</code>.
</li>
<li class="listitem">
The component templates containing your mappings and other index settings.
</li>
<li class="listitem">
A priority higher than <code class="literal">200</code> to avoid collisions with built-in templates.
See <a class="xref" href="index-templates.html#avoid-index-pattern-collisions" title="Avoid index pattern collisions">Avoid index pattern collisions</a>.
</li>
</ul>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _index_template/my-weather-sensor-index-template
{
  "index_patterns": ["metrics-weather_sensors-*"],
  "data_stream": { },
  "template": {
    "settings": {
      "index.mode": "time_series",
      "index.routing_path": [ "sensor_id", "location" ]
    }
  },
  "composed_of": [ "my-weather-sensor-mappings", "my-weather-sensor-settings" ],
  "priority": 500,
  "_meta": {
    "description": "Template for my weather sensor data"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/648.console"></div>
<h4><a id="create-tsds"></a>Create the TSDS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p><a class="xref" href="use-a-data-stream.html#add-documents-to-a-data-stream" title="Add documents to a data stream">Indexing requests</a> add documents to a TSDS.
Documents in a TSDS must include:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
A <code class="literal">@timestamp</code> field
</li>
<li class="listitem">
One or more dimension fields. At least one dimension must be a <code class="literal">keyword</code> field
that matches the <code class="literal">index.routing_path</code> index setting, if specified. If not specified
explicitly, <code class="literal">index.routing_path</code> is set automatically to whichever mappings have
 <code class="literal">time_series_dimension</code> set to <code class="literal">true</code>.
</li>
</ul>
</div>
<p>To automatically create your TSDS, submit an indexing request that
targets the TSDS&#8217;s name. This name must match one of your index template&#8217;s
index patterns.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>To test the following example, update the timestamps to within three hours of
your current time. Data added to a TSDS must always fall within an
<a class="xref" href="tsds.html#tsds-accepted-time-range" title="Accepted time range for adding data">accepted time range</a>.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT metrics-weather_sensors-dev/_bulk
{ "create":{ } }
{ "@timestamp": "2099-05-06T16:21:15.000Z", "sensor_id": "HAL-000001", "location": "plains", "temperature": 26.7,"humidity": 49.9 }
{ "create":{ } }
{ "@timestamp": "2099-05-06T16:25:42.000Z", "sensor_id": "SYKENET-000001", "location": "swamp", "temperature": 32.4, "humidity": 88.9 }

POST metrics-weather_sensors-dev/_doc
{
  "@timestamp": "2099-05-06T16:21:15.000Z",
  "sensor_id": "SYKENET-000001",
  "location": "swamp",
  "temperature": 32.4,
  "humidity": 88.9
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/649.console"></div>
<p>You can also manually create the TSDS using the
<a class="xref" href="data-stream-apis.html#indices-create-data-stream" title="Create data stream API">create data stream API</a>. The TSDS&#8217;s name must
still match one of your template&#8217;s index patterns.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _data_stream/metrics-weather_sensors-dev</pre>
</div>
<div class="console_widget" data-snippet="snippets/650.console"></div>
<h4><a id="secure-tsds"></a>Secure the TSDS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>Use <a class="xref" href="authorization.html#privileges-list-indices" title="Indices privileges">index privileges</a> to control access to a TSDS.
Granting privileges on a TSDS grants the same privileges on its backing indices.</p>
<p>For an example, refer to <a class="xref" href="authorization.html#data-stream-privileges" title="Data stream privileges">Data stream privileges</a>.</p>
<h4><a id="convert-existing-data-stream-to-tsds"></a>Convert an existing data stream to a TSDS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>You can also use the above steps to convert an existing regular data stream to
a TSDS. In this case, you&#8217;ll want to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Edit your existing index lifecycle policy, component templates, and index
templates instead of creating new ones.
</li>
<li class="listitem">
<p>Instead of creating the TSDS, manually roll over its write index. This ensures
the current write index and any new backing indices have an
<a class="xref" href="tsds.html#time-series-mode" title="Time series mode"><code class="literal">index.mode</code> of <code class="literal">time_series</code></a>.</p>
<p>You can manually roll over the write index using the
<a class="xref" href="indices.html#indices-rollover-index" title="Rollover API">rollover API</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST metrics-weather_sensors-dev/_rollover</pre>
</div>
<div class="console_widget" data-snippet="snippets/651.console"></div>
</li>
</ul>
</div>
<h4><a id="set-up-tsds-whats-next"></a>What&#8217;s next?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/set-up-tsds.asciidoc">edit</a></h4>
<p>Now that you&#8217;ve set up your TSDS, you can manage and use it like a regular
data stream. For more information, refer to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="use-a-data-stream.html" title="Use a data stream"><em>Use a data stream</em></a>
</li>
<li class="listitem">
<a class="xref" href="modify-data-streams.html#data-streams-change-mappings-and-settings" title="Change mappings and settings for a data stream">Change mappings and settings for a data stream</a>
</li>
<li class="listitem">
<a class="xref" href="data-stream-apis.html" title="Data stream APIs">data stream APIs</a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="tsds-index-settings"></a>Time series index settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/tsds-index-settings.asciidoc">edit</a></h2>
</div></div></div>
<p>Backing indices in a <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">time series data stream (TSDS)</a> support the
following index settings.</p>
<div class="variablelist">
<a id="index-mode"></a>
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">index.mode</code>
</span>
</dt>
<dd>
(<a class="xref" href="index-modules.html#_static_index_settings" title="Static index settings">Static</a>, string) Mode for the index.
Valid values are <a class="xref" href="tsds.html#time-series-mode" title="Time series mode"><code class="literal">time_series</code></a> and <code class="literal">null</code> (no mode).
Defaults to <code class="literal">null</code>.
</dd>
</dl>
</div>
<div class="variablelist">
<a id="index-time-series-start-time"></a>
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">index.time_series.start_time</code>
</span>
</dt>
<dd>
(<a class="xref" href="index-modules.html#_static_index_settings" title="Static index settings">Static</a>, string) Earliest <code class="literal">@timestamp</code>
value (inclusive) accepted by the index. Only indices with an <code class="literal">index.mode</code> of
<a class="xref" href="tsds.html#time-series-mode" title="Time series mode"><code class="literal">time_series</code></a> support this setting. For more information,
refer to <a class="xref" href="tsds.html#time-bound-indices" title="Time-bound indices">Time-bound indices</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<a id="index-time-series-end-time"></a>
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">index.time_series.end_time</code>
</span>
</dt>
<dd>
(<a class="xref" href="index-modules.html#dynamic-index-settings" title="Dynamic index settings">Dynamic</a>, string) Latest <code class="literal">@timestamp</code>
value (exclusive) accepted by the index. Only indices with an <code class="literal">index.mode</code> of
<code class="literal">time_series</code> support this setting. For more information, refer to
<a class="xref" href="tsds.html#time-bound-indices" title="Time-bound indices">Time-bound indices</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<a id="index-look-ahead-time"></a>
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">index.look_ahead_time</code>
</span>
</dt>
<dd>
(<a class="xref" href="index-modules.html#_static_index_settings" title="Static index settings">Static</a>, <a class="xref" href="api-conventions.html#time-units" title="Time units">time units</a>)
Interval used to calculate the <code class="literal">index.time_series.end_time</code> for a TSDS&#8217;s write
index. Defaults to <code class="literal">2h</code> (2 hours). Accepts <code class="literal">1m</code> (one minute) to <code class="literal">7d</code> (seven
days). Only indices with an <code class="literal">index.mode</code> of <code class="literal">time_series</code> support this setting.
For more information, refer to <a class="xref" href="tsds.html#tsds-look-ahead-time" title="Look-ahead time">Look-ahead time</a>. Additionally this setting
can not be less than <code class="literal">time_series.poll_interval</code> cluster setting.
</dd>
<dt>
<span class="term">
<a id="index-routing-path"></a> <code class="literal">index.routing_path</code>
</span>
</dt>
<dd>
(<a class="xref" href="index-modules.html#_static_index_settings" title="Static index settings">Static</a>, string or array of strings) Plain <code class="literal">keyword</code>
fields used to route documents in a TSDS to index shards. Supports wildcards
(<code class="literal">*</code>). Only indices with an <code class="literal">index.mode</code> of <code class="literal">time_series</code> support this setting.
Defaults to an empty list, except for data streams then defaults to the list
of <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">dimension fields</a> with a <code class="literal">time_series_dimension</code>
value of <code class="literal">true</code> defined in your component and index templates. For more
information, refer to <a class="xref" href="tsds.html#dimension-based-routing" title="Dimension-based routing">Dimension-based routing</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<a id="index-mapping-dimension-fields-limit"></a>
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">index.mapping.dimension_fields.limit</code>
</span>
</dt>
<dd>
(<a class="xref" href="index-modules.html#dynamic-index-settings" title="Dynamic index settings">Dynamic</a>, integer)
Maximum number of <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">time series dimensions</a> for the
index. Defaults to <code class="literal">21</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="downsampling"></a>Downsampling a time series data stream<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h2>
</div></div></div>
<p>Downsampling provides a method to reduce the footprint of your <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">time
series data</a> by storing it at reduced granularity.</p>
<p>Metrics solutions collect large amounts of time series data that grow over time.
As that data ages, it becomes less relevant to the current state of the system.
The downsampling process rolls up documents within a fixed time interval into a
single summary document. Each summary document includes statistical
representations of the original data: the <code class="literal">min</code>, <code class="literal">max</code>, <code class="literal">sum</code>, <code class="literal">value_count</code>,
and <code class="literal">average</code> for each metric. Data stream <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">time series
dimensions</a> are stored unchanged.</p>
<p>Downsampling, in effect, lets you to trade data resolution and precision for
storage size. You can include it in an <a class="xref" href="index-lifecycle-management.html" title="ILM: Manage the index lifecycle">index lifecycle management
(ILM)</a> policy to automatically manage the volume and associated cost of
your metrics data at it ages.</p>
<p>Check the following sections to learn more:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="tsds.html#how-downsampling-works" title="How it works">How it works</a>
</li>
<li class="listitem">
<a class="xref" href="tsds.html#running-downsampling" title="Running downsampling on time series data">Running downsampling on time series data</a>
</li>
<li class="listitem">
<a class="xref" href="tsds.html#querying-downsampled-indices" title="Querying downsampled indices">Querying downsampled indices</a>
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-restrictions" title="Restrictions and limitations">Restrictions and limitations</a>
</li>
<li class="listitem">
<a class="xref" href="tsds.html#try-out-downsampling" title="Try it out">Try it out</a>
</li>
</ul>
</div>
<h3><a id="how-downsampling-works"></a>How it works<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h3>
<p>A <a class="xref" href="tsds.html#time-series" title="What is a time series?">time series</a> is a sequence of observations taken over time for
a specific entity. The observed samples can be represented as a continuous
function, where the time series dimensions remain constant and the time series
metrics change over time.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-function.png" alt="time series function">
</div>
</div>
<p>In an Elasticsearch index, a single document is created for each timestamp,
containing the immutable time series dimensions, together with the metrics names
and the changing metrics values. For a single timestamp, several time series
dimensions and metrics may be stored.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-metric-anatomy.png" alt="time series metric anatomy">
</div>
</div>
<p>For your most current and relevant data, the metrics series typically has a low
sampling time interval, so it&#8217;s optimized for queries that require a high data
resolution.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-original.png" alt="time series original">
</div>
<div class="title">Figure 2. Original metrics series</div>
</div>
<p>Downsampling works on older, less frequently accessed data by replacing the
original time series with both a data stream of a higher sampling interval and
statistical representations of that data. Where the original metrics samples may
have been taken, for example, every ten seconds, as the data ages you may choose
to reduce the sample granularity to hourly or daily. You may choose to reduce
the granularity of <code class="literal">cold</code> archival data to monthly or less.</p>
<div class="imageblock text-center">
<div class="content">
<img src="images/data-streams/time-series-downsampled.png" alt="time series downsampled">
</div>
<div class="title">Figure 3. Downsampled metrics series</div>
</div>
<h3><a id="running-downsampling"></a>Running downsampling on time series data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h3>
<p>To downsample a time series index, use the
<a class="xref" href="data-stream-apis.html#indices-downsample-data-stream" title="Downsample index API">Downsample API</a> and set <code class="literal">fixed_interval</code> to
the level of granularity that you&#8217;d like:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /my-time-series-index/_downsample/my-downsampled-time-series-index
{
    "fixed_interval": "1d"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/652.console"></div>
<p>To downsample time series data as part of ILM, include a
<a class="xref" href="ilm-actions.html#ilm-downsample" title="Downsample">Downsample action</a> in your ILM policy and set <code class="literal">fixed_interval</code>
to the level of granularity that you&#8217;d like:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ilm/policy/my_policy
{
  "policy": {
    "phases": {
      "warm": {
        "actions": {
          "downsample" : {
            "fixed_interval": "1h"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/653.console"></div>
<h3><a id="querying-downsampled-indices"></a>Querying downsampled indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h3>
<p>You can use the <a class="xref" href="search.html#search-search" title="Search API"><code class="literal">_search</code></a> and <a class="xref" href="search.html#async-search" title="Async search"><code class="literal">_async_search</code></a>
endpoints to query a downsampled index. Multiple raw data and downsampled
indices can be queried in a single request, and a single request can include
downsampled indices at different granularities (different bucket timespan). That
is, you can query data streams that contain downsampled indices with multiple
downsampling intervals (for example, <code class="literal">15m</code>, <code class="literal">1h</code>, <code class="literal">1d</code>).</p>
<p>The result of a time based histogram aggregation is in a uniform bucket size and
each downsampled index returns data ignoring the downsampling time interval. For
example, if you run a <code class="literal">date_histogram</code> aggregation with <code class="literal">"fixed_interval": "1m"</code>
on a downsampled index that has been downsampled at an hourly resolution
(<code class="literal">"fixed_interval": "1h"</code>), the query returns one bucket with all of the data at
minute 0, then 59 empty buckets, and then a bucket with data again for the next
hour.</p>
<h4><a id="querying-downsampled-indices-notes"></a>Notes on downsample queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h4>
<p>There are a few things to note about querying downsampled indices:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
When you run queries in Kibana and through Elastic solutions, a normal
response is returned without notification that some of the queried indices are
downsampled.
</li>
<li class="listitem">
For
<a class="xref" href="search-aggregations-bucket.html#search-aggregations-bucket-datehistogram-aggregation" title="Date histogram aggregation">date histogram aggregations</a>,
only <code class="literal">fixed_intervals</code> (and not calendar-aware intervals) are supported.
</li>
<li class="listitem">
Only Coordinated Universal Time (UTC) date-times are supported.
</li>
</ul>
</div>
<h3><a id="downsampling-restrictions"></a>Restrictions and limitations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h3>
<p>The following restrictions and limitations apply for downsampling:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Only indices in a <a class="xref" href="tsds.html" title="Time series data stream (TSDS)">time series data stream</a> are supported.
</li>
<li class="listitem">
Data is downsampled based on the time dimension only. All other dimensions are
copied to the new index without any modification.
</li>
<li class="listitem">
Within a data stream, a downsampled index replaces the original index and the
original index is deleted. Only one index can exist for a given time period.
</li>
<li class="listitem">
A source index must be in read-only mode for the downsampling process to
succeed. Check the <a class="xref" href="tsds.html#downsampling-manual" title="Run downsampling manually">Run downsampling manually</a> example for
details.
</li>
<li class="listitem">
Downsampling data for the same period many times (downsampling of a
downsampled index) is supported. The downsampling interval must be a multiple of
the interval of the downsampled index.
</li>
<li class="listitem">
Downsampling is provided as an ILM action. See <a class="xref" href="ilm-actions.html#ilm-downsample" title="Downsample">Downsample</a>.
</li>
<li class="listitem">
The new, downsampled index is created on the data tier of the original index
and it inherits its settings (for example, the number of shards and replicas).
</li>
<li class="listitem">
The numeric <code class="literal">gauge</code> and <code class="literal">counter</code> <a class="xref" href="mapping-params.html#mapping-field-meta" title="meta">metric types</a> are
supported.
</li>
<li class="listitem">
The downsampling configuration is extracted from the time series data stream
<a class="xref" href="tsds.html#tsds-create-mappings-component-template" title="Create a mappings component template">index mapping</a>. The only additional
required setting is the downsampling <code class="literal">fixed_interval</code>.
</li>
</ul>
</div>
<h3><a id="try-out-downsampling"></a>Try it out<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling.asciidoc">edit</a></h3>
<p>To take downsampling for a test run, try our example of
<a class="xref" href="tsds.html#downsampling-manual" title="Run downsampling manually">running downsampling manually</a>.</p>
<p>Downsampling can easily be added to your ILM policy. To learn how, try our
<a class="xref" href="tsds.html#downsampling-ilm" title="Run downsampling with ILM">Run downsampling with ILM</a> example.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="downsampling-ilm"></a>Run downsampling with ILM<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-ilm.asciidoc">edit</a></h2>
</div></div></div>

<p>This is a simplified example that allows you to see quickly how
<a class="xref" href="tsds.html#downsampling" title="Downsampling a time series data stream">downsampling</a> works as part of an ILM policy to reduce the
storage size of a sampled set of metrics. The example uses typical Kubernetes
cluster monitoring data. To test out downsampling with ILM, follow these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Check the <a class="xref" href="tsds.html#downsampling-ilm-prereqs" title="Prerequisites">prerequisites</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-ilm-policy" title="Create an index lifecycle policy">Create an index lifecycle policy</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-ilm-create-index-template" title="Create an index template">Create an index template</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-ilm-ingest-data" title="Ingest time series data">Ingest time series data</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-ilm-view-results" title="View the results">View the results</a>.
</li>
</ol>
</div>
<h4><a id="downsampling-ilm-prereqs"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-ilm.asciidoc">edit</a></h4>
<p>Refer to <a class="xref" href="tsds.html#tsds-prereqs" title="Prerequisites">time series data stream prerequisites</a>.</p>
<p>Before running this example you may want to try the
<a class="xref" href="tsds.html#downsampling-manual" title="Run downsampling manually">Run downsampling manually</a> example.</p>
<h4><a id="downsampling-ilm-policy"></a>Create an index lifecycle policy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-ilm.asciidoc">edit</a></h4>
<p>Create an ILM policy for your time series data. While not required, an ILM
policy is recommended to automate the management of your time series data stream
indices.</p>
<p>To enable downsampling, add a <a class="xref" href="ilm-actions.html#ilm-downsample" title="Downsample">Downsample action</a> and set
<a class="xref" href="ilm-actions.html#ilm-downsample-options" title="Options"><code class="literal">fixed_interval</code></a> to the downsampling interval at
which you want to aggregate the original time series data.</p>
<p>In this example, an ILM policy is configured for the <code class="literal">hot</code> phase. The downsample
takes place after the initial index rollover, which for demonstration
purposes is set to run after five minutes.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ilm/policy/datastream_policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover" : {
            "max_age": "5m"
          },
          "downsample": {
  	        "fixed_interval": "1h"
  	      }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/654.console"></div>
<h4><a id="downsampling-ilm-create-index-template"></a>Create an index template<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-ilm.asciidoc">edit</a></h4>
<p>This creates an index template for a basic data stream. The available parameters
for an index template are described in detail in <a class="xref" href="set-up-a-data-stream.html" title="Set up a data stream">Set up a
time series data stream</a>.</p>
<p>For simplicity, in the time series mapping all <code class="literal">time_series_metric</code> parameters
are set to type <code class="literal">gauge</code>, but the <code class="literal">counter</code> metric type may also be used. The
<code class="literal">time_series_metric</code> values determine the kind of statistical representations
that are used during downsampling.</p>
<p>The index template includes a set of static <a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">time series
dimensions</a>: <code class="literal">host</code>, <code class="literal">namespace</code>, <code class="literal">node</code>, and <code class="literal">pod</code>. The time series dimensions
are not changed by the downsampling process.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _index_template/datastream_template
{
    "index_patterns": [
        "datastream*"
    ],
    "data_stream": {},
    "template": {
        "settings": {
            "index": {
                "mode": "time_series",
                "number_of_replicas": 0,
                "number_of_shards": 2
            },
            "index.lifecycle.name": "datastream_policy"
        },
        "mappings": {
            "properties": {
                "@timestamp": {
                    "type": "date"
                },
                "kubernetes": {
                    "properties": {
                        "container": {
                            "properties": {
                                "cpu": {
                                    "properties": {
                                        "usage": {
                                            "properties": {
                                                "core": {
                                                    "properties": {
                                                        "ns": {
                                                            "type": "long"
                                                        }
                                                    }
                                                },
                                                "limit": {
                                                    "properties": {
                                                        "pct": {
                                                            "type": "float"
                                                        }
                                                    }
                                                },
                                                "nanocores": {
                                                    "type": "long",
                                                    "time_series_metric": "gauge"
                                                },
                                                "node": {
                                                    "properties": {
                                                        "pct": {
                                                            "type": "float"
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "memory": {
                                    "properties": {
                                        "available": {
                                            "properties": {
                                                "bytes": {
                                                    "type": "long",
                                                    "time_series_metric": "gauge"
                                                }
                                            }
                                        },
                                        "majorpagefaults": {
                                            "type": "long"
                                        },
                                        "pagefaults": {
                                            "type": "long",
                                            "time_series_metric": "gauge"
                                        },
                                        "rss": {
                                            "properties": {
                                                "bytes": {
                                                    "type": "long",
                                                    "time_series_metric": "gauge"
                                                }
                                            }
                                        },
                                        "usage": {
                                            "properties": {
                                                "bytes": {
                                                    "type": "long",
                                                    "time_series_metric": "gauge"
                                                },
                                                "limit": {
                                                    "properties": {
                                                        "pct": {
                                                            "type": "float"
                                                        }
                                                    }
                                                },
                                                "node": {
                                                    "properties": {
                                                        "pct": {
                                                            "type": "float"
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "workingset": {
                                            "properties": {
                                                "bytes": {
                                                    "type": "long",
                                                    "time_series_metric": "gauge"
                                                }
                                            }
                                        }
                                    }
                                },
                                "name": {
                                    "type": "keyword"
                                },
                                "start_time": {
                                    "type": "date"
                                }
                            }
                        },
                        "host": {
                            "type": "keyword",
                            "time_series_dimension": true
                        },
                        "namespace": {
                            "type": "keyword",
                            "time_series_dimension": true
                        },
                        "node": {
                            "type": "keyword",
                            "time_series_dimension": true
                        },
                        "pod": {
                            "type": "keyword",
                            "time_series_dimension": true
                        }
                    }
                }
            }
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/655.console"></div>
<h4><a id="downsampling-ilm-ingest-data"></a>Ingest time series data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-ilm.asciidoc">edit</a></h4>
<p>Use a bulk API request to automatically create your TSDS and index a set of ten
documents.</p>
<p><span class="strong strong"><strong>Important:</strong></span> Before running this bulk request you need to update the
timestamps to within three to five hours after your current time. That is,
search <code class="literal">2022-06-21T15</code> and replace with your present date, and adjust the hour
to your current time plus three hours.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /datastream/_bulk?refresh
{"create": {}}
{"@timestamp":"2022-06-21T15:49:00Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":91153,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":463314616},"usage":{"bytes":307007078,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":585236},"rss":{"bytes":102728},"pagefaults":120901,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:45:50Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":124501,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":982546514},"usage":{"bytes":360035574,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1339884},"rss":{"bytes":381174},"pagefaults":178473,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:44:50Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":38907,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":862723768},"usage":{"bytes":379572388,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":431227},"rss":{"bytes":386580},"pagefaults":233166,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:44:40Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":86706,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":567160996},"usage":{"bytes":103266017,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1724908},"rss":{"bytes":105431},"pagefaults":233166,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:44:00Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":150069,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":639054643},"usage":{"bytes":265142477,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1786511},"rss":{"bytes":189235},"pagefaults":138172,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:42:40Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":82260,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":854735585},"usage":{"bytes":309798052,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":924058},"rss":{"bytes":110838},"pagefaults":259073,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:42:10Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":153404,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":279586406},"usage":{"bytes":214904955,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1047265},"rss":{"bytes":91914},"pagefaults":302252,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:40:20Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":125613,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":822782853},"usage":{"bytes":100475044,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":2109932},"rss":{"bytes":278446},"pagefaults":74843,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:40:10Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":100046,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":567160996},"usage":{"bytes":362826547,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1986724},"rss":{"bytes":402801},"pagefaults":296495,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:38:30Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":40018,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":1062428344},"usage":{"bytes":265142477,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":2294743},"rss":{"bytes":340623},"pagefaults":224530,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}</pre>
</div>
<div class="console_widget" data-snippet="snippets/656.console"></div>
<h4><a id="downsampling-ilm-view-results"></a>View the results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-ilm.asciidoc">edit</a></h4>
<p>Now that you&#8217;ve created and added documents to the data stream, check to confirm
the current state of the new index.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _data_stream</pre>
</div>
<div class="console_widget" data-snippet="snippets/657.console"></div>
<p>If the ILM policy has not yet been applied, your results will be like the
following. Note the original <code class="literal">index_name</code>: <code class="literal">.ds-datastream-&lt;timestamp&gt;-000001</code>.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "datastream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": ".ds-datastream-2022.08.26-000001",
          "index_uuid": "5g-3HrfETga-5EFKBM6R-w"
        },
        {
          "index_name": ".ds-datastream-2022.08.26-000002",
          "index_uuid": "o0yRTdhWSo2pY8XMvfwy7Q"
        }
      ],
      "generation": 2,
      "status": "GREEN",
      "template": "datastream_template",
      "ilm_policy": "datastream_policy",
      "hidden": false,
      "system": false,
      "allow_custom_routing": false,
      "replicated": false,
      "time_series": {
        "temporal_ranges": [
          {
            "start": "2022-08-26T13:29:07.000Z",
            "end": "2022-08-26T19:29:07.000Z"
          }
        ]
      }
    }
  ]
}</pre>
</div>
<p>Next, run a search query:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET datastream/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/658.console"></div>
<p>The query returns your ten newly added documents.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 17,
  "timed_out": false,
  "_shards": {
    "total": 4,
    "successful": 4,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 10,
      "relation": "eq"
    },
...</pre>
</div>
<p>By default, index lifecycle management checks every ten minutes for indices that
meet policy criteria. Wait for about ten minutes (maybe brew up a quick coffee
or tea &#9749; ) and then re-run the <code class="literal">GET _data_stream</code> request.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _data_stream</pre>
</div>
<div class="console_widget" data-snippet="snippets/659.console"></div>
<p>After the ILM policy has taken effect, the original
<code class="literal">.ds-datastream-2022.08.26-000001</code> index is replaced with a new, downsampled
index, in this case <code class="literal">downsample-6tkn-.ds-datastream-2022.08.26-000001</code>.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "datastream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": "downsample-6tkn-.ds-datastream-2022.08.26-000001",
          "index_uuid": "qRane1fQQDCNgKQhXmTIvg"
        },
        {
          "index_name": ".ds-datastream-2022.08.26-000002",
          "index_uuid": "o0yRTdhWSo2pY8XMvfwy7Q"
        }
      ],
...</pre>
</div>
<p>Run a search query on the datastream (note that when querying downsampled indices there are <a class="xref" href="tsds.html#querying-downsampled-indices-notes" title="Notes on downsample queries">a few nuances to be aware of</a>).</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET datastream/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/660.console"></div>
<p>The new downsampled index contains just one document that includes the <code class="literal">min</code>,
<code class="literal">max</code>, <code class="literal">sum</code>, and <code class="literal">value_count</code> statistics based off of the original sampled
metrics.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 6,
  "timed_out": false,
  "_shards": {
    "total": 4,
    "successful": 4,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 1,
    "hits": [
      {
        "_index": "downsample-6tkn-.ds-datastream-2022.08.26-000001",
        "_id": "0eL0wC_4-45SnTNFAAABgtpz0wA",
        "_score": 1,
        "_source": {
          "@timestamp": "2022-08-26T14:00:00.000Z",
          "_doc_count": 10,
          "kubernetes.host": "gke-apps-0",
          "kubernetes.namespace": "namespace26",
          "kubernetes.node": "gke-apps-0-0",
          "kubernetes.pod": "gke-apps-0-0-0",
          "kubernetes.container.cpu.usage.nanocores": {
            "min": 38907,
            "max": 153404,
            "sum": 992677,
            "value_count": 10
          },
          "kubernetes.container.memory.available.bytes": {
            "min": 279586406,
            "max": 1062428344,
            "sum": 7101494721,
            "value_count": 10
          },
          "kubernetes.container.memory.pagefaults": {
            "min": 74843,
            "max": 302252,
            "sum": 2061071,
            "value_count": 10
          },
          "kubernetes.container.memory.rss.bytes": {
            "min": 91914,
            "max": 402801,
            "sum": 2389770,
            "value_count": 10
          },
          "kubernetes.container.memory.usage.bytes": {
            "min": 100475044,
            "max": 379572388,
            "sum": 2668170609,
            "value_count": 10
          },
          "kubernetes.container.memory.workingset.bytes": {
            "min": 431227,
            "max": 2294743,
            "sum": 14230488,
            "value_count": 10
          },
          "kubernetes.container.cpu.usage.core.ns": 12828317850,
          "kubernetes.container.cpu.usage.limit.pct": 0.000027790500098490156,
          "kubernetes.container.cpu.usage.node.pct": 0.000027790500098490156,
          "kubernetes.container.memory.majorpagefaults": 0,
          "kubernetes.container.memory.usage.limit.pct": 0.00009923134348355234,
          "kubernetes.container.memory.usage.node.pct": 0.017700377851724625,
          "kubernetes.container.name": "container-name-44",
          "kubernetes.container.start_time": "2021-03-30T07:59:06.000Z"
        }
      }
    ]
  }
}</pre>
</div>
<p>Use the <a class="xref" href="data-stream-apis.html#data-stream-stats-api" title="Data stream stats API">data stream stats API</a> to get statistics for
the data stream, including the storage size.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_data_stream/datastream/_stats?human=true</pre>
</div>
<div class="console_widget" data-snippet="snippets/661.console"></div>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "_shards": {
    "total": 4,
    "successful": 4,
    "failed": 0
  },
  "data_stream_count": 1,
  "backing_indices": 2,
  "total_store_size": "16.6kb",
  "total_store_size_bytes": 17059,
  "data_streams": [
    {
      "data_stream": "datastream",
      "backing_indices": 2,
      "store_size": "16.6kb",
      "store_size_bytes": 17059,
      "maximum_timestamp": 1661522400000
    }
  ]
}</pre>
</div>
<p>This example demonstrates how downsampling works as part of an ILM policy to
reduce the storage size of metrics data as it becomes less current and less
frequently queried.</p>
<p>You can also try our <a class="xref" href="tsds.html#downsampling-manual" title="Run downsampling manually">Run downsampling manually</a>
example to learn how downsampling can work outside of an ILM policy.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="downsampling-manual"></a>Run downsampling manually<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-manual.asciidoc">edit</a></h2>
</div></div></div>

<p>The recommended way to downsample a time series data stream (TSDS) is
<a class="xref" href="tsds.html#downsampling-ilm" title="Run downsampling with ILM">through index lifecycle management (ILM)</a>. However, if
you&#8217;re not using ILM, you can downsample a TSDS manually. This guide shows you
how, using typical Kubernetes cluster monitoring data.</p>
<p>To test out manual downsampling, follow these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Check the <a class="xref" href="tsds.html#downsampling-manual-prereqs" title="Prerequisites">prerequisites</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-manual-create-index" title="Create a time series data stream">Create a time series data stream</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-manual-ingest-data" title="Ingest time series data">Ingest time series data</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-manual-run" title="Downsample the TSDS">Downsample the TSDS</a>.
</li>
<li class="listitem">
<a class="xref" href="tsds.html#downsampling-manual-view-results" title="View the results">View the results</a>.
</li>
</ol>
</div>
<h4><a id="downsampling-manual-prereqs"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-manual.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Refer to the <a class="xref" href="tsds.html#tsds-prereqs" title="Prerequisites">TSDS prerequisites</a>.
</li>
<li class="listitem">
It is not possible to downsample a data stream directly, nor
multiple indices at once. It&#8217;s only possible to downsample one time series index
(TSDS backing index).
</li>
<li class="listitem">
In order to downsample an index, it needs to be read-only. For a TSDS write
index, this means it needs to be rolled over and made read-only first.
</li>
<li class="listitem">
Downsampling uses UTC timestamps.
</li>
<li class="listitem">
Downsampling needs at least one metric field to exist in the time series
index.
</li>
</ul>
</div>
<h4><a id="downsampling-manual-create-index"></a>Create a time series data stream<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-manual.asciidoc">edit</a></h4>
<p>First, you&#8217;ll create a TSDS. For simplicity, in the time series mapping all
<code class="literal">time_series_metric</code> parameters are set to type <code class="literal">gauge</code>, but
<a class="xref" href="tsds.html#time-series-metric" title="Metrics">other values</a> such as <code class="literal">counter</code> and <code class="literal">histogram</code> may also
be used. The <code class="literal">time_series_metric</code> values determine the kind of statistical
representations that are used during downsampling.</p>
<p>The index template includes a set of static
<a class="xref" href="tsds.html#time-series-dimension" title="Dimensions">time series dimensions</a>: <code class="literal">host</code>, <code class="literal">namespace</code>,
<code class="literal">node</code>, and <code class="literal">pod</code>. The time series dimensions are not changed by the
downsampling process.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _index_template/my-data-stream-template
{
  "index_patterns": [
    "my-data-stream*"
  ],
  "data_stream": {},
  "template": {
    "settings": {
      "index": {
        "mode": "time_series",
        "routing_path": [
          "kubernetes.namespace",
          "kubernetes.host",
          "kubernetes.node",
          "kubernetes.pod"
        ],
        "number_of_replicas": 0,
        "number_of_shards": 2
      }
    },
    "mappings": {
      "properties": {
        "@timestamp": {
          "type": "date"
        },
        "kubernetes": {
          "properties": {
            "container": {
              "properties": {
                "cpu": {
                  "properties": {
                    "usage": {
                      "properties": {
                        "core": {
                          "properties": {
                            "ns": {
                              "type": "long"
                            }
                          }
                        },
                        "limit": {
                          "properties": {
                            "pct": {
                              "type": "float"
                            }
                          }
                        },
                        "nanocores": {
                          "type": "long",
                          "time_series_metric": "gauge"
                        },
                        "node": {
                          "properties": {
                            "pct": {
                              "type": "float"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "memory": {
                  "properties": {
                    "available": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "time_series_metric": "gauge"
                        }
                      }
                    },
                    "majorpagefaults": {
                      "type": "long"
                    },
                    "pagefaults": {
                      "type": "long",
                      "time_series_metric": "gauge"
                    },
                    "rss": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "time_series_metric": "gauge"
                        }
                      }
                    },
                    "usage": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "time_series_metric": "gauge"
                        },
                        "limit": {
                          "properties": {
                            "pct": {
                              "type": "float"
                            }
                          }
                        },
                        "node": {
                          "properties": {
                            "pct": {
                              "type": "float"
                            }
                          }
                        }
                      }
                    },
                    "workingset": {
                      "properties": {
                        "bytes": {
                          "type": "long",
                          "time_series_metric": "gauge"
                        }
                      }
                    }
                  }
                },
                "name": {
                  "type": "keyword"
                },
                "start_time": {
                  "type": "date"
                }
              }
            },
            "host": {
              "type": "keyword",
              "time_series_dimension": true
            },
            "namespace": {
              "type": "keyword",
              "time_series_dimension": true
            },
            "node": {
              "type": "keyword",
              "time_series_dimension": true
            },
            "pod": {
              "type": "keyword",
              "time_series_dimension": true
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/662.console"></div>
<h4><a id="downsampling-manual-ingest-data"></a>Ingest time series data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-manual.asciidoc">edit</a></h4>
<p>Because time series data streams have been designed to
<a class="xref" href="tsds.html#tsds-accepted-time-range" title="Accepted time range for adding data">only accept recent data</a>, in this example, you&#8217;ll
use an ingest pipeline to time-shift the data as it gets indexed. As a result,
the indexed data will have an <code class="literal">@timestamp</code> from the last 15 minutes.</p>
<p>Create the pipeline with this request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/my-timestamp-pipeline
{
  "description": "Shifts the @timestamp to the last 15 minutes",
  "processors": [
    {
      "set": {
        "field": "ingest_time",
        "value": "{{_ingest.timestamp}}"
      }
    },
    {
      "script": {
        "lang": "painless",
        "source": """
          def delta = ChronoUnit.SECONDS.between(
            ZonedDateTime.parse("2022-06-21T15:49:00Z"),
            ZonedDateTime.parse(ctx["ingest_time"])
          );
          ctx["@timestamp"] = ZonedDateTime.parse(ctx["@timestamp"]).plus(delta,ChronoUnit.SECONDS).toString();
        """
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/663.console"></div>
<p>Next, use a bulk API request to automatically create your TSDS and index a set
of ten documents:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-data-stream/_bulk?refresh&amp;pipeline=my-timestamp-pipeline
{"create": {}}
{"@timestamp":"2022-06-21T15:49:00Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":91153,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":463314616},"usage":{"bytes":307007078,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":585236},"rss":{"bytes":102728},"pagefaults":120901,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:45:50Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":124501,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":982546514},"usage":{"bytes":360035574,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1339884},"rss":{"bytes":381174},"pagefaults":178473,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:44:50Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":38907,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":862723768},"usage":{"bytes":379572388,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":431227},"rss":{"bytes":386580},"pagefaults":233166,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:44:40Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":86706,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":567160996},"usage":{"bytes":103266017,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1724908},"rss":{"bytes":105431},"pagefaults":233166,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:44:00Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":150069,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":639054643},"usage":{"bytes":265142477,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1786511},"rss":{"bytes":189235},"pagefaults":138172,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:42:40Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":82260,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":854735585},"usage":{"bytes":309798052,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":924058},"rss":{"bytes":110838},"pagefaults":259073,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:42:10Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":153404,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":279586406},"usage":{"bytes":214904955,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1047265},"rss":{"bytes":91914},"pagefaults":302252,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:40:20Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":125613,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":822782853},"usage":{"bytes":100475044,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":2109932},"rss":{"bytes":278446},"pagefaults":74843,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:40:10Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":100046,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":567160996},"usage":{"bytes":362826547,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":1986724},"rss":{"bytes":402801},"pagefaults":296495,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}
{"create": {}}
{"@timestamp":"2022-06-21T15:38:30Z","kubernetes":{"host":"gke-apps-0","node":"gke-apps-0-0","pod":"gke-apps-0-0-0","container":{"cpu":{"usage":{"nanocores":40018,"core":{"ns":12828317850},"node":{"pct":2.77905e-05},"limit":{"pct":2.77905e-05}}},"memory":{"available":{"bytes":1062428344},"usage":{"bytes":265142477,"node":{"pct":0.01770037710617187},"limit":{"pct":9.923134671484496e-05}},"workingset":{"bytes":2294743},"rss":{"bytes":340623},"pagefaults":224530,"majorpagefaults":0},"start_time":"2021-03-30T07:59:06Z","name":"container-name-44"},"namespace":"namespace26"}}</pre>
</div>
<div class="console_widget" data-snippet="snippets/664.console"></div>
<p>You can use the search API to check if the documents have been indexed
correctly:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-data-stream/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/665.console"></div>
<p>Run the following aggregation on the data to calculate some interesting
statistics:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-data-stream/_search
{
    "size": 0,
    "aggs": {
        "tsid": {
            "terms": {
                "field": "_tsid"
            },
            "aggs": {
                "over_time": {
                    "date_histogram": {
                        "field": "@timestamp",
                        "fixed_interval": "1d"
                    },
                    "aggs": {
                        "min": {
                            "min": {
                                "field": "kubernetes.container.memory.usage.bytes"
                            }
                        },
                        "max": {
                            "max": {
                                "field": "kubernetes.container.memory.usage.bytes"
                            }
                        },
                        "avg": {
                            "avg": {
                                "field": "kubernetes.container.memory.usage.bytes"
                            }
                        }
                    }
                }
            }
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/666.console"></div>
<h4><a id="downsampling-manual-run"></a>Downsample the TSDS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-manual.asciidoc">edit</a></h4>
<p>A TSDS can&#8217;t be downsampled directly. You need to downsample its backing indices
instead. You can see the backing index for your data stream by running:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_data_stream/my-data-stream</pre>
</div>
<div class="console_widget" data-snippet="snippets/667.console"></div>
<p>This returns:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "data_streams": [
    {
      "name": "my-data-stream",
      "timestamp_field": {
        "name": "@timestamp"
      },
      "indices": [
        {
          "index_name": ".ds-my-data-stream-2023.07.26-000001", <a id="CO180-1"></a><i class="conum" data-value="1"></i>
          "index_uuid": "ltOJGmqgTVm4T-Buoe7Acg"
        }
      ],
      "generation": 1,
      "status": "GREEN",
      "template": "my-data-stream-template",
      "hidden": false,
      "system": false,
      "allow_custom_routing": false,
      "replicated": false,
      "time_series": {
        "temporal_ranges": [
          {
            "start": "2023-07-26T09:26:42.000Z",
            "end": "2023-07-26T13:26:42.000Z"
          }
        ]
      }
    }
  ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO180-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The backing index for this data stream.</p>
</td>
</tr>
</table>
</div>
<p>Before a backing index can be downsampled, the TSDS needs to be rolled over and
the old index needs to be made read-only.</p>
<p>Roll over the TSDS using the <a class="xref" href="indices.html#indices-rollover-index" title="Rollover API">rollover API</a>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /my-data-stream/_rollover/</pre>
</div>
<div class="console_widget" data-snippet="snippets/668.console"></div>
<p>Copy the name of the <code class="literal">old_index</code> from the response. In the following steps,
replace the index name with that of your <code class="literal">old_index</code>.</p>
<p>The old index needs to be set to read-only mode. Run the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /.ds-my-data-stream-2023.07.26-000001/_block/write</pre>
</div>
<div class="console_widget" data-snippet="snippets/669.console"></div>
<p>Next, use the <a class="xref" href="data-stream-apis.html#indices-downsample-data-stream" title="Downsample index API">downsample API</a> to downsample
the index, setting the time series interval to one hour:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /.ds-my-data-stream-2023.07.26-000001/_downsample/.ds-my-data-stream-2023.07.26-000001-downsample
{
  "fixed_interval": "1h"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/670.console"></div>
<p>Now you can <a class="xref" href="data-stream-apis.html#modify-data-streams-api" title="Modify data streams API">modify the data stream</a>, and replace the
original index with the downsampled one:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _data_stream/_modify
{
  "actions": [
    {
      "remove_backing_index": {
        "data_stream": "my-data-stream",
        "index": ".ds-my-data-stream-2023.07.26-000001"
      }
    },
    {
      "add_backing_index": {
        "data_stream": "my-data-stream",
        "index": ".ds-my-data-stream-2023.07.26-000001-downsample"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/671.console"></div>
<p>You can now delete the old backing index. But be aware this will delete the
original data. Don&#8217;t delete the index if you may need the original data in the
future.</p>
<h4><a id="downsampling-manual-view-results"></a>View the results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/data-streams/downsampling-manual.asciidoc">edit</a></h4>
<p>Re-run the earlier search query (note that when querying downsampled indices
there are <a class="xref" href="tsds.html#querying-downsampled-indices-notes" title="Notes on downsample queries">a few nuances to be aware of</a>):</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-data-stream/_search</pre>
</div>
<div class="console_widget" data-snippet="snippets/672.console"></div>
<p>The TSDS with the new downsampled backing index contains just one document. For
counters, this document would only have the last value. For gauges, the field
type is now <code class="literal">aggregate_metric_double</code>. You see the <code class="literal">min</code>, <code class="literal">max</code>, <code class="literal">sum</code>, and
<code class="literal">value_count</code> statistics based off of the original sampled metrics:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 4,
    "successful": 4,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 1,
    "hits": [
      {
        "_index": ".ds-my-data-stream-2023.07.26-000001-downsample",
        "_id": "0eL0wC_4-45SnTNFAAABiZHbD4A",
        "_score": 1,
        "_source": {
          "@timestamp": "2023-07-26T11:00:00.000Z",
          "_doc_count": 10,
          "ingest_time": "2023-07-26T11:26:42.715Z",
          "kubernetes": {
            "container": {
              "cpu": {
                "usage": {
                  "core": {
                    "ns": 12828317850
                  },
                  "limit": {
                    "pct": 0.0000277905
                  },
                  "nanocores": {
                    "min": 38907,
                    "max": 153404,
                    "sum": 992677,
                    "value_count": 10
                  },
                  "node": {
                    "pct": 0.0000277905
                  }
                }
              },
              "memory": {
                "available": {
                  "bytes": {
                    "min": 279586406,
                    "max": 1062428344,
                    "sum": 7101494721,
                    "value_count": 10
                  }
                },
                "majorpagefaults": 0,
                "pagefaults": {
                  "min": 74843,
                  "max": 302252,
                  "sum": 2061071,
                  "value_count": 10
                },
                "rss": {
                  "bytes": {
                    "min": 91914,
                    "max": 402801,
                    "sum": 2389770,
                    "value_count": 10
                  }
                },
                "usage": {
                  "bytes": {
                    "min": 100475044,
                    "max": 379572388,
                    "sum": 2668170609,
                    "value_count": 10
                  },
                  "limit": {
                    "pct": 0.00009923134
                  },
                  "node": {
                    "pct": 0.017700378
                  }
                },
                "workingset": {
                  "bytes": {
                    "min": 431227,
                    "max": 2294743,
                    "sum": 14230488,
                    "value_count": 10
                  }
                }
              },
              "name": "container-name-44",
              "start_time": "2021-03-30T07:59:06.000Z"
            },
            "host": "gke-apps-0",
            "namespace": "namespace26",
            "node": "gke-apps-0-0",
            "pod": "gke-apps-0-0-0"
          }
        }
      }
    ]
  }
}</pre>
</div>
<p>Re-run the earlier aggregation. Even though the aggregation runs on the
downsampled TSDS that only contains 1 document, it returns the same results as
the earlier aggregation on the original TSDS.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-data-stream/_search
{
    "size": 0,
    "aggs": {
        "tsid": {
            "terms": {
                "field": "_tsid"
            },
            "aggs": {
                "over_time": {
                    "date_histogram": {
                        "field": "@timestamp",
                        "fixed_interval": "1d"
                    },
                    "aggs": {
                        "min": {
                            "min": {
                                "field": "kubernetes.container.memory.usage.bytes"
                            }
                        },
                        "max": {
                            "max": {
                                "field": "kubernetes.container.memory.usage.bytes"
                            }
                        },
                        "avg": {
                            "avg": {
                                "field": "kubernetes.container.memory.usage.bytes"
                            }
                        }
                    }
                }
            }
        }
    }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/673.console"></div>
<p>This example demonstrates how downsampling can dramatically reduce the number of
documents stored for time series data, within whatever time boundaries you
choose. It&#8217;s also possible to perform downsampling on already downsampled data,
to further reduce storage and associated costs, as the time series data ages and
the data resolution becomes less critical.</p>
<p>The recommended way to downsample a TSDS is with ILM. To learn more, try the
<a class="xref" href="tsds.html#downsampling-ilm" title="Run downsampling with ILM">Run downsampling with ILM</a> example.</p>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="modify-data-streams.html">« Modify a data stream</a>
</span>
<span class="next">
<a href="ingest.html">Ingest pipelines »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
