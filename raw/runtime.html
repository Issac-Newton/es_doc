<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Runtime fields | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Runtime fields | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="mapping.html" title="Mapping"/>
<link rel="prev" href="explicit-mapping.html" title="Explicit mapping"/>
<link rel="next" href="mapping-types.html" title="Field data types"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="mapping.html">Mapping</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="explicit-mapping.html">« Explicit mapping</a>
</span>
<span class="next">
<a href="mapping-types.html">Field data types »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime"></a>Runtime fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>A <em>runtime field</em> is a field that is evaluated at query time. Runtime fields
enable you to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add fields to existing documents without reindexing your data
</li>
<li class="listitem">
Start working with your data without understanding how it’s structured
</li>
<li class="listitem">
Override the value returned from an indexed field at query time
</li>
<li class="listitem">
Define fields for a specific use without modifying the underlying schema
</li>
</ul>
</div>
<p>You access runtime fields from the search API like any other field, and Elasticsearch
sees runtime fields no differently. You can define runtime fields in the
<a class="xref" href="runtime.html#runtime-mapping-fields" title="Map a runtime field">index mapping</a> or in the
<a class="xref" href="runtime.html#runtime-search-request" title="Define runtime fields in a search request">search request</a>. Your choice, which is part of the
inherent flexibility of runtime fields.</p>
<p>Use the <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a> parameter on the <code class="literal">_search</code> API to
<a class="xref" href="runtime.html#runtime-retrieving-fields" title="Retrieve a runtime field">retrieve the values of runtime fields</a>. Runtime
fields won&#8217;t display in <code class="literal">_source</code>, but the <code class="literal">fields</code> API works for all fields,
even those that were not sent as part of the original <code class="literal">_source</code>.</p>
<p>Runtime fields are useful when working with log data
(see <a class="xref" href="runtime.html#runtime-examples" title="Explore your data with runtime fields">examples</a>), especially when you&#8217;re unsure about the
data structure. Your search speed decreases, but your index size is much
smaller and you can more quickly process logs without having to index them.</p>
<h3><a id="runtime-benefits"></a>Benefits<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
<p>Because runtime fields aren&#8217;t indexed, adding a runtime field doesn&#8217;t increase
the index size. You define runtime fields directly in the index mapping, saving
storage costs and increasing ingestion speed. You can more quickly ingest
data into the Elastic Stack and access it right away. When you define a runtime
field, you can immediately use it in search requests, aggregations, filtering,
and sorting.</p>
<p>If you change a runtime field into an indexed field, you don&#8217;t need to modify
any queries that refer to the runtime field. Better yet, you can refer to some
indices where the field is a runtime field, and other indices where the field
is an indexed field. You have the flexibility to choose which fields to index
and which ones to keep as runtime fields.</p>
<p>At its core, the most important benefit of runtime fields is the ability to
add fields to documents after you&#8217;ve ingested them. This capability simplifies
mapping decisions because you don&#8217;t have to decide how to parse your data up
front, and can use runtime fields to amend the mapping at any time. Using
runtime fields allows for a smaller index and faster ingest time, which
combined use less resources and reduce your operating costs.</p>
<h3><a id="runtime-incentives"></a>Incentives<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
<p>Runtime fields can replace many of the ways you can use scripting with the
<code class="literal">_search</code> API. How you use a runtime field is impacted by the number of
documents that the included script runs against. For example, if you&#8217;re using
the <code class="literal">fields</code> parameter on the <code class="literal">_search</code> API to
<a class="xref" href="runtime.html#runtime-retrieving-fields" title="Retrieve a runtime field">retrieve the values of a runtime field</a>, the script
runs only against the top hits just like script fields do.</p>
<p>You can use <a class="xref" href="search-fields.html#script-fields" title="Script fields">script fields</a> to access values in <code class="literal">_source</code> and
return calculated values based on a script valuation. Runtime fields have the
same capabilities, but provide greater flexibility because you can query and
aggregate on runtime fields in a search request. Script fields can only fetch
values.</p>
<p>Similarly, you could write a <a class="xref" href="specialized-queries.html#query-dsl-script-query" title="Script query">script query</a> that
filters documents in a search request based on a script. Runtime fields provide
a very similar feature that is more flexible. You write a script to create
field values and they are available everywhere, such as
<a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a>, <a class="xref" href="query-dsl.html" title="Query DSL">all queries</a>, and
<a class="xref" href="search-aggregations.html" title="Aggregations">aggregations</a>.</p>
<p>You can also use scripts to <a class="xref" href="sort-search-results.html#script-based-sorting" title="Script Based Sorting">sort search results</a>, but
that same script works exactly the same in a runtime field.</p>
<p>If you move a script from any of these sections in a search request to a
runtime field that is computing values from the same number of documents, the
performance should be about the same. The performance for these features is
largely dependent upon the calculations that the included script is running and
how many documents the script runs against.</p>
<h3><a id="runtime-compromises"></a>Compromises<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
<p>Runtime fields use less disk space and provide flexibility in how you access
your data, but can impact search performance based on the computation defined in
the runtime script.</p>
<p>To balance search performance and flexibility, index fields that you&#8217;ll
frequently search for and filter on, such as a timestamp. Elasticsearch automatically
uses these indexed fields first when running a query, resulting in a fast
response time. You can then use runtime fields to limit the number of fields
that Elasticsearch needs to calculate values for. Using indexed fields in tandem with
runtime fields provides flexibility in the data that you index and how you
define queries for other fields.</p>
<p>Use the <a class="xref" href="search.html#async-search" title="Async search">asynchronous search API</a> to run searches that include
runtime fields. This method of search helps to offset the performance impacts
of computing values for runtime fields in each document containing that field.
If the query can&#8217;t return the result set synchronously, you&#8217;ll get results
asynchronously as they become available.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Queries against runtime fields are considered expensive. If
<a class="xref" href="query-dsl.html#query-dsl-allow-expensive-queries"><code class="literal">search.allow_expensive_queries</code></a> is set
to <code class="literal">false</code>, expensive queries are not allowed and Elasticsearch will reject any queries
against runtime fields.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime-mapping-fields"></a>Map a runtime field<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>You map runtime fields by adding a <code class="literal">runtime</code> section under the mapping
definition and defining
<a class="xref" href="modules-scripting-using.html" title="How to write scripts">a Painless script</a>. This script has access to the
entire context of a document, including the original <code class="literal">_source</code> via <code class="literal">params._source</code>
and any mapped fields plus their values. At query time, the script runs and
generates values for each scripted field that is required for the query.</p>
<div class="sidebar">
<div class="titlepage"><div><div>
<p class="title"><strong>Emitting runtime field values</strong></p>
</div></div></div>
<p>When defining a Painless script to use with runtime fields, you must include
the <a href="https://www.elastic.co/guide/en/elasticsearch/painless/8.9/painless-runtime-fields-context.html" class="ulink" target="_top"><code class="literal">emit</code> method</a> to emit
calculated values.</p>
</div>
<p>For example, the script in the following request calculates the day of the week
from the <code class="literal">@timestamp</code> field, which is defined as a <code class="literal">date</code> type. The script
calculates the day of the week based on the value of <code class="literal">timestamp</code>, and uses
<code class="literal">emit</code> to return the calculated value.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/
{
  "mappings": {
    "runtime": {
      "day_of_week": {
        "type": "keyword",
        "script": {
          "source": "emit(doc['@timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))"
        }
      }
    },
    "properties": {
      "@timestamp": {"type": "date"}
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/117.console"></div>
<p>The <code class="literal">runtime</code> section can be any of these data types:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">boolean</code>
</li>
<li class="listitem">
<code class="literal">composite</code>
</li>
<li class="listitem">
<code class="literal">date</code>
</li>
<li class="listitem">
<code class="literal">double</code>
</li>
<li class="listitem">
<code class="literal">geo_point</code>
</li>
<li class="listitem">
<code class="literal">ip</code>
</li>
<li class="listitem">
<code class="literal">keyword</code>
</li>
<li class="listitem">
<code class="literal">long</code>
</li>
<li class="listitem">
<a class="xref" href="runtime.html#lookup-runtime-fields" title="Retrieve fields from related indices"><code class="literal">lookup</code></a>
</li>
</ul>
</div>
<p>Runtime fields with a <code class="literal">type</code> of <code class="literal">date</code> can accept the
<a class="xref" href="mapping-params.html#mapping-date-format" title="format"><code class="literal">format</code></a> parameter exactly as the <code class="literal">date</code> field type.</p>
<p>Runtime fields with a <code class="literal">type</code> of <code class="literal">lookup</code> allow retrieving fields from
related indices. See <a class="xref" href="runtime.html#lookup-runtime-fields" title="Retrieve fields from related indices"><code class="literal">retrieve fields from related indices</code></a>.</p>
<p>If <a class="xref" href="dynamic-mapping.html#dynamic-field-mapping" title="Dynamic field mapping">dynamic field mapping</a> is enabled where the
<code class="literal">dynamic</code> parameter is set to <code class="literal">runtime</code>, new fields are automatically added to
the index mapping as runtime fields:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001
{
  "mappings": {
    "dynamic": "runtime",
    "properties": {
      "@timestamp": {
        "type": "date"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/118.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-fields-scriptless"></a>Define runtime fields without a script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>Runtime fields typically include a Painless script that manipulates data in some
way. However, there are instances where you might define a runtime field
<em>without</em> a script. For example, if you want to retrieve a single field from <code class="literal">_source</code> without making changes, you don&#8217;t need a script. You can just create
a runtime field without a script, such as <code class="literal">day_of_week</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/
{
  "mappings": {
    "runtime": {
      "day_of_week": {
        "type": "keyword"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/119.console"></div>
<p>When no script is provided, Elasticsearch implicitly looks in <code class="literal">_source</code> at query time
for a field with the same name as the runtime field, and returns a value if one
exists. If a field with the same name doesn’t exist, the response doesn&#8217;t
include any values for that runtime field.</p>
<p>In most cases, retrieve field values through
<a class="xref" href="mapping-params.html#doc-values" title="doc_values"><code class="literal">doc_values</code></a> whenever possible. Accessing <code class="literal">doc_values</code> with a
runtime field is faster than retrieving values from <code class="literal">_source</code> because of how
data is loaded from Lucene.</p>
<p>However, there are cases where retrieving fields from <code class="literal">_source</code> is necessary.
For example, <code class="literal">text</code> fields do not have <code class="literal">doc_values</code> available by default, so you
have to retrieve values from <code class="literal">_source</code>. In other instances, you might choose to
disable <code class="literal">doc_values</code> on a specific field.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can alternatively prefix the field you want to retrieve values for
with <code class="literal">params._source</code> (such as <code class="literal">params._source.day_of_week</code>). For simplicity,
defining a runtime field in the mapping definition without a script is the
recommended option, whenever possible.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-errorhandling"></a>Ignoring script errors on runtime fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>Scripts can throw errors at runtime, e.g. on accessing missing or invalid values
in documents or because of performing invalid operations. The <code class="literal">on_script_error</code>
parameter can be used to control error behaviour when this happens. Setting this
parameter to <code class="literal">continue</code> will have the effect of silently ignoring all errors on
this runtime field. The default <code class="literal">fail</code> value will cause a shard failure which
gets reported in the search response.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-updating-scripts"></a>Updating and removing runtime fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>You can update or remove runtime fields at any time. To replace an existing
runtime field, add a new runtime field to the mappings with the same name. To
remove a runtime field from the mappings, set the value of the runtime field to
<code class="literal">null</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mapping
{
 "runtime": {
   "day_of_week": null
 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/120.console"></div>
<div class="sidebar">
<div class="titlepage"><div><div>
<p class="title"><strong>Downstream impacts</strong></p>
</div></div></div>
<p>Updating or removing a runtime field while a dependent query is running can return
inconsistent results. Each shard might have access to different versions of the
script, depending on when the mapping change takes effect.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Existing queries or visualizations in Kibana that rely on runtime fields can
fail if you remove or update the field. For example, a bar chart visualization
that uses a runtime field of type <code class="literal">ip</code> will fail if the type is changed
to <code class="literal">boolean</code>, or if the runtime field is removed.</p>
</div>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime-search-request"></a>Define runtime fields in a search request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>You can specify a <code class="literal">runtime_mappings</code> section in a search request to create
runtime fields that exist only as part of the query. You specify a script
as part of the <code class="literal">runtime_mappings</code> section, just as you would if
<a class="xref" href="runtime.html#runtime-mapping-fields" title="Map a runtime field">adding a runtime field to the mappings</a>.</p>
<p>Defining a runtime field in a search request uses the same format as defining
a runtime field in the index mapping. Just copy the field definition from
the <code class="literal">runtime</code> in the index mapping to the <code class="literal">runtime_mappings</code> section of the search request.</p>
<p>The following search request adds a <code class="literal">day_of_week</code> field to the
<code class="literal">runtime_mappings</code> section. The field values will be calculated dynamically,
and only within the context of this search request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "runtime_mappings": {
    "day_of_week": {
      "type": "keyword",
      "script": {
        "source": "emit(doc['@timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))"
      }
    }
  },
  "aggs": {
    "day_of_week": {
      "terms": {
        "field": "day_of_week"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/121.console"></div>
<h3><a id="runtime-search-request-examples"></a>Create runtime fields that use other runtime fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
<p>You can even define runtime fields in a search request that return values from
other runtime fields. For example, let&#8217;s say you bulk index some sensor data:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST my-index-000001/_bulk?refresh=true
{"index":{}}
{"@timestamp":1516729294000,"model_number":"QVKC92Q","measures":{"voltage":"5.2","start": "300","end":"8675309"}}
{"index":{}}
{"@timestamp":1516642894000,"model_number":"QVKC92Q","measures":{"voltage":"5.8","start": "300","end":"8675309"}}
{"index":{}}
{"@timestamp":1516556494000,"model_number":"QVKC92Q","measures":{"voltage":"5.1","start": "300","end":"8675309"}}
{"index":{}}
{"@timestamp":1516470094000,"model_number":"QVKC92Q","measures":{"voltage":"5.6","start": "300","end":"8675309"}}
{"index":{}}
{"@timestamp":1516383694000,"model_number":"HG537PU","measures":{"voltage":"4.2","start": "400","end":"8625309"}}
{"index":{}}
{"@timestamp":1516297294000,"model_number":"HG537PU","measures":{"voltage":"4.0","start": "400","end":"8625309"}}</pre>
</div>
<div class="console_widget" data-snippet="snippets/122.console"></div>
<p>You realize after indexing that your numeric data was mapped as type <code class="literal">text</code>.
You want to aggregate on the <code class="literal">measures.start</code> and <code class="literal">measures.end</code> fields, but
the aggregation fails because you can&#8217;t aggregate on fields of type <code class="literal">text</code>.
Runtime fields to the rescue! You can add runtime fields with the same name as
your indexed fields and modify the data type:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mapping
{
  "runtime": {
    "measures.start": {
      "type": "long"
    },
    "measures.end": {
      "type": "long"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/123.console"></div>
<p>Runtime fields take precedence over fields defined with the same name in the
index mappings. This flexibility allows you to shadow existing fields and
calculate a different value, without modifying the field itself. If you made a
mistake in your index mapping, you can use runtime fields to calculate values
that <a class="xref" href="runtime.html#runtime-override-values" title="Override field values at query time">override values</a> in the mapping during the
search request.</p>
<p>Now, you can easily run an
<a class="xref" href="search-aggregations-metrics.html#search-aggregations-metrics-avg-aggregation" title="Avg aggregation">average aggregation</a> on the
<code class="literal">measures.start</code> and <code class="literal">measures.end</code> fields:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "aggs": {
    "avg_start": {
      "avg": {
        "field": "measures.start"
      }
    },
    "avg_end": {
      "avg": {
        "field": "measures.end"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/124.console"></div>
<p>The response includes the aggregation results without changing the values for
the underlying data:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "aggregations" : {
    "avg_start" : {
      "value" : 333.3333333333333
    },
    "avg_end" : {
      "value" : 8658642.333333334
    }
  }
}</pre>
</div>
<p>Further, you can define a runtime field as part of a search query that
calculates a value, and then run a
<a class="xref" href="search-aggregations-metrics.html#search-aggregations-metrics-stats-aggregation" title="Stats aggregation">stats aggregation</a> on that
field <em>in the same query</em>.</p>
<p>The <code class="literal">duration</code> runtime field doesn&#8217;t exist in the index mapping, but we can
still search and aggregate on that field. The following query returns the
calculated value for the <code class="literal">duration</code> field and runs a stats aggregation to
compute statistics over numeric values extracted from the aggregated documents.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "runtime_mappings": {
    "duration": {
      "type": "long",
      "script": {
        "source": """
          emit(doc['measures.end'].value - doc['measures.start'].value);
          """
      }
    }
  },
  "aggs": {
    "duration_stats": {
      "stats": {
        "field": "duration"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/125.console"></div>
<p>Even though the <code class="literal">duration</code> runtime field only exists in the context of a search
query, you can search and aggregate on that field. This flexibility is
incredibly powerful, enabling you to rectify mistakes in your index mappings
and dynamically complete calculations all within a single search request.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "aggregations" : {
    "duration_stats" : {
      "count" : 6,
      "min" : 8624909.0,
      "max" : 8675009.0,
      "avg" : 8658309.0,
      "sum" : 5.1949854E7
    }
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime-override-values"></a>Override field values at query time<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>If you create a runtime field with the same name as a field that
already exists in the mapping, the runtime field shadows the mapped field. At
query time, Elasticsearch evaluates the runtime field, calculates a value based on the
script, and returns the value as part of the query. Because the runtime field
shadows the mapped field, you can override the value returned in search without
modifying the mapped field.</p>
<p>For example, let&#8217;s say you indexed the following documents into <code class="literal">my-index-000001</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST my-index-000001/_bulk?refresh=true
{"index":{}}
{"@timestamp":1516729294000,"model_number":"QVKC92Q","measures":{"voltage":5.2}}
{"index":{}}
{"@timestamp":1516642894000,"model_number":"QVKC92Q","measures":{"voltage":5.8}}
{"index":{}}
{"@timestamp":1516556494000,"model_number":"QVKC92Q","measures":{"voltage":5.1}}
{"index":{}}
{"@timestamp":1516470094000,"model_number":"QVKC92Q","measures":{"voltage":5.6}}
{"index":{}}
{"@timestamp":1516383694000,"model_number":"HG537PU","measures":{"voltage":4.2}}
{"index":{}}
{"@timestamp":1516297294000,"model_number":"HG537PU","measures":{"voltage":4.0}}</pre>
</div>
<div class="console_widget" data-snippet="snippets/126.console"></div>
<p>You later realize that the <code class="literal">HG537PU</code> sensors aren&#8217;t reporting their true
voltage. The indexed values are supposed to be 1.7 times higher than
the reported values! Instead of reindexing your data, you can define a script in
the <code class="literal">runtime_mappings</code> section of the <code class="literal">_search</code> request to shadow the <code class="literal">voltage</code>
field and calculate a new value at query time.</p>
<p>If you search for documents where the model number matches <code class="literal">HG537PU</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "match": {
      "model_number": "HG537PU"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/127.console"></div>
<p>The response includes indexed values for documents matching model number
<code class="literal">HG537PU</code>:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 1.0296195,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "F1BeSXYBg_szTodcYCmk",
        "_score" : 1.0296195,
        "_source" : {
          "@timestamp" : 1516383694000,
          "model_number" : "HG537PU",
          "measures" : {
            "voltage" : 4.2
          }
        }
      },
      {
        "_index" : "my-index-000001",
        "_id" : "l02aSXYBkpNf6QRDO62Q",
        "_score" : 1.0296195,
        "_source" : {
          "@timestamp" : 1516297294000,
          "model_number" : "HG537PU",
          "measures" : {
            "voltage" : 4.0
          }
        }
      }
    ]
  }
}</pre>
</div>
<p>The following request defines a runtime field where the script evaluates the
<code class="literal">model_number</code> field where the value is <code class="literal">HG537PU</code>. For each match, the script
multiplies the value for the <code class="literal">voltage</code> field by <code class="literal">1.7</code>.</p>
<p>Using the <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a> parameter on the <code class="literal">_search</code> API, you can
retrieve the value that the script calculates for the <code class="literal">measures.voltage</code> field
for documents matching the search request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST my-index-000001/_search
{
  "runtime_mappings": {
    "measures.voltage": {
      "type": "double",
      "script": {
        "source":
        """if (doc['model_number.keyword'].value.equals('HG537PU'))
        {emit(1.7 * params._source['measures']['voltage']);}
        else{emit(params._source['measures']['voltage']);}"""
      }
    }
  },
  "query": {
    "match": {
      "model_number": "HG537PU"
    }
  },
  "fields": ["measures.voltage"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/128.console"></div>
<p>Looking at the response, the calculated values for <code class="literal">measures.voltage</code> on each
result are <code class="literal">7.14</code> and <code class="literal">6.8</code>. That&#8217;s more like it! The runtime field calculated
this value as part of the search request without modifying the mapped value,
which still returns in the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 1.0296195,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "F1BeSXYBg_szTodcYCmk",
        "_score" : 1.0296195,
        "_source" : {
          "@timestamp" : 1516383694000,
          "model_number" : "HG537PU",
          "measures" : {
            "voltage" : 4.2
          }
        },
        "fields" : {
          "measures.voltage" : [
            7.14
          ]
        }
      },
      {
        "_index" : "my-index-000001",
        "_id" : "l02aSXYBkpNf6QRDO62Q",
        "_score" : 1.0296195,
        "_source" : {
          "@timestamp" : 1516297294000,
          "model_number" : "HG537PU",
          "measures" : {
            "voltage" : 4.0
          }
        },
        "fields" : {
          "measures.voltage" : [
            6.8
          ]
        }
      }
    ]
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime-retrieving-fields"></a>Retrieve a runtime field<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>Use the <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a> parameter on the <code class="literal">_search</code> API to retrieve
the values of runtime fields. Runtime fields won&#8217;t display in <code class="literal">_source</code>, but
the <code class="literal">fields</code> API works for all fields, even those that were not sent as part of
the original <code class="literal">_source</code>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-define-field-dayofweek"></a>Define a runtime field to calculate the day of week<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>For example, the following request adds a runtime field called <code class="literal">day_of_week</code>.
The runtime field includes a script that calculates the day of the week based
on the value of the <code class="literal">@timestamp</code> field. We&#8217;ll include <code class="literal">"dynamic":"runtime"</code> in
the request so that new fields are added to the mapping as runtime fields.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/
{
  "mappings": {
    "dynamic": "runtime",
    "runtime": {
      "day_of_week": {
        "type": "keyword",
        "script": {
          "source": "emit(doc['@timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))"
        }
      }
    },
    "properties": {
      "@timestamp": {"type": "date"}
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/129.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-ingest-data"></a>Ingest some data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>Let&#8217;s ingest some sample data, which will result in two indexed fields:
<code class="literal">@timestamp</code> and <code class="literal">message</code>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /my-index-000001/_bulk?refresh
{ "index": {}}
{ "@timestamp": "2020-06-21T15:00:01-05:00", "message" : "211.11.9.0 - - [2020-06-21T15:00:01-05:00] \"GET /english/index.html HTTP/1.0\" 304 0"}
{ "index": {}}
{ "@timestamp": "2020-06-21T15:00:01-05:00", "message" : "211.11.9.0 - - [2020-06-21T15:00:01-05:00] \"GET /english/index.html HTTP/1.0\" 304 0"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:30:17-05:00", "message" : "40.135.0.0 - - [2020-04-30T14:30:17-05:00] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:30:53-05:00", "message" : "232.0.0.0 - - [2020-04-30T14:30:53-05:00] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:12-05:00", "message" : "26.1.0.0 - - [2020-04-30T14:31:12-05:00] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:19-05:00", "message" : "247.37.0.0 - - [2020-04-30T14:31:19-05:00] \"GET /french/splash_inet.html HTTP/1.0\" 200 3781"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:27-05:00", "message" : "252.0.0.0 - - [2020-04-30T14:31:27-05:00] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:29-05:00", "message" : "247.37.0.0 - - [2020-04-30T14:31:29-05:00] \"GET /images/hm_brdl.gif HTTP/1.0\" 304 0"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:29-05:00", "message" : "247.37.0.0 - - [2020-04-30T14:31:29-05:00] \"GET /images/hm_arw.gif HTTP/1.0\" 304 0"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:32-05:00", "message" : "247.37.0.0 - - [2020-04-30T14:31:32-05:00] \"GET /images/nav_bg_top.gif HTTP/1.0\" 200 929"}
{ "index": {}}
{ "@timestamp": "2020-04-30T14:31:43-05:00", "message" : "247.37.0.0 - - [2020-04-30T14:31:43-05:00] \"GET /french/images/nav_venue_off.gif HTTP/1.0\" 304 0"}</pre>
</div>
<div class="console_widget" data-snippet="snippets/130.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-search-dayofweek"></a>Search for the calculated day of week<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>The following request uses the search API to retrieve the <code class="literal">day_of_week</code> field
that the original request defined as a runtime field in the mapping. The value
for this field is calculated dynamically at query time without reindexing
documents or indexing the <code class="literal">day_of_week</code> field. This flexibility allows you to
modify the mapping without changing any field values.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "fields": [
    "@timestamp",
    "day_of_week"
  ],
  "_source": false
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/131.console"></div>
<p>The previous request returns the <code class="literal">day_of_week</code> field for all matching documents.
We can define another runtime field called <code class="literal">client_ip</code> that also operates on
the <code class="literal">message</code> field and will further refine the query:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-000001/_mapping
{
  "runtime": {
    "client_ip": {
      "type": "ip",
      "script" : {
      "source" : "String m = doc[\"message\"].value; int end = m.indexOf(\" \"); emit(m.substring(0, end));"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/132.console"></div>
<p>Run another query, but search for a specific IP address using the <code class="literal">client_ip</code>
runtime field:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "size": 1,
  "query": {
    "match": {
      "client_ip": "211.11.9.0"
    }
  },
  "fields" : ["*"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/133.console"></div>
<p>This time, the response includes only two hits. The value for <code class="literal">day_of_week</code>
(<code class="literal">Sunday</code>) was calculated at query time using the runtime script defined in the
mapping, and the result includes only documents matching the <code class="literal">211.11.9.0</code> IP
address.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "oWs5KXYB-XyJbifr9mrz",
        "_score" : 1.0,
        "_source" : {
          "@timestamp" : "2020-06-21T15:00:01-05:00",
          "message" : "211.11.9.0 - - [2020-06-21T15:00:01-05:00] \"GET /english/index.html HTTP/1.0\" 304 0"
        },
        "fields" : {
          "@timestamp" : [
            "2020-06-21T20:00:01.000Z"
          ],
          "client_ip" : [
            "211.11.9.0"
          ],
          "message" : [
            "211.11.9.0 - - [2020-06-21T15:00:01-05:00] \"GET /english/index.html HTTP/1.0\" 304 0"
          ],
          "day_of_week" : [
            "Sunday"
          ]
        }
      }
    ]
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="lookup-runtime-fields"></a>Retrieve fields from related indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>The <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a> parameter on the <code class="literal">_search</code> API can also be used to retrieve fields from
the related indices via runtime fields with a type of <code class="literal">lookup</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Fields that are retrieved by runtime fields of type <code class="literal">lookup</code> can be used
to enrich the hits in a search response. It&#8217;s not possible to query or aggregate
on these fields.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST ip_location/_doc?refresh
{
  "ip": "192.168.1.1",
  "country": "Canada",
  "city": "Montreal"
}

PUT logs/_doc/1?refresh
{
  "host": "192.168.1.1",
  "message": "the first message"
}

PUT logs/_doc/2?refresh
{
  "host": "192.168.1.2",
  "message": "the second message"
}

POST logs/_search
{
  "runtime_mappings": {
    "location": {
        "type": "lookup", <a id="CO42-1"></a><i class="conum" data-value="1"></i>
        "target_index": "ip_location", <a id="CO42-2"></a><i class="conum" data-value="2"></i>
        "input_field": "host", <a id="CO42-3"></a><i class="conum" data-value="3"></i>
        "target_field": "ip", <a id="CO42-4"></a><i class="conum" data-value="4"></i>
        "fetch_fields": ["country", "city"] <a id="CO42-5"></a><i class="conum" data-value="5"></i>
    }
  },
  "fields": [
    "host",
    "message",
    "location"
  ],
  "_source": false
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/134.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Define a runtime field in the main search request with a type of <code class="literal">lookup</code> that retrieves fields from the target index using the <a class="xref" href="term-level-queries.html#query-dsl-term-query" title="Term query"><code class="literal">term</code></a> queries.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The target index where the lookup query executes against</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>A field on the main index whose values are used as the input values of the lookup term query</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>A field on the lookup index which the lookup query searches against</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>A list of fields to retrieve from the lookup index. See the <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a> parameter of a search request.</p>
</td>
</tr>
</table>
</div>
<p>The above search returns the country and city from the <code class="literal">ip_location</code> index
for each ip address of the returned search hits.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 2,
      "relation": "eq"
    },
    "max_score": 1.0,
    "hits": [
      {
        "_index": "logs",
        "_id": "1",
        "_score": 1.0,
        "fields": {
          "host": [ "192.168.1.1" ],
          "location": [
            {
              "city": [ "Montreal" ],
              "country": [ "Canada" ]
            }
          ],
          "message": [ "the first message" ]
        }
      },
      {
        "_index": "logs",
        "_id": "2",
        "_score": 1.0,
        "fields": {
          "host": [ "192.168.1.2" ],
          "message": [ "the second message" ]
        }
      }
    ]
  }
}</pre>
</div>
<p>The response of lookup fields are grouped to maintain the independence
of each document from the lookup index. The lookup query for each input
value is expected to match at most one document on the lookup index.
If the lookup query matches more than one documents, then a random document
will be selected.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime-indexed"></a>Index a runtime field<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>Runtime fields are defined by the context where they run. For example, you
can define runtime fields in the
<a class="xref" href="runtime.html#runtime-search-request" title="Define runtime fields in a search request">context of a search query</a> or within the
<a class="xref" href="runtime.html#runtime-mapping-fields" title="Map a runtime field"><code class="literal">runtime</code> section</a> of an index mapping. If you
decide to index a runtime field for greater performance, just move the full
runtime field definition (including the script) to the context of an index
mapping. Elasticsearch automatically uses these indexed fields to drive queries,
resulting in a fast response time. This capability means you can write a
script only once, and apply it to any context that supports runtime fields.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Indexing a <code class="literal">composite</code> runtime field is currently not supported.</p>
</div>
</div>
<p>You can then use runtime fields to limit the number of fields that Elasticsearch needs
to calculate values for. Using indexed fields in tandem with runtime fields
provides flexibility in the data that you index and how you define queries for
other fields.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>After indexing a runtime field, you cannot update the included
script. If you need to change the script, create a new field with the updated
script.</p>
</div>
</div>
<p>For example, let&#8217;s say your company wants to replace some old pressure
valves. The connected sensors are only capable of reporting a fraction of
the true readings. Rather than outfit the pressure valves with new sensors,
you decide to calculate the values based on reported readings. Based on the
reported data, you define the following fields in your mapping for
<code class="literal">my-index-000001</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/
{
  "mappings": {
    "properties": {
      "timestamp": {
        "type": "date"
      },
      "temperature": {
        "type": "long"
      },
      "voltage": {
        "type": "double"
      },
      "node": {
        "type": "keyword"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/135.console"></div>
<p>You then bulk index some sample data from your sensors. This data includes
<code class="literal">voltage</code> readings for each sensor:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST my-index-000001/_bulk?refresh=true
{"index":{}}
{"timestamp": 1516729294000, "temperature": 200, "voltage": 5.2, "node": "a"}
{"index":{}}
{"timestamp": 1516642894000, "temperature": 201, "voltage": 5.8, "node": "b"}
{"index":{}}
{"timestamp": 1516556494000, "temperature": 202, "voltage": 5.1, "node": "a"}
{"index":{}}
{"timestamp": 1516470094000, "temperature": 198, "voltage": 5.6, "node": "b"}
{"index":{}}
{"timestamp": 1516383694000, "temperature": 200, "voltage": 4.2, "node": "c"}
{"index":{}}
{"timestamp": 1516297294000, "temperature": 202, "voltage": 4.0, "node": "c"}</pre>
</div>
<div class="console_widget" data-snippet="snippets/136.console"></div>
<p>After talking to a few site engineers, you realize that the sensors should
be reporting at least <em>double</em> the current values, but potentially higher.
You create a runtime field named <code class="literal">voltage_corrected</code> that retrieves the current
voltage and multiplies it by <code class="literal">2</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mapping
{
  "runtime": {
    "voltage_corrected": {
      "type": "double",
      "script": {
        "source": """
        emit(doc['voltage'].value * params['multiplier'])
        """,
        "params": {
          "multiplier": 2
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/137.console"></div>
<p>You retrieve the calculated values using the <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a>
parameter on the <code class="literal">_search</code> API:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "fields": [
    "voltage_corrected",
    "node"
  ],
  "size": 2
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/138.console"></div>
<p>After reviewing the sensor data and running some tests, you determine that the
multiplier for reported sensor data should be <code class="literal">4</code>. To gain greater performance,
you decide to index the <code class="literal">voltage_corrected</code> runtime field with the new
<code class="literal">multiplier</code> parameter.</p>
<p>In a new index named <code class="literal">my-index-000001</code>, copy the <code class="literal">voltage_corrected</code> runtime
field definition into the mappings of the new index. It&#8217;s that simple! You can
add an optional parameter named <code class="literal">on_script_error</code> that determines whether to
reject the entire document if the script throws an error at index time
(default).</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/
{
  "mappings": {
    "properties": {
      "timestamp": {
        "type": "date"
      },
      "temperature": {
        "type": "long"
      },
      "voltage": {
        "type": "double"
      },
      "node": {
        "type": "keyword"
      },
      "voltage_corrected": {
        "type": "double",
        "on_script_error": "fail", <a id="CO43-1"></a><i class="conum" data-value="1"></i>
        "script": {
          "source": """
        emit(doc['voltage'].value * params['multiplier'])
        """,
          "params": {
            "multiplier": 4
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/139.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Causes the entire document to be rejected if the script throws an error at
index time. Setting the value to <code class="literal">ignore</code> will register the field in the
document’s <code class="literal">_ignored</code> metadata field and continue indexing.</p>
</td>
</tr>
</table>
</div>
<p>Bulk index some sample data from your sensors into the <code class="literal">my-index-000001</code> index:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST my-index-000001/_bulk?refresh=true
{ "index": {}}
{ "timestamp": 1516729294000, "temperature": 200, "voltage": 5.2, "node": "a"}
{ "index": {}}
{ "timestamp": 1516642894000, "temperature": 201, "voltage": 5.8, "node": "b"}
{ "index": {}}
{ "timestamp": 1516556494000, "temperature": 202, "voltage": 5.1, "node": "a"}
{ "index": {}}
{ "timestamp": 1516470094000, "temperature": 198, "voltage": 5.6, "node": "b"}
{ "index": {}}
{ "timestamp": 1516383694000, "temperature": 200, "voltage": 4.2, "node": "c"}
{ "index": {}}
{ "timestamp": 1516297294000, "temperature": 202, "voltage": 4.0, "node": "c"}</pre>
</div>
<div class="console_widget" data-snippet="snippets/140.console"></div>
<p>You can now retrieve calculated values in a search query, and find documents
based on precise values. The following range query returns all documents where
the calculated <code class="literal">voltage_corrected</code> is greater than or equal to <code class="literal">16</code>, but less
than or equal to <code class="literal">20</code>. Again, use the <a class="xref" href="search-fields.html" title="Retrieve selected fields from a search"><code class="literal">fields</code></a> parameter on
the <code class="literal">_search</code> API to retrieve the fields you want:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST my-index-000001/_search
{
  "query": {
    "range": {
      "voltage_corrected": {
        "gte": 16,
        "lte": 20,
        "boost": 1.0
      }
    }
  },
  "fields": ["voltage_corrected", "node"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/141.console"></div>
<p>The response includes the <code class="literal">voltage_corrected</code> field for the documents that
match the range query, based on the calculated value of the included script:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "yoSLrHgBdg9xpPrUZz_P",
        "_score" : 1.0,
        "_source" : {
          "timestamp" : 1516383694000,
          "temperature" : 200,
          "voltage" : 4.2,
          "node" : "c"
        },
        "fields" : {
          "voltage_corrected" : [
            16.8
          ],
          "node" : [
            "c"
          ]
        }
      },
      {
        "_index" : "my-index-000001",
        "_id" : "y4SLrHgBdg9xpPrUZz_P",
        "_score" : 1.0,
        "_source" : {
          "timestamp" : 1516297294000,
          "temperature" : 202,
          "voltage" : 4.0,
          "node" : "c"
        },
        "fields" : {
          "voltage_corrected" : [
            16.0
          ],
          "node" : [
            "c"
          ]
        }
      }
    ]
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="runtime-examples"></a>Explore your data with runtime fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h2>
</div></div></div>
<p>Consider a large set of log data that you want to extract fields from.
Indexing the data is time consuming and uses a lot of disk space, and you just
want to explore the data structure without committing to a schema up front.</p>
<p>You know that your log data contains specific fields that you want to extract.
In this case, we want to focus on the <code class="literal">@timestamp</code> and <code class="literal">message</code> fields. By
using runtime fields, you can define scripts to calculate values at search
time for these fields.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-examples-define-fields"></a>Define indexed fields as a starting point<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>You can start with a simple example by adding the <code class="literal">@timestamp</code> and <code class="literal">message</code>
fields to the <code class="literal">my-index-000001</code> mapping as indexed fields. To remain flexible, use
<code class="literal">wildcard</code> as the field type for <code class="literal">message</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-000001/
{
  "mappings": {
    "properties": {
      "@timestamp": {
        "format": "strict_date_optional_time||epoch_second",
        "type": "date"
      },
      "message": {
        "type": "wildcard"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/142.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-examples-ingest-data"></a>Ingest some data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>After mapping the fields you want to retrieve, index a few records from
your log data into Elasticsearch. The following request uses the <a class="xref" href="docs.html#docs-bulk" title="Bulk API">bulk API</a>
to index raw log data into <code class="literal">my-index-000001</code>. Instead of indexing all of your log
data, you can use a small sample to experiment with runtime fields.</p>
<p>The final document is not a valid Apache log format, but we can account for
that scenario in our script.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /my-index-000001/_bulk?refresh
{"index":{}}
{"timestamp":"2020-04-30T14:30:17-05:00","message":"40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{"index":{}}
{"timestamp":"2020-04-30T14:30:53-05:00","message":"232.0.0.0 - - [30/Apr/2020:14:30:53 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{"index":{}}
{"timestamp":"2020-04-30T14:31:12-05:00","message":"26.1.0.0 - - [30/Apr/2020:14:31:12 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{"index":{}}
{"timestamp":"2020-04-30T14:31:19-05:00","message":"247.37.0.0 - - [30/Apr/2020:14:31:19 -0500] \"GET /french/splash_inet.html HTTP/1.0\" 200 3781"}
{"index":{}}
{"timestamp":"2020-04-30T14:31:22-05:00","message":"247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"}
{"index":{}}
{"timestamp":"2020-04-30T14:31:27-05:00","message":"252.0.0.0 - - [30/Apr/2020:14:31:27 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
{"index":{}}
{"timestamp":"2020-04-30T14:31:28-05:00","message":"not a valid apache log"}</pre>
</div>
<div class="console_widget" data-snippet="snippets/143.console"></div>
<p>At this point, you can view how Elasticsearch stores your raw data.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-000001</pre>
</div>
<div class="console_widget" data-snippet="snippets/144.console"></div>
<p>The mapping contains two fields: <code class="literal">@timestamp</code> and <code class="literal">message</code>.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "my-index-000001" : {
    "aliases" : { },
    "mappings" : {
      "properties" : {
        "@timestamp" : {
          "type" : "date",
          "format" : "strict_date_optional_time||epoch_second"
        },
        "message" : {
          "type" : "wildcard"
        },
        "timestamp" : {
          "type" : "date"
        }
      }
    },
    ...
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-examples-grok"></a>Define a runtime field with a grok pattern<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>If you want to retrieve results that include <code class="literal">clientip</code>, you can add that
field as a runtime field in the mapping. The following runtime script defines a
<a class="xref" href="modules-scripting-using.html#grok" title="Grokking grok">grok pattern</a> that extracts structured fields out of a single text
field within a document. A grok pattern is like a regular expression that
supports aliased expressions that you can reuse.</p>
<p>The script matches on the <code class="literal">%{COMMONAPACHELOG}</code> log pattern, which understands
the structure of Apache logs. If the pattern matches (<code class="literal">clientip != null</code>),
the script emits the value of the matching IP address. If the pattern doesn&#8217;t
match, the script just returns the field value without crashing.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mappings
{
  "runtime": {
    "http.client_ip": {
      "type": "ip",
      "script": """
        String clientip=grok('%{COMMONAPACHELOG}').extract(doc["message"].value)?.clientip;
        if (clientip != null) emit(clientip); <a id="CO44-1"></a><i class="conum" data-value="1"></i>
      """
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/145.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This condition ensures that the script doesn&#8217;t crash even if the pattern of
the message doesn&#8217;t match.</p>
</td>
</tr>
</table>
</div>
<p>Alternatively, you can define the same runtime field but in the context of a
search request. The runtime definition and the script are exactly the same as
the one defined previously in the index mapping. Just copy that definition into
the search request under the <code class="literal">runtime_mappings</code> section and include a query
that matches on the runtime field. This query returns the same results as if
you defined a search query for the <code class="literal">http.clientip</code> runtime field in your index
mappings, but only in the context of this specific search:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "runtime_mappings": {
    "http.clientip": {
      "type": "ip",
      "script": """
        String clientip=grok('%{COMMONAPACHELOG}').extract(doc["message"].value)?.clientip;
        if (clientip != null) emit(clientip);
      """
    }
  },
  "query": {
    "match": {
      "http.clientip": "40.135.0.0"
    }
  },
  "fields" : ["http.clientip"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/146.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-examples-grok-composite"></a>Define a composite runtime field<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>You can also define a <em>composite</em> runtime field to emit multiple fields from a
single script. You can define a set of typed subfields and emit a map of
values. At search time, each subfield retrieves the value associated with
their name in the map. This means that you only need to specify your grok
pattern one time and can return multiple values:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mappings
{
  "runtime": {
    "http": {
      "type": "composite",
      "script": "emit(grok(\"%{COMMONAPACHELOG}\").extract(doc[\"message\"].value))",
      "fields": {
        "clientip": {
          "type": "ip"
        },
        "verb": {
          "type": "keyword"
        },
        "response": {
          "type": "long"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/147.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="runtime-examples-grok-ip"></a>Search for a specific IP address<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h4>
</div></div></div>
<p>Using the <code class="literal">http.clientip</code> runtime field, you can define a simple query to run a
search for a specific IP address and return all related fields.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "match": {
      "http.clientip": "40.135.0.0"
    }
  },
  "fields" : ["*"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/148.console"></div>
<p>The API returns the following result. Because <code class="literal">http</code> is a <code class="literal">composite</code> runtime
field, the response includes each of the sub-fields under <code class="literal">fields</code>, including
any associated values that match the query. Without building your data structure
in advance, you can search and explore your data in meaningful ways to
experiment and determine which fields to index.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "sRVHBnwBB-qjgFni7h_O",
        "_score" : 1.0,
        "_source" : {
          "timestamp" : "2020-04-30T14:30:17-05:00",
          "message" : "40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"
        },
        "fields" : {
          "http.verb" : [
            "GET"
          ],
          "http.clientip" : [
            "40.135.0.0"
          ],
          "http.response" : [
            200
          ],
          "message" : [
            "40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"
          ],
          "http.client_ip" : [
            "40.135.0.0"
          ],
          "timestamp" : [
            "2020-04-30T19:30:17.000Z"
          ]
        }
      }
    ]
  }
}</pre>
</div>
<p>Also, remember that <code class="literal">if</code> statement in the script?</p>
<div class="pre_wrapper lang-painless">
<pre class="programlisting prettyprint lang-painless">if (clientip != null) emit(clientip);</pre>
</div>
<p>If the script didn&#8217;t include this condition, the query would fail on any shard
that doesn&#8217;t match the pattern. By including this condition, the query skips
data that doesn&#8217;t match the grok pattern.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="runtime-examples-grok-range"></a>Search for documents in a specific range<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h4>
</div></div></div>
<p>You can also run a <a class="xref" href="term-level-queries.html#query-dsl-range-query" title="Range query">range query</a> that operates on the
<code class="literal">timestamp</code> field. The following query returns any documents where the
<code class="literal">timestamp</code> is greater than or equal to <code class="literal">2020-04-30T14:31:27-05:00</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "2020-04-30T14:31:27-05:00"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/149.console"></div>
<p>The response includes the document where the log format doesn&#8217;t match, but the
timestamp falls within the defined range.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "hdEhyncBRSB6iD-PoBqe",
        "_score" : 1.0,
        "_source" : {
          "timestamp" : "2020-04-30T14:31:27-05:00",
          "message" : "252.0.0.0 - - [30/Apr/2020:14:31:27 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"
        }
      },
      {
        "_index" : "my-index-000001",
        "_id" : "htEhyncBRSB6iD-PoBqe",
        "_score" : 1.0,
        "_source" : {
          "timestamp" : "2020-04-30T14:31:28-05:00",
          "message" : "not a valid apache log"
        }
      }
    ]
  }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="runtime-examples-dissect"></a>Define a runtime field with a dissect pattern<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/mapping/runtime.asciidoc">edit</a></h3>
</div></div></div>
<p>If you don&#8217;t need the power of regular expressions, you can use
<a class="xref" href="processors.html#dissect-processor" title="Dissect processor">dissect patterns</a> instead of grok patterns. Dissect
patterns match on fixed delimiters but are typically faster than grok.</p>
<p>You can use dissect to achieve the same results as parsing the Apache logs with
a <a class="xref" href="runtime.html#runtime-examples-grok" title="Define a runtime field with a grok pattern">grok pattern</a>. Instead of matching on a log
pattern, you include the parts of the string that you want to discard. Paying
special attention to the parts of the string you want to discard will help build
successful dissect patterns.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mappings
{
  "runtime": {
    "http.client.ip": {
      "type": "ip",
      "script": """
        String clientip=dissect('%{clientip} %{ident} %{auth} [%{@timestamp}] "%{verb} %{request} HTTP/%{httpversion}" %{status} %{size}').extract(doc["message"].value)?.clientip;
        if (clientip != null) emit(clientip);
      """
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/150.console"></div>
<p>Similarly, you can define a dissect pattern to extract the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status" class="ulink" target="_top">HTTP response code</a>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001/_mappings
{
  "runtime": {
    "http.responses": {
      "type": "long",
      "script": """
        String response=dissect('%{clientip} %{ident} %{auth} [%{@timestamp}] "%{verb} %{request} HTTP/%{httpversion}" %{response} %{size}').extract(doc["message"].value)?.response;
        if (response != null) emit(Integer.parseInt(response));
      """
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/151.console"></div>
<p>You can then run a query to retrieve a specific HTTP response using the
<code class="literal">http.responses</code> runtime field. Use the <code class="literal">fields</code> parameter of the <code class="literal">_search</code>
request to indicate which fields you want to retrieve:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "match": {
      "http.responses": "304"
    }
  },
  "fields" : ["http.client_ip","timestamp","http.verb"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/152.console"></div>
<p>The response includes a single document where the HTTP response is <code class="literal">304</code>:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  ...
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "my-index-000001",
        "_id" : "A2qDy3cBWRMvVAuI7F8M",
        "_score" : 1.0,
        "_source" : {
          "timestamp" : "2020-04-30T14:31:22-05:00",
          "message" : "247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"
        },
        "fields" : {
          "http.verb" : [
            "GET"
          ],
          "http.client_ip" : [
            "247.37.0.0"
          ],
          "timestamp" : [
            "2020-04-30T19:31:22.000Z"
          ]
        }
      }
    ]
  }
}</pre>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="explicit-mapping.html">« Explicit mapping</a>
</span>
<span class="next">
<a href="mapping-types.html">Field data types »</a>
</span>
</div>
</div>
</body>
</html>
