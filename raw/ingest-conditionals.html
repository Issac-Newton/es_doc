<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Conditional Execution in Pipelines | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Conditional Execution in Pipelines | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="ingest.html" title="Ingest node"/>
<link rel="prev" href="accessing-data-in-pipelines.html" title="Accessing Data in Pipelines"/>
<link rel="next" href="handling-failure-in-pipelines.html" title="Handling Failures in Pipelines"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="ingest.html">Ingest node</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="accessing-data-in-pipelines.html">« Accessing Data in Pipelines</a>
</span>
<span class="next">
<a href="handling-failure-in-pipelines.html">Handling Failures in Pipelines »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ingest-conditionals"></a>Conditional Execution in Pipelines<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/ingest/ingest-node.asciidoc">edit</a></h2>
</div></div></div>
<p>Each processor allows for an optional <code class="literal">if</code> condition to determine if that
processor should be executed or skipped. The value of the <code class="literal">if</code> is a
<a class="xref" href="modules-scripting-painless.html" title="Painless scripting language">Painless</a> script that needs to evaluate
to <code class="literal">true</code> or <code class="literal">false</code>.</p>
<p>For example the following processor will <a class="xref" href="ingest-processors.html#drop-processor" title="Drop processor">drop</a> the document
(i.e. not index it) if the input document has a field named <code class="literal">network_name</code>
and it is equal to <code class="literal">Guest</code>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/drop_guests_network
{
  "processors": [
    {
      "drop": {
        "if": "ctx.network_name == 'Guest'"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/582.console"></div>
<p>Using that pipeline for an index request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/1?pipeline=drop_guests_network
{
  "network_name" : "Guest"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/583.console"></div>
<p>Results in nothing indexed since the conditional evaluated to <code class="literal">true</code>.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "_index": "test",
  "_type": "_doc",
  "_id": "1",
  "_version": -3,
  "result": "noop",
  "_shards": {
    "total": 0,
    "successful": 0,
    "failed": 0
  }
}</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ingest-conditional-nullcheck"></a>Handling Nested Fields in Conditionals<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/ingest/ingest-node.asciidoc">edit</a></h2>
</div></div></div>
<p>Source documents often contain nested fields. Care should be taken
to avoid NullPointerExceptions if the parent object does not exist
in the document. For example <code class="literal">ctx.a.b.c</code> can throw an NullPointerExceptions
if the source document does not have top level <code class="literal">a</code> object, or a second
level <code class="literal">b</code> object.</p>
<p>To help protect against NullPointerExceptions, null safe operations should be used.
Fortunately, Painless makes <a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.10/painless-operators-reference.html#null-safe-operator" class="ulink" target="_top">null safe</a>
operations easy with the <code class="literal">?.</code> operator.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/drop_guests_network
{
  "processors": [
    {
      "drop": {
        "if": "ctx.network?.name == 'Guest'"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/584.console"></div>
<p>The following document will get <a class="xref" href="ingest-processors.html#drop-processor" title="Drop processor">dropped</a> correctly:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/1?pipeline=drop_guests_network
{
  "network": {
    "name": "Guest"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/585.console"></div>
<p>Thanks to the <code class="literal">?.</code> operator the following document will not throw an error.
If the pipeline used a <code class="literal">.</code> the following document would throw a NullPointerException
since the <code class="literal">network</code> object is not part of the source document.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/2?pipeline=drop_guests_network
{
  "foo" : "bar"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/586.console"></div>
<p>The source document can also use dot delimited fields to represent nested fields.</p>
<p>For example instead the source document defining the fields nested:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "network": {
    "name": "Guest"
  }
}</pre>
</div>
<p>The source document may have the nested fields flattened as such:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "network.name": "Guest"
}</pre>
</div>
<p>If this is the case, use the <a class="xref" href="ingest-processors.html#dot-expand-processor" title="Dot expander processor">Dot Expand Processor</a>
so that the nested fields may be used in a conditional.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/drop_guests_network
{
  "processors": [
    {
      "dot_expander": {
        "field": "network.name"
      }
    },
    {
      "drop": {
        "if": "ctx.network?.name == 'Guest'"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/587.console"></div>
<p>Now the following input document can be used with a conditional in the pipeline.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/3?pipeline=drop_guests_network
{
  "network.name": "Guest"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/588.console"></div>
<p>The <code class="literal">?.</code> operators works well for use in the <code class="literal">if</code> conditional
because the <a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.10/painless-operators-reference.html#null-safe-operator" class="ulink" target="_top">null safe operator</a>
returns null if the object is null and <code class="literal">==</code> is null safe (as well as many other
<a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.10/painless-operators.html" class="ulink" target="_top">painless operators</a>).</p>
<p>However, calling a method such as <code class="literal">.equalsIgnoreCase</code> is not null safe
and can result in a NullPointerException.</p>
<p>Some situations allow for the same functionality but done so in a null safe manner.
For example: <code class="literal">'Guest'.equalsIgnoreCase(ctx.network?.name)</code> is null safe because
<code class="literal">Guest</code> is always non null, but <code class="literal">ctx.network?.name.equalsIgnoreCase('Guest')</code> is not null safe
since <code class="literal">ctx.network?.name</code> can return null.</p>
<p>Some situations require an explicit null check. In the following example there
is not null safe alternative, so an explicit null check is needed.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "drop": {
    "if": "ctx.network?.name != null &amp;&amp; ctx.network.name.contains('Guest')"
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ingest-conditional-complex"></a>Complex Conditionals<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/ingest/ingest-node.asciidoc">edit</a></h2>
</div></div></div>
<p>The <code class="literal">if</code> condition can be more complex than a simple equality check.
The full power of the <a class="xref" href="modules-scripting-painless.html" title="Painless scripting language">Painless Scripting Language</a> is available and
running in the <a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.10/painless-ingest-processor-context.html" class="ulink" target="_top">ingest processor context</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The value of ctx is read-only in <code class="literal">if</code> conditions.</p>
</div>
</div>
<p>A more complex <code class="literal">if</code> condition that drops the document (i.e. not index it)
unless it has a multi-valued tag field with at least one value that contains the characters
<code class="literal">prod</code> (case insensitive).</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/not_prod_dropper
{
  "processors": [
    {
      "drop": {
        "if": "Collection tags = ctx.tags;if(tags != null){for (String tag : tags) {if (tag.toLowerCase().contains('prod')) { return false;}}} return true;"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/589.console"></div>
<p>The conditional needs to be all on one line since JSON does not
support new line characters. However, Kibana&#8217;s console supports
a triple quote syntax to help with writing and debugging
scripts like these.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/not_prod_dropper
{
  "processors": [
    {
      "drop": {
        "if": """
            Collection tags = ctx.tags;
            if(tags != null){
              for (String tag : tags) {
                  if (tag.toLowerCase().contains('prod')) {
                      return false;
                  }
              }
            }
            return true;
        """
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/590.console"></div>
<p>or it can be built with a stored script:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _scripts/not_prod
{
  "script": {
    "lang": "painless",
    "source": """
        Collection tags = ctx.tags;
        if(tags != null){
          for (String tag : tags) {
              if (tag.toLowerCase().contains('prod')) {
                  return false;
              }
          }
        }
        return true;
    """
  }
}
PUT _ingest/pipeline/not_prod_dropper
{
  "processors": [
    {
      "drop": {
        "if": { "id": "not_prod" }
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/591.console"></div>
<p>Either way, you can run it with:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/1?pipeline=not_prod_dropper
{
  "tags": ["application:myapp", "env:Stage"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/592.console"></div>
<p>The document is <a class="xref" href="ingest-processors.html#drop-processor" title="Drop processor">dropped</a> since <code class="literal">prod</code> (case insensitive)
is not found in the tags.</p>
<p>The following document is indexed (i.e. not dropped) since
<code class="literal">prod</code> (case insensitive) is found in the tags.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/2?pipeline=not_prod_dropper
{
  "tags": ["application:myapp", "env:Production"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/593.console"></div>
<p>The <a class="xref" href="ingest-apis.html#simulate-pipeline-api" title="Simulate pipeline API">Simulate pipeline</a> with verbose can be used to help build out
complex conditionals. If the conditional evaluates to false it will be
omitted from the verbose results of the simulation since the document will not change.</p>
<p>Care should be taken to avoid overly complex or expensive conditional checks
since the condition needs to be checked for each and every document.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="conditionals-with-multiple-pipelines"></a>Conditionals with the Pipeline Processor<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/ingest/ingest-node.asciidoc">edit</a></h2>
</div></div></div>
<p>The combination of the <code class="literal">if</code> conditional and the <a class="xref" href="ingest-processors.html#pipeline-processor" title="Pipeline processor">Pipeline</a> can result in a simple,
yet powerful means to process heterogeneous input. For example, you can define a single pipeline
that delegates to other pipelines based on some criteria.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/logs_pipeline
{
  "description": "A pipeline of pipelines for log files",
  "version": 1,
  "processors": [
    {
      "pipeline": {
        "if": "ctx.service?.name == 'apache_httpd'",
        "name": "httpd_pipeline"
      }
    },
    {
      "pipeline": {
        "if": "ctx.service?.name == 'syslog'",
        "name": "syslog_pipeline"
      }
    },
    {
      "fail": {
        "if": "ctx.service?.name != 'apache_httpd' &amp;&amp; ctx.service?.name != 'syslog'",
        "message": "This pipeline requires service.name to be either `syslog` or `apache_httpd`"
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/594.console"></div>
<p>The above example allows consumers to point to a single pipeline for all log based index requests.
Based on the conditional, the correct pipeline will be called to process that type of data.</p>
<p>This pattern works well with a <a class="xref" href="index-modules.html#dynamic-index-settings" title="Dynamic index settings">default pipeline</a> defined in an index mapping
template for all indexes that hold data that needs pre-index processing.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="conditionals-with-regex"></a>Conditionals with the Regular Expressions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/ingest/ingest-node.asciidoc">edit</a></h2>
</div></div></div>
<p>The <code class="literal">if</code> conditional is implemented as a Painless script. If the
<a class="xref" href="settings.html#script-painless-regex-enabled"><code class="literal">script.painless.regex.enabled</code></a> cluster
setting is enabled, you can use regular expressions in your <code class="literal">if</code> condition
scripts. For supported syntax, see <a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.10/painless-regexes.html" class="ulink" target="_top">Painless
regular expressions</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/check_url
{
  "processors": [
    {
      "set": {
        "if": "ctx.href?.url =~ /^http[^s]/",
        "field": "href.insecure",
        "value": true
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/595.console"></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST test/_doc/1?pipeline=check_url
{
  "href": {
    "url": "http://www.elastic.co/"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/596.console"></div>
<p>Results in:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "_index": "test",
  "_type": "_doc",
  "_id": "1",
  "_version": 1,
  "_seq_no": 60,
  "_primary_term": 1,
  "found": true,
  "_source": {
    "href": {
      "insecure": true,
      "url": "http://www.elastic.co/"
    }
  }
}</pre>
</div>
<p>Regular expressions can be expensive and should be avoided if viable
alternatives exist.</p>
<p>For example in this case <code class="literal">startsWith</code> can be used to get the same result
without using a regular expression:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/check_url
{
  "processors": [
    {
      "set": {
        "if": "ctx.href?.url != null &amp;&amp; ctx.href.url.startsWith('http://')",
        "field": "href.insecure",
        "value": true
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/597.console"></div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="accessing-data-in-pipelines.html">« Accessing Data in Pipelines</a>
</span>
<span class="next">
<a href="handling-failure-in-pipelines.html">Handling Failures in Pipelines »</a>
</span>
</div>
</div>
</body>
</html>
