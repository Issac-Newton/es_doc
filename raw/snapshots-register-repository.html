<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Register a snapshot repository | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Register a snapshot repository | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="snapshot-restore.html" title="Snapshot and restore"/>
<link rel="prev" href="snapshot-restore.html" title="Snapshot and restore"/>
<link rel="next" href="snapshots-take-snapshot.html" title="Create a snapshot"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="snapshot-restore.html">Snapshot and restore</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="snapshot-restore.html">« Snapshot and restore</a>
</span>
<span class="next">
<a href="snapshots-take-snapshot.html">Create a snapshot »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="snapshots-register-repository"></a>Register a snapshot repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h2>
</div></div></div>

<p>This guide shows you how to register a snapshot repository. A snapshot
repository is an off-cluster storage location for your snapshots. You must
register a repository before you can take or restore snapshots.</p>
<p>In this guide, you’ll learn how to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Register a snapshot repository
</li>
<li class="listitem">
Verify that a repository is functional
</li>
<li class="listitem">
Clean up a repository to remove unneeded files
</li>
</ul>
</div>
<h3><a id="snapshot-repo-prereqs"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>To use Kibana&#8217;s <span class="strong strong"><strong>Snapshot and Restore</strong></span> feature, you must have the following
permissions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="authorization.html#privileges-list-cluster" title="Cluster privileges">Cluster privileges</a>: <code class="literal">monitor</code>, <code class="literal">manage_slm</code>,
<code class="literal">cluster:admin/snapshot</code>, and <code class="literal">cluster:admin/repository</code>
</li>
<li class="listitem">
<a class="xref" href="authorization.html#privileges-list-indices" title="Indices privileges">Index privilege</a>: <code class="literal">all</code> on the <code class="literal">monitor</code> index
</li>
</ul>
</div>
</li>
<li class="listitem">
To register a snapshot repository, the cluster&#8217;s global metadata must be
writeable. Ensure there aren&#8217;t any <a class="xref" href="settings.html#cluster-read-only" title="Metadata">cluster blocks</a> that
prevent write access.
</li>
</ul>
</div>
<h3><a id="snapshot-repo-considerations"></a>Considerations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<p>When registering a snapshot repository, keep the following in mind:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Each snapshot repository is separate and independent. Elasticsearch doesn&#8217;t share
data between repositories.
</li>
<li class="listitem">
<p></p>
<p>Clusters should only register a particular snapshot repository bucket once.
If you register the same snapshot repository with multiple clusters, only one
cluster should have write access to the repository. On other clusters, register
the repository as read-only.</p>
<p>This prevents multiple clusters from writing to the repository at the same time
and corrupting the repository’s contents. It also prevents Elasticsearch from caching the
repository&#8217;s contents, which means that changes made by other clusters will
become visible straight away.</p>
</li>
<li class="listitem">
When upgrading Elasticsearch to a newer version you can continue to use the same
repository you were using before the upgrade. If the repository is accessed by
multiple clusters, they should all have the same version. Once a repository has
been modified by a particular version of Elasticsearch, it may not work correctly when
accessed by older versions. However, you will be able to recover from a failed
upgrade by restoring a snapshot taken before the upgrade into a cluster running
the pre-upgrade version, even if you have taken more snapshots during or after
the upgrade.
</li>
</ul>
</div>
<h3><a id="manage-snapshot-repos"></a>Manage snapshot repositories<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<p>You can register and manage snapshot repositories in two ways:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Kibana&#8217;s <span class="strong strong"><strong>Snapshot and Restore</strong></span> feature
</li>
<li class="listitem">
Elasticsearch&#8217;s <a class="xref" href="snapshot-restore-apis.html#snapshot-restore-repo-apis" title="Snapshot repository management APIs">snapshot repository management APIs</a>
</li>
</ul>
</div>
<p>To manage repositories in Kibana, go to the main menu and click <span class="strong strong"><strong>Stack
Management</strong></span> &gt; <span class="strong strong"><strong>Snapshot and Restore</strong></span> &gt; <span class="strong strong"><strong>Repositories</strong></span>. To register a
snapshot repository, click <span class="strong strong"><strong>Register repository</strong></span>.</p>
<p>You can also register a repository using the <a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api" title="Create or update snapshot repository API">Create
snapshot repository API</a>.</p>
<h3><a id="snapshot-repo-types"></a>Snapshot repository types<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<p>Supported snapshot repository types vary based on your deployment type:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#ess-repo-types" title="Elasticsearch Service repository types">Elasticsearch Service repository types</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#self-managed-repo-types" title="Self-managed repository types">Self-managed repository types</a>
</li>
</ul>
</div>
<h4><a id="ess-repo-types"></a>Elasticsearch Service repository types<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h4>
<p><a href="https://www.elastic.co/cloud/elasticsearch-service/signup?page=docs&amp;placement=docs-body" class="ulink" target="_top">Elasticsearch Service deployments</a> automatically register the
<a href="https://www.elastic.co/guide/en/cloud/current/ec-snapshot-restore.html" class="ulink" target="_top"><code class="literal">found-snapshots</code></a> repository. Elasticsearch Service uses this
repository and the <code class="literal">cloud-snapshot-policy</code> to take periodic snapshots of your
cluster. You can also use the <code class="literal">found-snapshots</code> repository for your own
<a class="xref" href="snapshots-take-snapshot.html#automate-snapshots-slm" title="Automate snapshots with SLM">SLM policies</a> or to store searchable snapshots.</p>
<p>The <code class="literal">found-snapshots</code> repository is specific to each deployment. However, you
can restore snapshots from another deployment&#8217;s <code class="literal">found-snapshots</code> repository if
the deployments are under the same account and in the same region. See the Cloud
<a href="https://www.elastic.co/guide/en/cloud/current/ec-snapshot-restore.html" class="ulink" target="_top">Snapshot and restore</a> documentation to learn more.</p>
<p>Elasticsearch Service deployments also support the following repository types:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.elastic.co/guide/en/cloud/current/ec-azure-snapshotting.html" class="ulink" target="_top">Azure</a>
</li>
<li class="listitem">
<a href="https://www.elastic.co/guide/en/cloud/current/ec-gcs-snapshotting.html" class="ulink" target="_top">Google Cloud Storage</a>
</li>
<li class="listitem">
<a href="https://www.elastic.co/guide/en/cloud/current/ec-aws-custom-repository.html" class="ulink" target="_top">AWS S3</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#snapshots-source-only-repository" title="Source-only repository">Source-only</a>
</li>
</ul>
</div>
<h4><a id="self-managed-repo-types"></a>Self-managed repository types<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h4>
<p>If you manage your own Elasticsearch cluster, you can use the following built-in
snapshot repository types:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#repository-azure" title="Azure repository">Azure</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#repository-gcs" title="Google Cloud Storage repository">Google Cloud Storage</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#repository-s3" title="S3 repository">AWS S3</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#snapshots-filesystem-repository" title="Shared file system repository">Shared file system</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#snapshots-read-only-repository" title="Read-only URL repository">Read-only URL</a>
</li>
<li class="listitem">
<a class="xref" href="snapshots-register-repository.html#snapshots-source-only-repository" title="Source-only repository">Source-only</a>
</li>
</ul>
</div>
<p><a id="snapshots-repository-plugins"></a>Other repository types are available through official plugins:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/8.9/repository-hdfs.html" class="ulink" target="_top">Hadoop Distributed File System (HDFS)</a>
</li>
</ul>
</div>
<p>You can also use alternative storage implementations with these repository
types, as long as the alternative implementation is fully compatible. For
instance, <a href="https://minio.io" class="ulink" target="_top">MinIO</a> provides an alternative implementation of the
AWS S3 API and you can use MinIO with the <a class="xref" href="snapshots-register-repository.html#repository-s3" title="S3 repository"><code class="literal">s3</code> repository
type</a>.</p>
<p>Note that some storage systems claim to be compatible with these repository
types without emulating their behaviour in full. Elasticsearch requires full
compatibility. In particular the alternative implementation must support the
same set of API endpoints, return the same errors in case of failures, and
offer equivalent consistency guarantees and performance even when accessed
concurrently by multiple nodes. Incompatible error codes, consistency or
performance may be particularly hard to track down since errors, consistency
failures, and performance issues are usually rare and hard to reproduce.</p>
<p>You can perform some basic checks of the suitability of your storage system
using the <a class="xref" href="snapshot-restore-apis.html#repo-analysis-api" title="Repository analysis API">Repository analysis</a> API. If this API does not complete
successfully, or indicates poor performance, then your storage system is not
fully compatible and is therefore unsuitable for use as a snapshot repository.
You will need to work with the supplier of your storage system to address any
incompatibilities you encounter.</p>
<h3><a id="snapshots-repository-verification"></a>Verify a repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<p>When you register a snapshot repository, Elasticsearch automatically verifies that the
repository is available and functional on all master and data nodes.</p>
<p>To disable this verification, set the <a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api" title="Create or update snapshot repository API">create snapshot
repository API</a>'s <code class="literal">verify</code> query parameter to <code class="literal">false</code>. You can&#8217;t disable
repository verification in Kibana.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_unverified_backup?verify=false
{
  "type": "fs",
  "settings": {
    "location": "my_unverified_backup_location"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1711.console"></div>
<p>If wanted, you can manually run the repository verification check. To verify a
repository in Kibana, go to the <span class="strong strong"><strong>Repositories</strong></span> list page and click the name of
a repository. Then click <span class="strong strong"><strong>Verify repository</strong></span>. You can also use the
<a class="xref" href="snapshot-restore-apis.html#verify-snapshot-repo-api" title="Verify snapshot repository API">verify snapshot repository API</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _snapshot/my_unverified_backup/_verify</pre>
</div>
<div class="console_widget" data-snippet="snippets/1712.console"></div>
<p>If successful, the request returns a list of nodes used to verify the
repository. If verification fails, the request returns an error.</p>
<p>You can test a repository more thoroughly using the
<a class="xref" href="snapshot-restore-apis.html#repo-analysis-api" title="Repository analysis API">repository analysis API</a>.</p>
<h3><a id="snapshots-repository-cleanup"></a>Clean up a repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<p>Repositories can over time accumulate data that is not referenced by any existing snapshot. This is a result of the data safety guarantees
the snapshot functionality provides in failure scenarios during snapshot creation and the decentralized nature of the snapshot creation
process. This unreferenced data does in no way negatively impact the performance or safety of a snapshot repository but leads to higher
than necessary storage use. To remove this unreferenced data, you can run a cleanup operation on the repository. This will
trigger a complete accounting of the repository&#8217;s contents and delete any unreferenced data.</p>
<p>To run the repository cleanup operation in Kibana, go to the <span class="strong strong"><strong>Repositories</strong></span>
list page and click the name of a repository. Then click <span class="strong strong"><strong>Clean up
repository</strong></span>.</p>
<p>You can also use the <a class="xref" href="snapshot-restore-apis.html#clean-up-snapshot-repo-api" title="Clean up snapshot repository API">clean up snapshot repository
API</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _snapshot/my_repository/_cleanup</pre>
</div>
<div class="console_widget" data-snippet="snippets/1713.console"></div>
<p>The API returns:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "results": {
    "deleted_bytes": 20,
    "deleted_blobs": 5
  }
}</pre>
</div>
<p>Depending on the concrete repository implementation the numbers shown for bytes free as well as the number of blobs removed will either
be an approximation or an exact result. Any non-zero value for the number of blobs removed implies that unreferenced blobs were found and
subsequently cleaned up.</p>
<p>Please note that most of the cleanup operations executed by this endpoint are automatically executed when deleting any snapshot from a
repository. If you regularly delete snapshots, you will in most cases not get any or only minor space savings from using this functionality
and should lower your frequency of invoking it accordingly.</p>
<h3><a id="snapshots-repository-backup"></a>Back up a repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/register-repository.asciidoc">edit</a></h3>
<p>You may wish to make an independent backup of your repository, for instance so
that you have an archive copy of its contents that you can use to recreate the
repository in its current state at a later date.</p>
<p>You must ensure that Elasticsearch does not write to the repository while you are taking
the backup of its contents. You can do this by unregistering it, or registering
it with <code class="literal">readonly: true</code>, on all your clusters. If Elasticsearch writes any data to the
repository during the backup then the contents of the backup may not be
consistent and it may not be possible to recover any data from it in future.</p>
<p>Alternatively, if your repository supports it, you may take an atomic snapshot
of the underlying filesystem and then take a backup of this filesystem
snapshot. It is very important that the filesystem snapshot is taken
atomically.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use filesystem snapshots of individual nodes as a backup
mechanism. You must use the Elasticsearch snapshot and restore feature to copy the
cluster contents to a separate repository. Then, if desired, you can take a
filesystem snapshot of this repository.</p>
</div>
</div>
<p>When restoring a repository from a backup, you must not register the repository
with Elasticsearch until the repository contents are fully restored. If you alter the
contents of a repository while it is registered with Elasticsearch then the repository
may become unreadable or may silently lose some of its contents.</p>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="repository-azure"></a>Azure repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction" class="ulink" target="_top">Azure Blob storage</a> as a repository for <a class="xref" href="snapshot-restore.html" title="Snapshot and restore">Snapshot/Restore</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-usage"></a>Setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>To enable Azure repositories, you have first to define your azure storage settings as
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">secure settings</a>, before starting up the node:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add azure.client.default.account
bin/elasticsearch-keystore add azure.client.default.key</pre>
</div>
<p>Note that you can also define more than one account:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add azure.client.default.account
bin/elasticsearch-keystore add azure.client.default.key
bin/elasticsearch-keystore add azure.client.secondary.account
bin/elasticsearch-keystore add azure.client.secondary.sas_token</pre>
</div>
<p>For more information about these settings, see
<a class="xref" href="snapshots-register-repository.html#repository-azure-client-settings" title="Client settings">Client settings</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Supported Azure Storage Account types</h3>
<p>The Azure repository type works with all Standard storage accounts</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Standard Locally Redundant Storage - <code class="literal">Standard_LRS</code>
</li>
<li class="listitem">
Standard Zone-Redundant Storage - <code class="literal">Standard_ZRS</code>
</li>
<li class="listitem">
Standard Geo-Redundant Storage - <code class="literal">Standard_GRS</code>
</li>
<li class="listitem">
Standard Read Access Geo-Redundant Storage - <code class="literal">Standard_RAGRS</code>
</li>
</ul>
</div>
<p><a href="https://azure.microsoft.com/en-gb/documentation/articles/storage-premium-storage" class="ulink" target="_top">Premium Locally Redundant Storage</a> (<code class="literal">Premium_LRS</code>) is <span class="strong strong"><strong>not supported</strong></span> as it is only usable as VM disk storage, not as general storage.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-client-settings"></a>Client settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>The client that you use to connect to Azure has a number of settings available.
The settings have the form <code class="literal">azure.client.CLIENT_NAME.SETTING_NAME</code>. By default,
<code class="literal">azure</code> repositories use a client named <code class="literal">default</code>, but this can be modified using
the <a class="xref" href="snapshots-register-repository.html#repository-azure-repository-settings" title="Repository settings">repository setting</a> <code class="literal">client</code>.
For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_backup
{
  "type": "azure",
  "settings": {
    "client": "secondary"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1714.console"></div>
<p>Most client settings can be added to the <code class="literal">elasticsearch.yml</code> configuration file.
For example:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">azure.client.default.timeout: 10s
azure.client.default.max_retries: 7
azure.client.default.endpoint_suffix: core.chinacloudapi.cn
azure.client.secondary.timeout: 30s</pre>
</div>
<p>In this example, the client side timeout is <code class="literal">10s</code> per try for the <code class="literal">default</code>
account with <code class="literal">7</code> retries before failing. The endpoint suffix is
<code class="literal">core.chinacloudapi.cn</code> and <code class="literal">30s</code> per try for the <code class="literal">secondary</code> account with <code class="literal">3</code>
retries.</p>
<p>The <code class="literal">account</code>, <code class="literal">key</code>, and <code class="literal">sas_token</code> storage settings are reloadable secure
settings, which you add to the Elasticsearch keystore. For more information about
creating and updating the Elasticsearch keystore, see
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure settings</a>. After you reload the settings, the
internal Azure clients, which are used to transfer the snapshot, utilize the
latest settings from the keystore.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In progress snapshot or restore jobs will not be preempted by a <span class="strong strong"><strong>reload</strong></span>
of the storage secure settings. They will complete using the client as it was
built when the operation started.</p>
</div>
</div>
<p>The following list contains the available client settings. Those that must be
stored in the keystore are marked as "secure"; the other settings belong in the
<code class="literal">elasticsearch.yml</code> file.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">account</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The Azure account name, which is used by the repository&#8217;s internal Azure client.
</dd>
<dt>
<span class="term">
<code class="literal">endpoint_suffix</code>
</span>
</dt>
<dd>
The Azure endpoint suffix to connect to. The default value is
<code class="literal">core.windows.net</code>.
</dd>
<dt>
<span class="term">
<code class="literal">key</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The Azure secret key, which is used by the repository&#8217;s internal Azure client. Alternatively, use <code class="literal">sas_token</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_retries</code>
</span>
</dt>
<dd>
The number of retries to use when an Azure request fails. This setting helps
control the exponential backoff policy. It specifies the number of retries
that must occur before the snapshot fails. The default value is <code class="literal">3</code>. The
initial backoff period is defined by Azure SDK as <code class="literal">30s</code>. Thus there is <code class="literal">30s</code>
of wait time before retrying after a first timeout or failure. The maximum
backoff period is defined by Azure SDK as <code class="literal">90s</code>.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.host</code>
</span>
</dt>
<dd>
The host name of a proxy to connect to Azure through. For example: <code class="literal">azure.client.default.proxy.host: proxy.host</code>.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.port</code>
</span>
</dt>
<dd>
The port of a proxy to connect to Azure through. For example, <code class="literal">azure.client.default.proxy.port: 8888</code>.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.type</code>
</span>
</dt>
<dd>
Register a proxy type for the client. Supported values are <code class="literal">direct</code>, <code class="literal">http</code>,
and <code class="literal">socks</code>. For example: <code class="literal">azure.client.default.proxy.type: http</code>. When
<code class="literal">proxy.type</code> is set to <code class="literal">http</code> or <code class="literal">socks</code>, <code class="literal">proxy.host</code> and <code class="literal">proxy.port</code> must
also be provided. The default value is <code class="literal">direct</code>.
</dd>
<dt>
<span class="term">
<code class="literal">sas_token</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
A shared access signatures (SAS) token, which the repository&#8217;s internal Azure
client uses for authentication. The SAS token must have read (r), write (w),
list (l), and delete (d) permissions for the repository base path and all its
contents. These permissions must be granted for the blob service (b) and apply
to resource types service (s), container (c), and object (o). Alternatively,
use <code class="literal">key</code>.
</dd>
<dt>
<span class="term">
<code class="literal">timeout</code>
</span>
</dt>
<dd>
The client side timeout for any single request to Azure. The value should
specify the time unit. For example, a value of <code class="literal">5s</code> specifies a 5 second
timeout. There is no default value, which means that Elasticsearch uses the
<a href="https://azure.github.io/azure-storage-java/com/microsoft/azure/storage/RequestOptions.html#setTimeoutIntervalInMs(java.lang.Integer)" class="ulink" target="_top">default value</a>
set by the Azure client (known as 5 minutes). This setting can be defined
globally, per account, or both.
</dd>
<dt>
<span class="term">
<code class="literal">endpoint</code>
</span>
</dt>
<dd>
The Azure endpoint to connect to. It must include the protocol used to connect to Azure.
</dd>
<dt>
<span class="term">
<code class="literal">secondary_endpoint</code>
</span>
</dt>
<dd>
The Azure secondary endpoint to connect to. It must include the protocol used to connect to Azure.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-repository-settings"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>The Azure repository supports following settings:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">client</code>
</span>
</dt>
<dd>
Azure named client to use. Defaults to <code class="literal">default</code>.
</dd>
<dt>
<span class="term">
<code class="literal">container</code>
</span>
</dt>
<dd>
Container name. You must create the azure container before creating the repository.
Defaults to <code class="literal">elasticsearch-snapshots</code>.
</dd>
<dt>
<span class="term">
<code class="literal">base_path</code>
</span>
</dt>
<dd>
<p>
Specifies the path within container to repository data. Defaults to empty
(root directory).
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t set <code class="literal">base_path</code> when configuring a snapshot repository for Elastic Cloud Enterprise.
Elastic Cloud Enterprise automatically generates the <code class="literal">base_path</code> for each deployment so that
multiple deployments may share the same bucket.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
Big files can be broken down into multiple smaller blobs in the blob store during snapshotting.
It is not recommended to change this value from its default unless there is an explicit reason for limiting the
size of blobs in the repository. Setting a value lower than the default can result in an increased number of API
calls to the Azure blob store during snapshot create as well as restore operations compared to using the default
value and thus make both operations slower as well as more costly.
Specify the chunk size as a value and unit, for example:
<code class="literal">10MB</code>, <code class="literal">5KB</code>, <code class="literal">500B</code>. Defaults to the maximum size of a blob in the Azure blob store which is <code class="literal">5TB</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> metadata files are stored in compressed format. This
setting doesn&#8217;t affect index files that are already compressed by default.
Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="settings.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">location_mode</code>
</span>
</dt>
<dd>
<code class="literal">primary_only</code> or <code class="literal">secondary_only</code>. Defaults to <code class="literal">primary_only</code>. Note that if you set it
to <code class="literal">secondary_only</code>, it will force <code class="literal">readonly</code> to true.
</dd>
</dl>
</div>
<p>Some examples, using scripts:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console"># The simplest one
PUT _snapshot/my_backup1
{
  "type": "azure"
}

# With some settings
PUT _snapshot/my_backup2
{
  "type": "azure",
  "settings": {
    "container": "backup-container",
    "base_path": "backups",
    "chunk_size": "32MB",
    "compress": true
  }
}


# With two accounts defined in elasticsearch.yml (my_account1 and my_account2)
PUT _snapshot/my_backup3
{
  "type": "azure",
  "settings": {
    "client": "secondary"
  }
}
PUT _snapshot/my_backup4
{
  "type": "azure",
  "settings": {
    "client": "secondary",
    "location_mode": "primary_only"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1715.console"></div>
<p>Example using Java:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">client.admin().cluster().preparePutRepository("my_backup_java1")
    .setType("azure").setSettings(Settings.builder()
        .put(Storage.CONTAINER, "backup-container")
        .put(Storage.CHUNK_SIZE, new ByteSizeValue(32, ByteSizeUnit.MB))
    ).get();</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-azure-validation"></a>Repository validation rules<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-azure.asciidoc">edit</a></h3>
</div></div></div>
<p>According to the
<a href="https://docs.microsoft.com/en-us/rest/api/storageservices/Naming-and-Referencing-Containers&#8212;&#8203;Blobs&#8212;&#8203;and-Metadata" class="ulink" target="_top">containers
naming guide</a>, a container name must be a valid DNS name, conforming to the
following naming rules:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Container names must start with a letter or number, and can contain only letters, numbers, and the dash (-) character.
</li>
<li class="listitem">
Every dash (-) character must be immediately preceded and followed by a letter or number; consecutive dashes are not
permitted in container names.
</li>
<li class="listitem">
All letters in a container name must be lowercase.
</li>
<li class="listitem">
Container names must be from 3 through 63 characters long.
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="repository-gcs"></a>Google Cloud Storage repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use the <a href="https://cloud.google.com/storage/" class="ulink" target="_top">Google Cloud Storage</a>
service as a repository for <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/snapshot-restore.html" class="ulink" target="_top">Snapshot/Restore</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-usage"></a>Getting started<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>This repository type uses the <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/tree/master/google-cloud-clients/google-cloud-storage" class="ulink" target="_top">Google Cloud Java Client for Storage</a>
to connect to the Storage service. If you are using
<a href="https://cloud.google.com/storage/" class="ulink" target="_top">Google Cloud Storage</a> for the first time, you
must connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>
and create a new project. After your project is created, you must enable the
Cloud Storage Service for your project.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-creating-bucket"></a>Creating a bucket<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>The Google Cloud Storage service uses the concept of a
<a href="https://cloud.google.com/storage/docs/key-terms" class="ulink" target="_top">bucket</a> as a container for all
the data. Buckets are usually created using the
<a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>. This
repository type does not automatically create buckets.</p>
<p>To create a new bucket:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>.
</li>
<li class="listitem">
Select your project.
</li>
<li class="listitem">
Go to the <a href="https://console.cloud.google.com/storage/browser" class="ulink" target="_top">Storage Browser</a>.
</li>
<li class="listitem">
Click the <span class="strong strong"><strong>Create Bucket</strong></span> button.
</li>
<li class="listitem">
Enter the name of the new bucket.
</li>
<li class="listitem">
Select a storage class.
</li>
<li class="listitem">
Select a location.
</li>
<li class="listitem">
Click the <span class="strong strong"><strong>Create</strong></span> button.
</li>
</ol>
</div>
<p>For more detailed instructions, see the
<a href="https://cloud.google.com/storage/docs/quickstart-console#create_a_bucket" class="ulink" target="_top">Google Cloud documentation</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-service-authentication"></a>Service authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>The repository must authenticate the requests it makes to the Google Cloud Storage
service. It is common for Google client libraries to employ a strategy named <a href="https://cloud.google.com/docs/authentication/production#providing_credentials_to_your_application" class="ulink" target="_top">application default credentials</a>.
However, that strategy is only <span class="strong strong"><strong>partially supported</strong></span> by Elasticsearch. The
repository operates under the Elasticsearch process, which runs with the security
manager enabled. The security manager obstructs the "automatic" credential discovery
when the environment variable <code class="literal">GOOGLE_APPLICATION_CREDENTIALS</code> is used to point to a
local file on disk. It can, however, retrieve the service account that is attached to
the resource that is running Elasticsearch, or fall back to the default service
account that Compute Engine, Kubernetes Engine or App Engine provide.
Alternatively, you must configure <a class="xref" href="snapshots-register-repository.html#repository-gcs-using-service-account" title="Using a service account">service account</a>
credentials if you are using an environment that does not support automatic
credential discovery.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-using-service-account"></a>Using a service account<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>You have to obtain and provide <a href="https://cloud.google.com/iam/docs/overview#service_account" class="ulink" target="_top">service account credentials</a>
manually.</p>
<p>For detailed information about generating JSON service account files, see the <a href="https://cloud.google.com/storage/docs/authentication?hl=en#service_accounts" class="ulink" target="_top">Google Cloud documentation</a>.
Note that the PKCS12 format is not supported by this repository type.</p>
<p>Here is a summary of the steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>.
</li>
<li class="listitem">
Select your project.
</li>
<li class="listitem">
Select the <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" class="ulink" target="_top">Service Accounts</a> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Create service account</strong></span>.
</li>
<li class="listitem">
After the account is created, select it and go to <span class="strong strong"><strong>Keys</strong></span>.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Add Key</strong></span> and then <span class="strong strong"><strong>Create new key</strong></span>.
</li>
<li class="listitem">
Select Key Type <span class="strong strong"><strong>JSON</strong></span> as P12 is unsupported.
</li>
</ol>
</div>
<p>A JSON service account file looks like this:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "service-account-for-your-repository@your-project-id.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://accounts.google.com/o/oauth2/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/your-bucket@your-project-id.iam.gserviceaccount.com"
}</pre>
</div>
<p>To provide this file to the repository, it must be stored in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Elasticsearch keystore</a>. You must
add a <code class="literal">file</code> setting with the name <code class="literal">gcs.client.NAME.credentials_file</code> using the <code class="literal">add-file</code> subcommand.
 <code class="literal">NAME</code> is the name of the client configuration for the repository. The implicit client
name is <code class="literal">default</code>, but a different client name can be specified in the
repository settings with the <code class="literal">client</code> key.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Passing the file path via the GOOGLE_APPLICATION_CREDENTIALS environment
variable is <span class="strong strong"><strong>not</strong></span> supported.</p>
</div>
</div>
<p>For example, if you added a <code class="literal">gcs.client.my_alternate_client.credentials_file</code>
setting in the keystore, you can configure a repository to use those credentials
like this:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_gcs_repository
{
  "type": "gcs",
  "settings": {
    "bucket": "my_bucket",
    "client": "my_alternate_client"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1716.console"></div>
<p>The <code class="literal">credentials_file</code> settings are <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>.
After you reload the settings, the internal <code class="literal">gcs</code> clients, which are used to
transfer the snapshot contents, utilize the latest settings from the keystore.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Snapshot or restore jobs that are in progress are not preempted by a <span class="strong strong"><strong>reload</strong></span>
of the client&#8217;s <code class="literal">credentials_file</code> settings. They complete using the client as
it was built when the operation started.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-client"></a>Client settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>The client used to connect to Google Cloud Storage has a number of settings available.
Client setting names are of the form <code class="literal">gcs.client.CLIENT_NAME.SETTING_NAME</code> and are specified
inside <code class="literal">elasticsearch.yml</code>. The default client name looked up by a <code class="literal">gcs</code> repository is
called <code class="literal">default</code>, but can be customized with the repository setting <code class="literal">client</code>.</p>
<p>For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_gcs_repository
{
  "type": "gcs",
  "settings": {
    "bucket": "my_bucket",
    "client": "my_alternate_client"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1717.console"></div>
<p>Some settings are sensitive and must be stored in the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Elasticsearch keystore</a>. This is the case for the service account file:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add-file gcs.client.default.credentials_file /path/service-account.json</pre>
</div>
<p>The following are the available client settings. Those that must be stored in the keystore
are marked as <code class="literal">Secure</code>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">credentials_file</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The service account file that is used to authenticate to the Google Cloud Storage service.
</dd>
<dt>
<span class="term">
<code class="literal">endpoint</code>
</span>
</dt>
<dd>
The Google Cloud Storage service endpoint to connect to. This will be automatically
determined by the Google Cloud Storage client but can be specified explicitly.
</dd>
<dt>
<span class="term">
<code class="literal">connect_timeout</code>
</span>
</dt>
<dd>
The timeout to establish a connection to the Google Cloud Storage service. The value should
specify the unit. For example, a value of <code class="literal">5s</code> specifies a 5 second timeout. The value of <code class="literal">-1</code>
corresponds to an infinite timeout. The default value is 20 seconds.
</dd>
<dt>
<span class="term">
<code class="literal">read_timeout</code>
</span>
</dt>
<dd>
The timeout to read data from an established connection. The value should
specify the unit. For example, a value of <code class="literal">5s</code> specifies a 5 second timeout. The value of <code class="literal">-1</code>
corresponds to an infinite timeout. The default value is 20 seconds.
</dd>
<dt>
<span class="term">
<code class="literal">application_name</code>
</span>
</dt>
<dd>
Name used by the client when it uses the Google Cloud Storage service. Setting
a custom name can be useful to authenticate your cluster when requests
statistics are logged in the Google Cloud Platform. Default to <code class="literal">repository-gcs</code>
</dd>
<dt>
<span class="term">
<code class="literal">project_id</code>
</span>
</dt>
<dd>
The Google Cloud project id. This will be automatically inferred from the credentials file but
can be specified explicitly. For example, it can be used to switch between projects when the
same credentials are usable for both the production and the development projects.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.host</code>
</span>
</dt>
<dd>
Host name of a proxy to connect to the Google Cloud Storage through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.port</code>
</span>
</dt>
<dd>
Port of a proxy to connect to the Google Cloud Storage through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.type</code>
</span>
</dt>
<dd>
Proxy type for the client. Supported values are <code class="literal">direct</code> (no proxy),
<code class="literal">http</code>, and <code class="literal">socks</code>. Defaults to <code class="literal">direct</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-gcs-repository"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">gcs</code> repository type supports a number of settings to customize how data
is stored in Google Cloud Storage.</p>
<p>These can be specified when creating the repository. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_gcs_repository
{
  "type": "gcs",
  "settings": {
    "bucket": "my_other_bucket",
    "base_path": "dev"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1718.console"></div>
<p>The following settings are supported:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">bucket</code>
</span>
</dt>
<dd>
The name of the bucket to be used for snapshots. (Mandatory)
</dd>
<dt>
<span class="term">
<code class="literal">client</code>
</span>
</dt>
<dd>
The name of the client to use to connect to Google Cloud Storage.
Defaults to <code class="literal">default</code>.
</dd>
<dt>
<span class="term">
<code class="literal">base_path</code>
</span>
</dt>
<dd>
<p>
Specifies the path within bucket to repository data. Defaults to
the root of the bucket.
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t set <code class="literal">base_path</code> when configuring a snapshot repository for Elastic Cloud Enterprise.
Elastic Cloud Enterprise automatically generates the <code class="literal">base_path</code> for each deployment so that
multiple deployments may share the same bucket.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
Big files can be broken down into multiple smaller blobs in the blob store during snapshotting.
It is not recommended to change this value from its default unless there is an explicit reason for limiting the
size of blobs in the repository. Setting a value lower than the default can result in an increased number of API
calls to the Google Cloud Storage Service during snapshot create as well as restore operations compared to using
the default value and thus make both operations slower as well as more costly.
Specify the chunk size as a value and unit, for example:
<code class="literal">10MB</code>, <code class="literal">5KB</code>, <code class="literal">500B</code>. Defaults to the maximum size of a blob in the Google Cloud Storage Service which is <code class="literal">5TB</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> metadata files are stored in compressed format. This
setting doesn&#8217;t affect index files that are already compressed by default.
Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="settings.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">application_name</code>
</span>
</dt>
<dd>
<span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono u-strikethrough">6.3.0</span>]
<span class="Admonishment-detail">
Deprecated in 6.3.0. This setting is now defined in the <a class="xref" href="snapshots-register-repository.html#repository-gcs-client" title="Client settings">client settings</a>.
</span>
</span>
Name used by the client when it uses the Google Cloud Storage service.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-gcs-bucket-permission"></a>Recommended bucket permission<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-gcs.asciidoc">edit</a></h4>
</div></div></div>
<p>The service account used to access the bucket must have the "Writer" access to the bucket:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Connect to the <a href="https://console.cloud.google.com/" class="ulink" target="_top">Google Cloud Platform Console</a>.
</li>
<li class="listitem">
Select your project.
</li>
<li class="listitem">
Go to the <a href="https://console.cloud.google.com/storage/browser" class="ulink" target="_top">Storage Browser</a>.
</li>
<li class="listitem">
Select the bucket and "Edit bucket permission".
</li>
<li class="listitem">
The service account must be configured as a "User" with "Writer" access.
</li>
</ol>
</div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="repository-s3"></a>S3 repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use AWS S3 as a repository for <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/snapshot-restore.html" class="ulink" target="_top">Snapshot/Restore</a>.</p>
<p><span class="strong strong"><strong>If you are looking for a hosted solution of Elasticsearch on AWS, please visit
<a href="https://www.elastic.co/cloud/" class="ulink" target="_top">https://www.elastic.co/cloud/</a>.</strong></span></p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-s3-usage"></a>Getting started<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h3>
</div></div></div>
<p>To register an S3 repository, specify the type as <code class="literal">s3</code> when creating
the repository. The repository defaults to using
<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html" class="ulink" target="_top">ECS
IAM Role</a> credentials for authentication. You can also use <a class="xref" href="snapshots-register-repository.html#iam-kubernetes-service-accounts" title="Using IAM roles for Kubernetes service accounts for authentication">Using IAM roles for Kubernetes service accounts for authentication</a> Kubernetes service accounts.</p>
<p>The only mandatory setting is the bucket name:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "bucket": "my-bucket"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1719.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-s3-client"></a>Client settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h3>
</div></div></div>
<p>The client that you use to connect to S3 has a number of settings available.
The settings have the form <code class="literal">s3.client.CLIENT_NAME.SETTING_NAME</code>. By default,
<code class="literal">s3</code> repositories use a client named <code class="literal">default</code>, but this can be modified using
the <a class="xref" href="snapshots-register-repository.html#repository-s3-repository" title="Repository settings">repository setting</a> <code class="literal">client</code>. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "bucket": "my-bucket",
    "client": "my-alternate-client"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1720.console"></div>
<p>Most client settings can be added to the <code class="literal">elasticsearch.yml</code> configuration file
with the exception of the secure settings, which you add to the Elasticsearch keystore.
For more information about creating and updating the Elasticsearch keystore, see
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure settings</a>.</p>
<p>For example, if you want to use specific credentials to access S3 then run the
following commands to add these credentials to the keystore:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add s3.client.default.access_key
bin/elasticsearch-keystore add s3.client.default.secret_key
# a session token is optional so the following command may not be needed
bin/elasticsearch-keystore add s3.client.default.session_token</pre>
</div>
<p>If instead you want to use the instance role or container role to access S3
then you should leave these settings unset. You can switch from using specific
credentials back to the default of using the instance role or container role by
removing these settings from the keystore as follows:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore remove s3.client.default.access_key
bin/elasticsearch-keystore remove s3.client.default.secret_key
# a session token is optional so the following command may not be needed
bin/elasticsearch-keystore remove s3.client.default.session_token</pre>
</div>
<p><span class="strong strong"><strong>All</strong></span> client secure settings of this repository type are
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>. After you
reload the settings, the internal <code class="literal">s3</code> clients, used to transfer the snapshot
contents, will utilize the latest settings from the keystore. Any existing <code class="literal">s3</code>
repositories, as well as any newly created ones, will pick up the new values
stored in the keystore.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In-progress snapshot/restore tasks will not be preempted by a <span class="strong strong"><strong>reload</strong></span> of
the client&#8217;s secure settings. The task will complete using the client as it was
built when the operation started.</p>
</div>
</div>
<p>The following list contains the available client settings. Those that must be
stored in the keystore are marked as "secure" and are <span class="strong strong"><strong>reloadable</strong></span>; the other
settings belong in the <code class="literal">elasticsearch.yml</code> file.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">access_key</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
An S3 access key. If set, the <code class="literal">secret_key</code> setting must also be specified.
If unset, the client will use the instance or container role instead.
</dd>
<dt>
<span class="term">
<code class="literal">secret_key</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
An S3 secret key. If set, the <code class="literal">access_key</code> setting must also be specified.
</dd>
<dt>
<span class="term">
<code class="literal">session_token</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
An S3 session token. If set, the <code class="literal">access_key</code> and <code class="literal">secret_key</code> settings
must also be specified.
</dd>
<dt>
<span class="term">
<code class="literal">endpoint</code>
</span>
</dt>
<dd>
The S3 service endpoint to connect to. This defaults to <code class="literal">s3.amazonaws.com</code>
but the
<a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region" class="ulink" target="_top">AWS
documentation</a> lists alternative S3 endpoints. If you are using an
<a class="xref" href="snapshots-register-repository.html#repository-s3-compatible-services" title="S3-compatible services">S3-compatible service</a> then you should
set this to the service&#8217;s endpoint.
</dd>
<dt>
<span class="term">
<code class="literal">protocol</code>
</span>
</dt>
<dd>
The protocol to use to connect to S3. Valid values are either <code class="literal">http</code> or
<code class="literal">https</code>. Defaults to <code class="literal">https</code>. When using HTTPS, this repository type validates the
repository&#8217;s certificate chain using the JVM-wide truststore. Ensure that
the root certificate authority is in this truststore using the JVM&#8217;s
<code class="literal">keytool</code> tool.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.host</code>
</span>
</dt>
<dd>
The host name of a proxy to connect to S3 through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.port</code>
</span>
</dt>
<dd>
The port of a proxy to connect to S3 through.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.username</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The username to connect to the <code class="literal">proxy.host</code> with.
</dd>
<dt>
<span class="term">
<code class="literal">proxy.password</code> (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html" class="ulink" target="_top">Secure</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/secure-settings.html#reloadable-secure-settings" class="ulink" target="_top">reloadable</a>)
</span>
</dt>
<dd>
The password to connect to the <code class="literal">proxy.host</code> with.
</dd>
<dt>
<span class="term">
<code class="literal">read_timeout</code>
</span>
</dt>
<dd>
(<a class="xref" href="api-conventions.html#time-units" title="Time units">time value</a>) The maximum time Elasticsearch will wait to receive the next byte
of data over an established, open connection to the repository before it closes the
connection. The default value is 50 seconds.
</dd>
<dt>
<span class="term">
<code class="literal">max_retries</code>
</span>
</dt>
<dd>
The number of retries to use when an S3 request fails. The default value is
<code class="literal">3</code>.
</dd>
<dt>
<span class="term">
<code class="literal">use_throttle_retries</code>
</span>
</dt>
<dd>
Whether retries should be throttled (i.e. should back off). Must be <code class="literal">true</code>
or <code class="literal">false</code>. Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">path_style_access</code>
</span>
</dt>
<dd>
Whether to force the use of the path style access pattern. If <code class="literal">true</code>, the
path style access pattern will be used. If <code class="literal">false</code>, the access pattern will
be automatically determined by the AWS Java SDK (See
<a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/AmazonS3Builder.html#setPathStyleAccessEnabled-java.lang.Boolean-" class="ulink" target="_top">AWS
documentation</a> for details). Defaults to <code class="literal">false</code>.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<a id="repository-s3-path-style-deprecation"></a>
<p>In versions <code class="literal">7.0</code>, <code class="literal">7.1</code>, <code class="literal">7.2</code> and <code class="literal">7.3</code> all bucket operations used the
<a href="https://aws.amazon.com/blogs/aws/amazon-s3-path-deprecation-plan-the-rest-of-the-story/" class="ulink" target="_top">now-deprecated</a>
path style access pattern. If your deployment requires the path style access
pattern then you should set this setting to <code class="literal">true</code> when upgrading.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">disable_chunked_encoding</code>
</span>
</dt>
<dd>
Whether chunked encoding should be disabled or not. If <code class="literal">false</code>, chunked
encoding is enabled and will be used where appropriate. If <code class="literal">true</code>, chunked
encoding is disabled and will not be used, which may mean that snapshot
operations consume more resources and take longer to complete. It should
only be set to <code class="literal">true</code> if you are using a storage service that does not
support chunked encoding. See the
<a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/s3/AmazonS3Builder.html#disableChunkedEncoding--" class="ulink" target="_top">AWS
Java SDK documentation</a> for details. Defaults to <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<code class="literal">region</code>
</span>
</dt>
<dd>
Allows specifying the signing region to use. Specificing this setting manually should not be necessary for most use cases. Generally,
the SDK will correctly guess the signing region to use. It should be considered an expert level setting to support S3-compatible APIs
that require <a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html" class="ulink" target="_top">v4 signatures</a> and use a region other than the
default <code class="literal">us-east-1</code>. Defaults to empty string which means that the SDK will try to automatically determine the correct signing region.
</dd>
<dt>
<span class="term">
<code class="literal">signer_override</code>
</span>
</dt>
<dd>
Allows specifying the name of the signature algorithm to use for signing requests by the S3 client. Specifying this setting should not
be necessary for most use cases. It should be considered an expert level setting to support S3-compatible APIs that do not support the
signing algorithm that the SDK automatically determines for them.
See the
<a href="https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/ClientConfiguration.html#setSignerOverride-java.lang.String-" class="ulink" target="_top">AWS
Java SDK documentation</a> for details. Defaults to empty string which means that no signing algorithm override will be used.
</dd>
</dl>
</div>
<h5><a id="repository-s3-compatible-services"></a>S3-compatible services<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h5>
<p>There are a number of storage systems that provide an S3-compatible API, and
the <code class="literal">repository-s3</code> type allows you to use these systems in place of AWS S3.
To do so, you should set the <code class="literal">s3.client.CLIENT_NAME.endpoint</code> setting to the
system&#8217;s endpoint. This setting accepts IP addresses and hostnames and may
include a port. For example, the endpoint may be <code class="literal">172.17.0.2</code> or
<code class="literal">172.17.0.2:9000</code>.</p>
<p>By default Elasticsearch communicates with your storage system using HTTPS, and
validates the repository&#8217;s certificate chain using the JVM-wide truststore.
Ensure that the JVM-wide truststore includes an entry for your repository. If
you wish to use unsecured HTTP communication instead of HTTPS, set
<code class="literal">s3.client.CLIENT_NAME.protocol</code> to <code class="literal">http</code>.</p>
<p><a href="https://minio.io" class="ulink" target="_top">MinIO</a> is an example of a storage system that provides an
S3-compatible API. The <code class="literal">repository-s3</code> type allows Elasticsearch to work with
MinIO-backed repositories as well as repositories stored on AWS S3. Other
S3-compatible storage systems may also work with Elasticsearch, but these are not
covered by the Elasticsearch test suite.</p>
<p>Note that some storage systems claim to be S3-compatible but do not faithfully
emulate S3&#8217;s behaviour in full. The <code class="literal">repository-s3</code> type requires full
compatibility with S3. In particular it must support the same set of API
endpoints, return the same errors in case of failures, and offer consistency
and performance at least as good as S3 even when accessed concurrently by
multiple nodes. You will need to work with the supplier of your storage system
to address any incompatibilities you encounter.</p>
<p>You can perform some basic checks of the suitability of your storage system
using the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/repo-analysis-api.html" class="ulink" target="_top">repository analysis API</a>. If this API
does not complete successfully, or indicates poor performance, then your
storage system is not fully compatible with AWS S3 and therefore unsuitable for
use as a snapshot repository. However, these checks do not guarantee full
compatibility. Incompatible error codes and consistency or performance issues
may be rare and hard to reproduce.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="repository-s3-repository"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">s3</code> repository type supports a number of settings to customize how data is
stored in S3. These can be specified when creating the repository. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "bucket": "my-bucket",
    "another_setting": "setting-value"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1721.console"></div>
<p>The following settings are supported:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">bucket</code>
</span>
</dt>
<dd>
<p>
(Required)
Name of the S3 bucket to use for snapshots.
</p>
<p>The bucket name must adhere to Amazon&#8217;s
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html#bucketnamingrules" class="ulink" target="_top">S3
bucket naming rules</a>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">client</code>
</span>
</dt>
<dd>
The name of the <a class="xref" href="snapshots-register-repository.html#repository-s3-client" title="Client settings">S3 client</a> to use to connect to S3.
Defaults to <code class="literal">default</code>.
</dd>
<dt>
<span class="term">
<code class="literal">base_path</code>
</span>
</dt>
<dd>
<p>
Specifies the path to the repository data within its bucket. Defaults to an
empty string, meaning that the repository is at the root of the bucket. The
value of this setting should not start or end with a <code class="literal">/</code>.
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Don&#8217;t set <code class="literal">base_path</code> when configuring a snapshot repository for Elastic Cloud Enterprise.
Elastic Cloud Enterprise automatically generates the <code class="literal">base_path</code> for each deployment so that
multiple deployments may share the same bucket.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
(<a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>) Big files can be broken down into chunks during snapshotting if needed.
Specify the chunk size as a value and unit, for example:
<code class="literal">1TB</code>, <code class="literal">1GB</code>, <code class="literal">10MB</code>. Defaults to the maximum size of a blob in the S3 which is <code class="literal">5TB</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> metadata files are stored in compressed format. This
setting doesn&#8217;t affect index files that are already compressed by default.
Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="settings.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">server_side_encryption</code>
</span>
</dt>
<dd>
When set to <code class="literal">true</code> files are encrypted on server side using AES256
algorithm. Defaults to <code class="literal">false</code>.
</dd>
<dt>
<span class="term">
<code class="literal">buffer_size</code>
</span>
</dt>
<dd>
(<a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>) Minimum threshold below which the chunk is
uploaded using a single request.
Beyond this threshold, the S3 repository will use the
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/uploadobjusingmpu.html" class="ulink" target="_top">AWS
Multipart Upload API</a> to split the chunk into several parts, each of
<code class="literal">buffer_size</code> length, and to upload each part in its own request. Note that
setting a buffer size lower than <code class="literal">5mb</code> is not allowed since it will prevent
the use of the Multipart API and may result in upload errors. It is also not
possible to set a buffer size greater than <code class="literal">5gb</code> as it is the maximum upload
size allowed by S3. Defaults to <code class="literal">100mb</code> or <code class="literal">5%</code> of JVM heap, whichever is
smaller.
</dd>
<dt>
<span class="term">
<code class="literal">canned_acl</code>
</span>
</dt>
<dd>
The S3 repository supports all
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl" class="ulink" target="_top">S3
canned ACLs</a> : <code class="literal">private</code>, <code class="literal">public-read</code>, <code class="literal">public-read-write</code>,
<code class="literal">authenticated-read</code>, <code class="literal">log-delivery-write</code>, <code class="literal">bucket-owner-read</code>,
<code class="literal">bucket-owner-full-control</code>. Defaults to <code class="literal">private</code>. You could specify a
canned ACL using the <code class="literal">canned_acl</code> setting. When the S3 repository creates
buckets and objects, it adds the canned ACL into the buckets and objects.
</dd>
<dt>
<span class="term">
<code class="literal">storage_class</code>
</span>
</dt>
<dd>
Sets the S3 storage class for objects stored in the snapshot repository.
Values may be <code class="literal">standard</code>, <code class="literal">reduced_redundancy</code>, <code class="literal">standard_ia</code>, <code class="literal">onezone_ia</code>
and <code class="literal">intelligent_tiering</code>. Defaults to <code class="literal">standard</code>. Changing this setting on
an existing repository only affects the storage class for newly created
objects, resulting in a mixed usage of storage classes. You may use an S3
Lifecycle Policy to adjust the storage class of existing objects in your
repository, but you must not transition objects to Glacier classes and you
must not expire objects. If you use Glacier storage classes or object
expiry then you may permanently lose access to your repository contents.
For more information about S3 storage classes, see
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/storage-class-intro.html" class="ulink" target="_top">AWS
Storage Classes Guide</a>
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The option of defining client settings in the repository settings as
documented below is considered deprecated, and will be removed in a future
version.</p>
</div>
</div>
<p>In addition to the above settings, you may also specify all non-secure client
settings in the repository settings. In this case, the client settings found in
the repository settings will be merged with those of the named client used by
the repository. Conflicts between client and repository settings are resolved
by the repository settings taking precedence over client settings.</p>
<p>For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_s3_repository
{
  "type": "s3",
  "settings": {
    "client": "my-client",
    "bucket": "my-bucket",
    "endpoint": "my.s3.endpoint"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1722.console"></div>
<p>This sets up a repository that uses all client settings from the client
<code class="literal">my_client_name</code> except for the <code class="literal">endpoint</code> that is overridden to
<code class="literal">my.s3.endpoint</code> by the repository settings.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="repository-s3-permissions"></a>Recommended S3 permissions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
</div></div></div>
<p>In order to restrict the Elasticsearch snapshot process to the minimum required
resources, we recommend using Amazon IAM in conjunction with pre-existing S3
buckets. Here is an example policy which will allow the snapshot access to an S3
bucket named "snaps.example.com". This may be configured through the AWS IAM
console, by creating a Custom Policy, and using a Policy Document similar to
this (changing snaps.example.com to your bucket name).</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "Statement": [
    {
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation",
        "s3:ListBucketMultipartUploads",
        "s3:ListBucketVersions"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com"
      ]
    },
    {
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:AbortMultipartUpload",
        "s3:ListMultipartUploadParts"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com/*"
      ]
    }
  ],
  "Version": "2012-10-17"
}</pre>
</div>
<p>You may further restrict the permissions by specifying a prefix within the
bucket, in this example, named "foo".</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "Statement": [
    {
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation",
        "s3:ListBucketMultipartUploads",
        "s3:ListBucketVersions"
      ],
      "Condition": {
        "StringLike": {
          "s3:prefix": [
            "foo/*"
          ]
        }
      },
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com"
      ]
    },
    {
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:AbortMultipartUpload",
        "s3:ListMultipartUploadParts"
      ],
      "Effect": "Allow",
      "Resource": [
        "arn:aws:s3:::snaps.example.com/foo/*"
      ]
    }
  ],
  "Version": "2012-10-17"
}</pre>
</div>
<p>The bucket needs to exist to register a repository for snapshots. If you did not
create the bucket then the repository registration will fail.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_cleaning_up_multi_part_uploads"></a>Cleaning up multi-part uploads<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch uses S3&#8217;s multi-part upload process to upload larger blobs to the
repository. The multi-part upload process works by dividing each blob into
smaller parts, uploading each part independently, and then completing the
upload in a separate step. This reduces the amount of data that Elasticsearch must
re-send if an upload fails: Elasticsearch only needs to re-send the part that failed
rather than starting from the beginning of the whole blob. The storage for each
part is charged independently starting from the time at which the part was
uploaded.</p>
<p>If a multi-part upload cannot be completed then it must be aborted in order to
delete any parts that were successfully uploaded, preventing further storage
charges from accumulating. Elasticsearch will automatically abort a multi-part upload on
failure, but sometimes the abort request itself fails. For example, if the
repository becomes inaccessible or the instance on which Elasticsearch is running is
terminated abruptly then Elasticsearch cannot complete or abort any ongoing uploads.</p>
<p>You must make sure that failed uploads are eventually aborted to avoid
unnecessary storage costs. You can use the
<a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListMultipartUploads.html" class="ulink" target="_top">List
multipart uploads API</a> to list the ongoing uploads and look for any which are
unusually long-running, or you can
<a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpu-abort-incomplete-mpu-lifecycle-config.html" class="ulink" target="_top">configure
a bucket lifecycle policy</a> to automatically abort incomplete uploads once they
reach a certain age.</p>
<h4><a id="repository-s3-aws-vpc"></a>AWS VPC bandwidth settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
<p>AWS instances resolve S3 endpoints to a public IP. If the Elasticsearch
instances reside in a private subnet in an AWS VPC then all traffic to S3 will
go through the VPC&#8217;s NAT instance. If your VPC&#8217;s NAT instance is a smaller
instance size (e.g. a t2.micro) or is handling a high volume of network traffic
your bandwidth to S3 may be limited by that NAT instance&#8217;s networking bandwidth
limitations. Instead we recommend creating a <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints.html" class="ulink" target="_top">VPC endpoint</a>
that enables connecting to S3 in instances that reside in a private subnet in
an AWS VPC. This will eliminate any limitations imposed by the network
bandwidth of your VPC&#8217;s NAT instance.</p>
<p>Instances residing in a public subnet in an AWS VPC will connect to S3 via the
VPC&#8217;s internet gateway and not be bandwidth limited by the VPC&#8217;s NAT instance.</p>
<h4><a id="iam-kubernetes-service-accounts"></a>Using IAM roles for Kubernetes service accounts for authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-s3.asciidoc">edit</a></h4>
<p>If you want to use <a href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/" class="ulink" target="_top">Kubernetes service accounts</a>
for authentication, you need to add a symlink to the <code class="literal">$AWS_WEB_IDENTITY_TOKEN_FILE</code> environment variable
(which should be automatically set by a Kubernetes pod) in the S3 repository config directory, so the repository
can have the read access for the service account (a repository can&#8217;t read any files outside its config directory).
For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">mkdir -p "${ES_PATH_CONF}/repository-s3"
ln -s $AWS_WEB_IDENTITY_TOKEN_FILE "${ES_PATH_CONF}/repository-s3/aws-web-identity-token-file"</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The symlink must be created on all data and master eligible nodes and be readable
by the <code class="literal">elasticsearch</code> user. By default, Elasticsearch runs as user <code class="literal">elasticsearch</code> using uid:gid <code class="literal">1000:0</code>.</p>
</div>
</div>
<p>If the symlink exists, it will be used by default by all S3 repositories that don&#8217;t have explicit <code class="literal">client</code> credentials.</p>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="snapshots-filesystem-repository"></a>Shared file system repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-shared-file-system.asciidoc">edit</a></h2>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This repository type is only available if you run Elasticsearch on your own
hardware. If you use Elasticsearch Service, see <a class="xref" href="snapshots-register-repository.html#ess-repo-types" title="Elasticsearch Service repository types">Elasticsearch Service repository types</a>.</p>
</div>
</div>
<p>Use a shared file system repository to store snapshots on a shared file system.</p>
<p>To register a shared file system repository, first mount the file system to the
same location on all master and data nodes. Then add the file system&#8217;s path or
parent directory to the <code class="literal">path.repo</code> setting in <code class="literal">elasticsearch.yml</code> for each
master and data node. For running clusters, this requires a
<a class="xref" href="restart-cluster.html#restart-cluster-rolling" title="Rolling restart">rolling restart</a> of each node.</p>
<p>Supported <code class="literal">path.repo</code> values vary by platform:</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="fs-repo">
    <button role="tab"
            aria-selected="true"
            aria-controls="unix-tab-fs-repo"
            id="unix-fs-repo">
      Unix-like systems
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-fs-repo"
            id="win-fs-repo">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="unix-tab-fs-repo"
       aria-labelledby="unix-fs-repo">
<p>Linux and macOS installations support Unix-style paths:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">path:
  repo:
    - /mount/backups
    - /mount/long_term_backups</pre>
</div>
<p>After restarting each node, use Kibana or the <a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api" title="Create or update snapshot repository API">create
snapshot repository API</a> to register the repository. When registering the
repository, specify the file system&#8217;s path:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_fs_backup
{
  "type": "fs",
  "settings": {
    "location": "/mount/backups/my_fs_backup_location"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1723.console"></div>
<p>If you specify a relative path, Elasticsearch resolves the path using the first value in
the <code class="literal">path.repo</code> setting.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_fs_backup
{
  "type": "fs",
  "settings": {
    "location": "my_fs_backup_location"        <a id="CO550-1"></a><i class="conum" data-value="1"></i>
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1724.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO550-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The first value in the <code class="literal">path.repo</code> setting is <code class="literal">/mount/backups</code>. This
relative path, <code class="literal">my_fs_backup_location</code>, resolves to
<code class="literal">/mount/backups/my_fs_backup_location</code>.</p>
</td>
</tr>
</table>
</div>
<p>Clusters should only register a particular snapshot repository bucket once.
If you register the same snapshot repository with multiple clusters, only one
cluster should have write access to the repository. On other clusters, register
the repository as read-only.</p>
<p>This prevents multiple clusters from writing to the repository at the same time
and corrupting the repository’s contents. It also prevents Elasticsearch from caching the
repository&#8217;s contents, which means that changes made by other clusters will
become visible straight away.</p>
<p>To register a file system repository as read-only using the create snapshot
repository API, set the <code class="literal">readonly</code> parameter to true. Alternatively, you can
register a <a class="xref" href="snapshots-register-repository.html#snapshots-read-only-repository" title="Read-only URL repository">URL repository</a> for the file
system.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_fs_backup
{
  "type": "fs",
  "settings": {
    "location": "my_fs_backup_location",
    "readonly": true
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1725.console"></div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-fs-repo"
       aria-labelledby="win-fs-repo"
       hidden="">
<p>Windows installations support both DOS and Microsoft UNC paths. Escape any
backslashes in the paths. For UNC paths, provide the server and share name as a
prefix.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">path:
  repo:
    - "E:\\Mount\\Backups"                      <a id="CO551-1"></a><i class="conum" data-value="1"></i>
    - "\\\\MY_SERVER\\Mount\\Long_term_backups" <a id="CO551-2"></a><i class="conum" data-value="2"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO551-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>DOS path</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO551-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>UNC path</p>
</td>
</tr>
</table>
</div>
<p>After restarting each node, use Kibana or the <a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api" title="Create or update snapshot repository API">create
snapshot repository API</a> to register the repository. When registering the
repository, specify the file system&#8217;s path:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_fs_backup
{
  "type": "fs",
  "settings": {
    "location": "E:\\Mount\\Backups\\My_fs_backup_location"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1726.console"></div>
<p>If you specify a relative path, Elasticsearch resolves the path using the first value in
the <code class="literal">path.repo</code> setting.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_fs_backup
{
  "type": "fs",
  "settings": {
    "location": "My_fs_backup_location"        <a id="CO552-1"></a><i class="conum" data-value="1"></i>
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1727.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO552-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The first value in the <code class="literal">path.repo</code> setting is <code class="literal">E:\Mount\Backups</code>. This
relative path, <code class="literal">My_fs_backup_location</code>, resolves to
<code class="literal">E:\Mount\Backups\My_fs_backup_location</code>.</p>
</td>
</tr>
</table>
</div>
<p>Clusters should only register a particular snapshot repository bucket once.
If you register the same snapshot repository with multiple clusters, only one
cluster should have write access to the repository. On other clusters, register
the repository as read-only.</p>
<p>This prevents multiple clusters from writing to the repository at the same time
and corrupting the repository’s contents. It also prevents Elasticsearch from caching the
repository&#8217;s contents, which means that changes made by other clusters will
become visible straight away.</p>
<p>To register a file system repository as read-only using the create snapshot
repository API, set the <code class="literal">readonly</code> parameter to true. Alternatively, you can
register a <a class="xref" href="snapshots-register-repository.html#snapshots-read-only-repository" title="Read-only URL repository">URL repository</a> for the file
system.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_fs_backup
{
  "type": "fs",
  "settings": {
    "location": "my_fs_backup_location",
    "readonly": true
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1728.console"></div>
  </div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="filesystem-repository-settings"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-shared-file-system.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum size of files in snapshots. In snapshots, files larger than this are
broken down into chunks of this size or smaller. Defaults to <code class="literal">null</code> (unlimited
file size).
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
(Optional, Boolean)
If <code class="literal">true</code>, metadata files, such as index mappings and settings, are compressed
in snapshots. Data files are not compressed. Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">location</code>
</span>
</dt>
<dd>
(Required, string)
Location of the shared filesystem used to store and retrieve snapshots. This
location must be registered in the <code class="literal">path.repo</code> setting on all master and data
nodes in the cluster.
</dd>
<dt>
<span class="term">
<code class="literal">max_number_of_snapshots</code>
</span>
</dt>
<dd>
(Optional, integer)
Maximum number of snapshots the repository can contain.
Defaults to <code class="literal">Integer.MAX_VALUE</code>, which is <code class="literal">2^31-1</code> or <code class="literal">2147483647</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="settings.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_troubleshooting_a_shared_file_system_repository"></a>Troubleshooting a shared file system repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-shared-file-system.asciidoc">edit</a></h3>
</div></div></div>
<p>Elasticsearch interacts with a shared file system repository using the file system
abstraction in your operating system. This means that every Elasticsearch node must be
able to perform operations within the repository path such as creating,
opening, and renaming files, and creating and listing directories, and
operations performed by one node must be visible to other nodes as soon as they
complete.</p>
<p>Check for common misconfigurations using the <a class="xref" href="snapshot-restore-apis.html#verify-snapshot-repo-api" title="Verify snapshot repository API">Verify snapshot repository</a> API
and the <a class="xref" href="snapshot-restore-apis.html#repo-analysis-api" title="Repository analysis API">Repository analysis</a> API. When the repository is properly configured,
these APIs will complete successfully. If the verify repository or repository
analysis APIs report a problem then you will be able to reproduce this problem
outside Elasticsearch by performing similar operations on the file system directly.</p>
<p>If the verify repository or repository analysis APIs fail with an error
indicating insufficient permissions then adjust the configuration of the
repository within your operating system to give Elasticsearch an appropriate level of
access. To reproduce such problems directly, perform the same operations as
Elasticsearch in the same security context as the one in which Elasticsearch is running. For
example, on Linux, use a command such as <code class="literal">su</code> to switch to the user as which
Elasticsearch runs.</p>
<p>If the verify repository or repository analysis APIs fail with an error
indicating that operations on one node are not immediately visible on another
node then adjust the configuration of the repository within your operating
system to address this problem. If your repository cannot be configured with
strong enough visibility guarantees then it is not suitable for use as an Elasticsearch
snapshot repository.</p>
<p>The verify repository and repository analysis APIs will also fail if the
operating system returns any other kind of I/O error when accessing the
repository. If this happens, address the cause of the I/O error reported by the
operating system.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Many NFS implementations match accounts across nodes using their <em>numeric</em>
user IDs (UIDs) and group IDs (GIDs) rather than their names. It is possible
for Elasticsearch to run under an account with the same name (often <code class="literal">elasticsearch</code>) on
each node, but for these accounts to have different numeric user or group IDs.
If your shared file system uses NFS then ensure that every node is running with
the same numeric UID and GID, or else update your NFS configuration to account
for the variance in numeric IDs across nodes.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="snapshots-read-only-repository"></a>Read-only URL repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-read-only-url.asciidoc">edit</a></h2>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This repository type is only available if you run Elasticsearch on your own
hardware. If you use Elasticsearch Service, see <a class="xref" href="snapshots-register-repository.html#ess-repo-types" title="Elasticsearch Service repository types">Elasticsearch Service repository types</a>.</p>
</div>
</div>
<p>You can use a URL repository to give a cluster read-only access to a shared file
system. Since URL repositories are always read-only, they&#8217;re a safer and more
convenient alternative to registering a read-only shared filesystem repository.</p>
<p>Use Kibana or the <a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api" title="Create or update snapshot repository API">create snapshot repository API</a> to
register a URL repository.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_read_only_url_repository
{
  "type": "url",
  "settings": {
    "url": "file:/mount/backups/my_fs_backup_location"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1729.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="read-only-url-repository-settings"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-read-only-url.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum size of files in snapshots. In snapshots, files larger than this are
broken down into chunks of this size or smaller. Defaults to <code class="literal">null</code> (unlimited
file size).
</dd>
<dt>
<span class="term">
<code class="literal">http_max_retries</code>
</span>
</dt>
<dd>
(Optional, integer) Maximum number of retries for <code class="literal">http</code> and <code class="literal">https</code> URLs.
Defaults to <code class="literal">5</code>.
</dd>
<dt>
<span class="term">
<code class="literal">http_socket_timeout</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#time-units" title="Time units">time value</a>) Maximum wait time for data transfers over
a connection. Defaults to <code class="literal">50s</code>.
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
(Optional, Boolean)
If <code class="literal">true</code>, metadata files, such as index mappings and settings, are compressed
in snapshots. Data files are not compressed. Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_number_of_snapshots</code>
</span>
</dt>
<dd>
(Optional, integer)
Maximum number of snapshots the repository can contain.
Defaults to <code class="literal">Integer.MAX_VALUE</code>, which is <code class="literal">2^31-1</code> or <code class="literal">2147483647</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="settings.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">url</code>
</span>
</dt>
<dd>
<p>(Required, string)
URL location of the root of the shared filesystem repository. The following
protocols are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">file</code>
</li>
<li class="listitem">
<code class="literal">ftp</code>
</li>
<li class="listitem">
<code class="literal">http</code>
</li>
<li class="listitem">
<code class="literal">https</code>
</li>
<li class="listitem">
<code class="literal">jar</code>
</li>
</ul>
</div>
<p>URLs using the <code class="literal">http</code>, <code class="literal">https</code>, or <code class="literal">ftp</code> protocols must be explicitly allowed
with the <a class="xref" href="settings.html#repositories-url-allowed"><code class="literal">repositories.url.allowed_urls</code></a> cluster
setting. This setting supports wildcards in the place of a host, path, query, or
fragment in the URL.</p>
<p>URLs using the <code class="literal">file</code> protocol must point to the location of a shared filesystem
accessible to all master and data nodes in the cluster. This location must be
registered in the <code class="literal">path.repo</code> setting. You don&#8217;t need to register URLs using the
<code class="literal">ftp</code>, <code class="literal">http</code>, <code class="literal">https</code>, or <code class="literal">jar</code> protocols in the <code class="literal">path.repo</code> setting.</p>
</dd>
</dl>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="snapshots-source-only-repository"></a>Source-only repository<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-source-only.asciidoc">edit</a></h2>
</div></div></div>
<p>You can use a source-only repository to take minimal, source-only snapshots that
use up to 50% less disk space than regular snapshots.</p>
<p>Unlike other repository types, a source-only repository doesn&#8217;t directly store
snapshots. It delegates storage to another registered snapshot repository.</p>
<p>When you take a snapshot using a source-only repository, Elasticsearch creates a
source-only snapshot in the delegated storage repository. This snapshot only
contains stored fields and metadata. It doesn&#8217;t include index or doc values
structures and isn&#8217;t immediately searchable when restored. To search the
restored data, you first have to <a class="xref" href="docs.html#docs-reindex" title="Reindex API">reindex</a> it into a new data
stream or index.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Source-only snapshots are only supported if the <code class="literal">_source</code> field is enabled and no source-filtering is applied.
When you restore a source-only snapshot:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The restored index is read-only and can only serve <code class="literal">match_all</code> search or scroll requests to enable reindexing.
</li>
<li class="listitem">
Queries other than <code class="literal">match_all</code> and <code class="literal">_get</code> requests are not supported.
</li>
<li class="listitem">
The mapping of the restored index is empty, but the original mapping is available from the types top
level <code class="literal">meta</code> element.
</li>
</ul>
</div>
</div>
</div>
<p>Before registering a source-only repository, use Kibana or the
<a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api" title="Create or update snapshot repository API">create snapshot repository API</a> to register a snapshot
repository of another type to use for storage. Then register the source-only
repository and specify the delegated storage repository in the request.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _snapshot/my_src_only_repository
{
  "type": "source",
  "settings": {
    "delegate_type": "fs",
    "location": "my_backup_repository"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1730.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="source-only-repository-settings"></a>Repository settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/docs/reference/snapshot-restore/repository-source-only.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">chunk_size</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum size of files in snapshots. In snapshots, files larger than this are
broken down into chunks of this size or smaller. Defaults to <code class="literal">null</code> (unlimited
file size).
</dd>
<dt>
<span class="term">
<code class="literal">compress</code>
</span>
</dt>
<dd>
(Optional, Boolean)
If <code class="literal">true</code>, metadata files, such as index mappings and settings, are compressed
in snapshots. Data files are not compressed. Defaults to <code class="literal">true</code>.
</dd>
<dt>
<span class="term">
<code class="literal">delegate_type</code>
</span>
</dt>
<dd>
<p>
(Optional, string)
Delegated repository type. For valid values, see the
<a class="xref" href="snapshot-restore-apis.html#put-snapshot-repo-api-request-type"><code class="literal">type</code> parameter</a>.
</p>
<p><code class="literal">source</code> repositories can use <code class="literal">settings</code> properties for its delegated repository
type. See <a class="xref" href="snapshots-register-repository.html#snapshots-source-only-repository" title="Source-only repository">Source-only repository</a>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">max_number_of_snapshots</code>
</span>
</dt>
<dd>
(Optional, integer)
Maximum number of snapshots the repository can contain.
Defaults to <code class="literal">Integer.MAX_VALUE</code>, which is <code class="literal">2^31-1</code> or <code class="literal">2147483647</code>.
</dd>
<dt>
<span class="term">
<code class="literal">max_restore_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot restore rate per node. Defaults to unlimited. Note
that restores are also throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
<dt>
<span class="term">
<code class="literal">max_snapshot_bytes_per_sec</code>
</span>
</dt>
<dd>
(Optional, <a class="xref" href="api-conventions.html#byte-units" title="Byte size units">byte value</a>)
Maximum snapshot creation rate per node. Defaults to <code class="literal">40mb</code> per second.
Note that if the <a class="xref" href="settings.html#recovery-settings-for-managed-services" title="Recovery settings for managed services">recovery settings for managed services</a>
are set, then it defaults to unlimited, and the rate is additionally
throttled through <a class="xref" href="settings.html#recovery" title="Index recovery settings">recovery settings</a>.
</dd>
</dl>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">readonly</code>
</span>
</dt>
<dd>
<p>
(Optional, Boolean)
If <code class="literal">true</code>, the repository is read-only. The cluster can retrieve and restore
snapshots from the repository but not write to the repository or create
snapshots in it.
</p>
<p>Only a cluster with write access can create snapshots in the repository. All
other clusters connected to the repository should have the <code class="literal">readonly</code> parameter
set to <code class="literal">true</code>.</p>
<p>If <code class="literal">false</code>, the cluster can write to the repository and create snapshots in it.
Defaults to <code class="literal">false</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you register the same snapshot repository with multiple clusters, only
one cluster should have write access to the repository. Having multiple clusters
write to the repository at the same time risks corrupting the contents of the
repository.</p>
</div>
</div>
</dd>
</dl>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="snapshot-restore.html">« Snapshot and restore</a>
</span>
<span class="next">
<a href="snapshots-take-snapshot.html">Create a snapshot »</a>
</span>
</div>
</div>
</body>
</html>
