<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Compound queries | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Compound queries | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="query-dsl.html" title="Query DSL"/>
<link rel="prev" href="query-filter-context.html" title="Query and filter context"/>
<link rel="next" href="full-text-queries.html" title="Full text queries"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="query-filter-context.html">« Query and filter context</a>
</span>
<span class="next">
<a href="full-text-queries.html">Full text queries »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="compound-queries"></a>Compound queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/compound-queries.asciidoc">edit</a></h2>
</div></div></div>
<p>Compound queries wrap other compound or leaf queries, either to combine their
results and scores, to change their behaviour, or to switch from query to
filter context.</p>
<p>The queries in this group are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<a class="xref" href="compound-queries.html#query-dsl-bool-query" title="Boolean query"><code class="literal">bool</code> query</a>
</span>
</dt>
<dd>
The default query for combining multiple leaf or compound query clauses, as
<code class="literal">must</code>, <code class="literal">should</code>, <code class="literal">must_not</code>, or <code class="literal">filter</code> clauses.  The <code class="literal">must</code> and <code class="literal">should</code>
clauses have their scores combined&#8201;&#8212;&#8201;the more matching clauses, the better&#8201;&#8212;&#8201;while the <code class="literal">must_not</code> and <code class="literal">filter</code> clauses are executed in filter context.
</dd>
<dt>
<span class="term">
<a class="xref" href="compound-queries.html#query-dsl-boosting-query" title="Boosting query"><code class="literal">boosting</code> query</a>
</span>
</dt>
<dd>
Return documents which match a <code class="literal">positive</code> query, but reduce the score of
documents which also match a <code class="literal">negative</code> query.
</dd>
<dt>
<span class="term">
<a class="xref" href="compound-queries.html#query-dsl-constant-score-query" title="Constant score query"><code class="literal">constant_score</code> query</a>
</span>
</dt>
<dd>
A query which wraps another query, but executes it in filter context.  All
matching documents are given the same &#8220;constant&#8221; <code class="literal">_score</code>.
</dd>
<dt>
<span class="term">
<a class="xref" href="compound-queries.html#query-dsl-dis-max-query" title="Disjunction max query"><code class="literal">dis_max</code> query</a>
</span>
</dt>
<dd>
A query which accepts multiple queries, and returns any documents which match
any of the query clauses.  While the <code class="literal">bool</code> query combines the scores from all
matching queries, the <code class="literal">dis_max</code> query uses the score of the single best-
matching query clause.
</dd>
<dt>
<span class="term">
<a class="xref" href="compound-queries.html#query-dsl-function-score-query" title="Function score query"><code class="literal">function_score</code> query</a>
</span>
</dt>
<dd>
Modify the scores returned by the main query with functions to take into
account factors like popularity, recency, distance, or custom algorithms
implemented with scripting.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-bool-query"></a>Boolean query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/bool-query.asciidoc">edit</a></h2>
</div></div></div>

<p>A query that matches documents matching boolean combinations of other
queries. The bool query maps to Lucene <code class="literal">BooleanQuery</code>. It is built using
one or more boolean clauses, each clause with a typed occurrence. The
occurrence types are:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Occur</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">must</code></p></td>
<td align="left" valign="top"><p>The clause (query) must appear in matching documents and will
contribute to the score.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">filter</code></p></td>
<td align="left" valign="top"><p>The clause (query) must appear in matching documents. However unlike
<code class="literal">must</code> the score of the query will be ignored. Filter clauses are executed
in <a class="xref" href="query-filter-context.html" title="Query and filter context">filter context</a>, meaning that scoring is ignored
and clauses are considered for caching.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">should</code></p></td>
<td align="left" valign="top"><p>The clause (query) should appear in the matching document.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">must_not</code></p></td>
<td align="left" valign="top"><p>The clause (query) must not appear in the matching
documents.  Clauses are executed in <a class="xref" href="query-filter-context.html" title="Query and filter context">filter context</a> meaning
that scoring is ignored and clauses are considered for caching. Because scoring is
ignored, a score of <code class="literal">0</code> for all documents is returned.</p></td>
</tr>
</tbody>
</table>
</div>
<p>The <code class="literal">bool</code> query takes a <em>more-matches-is-better</em> approach, so the score from
each matching <code class="literal">must</code> or <code class="literal">should</code> clause will be added together to provide the
final <code class="literal">_score</code> for each document.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _search
{
  "query": {
    "bool" : {
      "must" : {
        "term" : { "user.id" : "kimchy" }
      },
      "filter": {
        "term" : { "tags" : "production" }
      },
      "must_not" : {
        "range" : {
          "age" : { "gte" : 10, "lte" : 20 }
        }
      },
      "should" : [
        { "term" : { "tags" : "env1" } },
        { "term" : { "tags" : "deployed" } }
      ],
      "minimum_should_match" : 1,
      "boost" : 1.0
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/736.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="bool-min-should-match"></a>Using <code class="literal">minimum_should_match</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/bool-query.asciidoc">edit</a></h3>
</div></div></div>
<p>You can use the <code class="literal">minimum_should_match</code> parameter to specify the number or
percentage of <code class="literal">should</code> clauses returned documents <em>must</em> match.</p>
<p>If the <code class="literal">bool</code> query includes at least one <code class="literal">should</code> clause and no <code class="literal">must</code> or
<code class="literal">filter</code> clauses, the default value is <code class="literal">1</code>.
Otherwise, the default value is <code class="literal">0</code>.</p>
<p>For other valid values, see the
<a class="xref" href="query-dsl-minimum-should-match.html" title="minimum_should_match parameter"><code class="literal">minimum_should_match</code> parameter</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="score-bool-filter"></a>Scoring with <code class="literal">bool.filter</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/bool-query.asciidoc">edit</a></h3>
</div></div></div>
<p>Queries specified under the <code class="literal">filter</code> element have no effect on scoring&#8201;&#8212;&#8201;scores are returned as <code class="literal">0</code>.  Scores are only affected by the query that has
been specified.  For instance, all three of the following queries return
all documents where the <code class="literal">status</code> field contains the term <code class="literal">active</code>.</p>
<p>This first query assigns a score of <code class="literal">0</code> to all documents, as no scoring
query has been specified:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _search
{
  "query": {
    "bool": {
      "filter": {
        "term": {
          "status": "active"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/737.console"></div>
<p>This <code class="literal">bool</code> query has a <code class="literal">match_all</code> query, which assigns a score of <code class="literal">1.0</code> to
all documents.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _search
{
  "query": {
    "bool": {
      "must": {
        "match_all": {}
      },
      "filter": {
        "term": {
          "status": "active"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/738.console"></div>
<p>This <code class="literal">constant_score</code> query behaves in exactly the same way as the second example above.
The <code class="literal">constant_score</code> query assigns a score of <code class="literal">1.0</code> to all documents matched
by the filter.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _search
{
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "status": "active"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/739.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="named-queries"></a>Named queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/bool-query.asciidoc">edit</a></h3>
</div></div></div>
<p>Each query accepts a <code class="literal">_name</code> in its top level definition. You can use named
queries to track which queries matched returned documents. If named queries are
used, the response includes a <code class="literal">matched_queries</code> property for each hit.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": { "name.first": { "query": "shay", "_name": "first" } } },
        { "match": { "name.last": { "query": "banon", "_name": "last" } } }
      ],
      "filter": {
        "terms": {
          "name.last": [ "banon", "kimchy" ],
          "_name": "test"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/740.console"></div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-boosting-query"></a>Boosting query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/boosting-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Returns documents matching a <code class="literal">positive</code> query while reducing the
<a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> of documents that also match a
<code class="literal">negative</code> query.</p>
<p>You can use the <code class="literal">boosting</code> query to demote certain documents without
excluding them from the search results.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="boosting-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/boosting-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "boosting": {
      "positive": {
        "term": {
          "text": "apple"
        }
      },
      "negative": {
        "term": {
          "text": "pie tart fruit crumble tree"
        }
      },
      "negative_boost": 0.5
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/741.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="boosting-top-level-params"></a>Top-level parameters for <code class="literal">boosting</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/boosting-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">positive</code>
</span>
</dt>
<dd>
(Required, query object) Query you wish to run. Any returned documents must
match this query.
</dd>
<dt>
<span class="term">
<code class="literal">negative</code>
</span>
</dt>
<dd>
<p>(Required, query object) Query used to decrease the <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance
score</a> of matching documents.</p>
<p>If a returned document matches the <code class="literal">positive</code> query and this query, the
<code class="literal">boosting</code> query calculates the final <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> for
the document as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Take the original relevance score from the <code class="literal">positive</code> query.
</li>
<li class="listitem">
Multiply the score by the <code class="literal">negative_boost</code> value.
</li>
</ol>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">negative_boost</code>
</span>
</dt>
<dd>
(Required, float) Floating point number between <code class="literal">0</code> and <code class="literal">1.0</code> used to decrease
the <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a> of documents matching the
<code class="literal">negative</code> query.
</dd>
</dl>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-constant-score-query"></a>Constant score query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/constant-score-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Wraps a <a class="xref" href="compound-queries.html#query-dsl-bool-query" title="Boolean query">filter query</a> and returns every matching
document with a <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> equal to the <code class="literal">boost</code>
parameter value.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "constant_score": {
      "filter": {
        "term": { "user.id": "kimchy" }
      },
      "boost": 1.2
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/742.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="constant-score-top-level-params"></a>Top-level parameters for <code class="literal">constant_score</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/constant-score-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">filter</code>
</span>
</dt>
<dd>
<p>(Required, query object) <a class="xref" href="compound-queries.html#query-dsl-bool-query" title="Boolean query">Filter query</a> you wish to run.
Any returned documents must match this query.</p>
<p>Filter queries do not calculate <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a>. To
speed up performance, Elasticsearch automatically caches frequently used filter queries.</p>
</dd>
<dt>
<span class="term">
<code class="literal">boost</code>
</span>
</dt>
<dd>
(Optional, float) Floating point number used as the constant
<a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> for every document matching the
<code class="literal">filter</code> query. Defaults to <code class="literal">1.0</code>.
</dd>
</dl>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-dis-max-query"></a>Disjunction max query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/dis-max-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Returns documents matching one or more wrapped queries, called query clauses or
clauses.</p>
<p>If a returned document matches multiple query clauses, the <code class="literal">dis_max</code> query
assigns the document the highest relevance score from any matching clause, plus
a tie breaking increment for any additional matching subqueries.</p>
<p>You can use the <code class="literal">dis_max</code> to search for a term in fields mapped with different
<a class="xref" href="mapping-params.html#mapping-boost" title="boost">boost</a> factors.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="query-dsl-dis-max-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/dis-max-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "dis_max": {
      "queries": [
        { "term": { "title": "Quick pets" } },
        { "term": { "body": "Quick pets" } }
      ],
      "tie_breaker": 0.7
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/743.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="query-dsl-dis-max-query-top-level-params"></a>Top-level parameters for <code class="literal">dis_max</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/dis-max-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">queries</code>
</span>
</dt>
<dd>
(Required, array of query objects) Contains one or more query clauses. Returned
documents <span class="strong strong"><strong>must match one or more</strong></span> of these queries. If a document matches
multiple queries, Elasticsearch uses the highest <a class="xref" href="query-filter-context.html" title="Query and filter context">relevance
score</a>.
</dd>
<dt>
<span class="term">
<code class="literal">tie_breaker</code>
</span>
</dt>
<dd>
<p>(Optional, float) Floating point number between <code class="literal">0</code> and <code class="literal">1.0</code> used to increase
the <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a> of documents matching multiple
query clauses. Defaults to <code class="literal">0.0</code>.</p>
<p>You can use the <code class="literal">tie_breaker</code> value to assign higher relevance scores to
documents that contain the same term in multiple fields than documents that
contain this term in only the best of those multiple fields, without confusing
this with the better case of two different terms in the multiple fields.</p>
<p>If a document matches multiple clauses, the <code class="literal">dis_max</code> query calculates the
relevance score for the document as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Take the relevance score from a matching clause with the highest score.
</li>
<li class="listitem">
Multiply the score from any other matching clauses by the <code class="literal">tie_breaker</code> value.
</li>
<li class="listitem">
Add the highest score to the multiplied scores.
</li>
</ol>
</div>
<p>If the <code class="literal">tie_breaker</code> value is greater than <code class="literal">0.0</code>, all matching clauses count,
but the clause with the highest score counts most.</p>
</dd>
</dl>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-function-score-query"></a>Function score query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h2>
</div></div></div>

<p>The <code class="literal">function_score</code> allows you to modify the score of documents that are
retrieved by a query. This can be useful if, for example, a score
function is computationally expensive and it is sufficient to compute
the score on a filtered set of documents.</p>
<p>To use <code class="literal">function_score</code>, the user has to define a query and one or
more functions, that compute a new score for each document returned
by the query.</p>
<p><code class="literal">function_score</code> can be used with only one function like this:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "query": { "match_all": {} },
      "boost": "5",
      "random_score": {}, <a id="CO196-1"></a><i class="conum" data-value="1"></i>
      "boost_mode": "multiply"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/744.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO196-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>See <a class="xref" href="compound-queries.html#score-functions">Function score</a> for a list of supported functions.</p>
</td>
</tr>
</table>
</div>
<p>Furthermore, several functions can be combined. In this case one can
optionally choose to apply the function only if a document matches a
given filtering query</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "query": { "match_all": {} },
      "boost": "5", <a id="CO197-1"></a><i class="conum" data-value="1"></i>
      "functions": [
        {
          "filter": { "match": { "test": "bar" } },
          "random_score": {}, <a id="CO197-2"></a><i class="conum" data-value="2"></i>
          "weight": 23
        },
        {
          "filter": { "match": { "test": "cat" } },
          "weight": 42
        }
      ],
      "max_boost": 42,
      "score_mode": "max",
      "boost_mode": "multiply",
      "min_score": 42
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/745.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO197-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Boost for the whole query.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO197-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>See <a class="xref" href="compound-queries.html#score-functions">Function score</a> for a list of supported functions.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The scores produced by the filtering query of each function do not matter.</p>
</div>
</div>
<p>If no filter is given with a function this is equivalent to specifying
<code class="literal">"match_all": {}</code></p>
<p>First, each document is scored by the defined functions. The parameter
<code class="literal">score_mode</code> specifies how the computed scores are combined:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">multiply</code>
</p>
</td>
<td valign="top">
<p>
scores are multiplied (default)
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">sum</code>
</p>
</td>
<td valign="top">
<p>
scores are summed
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">avg</code>
</p>
</td>
<td valign="top">
<p>
scores are averaged
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">first</code>
</p>
</td>
<td valign="top">
<p>
the first function that has a matching filter
is applied
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">max</code>
</p>
</td>
<td valign="top">
<p>
maximum score is used
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">min</code>
</p>
</td>
<td valign="top">
<p>
minimum score is used
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Because scores can be on different scales (for example, between 0 and 1 for decay functions but arbitrary for <code class="literal">field_value_factor</code>) and also
because sometimes a different impact of functions on the score is desirable, the score of each function can be adjusted with a user defined
<code class="literal">weight</code>. The <code class="literal">weight</code> can be defined per function in the <code class="literal">functions</code> array (example above) and is multiplied with the score computed by
the respective function.
If weight is given without any other function declaration, <code class="literal">weight</code> acts as a function that simply returns the <code class="literal">weight</code>.</p>
<p>In case <code class="literal">score_mode</code> is set to <code class="literal">avg</code> the individual scores will be combined by a <span class="strong strong"><strong>weighted</strong></span> average.
For example, if two functions return score 1 and 2 and their respective weights are 3 and 4, then their scores will be combined as
<code class="literal">(1*3+2*4)/(3+4)</code> and <span class="strong strong"><strong>not</strong></span> <code class="literal">(1*3+2*4)/2</code>.</p>
<p>The new score can be restricted to not exceed a certain limit by setting
the <code class="literal">max_boost</code> parameter. The default for <code class="literal">max_boost</code> is FLT_MAX.</p>
<p>The newly computed score is combined with the score of the
query. The parameter <code class="literal">boost_mode</code> defines how:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">multiply</code>
</p>
</td>
<td valign="top">
<p>
query score and function score is multiplied (default)
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">replace</code>
</p>
</td>
<td valign="top">
<p>
only function score is used, the query score is ignored
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">sum</code>
</p>
</td>
<td valign="top">
<p>
query score and function score are added
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">avg</code>
</p>
</td>
<td valign="top">
<p>
average
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">max</code>
</p>
</td>
<td valign="top">
<p>
max of query score and function score
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">min</code>
</p>
</td>
<td valign="top">
<p>
min of query score and function score
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>By default, modifying the score does not change which documents match. To exclude
documents that do not meet a certain score threshold the <code class="literal">min_score</code> parameter can be set to the desired score threshold.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For <code class="literal">min_score</code> to work, <span class="strong strong"><strong>all</strong></span> documents returned by the query need to be scored and then filtered out one by one.</p>
</div>
</div>
<p><a id="score-functions"></a>The <code class="literal">function_score</code> query provides several types of score functions.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="compound-queries.html#function-script-score" title="Script score"><code class="literal">script_score</code></a>
</li>
<li class="listitem">
<a class="xref" href="compound-queries.html#function-weight" title="Weight"><code class="literal">weight</code></a>
</li>
<li class="listitem">
<a class="xref" href="compound-queries.html#function-random" title="Random"><code class="literal">random_score</code></a>
</li>
<li class="listitem">
<a class="xref" href="compound-queries.html#function-field-value-factor" title="Field Value factor"><code class="literal">field_value_factor</code></a>
</li>
<li class="listitem">
<a class="xref" href="compound-queries.html#function-decay" title="Decay functions">decay functions</a>: <code class="literal">gauss</code>, <code class="literal">linear</code>, <code class="literal">exp</code>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="function-script-score"></a>Script score<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">script_score</code> function allows you to wrap another query and customize
the scoring of it optionally with a computation derived from other numeric
field values in the doc using a script expression. Here is a
simple sample:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "query": {
        "match": { "message": "elasticsearch" }
      },
      "script_score": {
        "script": {
          "source": "Math.log(2 + doc['my-int'].value)"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/746.console"></div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>In Elasticsearch, all document scores are positive 32-bit floating point numbers.</p>
<p>If the <code class="literal">script_score</code> function produces a score with greater precision, it is
converted to the nearest 32-bit float.</p>
<p>Similarly, scores must be non-negative. Otherwise, Elasticsearch returns an error.</p>
</div>
</div>
<p>On top of the different scripting field values and expression, the
<code class="literal">_score</code> script parameter can be used to retrieve the score based on the
wrapped query.</p>
<p>Scripts compilation is cached for faster execution. If the script has
parameters that it needs to take into account, it is preferable to reuse the
same script, and provide parameters to it:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "query": {
        "match": { "message": "elasticsearch" }
      },
      "script_score": {
        "script": {
          "params": {
            "a": 5,
            "b": 1.2
          },
          "source": "params.a / Math.pow(params.b, doc['my-int'].value)"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/747.console"></div>
<p>Note that unlike the <code class="literal">custom_score</code> query, the
score of the query is multiplied with the result of the script scoring. If
you wish to inhibit this, set <code class="literal">"boost_mode": "replace"</code></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="function-weight"></a>Weight<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">weight</code> score allows you to multiply the score by the provided
<code class="literal">weight</code>. This can sometimes be desired since boost value set on
specific queries gets normalized, while for this score function it does
not. The number value is of type float.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"weight" : number</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="function-random"></a>Random<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">random_score</code> generates scores that are uniformly distributed from 0 up to
but not including 1. By default, it uses the internal Lucene doc ids as a
source of randomness, which is very efficient but unfortunately not
reproducible since documents might be renumbered by merges.</p>
<p>In case you want scores to be reproducible, it is possible to provide a <code class="literal">seed</code>
and <code class="literal">field</code>. The final score will then be computed based on this seed, the
minimum value of <code class="literal">field</code> for the considered document and a salt that is computed
based on the index name and shard id so that documents that have the same
value but are stored in different indexes get different scores. Note that
documents that are within the same shard and have the same value for <code class="literal">field</code>
will however get the same score, so it is usually desirable to use a field that
has unique values for all documents. A good default choice might be to use the
<code class="literal">_seq_no</code> field, whose only drawback is that scores will change if the document
is updated since update operations also update the value of the <code class="literal">_seq_no</code> field.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>It was possible to set a seed without setting a field, but this has been
deprecated as this requires loading fielddata on the <code class="literal">_id</code> field which consumes
a lot of memory.</p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "random_score": {
        "seed": 10,
        "field": "_seq_no"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/748.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="function-field-value-factor"></a>Field Value factor<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">field_value_factor</code> function allows you to use a field from a document to
influence the score. It&#8217;s similar to using the <code class="literal">script_score</code> function, however,
it avoids the overhead of scripting. If used on a multi-valued field, only the
first value of the field is used in calculations.</p>
<p>As an example, imagine you have a document indexed with a numeric <code class="literal">my-int</code>
field and wish to influence the score of a document with this field, an example
doing so would look like:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "field_value_factor": {
        "field": "my-int",
        "factor": 1.2,
        "modifier": "sqrt",
        "missing": 1
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/749.console"></div>
<p>Which will translate into the following formula for scoring:</p>
<p><code class="literal">sqrt(1.2 * doc['my-int'].value)</code></p>
<p>There are a number of options for the <code class="literal">field_value_factor</code> function:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">field</code>
</p>
</td>
<td valign="top">
<p>
Field to be extracted from the document.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">factor</code>
</p>
</td>
<td valign="top">
<p>
Optional factor to multiply the field value with, defaults to <code class="literal">1</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">modifier</code>
</p>
</td>
<td valign="top">
<p>
Modifier to apply to the field value, can be one of: <code class="literal">none</code>, <code class="literal">log</code>,
<code class="literal">log1p</code>, <code class="literal">log2p</code>, <code class="literal">ln</code>, <code class="literal">ln1p</code>, <code class="literal">ln2p</code>, <code class="literal">square</code>, <code class="literal">sqrt</code>, or <code class="literal">reciprocal</code>.
Defaults to <code class="literal">none</code>.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Modifier</th>
<th align="left" valign="top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">none</code></p></td>
<td align="left" valign="top"><p>Do not apply any multiplier to the field value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log</code></p></td>
<td align="left" valign="top"><p>Take the <a href="https://en.wikipedia.org/wiki/Common_logarithm" class="ulink" target="_top">common logarithm</a> of the field value.
          Because this function will return a negative value and cause an error if used on values
          between 0 and 1, it is recommended to use <code class="literal">log1p</code> instead.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log1p</code></p></td>
<td align="left" valign="top"><p>Add 1 to the field value and take the common logarithm</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log2p</code></p></td>
<td align="left" valign="top"><p>Add 2 to the field value and take the common logarithm</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln</code></p></td>
<td align="left" valign="top"><p>Take the <a href="https://en.wikipedia.org/wiki/Natural_logarithm" class="ulink" target="_top">natural logarithm</a> of the field value.
         Because this function will return a negative value and cause an error if used on values
         between 0 and 1, it is recommended to use <code class="literal">ln1p</code> instead.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln1p</code></p></td>
<td align="left" valign="top"><p>Add 1 to the field value and take the natural logarithm</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln2p</code></p></td>
<td align="left" valign="top"><p>Add 2 to the field value and take the natural logarithm</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">square</code></p></td>
<td align="left" valign="top"><p>Square the field value (multiply it by itself)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqrt</code></p></td>
<td align="left" valign="top"><p>Take the <a href="https://en.wikipedia.org/wiki/Square_root" class="ulink" target="_top">square root</a> of the field value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">reciprocal</code></p></td>
<td align="left" valign="top"><p><a href="https://en.wikipedia.org/wiki/Multiplicative_inverse" class="ulink" target="_top">Reciprocate</a> the field value, same as <code class="literal">1/x</code> where <code class="literal">x</code> is the field&#8217;s value</p></td>
</tr>
</tbody>
</table>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">missing</code>
</span>
</dt>
<dd>
Value used if the document doesn&#8217;t have that field. The modifier
and factor are still applied to it as though it were read from the document.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Scores produced by the <code class="literal">field_value_score</code> function must be
non-negative, otherwise an error will be thrown. The <code class="literal">log</code> and <code class="literal">ln</code> modifiers
will produce negative values if used on values between 0 and 1. Be sure to limit
the values of the field with a range filter to avoid this, or use <code class="literal">log1p</code> and
<code class="literal">ln1p</code>.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Keep in mind that taking the log() of 0, or the square root of a
negative number is an illegal operation, and an exception will be thrown. Be
sure to limit the values of the field with a range filter to avoid this, or use
<code class="literal">log1p</code> and <code class="literal">ln1p</code>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="function-decay"></a>Decay functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>Decay functions score a document with a function that decays depending
on the distance of a numeric field value of the document from a user
given origin. This is similar to a range query, but with smooth edges
instead of boxes.</p>
<p>To use distance scoring on a query that has numerical fields, the user
has to define an <code class="literal">origin</code> and a <code class="literal">scale</code> for each field. The <code class="literal">origin</code>
is needed to define the &#8220;central point&#8221; from which the distance
is calculated, and the <code class="literal">scale</code> to define the rate of decay. The
decay function is specified as</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"DECAY_FUNCTION": { <a id="CO198-1"></a><i class="conum" data-value="1"></i>
    "FIELD_NAME": { <a id="CO198-2"></a><i class="conum" data-value="2"></i>
          "origin": "11, 12",
          "scale": "2km",
          "offset": "0km",
          "decay": 0.33
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO198-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">DECAY_FUNCTION</code> should be one of <code class="literal">linear</code>, <code class="literal">exp</code>, or <code class="literal">gauss</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO198-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The specified field must be a numeric, date, or geo-point field.</p>
</td>
</tr>
</table>
</div>
<p>In the above example, the field is a <a class="xref" href="mapping-types.html#geo-point" title="Geo-point field type"><code class="literal">geo_point</code></a> and origin can
be provided in geo format. <code class="literal">scale</code> and <code class="literal">offset</code> must be given with a unit in
this case. If your field is a date field, you can set <code class="literal">scale</code> and <code class="literal">offset</code> as
days, weeks, and so on. Example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "gauss": {
        "@timestamp": {
          "origin": "2013-09-17", <a id="CO199-1"></a><i class="conum" data-value="1"></i>
          "scale": "10d",
          "offset": "5d",         <a id="CO199-2"></a><i class="conum" data-value="2"></i>
          "decay": 0.5            <a id="CO199-3"></a><i class="conum" data-value="2"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/750.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO199-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The date format of the origin depends on the <a class="xref" href="mapping-params.html#mapping-date-format" title="format"><code class="literal">format</code></a> defined in
your mapping. If you do not define the origin, the current time is used.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO199-2"><i class="conum" data-value="2"></i></a><a href="#CO199-3"></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">offset</code> and <code class="literal">decay</code> parameters are optional.</p>
</td>
</tr>
</table>
</div>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">origin</code>
</p>
</td>
<td valign="top">
<p>
The point of origin used for calculating distance. Must be given as a
number for numeric field, date for date fields and geo point for geo fields.
Required for geo and numeric field. For date fields the default is <code class="literal">now</code>. Date
math (for example <code class="literal">now-1h</code>) is supported for origin.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">scale</code>
</p>
</td>
<td valign="top">
<p>
Required for all types. Defines the distance from origin + offset at which the computed
score will equal <code class="literal">decay</code> parameter. For geo fields: Can be defined as number+unit (1km, 12m,&#8230;&#8203;).
Default unit is meters. For date fields: Can to be defined as a number+unit ("1h", "10d",&#8230;&#8203;).
Default unit is milliseconds. For numeric field: Any number.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">offset</code>
</p>
</td>
<td valign="top">
<p>
If an <code class="literal">offset</code> is defined, the decay function will only compute the
decay function for documents with a distance greater than the defined
<code class="literal">offset</code>. The default is 0.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">decay</code>
</p>
</td>
<td valign="top">
<p>
The <code class="literal">decay</code> parameter defines how documents are scored at the distance
given at <code class="literal">scale</code>. If no <code class="literal">decay</code> is defined, documents at the distance
<code class="literal">scale</code> will be scored 0.5.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>In the first example, your documents might represents hotels and contain a geo
location field. You want to compute a decay function depending on how
far the hotel is from a given location. You might not immediately see
what scale to choose for the gauss function, but you can say something
like: "At a distance of 2km from the desired location, the score should
be reduced to one third."
The parameter "scale" will then be adjusted automatically to assure that
the score function computes a score of 0.33 for hotels that are 2km away
from the desired location.</p>
<p>In the second example, documents with a field value between 2013-09-12 and 2013-09-22 would get a weight of 1.0 and documents which are 15 days from that date a weight of 0.5.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_supported_decay_functions"></a>Supported decay functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">DECAY_FUNCTION</code> determines the shape of the decay:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">gauss</code>
</span>
</dt>
<dd>
<p>Normal decay, computed as:</p>
<p><span class="image"><img src="images/Gaussian.png" alt="Gaussian"></span></p>
<p>where <span class="image"><img src="images/sigma.png" alt="sigma"></span> is computed to assure that the score takes the value <code class="literal">decay</code> at distance <code class="literal">scale</code> from <code class="literal">origin</code>+-<code class="literal">offset</code></p>
<p><span class="image"><img src="images/sigma_calc.png" alt="sigma calc"></span></p>
<p>See <a class="xref" href="compound-queries.html#gauss-decay" title="Normal decay, keyword gauss">Normal decay, keyword <code class="literal">gauss</code></a> for graphs demonstrating the curve generated by the <code class="literal">gauss</code> function.</p>
</dd>
<dt>
<span class="term">
<code class="literal">exp</code>
</span>
</dt>
<dd>
<p>Exponential decay, computed as:</p>
<p><span class="image"><img src="images/Exponential.png" alt="Exponential"></span></p>
<p>where again the parameter <span class="image"><img src="images/lambda.png" alt="lambda"></span> is computed to assure that the score takes the value <code class="literal">decay</code> at distance <code class="literal">scale</code> from <code class="literal">origin</code>+-<code class="literal">offset</code></p>
<p><span class="image"><img src="images/lambda_calc.png" alt="lambda calc"></span></p>
<p>See <a class="xref" href="compound-queries.html#exp-decay" title="Exponential decay, keyword exp">Exponential decay, keyword <code class="literal">exp</code></a> for graphs demonstrating the curve generated by the <code class="literal">exp</code> function.</p>
</dd>
<dt>
<span class="term">
<code class="literal">linear</code>
</span>
</dt>
<dd>
<p>Linear decay, computed as:</p>
<p><span class="image"><img src="images/Linear.png" alt="Linear"></span>.</p>
<p>where again the parameter <code class="literal">s</code> is computed to assure that the score takes the value <code class="literal">decay</code> at distance <code class="literal">scale</code> from <code class="literal">origin</code>+-<code class="literal">offset</code></p>
<p><span class="image"><img src="images/s_calc.png" alt="s calc"></span></p>
<p>In contrast to the normal and exponential decay, this function actually
sets the score to 0 if the field value exceeds twice the user given
scale value.</p>
</dd>
</dl>
</div>
<p>For single functions the three decay functions together with their parameters can be visualized like this (the field in this example called "age"):</p>
<p><span class="image"><img src="images/decay_2d.png" alt="decay 2d" width="600"></span></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_multi_values_fields"></a>Multi-values fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>If a field used for computing the decay contains multiple values, per default the value closest to the origin is chosen for determining the distance.
This can be changed by setting <code class="literal">multi_value_mode</code>.</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">min</code>
</p>
</td>
<td valign="top">
<p>
Distance is the minimum distance
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">max</code>
</p>
</td>
<td valign="top">
<p>
Distance is the maximum distance
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">avg</code>
</p>
</td>
<td valign="top">
<p>
Distance is the average distance
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">sum</code>
</p>
</td>
<td valign="top">
<p>
Distance is the sum of all distances
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Example:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">    "DECAY_FUNCTION": {
        "FIELD_NAME": {
              "origin": ...,
              "scale": ...
        },
        "multi_value_mode": "avg"
    }</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_detailed_example"></a>Detailed example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>Suppose you are searching for a hotel in a certain town. Your budget is
limited. Also, you would like the hotel to be close to the town center,
so the farther the hotel is from the desired location the less likely
you are to check in.</p>
<p>You would like the query results that match your criterion (for
example, "hotel, Nancy, non-smoker") to be scored with respect to
distance to the town center and also the price.</p>
<p>Intuitively, you would like to define the town center as the origin and
maybe you are willing to walk 2km to the town center from the hotel.<br>
In this case your <span class="strong strong"><strong>origin</strong></span> for the location field is the town center
and the <span class="strong strong"><strong>scale</strong></span> is ~2km.</p>
<p>If your budget is low, you would probably prefer something cheap above
something expensive.  For the price field, the <span class="strong strong"><strong>origin</strong></span> would be 0 Euros
and the <span class="strong strong"><strong>scale</strong></span> depends on how much you are willing to pay, for example 20 Euros.</p>
<p>In this example, the fields might be called "price" for the price of the
hotel and "location" for the coordinates of this hotel.</p>
<p>The function for <code class="literal">price</code> in this case would be</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"gauss": { <a id="CO200-1"></a><i class="conum" data-value="1"></i>
    "price": {
          "origin": "0",
          "scale": "20"
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO200-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This decay function could also be <code class="literal">linear</code> or <code class="literal">exp</code>.</p>
</td>
</tr>
</table>
</div>
<p>and for <code class="literal">location</code>:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"gauss": { <a id="CO201-1"></a><i class="conum" data-value="1"></i>
    "location": {
          "origin": "11, 12",
          "scale": "2km"
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO201-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This decay function could also be <code class="literal">linear</code> or <code class="literal">exp</code>.</p>
</td>
</tr>
</table>
</div>
<p>Suppose you want to multiply these two functions on the original score,
the request would look like this:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "function_score": {
      "functions": [
        {
          "gauss": {
            "price": {
              "origin": "0",
              "scale": "20"
            }
          }
        },
        {
          "gauss": {
            "location": {
              "origin": "11, 12",
              "scale": "2km"
            }
          }
        }
      ],
      "query": {
        "match": {
          "properties": "balcony"
        }
      },
      "score_mode": "multiply"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/751.console"></div>
<p>Next, we show how the computed score looks like for each of the three
possible decay functions.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="gauss-decay"></a>Normal decay, keyword <code class="literal">gauss</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>When choosing <code class="literal">gauss</code> as the decay function in the above example, the
contour and surface plot of the multiplier looks like this:</p>
<div class="imageblock">
<div class="content">
<img src="https://f.cloud.github.com/assets/4320215/768157/cd0e18a6-e898-11e2-9b3c-f0145078bd6f.png" alt="cd0e18a6 e898 11e2 9b3c f0145078bd6f" width="700px">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://f.cloud.github.com/assets/4320215/768160/ec43c928-e898-11e2-8e0d-f3c4519dbd89.png" alt="ec43c928 e898 11e2 8e0d f3c4519dbd89" width="700px">
</div>
</div>
<p>Suppose your original search results matches three hotels :</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
"Backback Nap"
</li>
<li class="listitem">
"Drink n Drive"
</li>
<li class="listitem">
"BnB Bellevue".
</li>
</ul>
</div>
<p>"Drink n Drive" is pretty far from your defined location (nearly 2 km)
and is not too cheap (about 13 Euros) so it gets a low factor a factor
of 0.56. "BnB Bellevue" and "Backback Nap" are both pretty close to the
defined location but "BnB Bellevue" is cheaper, so it gets a multiplier
of 0.86 whereas "Backpack Nap" gets a value of 0.66.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="exp-decay"></a>Exponential decay, keyword <code class="literal">exp</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>When choosing <code class="literal">exp</code> as the decay function in the above example, the
contour and surface plot of the multiplier looks like this:</p>
<div class="imageblock">
<div class="content">
<img src="https://f.cloud.github.com/assets/4320215/768161/082975c0-e899-11e2-86f7-174c3a729d64.png" alt="082975c0 e899 11e2 86f7 174c3a729d64" width="700px">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://f.cloud.github.com/assets/4320215/768162/0b606884-e899-11e2-907b-aefc77eefef6.png" alt="0b606884 e899 11e2 907b aefc77eefef6" width="700px">
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="linear-decay"></a>Linear decay, keyword <code class="literal">linear</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>When choosing <code class="literal">linear</code> as the decay function in the above example, the
contour and surface plot of the multiplier looks like this:</p>
<div class="imageblock">
<div class="content">
<img src="https://f.cloud.github.com/assets/4320215/768164/1775b0ca-e899-11e2-9f4a-776b406305c6.png" alt="1775b0ca e899 11e2 9f4a 776b406305c6" width="700px">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://f.cloud.github.com/assets/4320215/768165/19d8b1aa-e899-11e2-91bc-6b0553e8d722.png" alt="19d8b1aa e899 11e2 91bc 6b0553e8d722" width="700px">
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_supported_fields_for_decay_functions"></a>Supported fields for decay functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>Only numeric, date, and geo-point fields are supported.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_what_if_a_field_is_missing"></a>What if a field is missing?<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/function-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>If the numeric field is missing in the document, the function will
return 1.</p>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="query-filter-context.html">« Query and filter context</a>
</span>
<span class="next">
<a href="full-text-queries.html">Full text queries »</a>
</span>
</div>
</div>
</body>
</html>
