<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User authentication | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="User authentication | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="secure-cluster.html" title="Secure the Elastic Stack"/>
<link rel="prev" href="update-node-certs.html" title="Updating node security certificates"/>
<link rel="next" href="authorization.html" title="User authorization"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="secure-cluster.html">Secure the Elastic Stack</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="update-node-certs.html">« Updating node security certificates</a>
</span>
<span class="next">
<a href="authorization.html">User authorization »</a>
</span>
</div>
<div class="chapter xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="setting-up-authentication"></a>User authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/overview.asciidoc">edit</a></h2>
</div></div></div>
<p>Authentication identifies an individual. To gain access to restricted resources,
a user must prove their identity, via passwords, credentials, or some other
means (typically referred to as authentication tokens).</p>
<p>The Elastic Stack authenticates users by identifying the users behind the requests
that hit the cluster and verifying that they are who they claim to be. The
authentication process is handled by one or more authentication services called
<a class="xref" href="setting-up-authentication.html#realms" title="Realms"><em>realms</em></a>.</p>
<p>You can use the native support for managing and authenticating users, or
integrate with external user management systems such as LDAP and Active
Directory.</p>
<p>The Elastic Stack security features provide built-in realms such as <code class="literal">native</code>,<code class="literal">ldap</code>,
<code class="literal">active_directory</code>, <code class="literal">pki</code>, <code class="literal">file</code>, <code class="literal">saml</code>, <code class="literal">kerberos</code>, <code class="literal">oidc</code>, and <code class="literal">jwt</code>. If
none of the built-in realms meet your needs, you can also build your own
custom realm and plug it into the Elastic Stack.</p>
<p>When security features are enabled, depending on the realms you&#8217;ve configured,
you must attach your user credentials to the requests sent to Elasticsearch. For example,
when using realms that support usernames and passwords you can simply attach
<a href="https://en.wikipedia.org/wiki/Basic_access_authentication" class="ulink" target="_top">basic auth</a> header to the requests.</p>
<p>The security features provide two services: the token service and the API key
service. You can use these services to exchange the current authentication for
a token or key. This token or key can then be used as credentials for authenticating
new requests.
The API key service is enabled by default.
The token service is enabled by default when TLS/SSL is enabled for HTTP.</p>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="built-in-users"></a>Built-in users<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack security features provide built-in user credentials to help you get
up and running. These users have a fixed set of privileges and cannot be
authenticated until their passwords have been set. The <code class="literal">elastic</code> user can be
used to <a class="xref" href="setting-up-authentication.html#set-built-in-user-passwords" title="Setting built-in user passwords">set all of the built-in user passwords</a>.</p>
<div class="sidebar">
<div class="titlepage"><div><div>
<p class="title"><strong>Create users with minimum privileges</strong></p>
</div></div></div>
<p>The built-in users serve specific purposes and are not intended for general
use. In particular, do not use the <code class="literal">elastic</code> superuser unless full access to
the cluster is absolutely required. On self-managed deployments, use the
<code class="literal">elastic</code> user to create users that have the minimum necessary roles or
privileges for their activities.</p>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>On Elastic Cloud, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/operator-privileges.html" class="ulink" target="_top">operator privileges</a> are enabled.
These privileges restrict some infrastructure functionality, even if a role
would otherwise permit a user to complete an administrative task.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">elastic</code>
</span>
</dt>
<dd>
<p>
A built-in <a class="xref" href="authorization.html#built-in-roles" title="Built-in roles">superuser</a>.
</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Anyone who can log in as the <code class="literal">elastic</code> user has direct read-only
access to restricted indices, such as <code class="literal">.security</code>. This user also has the ability
to manage security and create roles with unlimited privileges.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">kibana_system</code>
</span>
</dt>
<dd>
The user Kibana uses to connect and communicate with Elasticsearch.
</dd>
<dt>
<span class="term">
<code class="literal">logstash_system</code>
</span>
</dt>
<dd>
The user Logstash uses when storing monitoring information in Elasticsearch.
</dd>
<dt>
<span class="term">
<code class="literal">beats_system</code>
</span>
</dt>
<dd>
The user the Beats use when storing monitoring information in Elasticsearch.
</dd>
<dt>
<span class="term">
<code class="literal">apm_system</code>
</span>
</dt>
<dd>
The user the APM server uses when storing monitoring information in Elasticsearch.
</dd>
<dt>
<span class="term">
<code class="literal">remote_monitoring_user</code>
</span>
</dt>
<dd>
The user Metricbeat uses when collecting and
storing monitoring information in Elasticsearch. It has the <code class="literal">remote_monitoring_agent</code> and
<code class="literal">remote_monitoring_collector</code> built-in roles.
</dd>
</dl>
</div>
<h4><a id="built-in-user-explanation"></a>How the built-in users work<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>These built-in users are stored in a special <code class="literal">.security</code> index, which is managed
by Elasticsearch. If a built-in user is disabled or its password
changes, the change is automatically reflected on each node in the cluster. If
your <code class="literal">.security</code> index is deleted or restored from a snapshot, however, any
changes you have applied are lost.</p>
<p>Although they share the same API, the built-in users are separate and distinct
from users managed by the <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">native realm</a>. Disabling the native
realm will not have any effect on the built-in users. The built-in users can
be disabled individually, using the
<a class="xref" href="security-api.html#security-api-disable-user" title="Disable users API">disable users API</a>.</p>
<h4><a id="bootstrap-elastic-passwords"></a>The Elastic bootstrap password<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>When you install Elasticsearch, if the <code class="literal">elastic</code> user does not already have a password,
it uses a default bootstrap password. The bootstrap password is a transient
password that enables you to run the tools that set all the built-in user passwords.</p>
<p>By default, the bootstrap password is derived from a randomized <code class="literal">keystore.seed</code>
setting, which is added to the keystore during installation. You do not need
to know or change this bootstrap password. If you have defined a
<code class="literal">bootstrap.password</code> setting in the keystore, however, that value is used instead.
For more information about interacting with the keystore, see
<a class="xref" href="settings.html#secure-settings" title="Secure settings">Secure settings</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>After you <a class="xref" href="setting-up-authentication.html#set-built-in-user-passwords" title="Setting built-in user passwords">set passwords for the built-in users</a>,
in particular for the <code class="literal">elastic</code> user, there is no further use for the bootstrap
password.</p>
</div>
</div>
<h4><a id="set-built-in-user-passwords"></a>Setting built-in user passwords<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>You must set the passwords for all built-in users.</p>
<p>The <code class="literal">elasticsearch-setup-passwords</code> tool is the simplest method to set the
built-in users' passwords for the first time. It uses the <code class="literal">elastic</code> user&#8217;s
bootstrap password to run user management API requests. For example, you can run
the command in an "interactive" mode, which prompts you to enter new passwords
for the <code class="literal">elastic</code>, <code class="literal">kibana_system</code>, <code class="literal">logstash_system</code>, <code class="literal">beats_system</code>, <code class="literal">apm_system</code>,
and <code class="literal">remote_monitoring_user</code> users:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-setup-passwords interactive</pre>
</div>
<p>For more information about the command options, see
<a class="xref" href="setup-passwords.html" title="elasticsearch-setup-passwords">elasticsearch-setup-passwords</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>After you set a password for the <code class="literal">elastic</code> user, the bootstrap
password is no longer valid; you cannot run the <code class="literal">elasticsearch-setup-passwords</code>
command a second time.</p>
</div>
</div>
<p>Alternatively, you can set the initial passwords for the built-in users by using
the <span class="strong strong"><strong>Management &gt; Users</strong></span> page in Kibana or the
<a class="xref" href="security-api.html#security-api-change-password" title="Change passwords API">change password API</a>. These methods are
more complex. You must supply the <code class="literal">elastic</code> user and its bootstrap password to
log in to Kibana or run the API. This requirement means that you cannot use the
default bootstrap password that is derived from the <code class="literal">keystore.seed</code> setting.
Instead, you must explicitly set a <code class="literal">bootstrap.password</code> setting in the keystore
before you start Elasticsearch. For example, the following command prompts you to enter a
new bootstrap password:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add "bootstrap.password"</pre>
</div>
<p>You can then start Elasticsearch and Kibana and use the <code class="literal">elastic</code> user and bootstrap
password to log in to Kibana and change the passwords. Alternatively, you can
submit Change Password API requests for each built-in user. These methods are
better suited for changing your passwords after the initial setup is complete,
since at that point the bootstrap password is no longer required.</p>
<h4><a id="add-built-in-user-kibana"></a>Adding built-in user passwords to Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>After the <code class="literal">kibana_system</code> user password is set, you need to update the Kibana server
with the new password by setting <code class="literal">elasticsearch.password</code> in the <code class="literal">kibana.yml</code>
configuration file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">elasticsearch.password: kibanapassword</pre>
</div>
<p>See <a href="https://www.elastic.co/guide/en/kibana/8.9/using-kibana-with-security.html" class="ulink" target="_top">Configuring security in Kibana</a>.</p>
<h4><a id="add-built-in-user-logstash"></a>Adding built-in user passwords to Logstash<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>The <code class="literal">logstash_system</code> user is used internally within Logstash when
monitoring is enabled for Logstash.</p>
<p>To enable this feature in Logstash, you need to update the Logstash
configuration with the new password by setting <code class="literal">xpack.monitoring.elasticsearch.password</code> in
the <code class="literal">logstash.yml</code> configuration file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.monitoring.elasticsearch.password: logstashpassword</pre>
</div>
<p>If you have upgraded from an older version of Elasticsearch, the <code class="literal">logstash_system</code> user
may have defaulted to <em>disabled</em> for security reasons. Once the password has
been changed, you can enable the user via the following API call:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _security/user/logstash_system/_enable</pre>
</div>
<div class="console_widget" data-snippet="snippets/1791.console"></div>
<p>See <a href="https://www.elastic.co/guide/en/logstash/8.9/ls-security.html#ls-monitoring-user" class="ulink" target="_top">Configuring credentials for Logstash monitoring</a>.</p>
<h4><a id="add-built-in-user-beats"></a>Adding built-in user passwords to Beats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>The <code class="literal">beats_system</code> user is used internally within Beats when monitoring is
enabled for Beats.</p>
<p>To enable this feature in Beats, you need to update the configuration for each
of your beats to reference the correct username and password. For example:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.monitoring.elasticsearch.username: beats_system
xpack.monitoring.elasticsearch.password: beatspassword</pre>
</div>
<p>For example, see <a href="https://www.elastic.co/guide/en/beats/metricbeat/8.9/monitoring.html" class="ulink" target="_top">Monitoring Metricbeat</a>.</p>
<p>The <code class="literal">remote_monitoring_user</code> is used when Metricbeat collects and stores
monitoring data for the Elastic Stack. See <a class="xref" href="monitoring-production.html" title="Monitoring in a production environment"><em>Monitoring in a production environment</em></a>.</p>
<p>If you have upgraded from an older version of Elasticsearch, then you may not have set a
password for the <code class="literal">beats_system</code> or <code class="literal">remote_monitoring_user</code> users. If this is
the case, then you should use the <span class="strong strong"><strong>Management &gt; Users</strong></span> page in Kibana or the
<a class="xref" href="security-api.html#security-api-change-password" title="Change passwords API">change password API</a> to set a password
for these users.</p>
<h4><a id="add-built-in-user-apm"></a>Adding built-in user passwords to APM<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<p>The <code class="literal">apm_system</code> user is used internally within APM when monitoring is enabled.</p>
<p>To enable this feature in APM, you need to update the
<code class="literal">apm-server.yml</code> configuration file to
reference the correct username and password. For example:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.monitoring.elasticsearch.username: apm_system
xpack.monitoring.elasticsearch.password: apmserverpassword</pre>
</div>
<p>If you have upgraded from an older version of Elasticsearch, then you may not have set a
password for the <code class="literal">apm_system</code> user. If this is the case,
then you should use the <span class="strong strong"><strong>Management &gt; Users</strong></span> page in Kibana or the
<a class="xref" href="security-api.html#security-api-change-password" title="Change passwords API">change password API</a> to set a password
for these users.</p>
<h4><a id="disabling-default-password"></a>Disabling default password functionality<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/built-in-users.asciidoc">edit</a></h4>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>This setting is deprecated. The elastic user no longer has a default password.
The password must be set before the user can be used.
See <a class="xref" href="setting-up-authentication.html#bootstrap-elastic-passwords" title="The Elastic bootstrap password">The Elastic bootstrap password</a>.</p>
</div>
</div>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="service-accounts"></a>Service accounts<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/service-accounts.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack security features provide <em>service accounts</em> specifically for
integration with external services that connect to Elasticsearch, such as Fleet server.
Service accounts have a fixed set of privileges and cannot authenticate
until you create a service account token for them. Additionally, service
accounts are predefined in code, and are always enabled.</p>
<p>A service account corresponds to a specific external service. You create service
account tokens for a service account. The service can then authenticate with the
token and perform relevant actions. For example, Fleet server can use its
service token to authenticate with Elasticsearch and then manage its own API keys.</p>
<p>You can create multiple service tokens for the same service account, which
prevents credential sharing between multiple instances of the same
external service. Each instance can assume the same identity while using
their own distinct service token for authentication.</p>
<p>Service accounts provide flexibility over <a class="xref" href="setting-up-authentication.html#built-in-users" title="Built-in users">built-in users</a>
because they:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Do not rely on the <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">internal <code class="literal">native</code> realm</a>, and aren&#8217;t
always required to rely on the <code class="literal">.security</code> index
</li>
<li class="listitem">
Use a <a class="xref" href="security-api.html#security-api-create-api-key-request-body" title="Request body">role descriptor</a> named after the service account principal instead of
traditional roles
</li>
<li class="listitem">
Support multiple credentials through service account tokens
</li>
</ul>
</div>
<p>Service accounts are not included in the response of the
<a class="xref" href="security-api.html#security-api-get-user" title="Get users API">get users API</a>. To retrieve a service account, use the
<a class="xref" href="security-api.html#security-api-get-service-accounts" title="Get service accounts API">get service accounts API</a>. Use the
<a class="xref" href="security-api.html#security-api-get-service-credentials" title="Get service account credentials API">get service account credentials API</a>
to retrieve all service credentials for a service account.</p>
<h3><a id="service-accounts-explanation"></a>Service accounts usage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/service-accounts.asciidoc">edit</a></h3>
<p>Service accounts have a
<a class="xref" href="security-api.html#security-api-get-service-accounts-path-params" title="Path parameters">unique principal</a> that takes
the format of <code class="literal">&lt;namespace&gt;/&lt;service&gt;</code>, where the <code class="literal">namespace</code> is a top-level
grouping of service accounts, and <code class="literal">service</code> is the name of the service and
must be unique within its namespace.</p>
<p>Service accounts are predefined in code. The following service accounts are
available:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">elastic/fleet-server</code>
</span>
</dt>
<dd>
The service account used by the Fleet server to
communicate with Elasticsearch.
</dd>
<dt>
<span class="term">
<code class="literal">elastic/kibana</code>
</span>
</dt>
<dd>
The service account used by Kibana to communicate with
Elasticsearch.
</dd>
<dt>
<span class="term">
<code class="literal">elastic/enterprise-search-server</code>
</span>
</dt>
<dd>
The service account used by Enterprise Search
to communicate with Elasticsearch.
</dd>
</dl>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Do not attempt to use service accounts for authenticating individual
users. Service accounts can only be authenticated with service tokens, which are
not applicable to regular users.</p>
</div>
</div>
<h3><a id="service-accounts-tokens"></a>Service account tokens<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/service-accounts.asciidoc">edit</a></h3>
<p>A service account token, or service token, is a unique string that a
service uses to authenticate with Elasticsearch. For a given service account, each token
must have a unique name. Because tokens include access credentials, they should
always be kept secret by whichever client is using them.</p>
<p>Service tokens can be backed by either the <code class="literal">.security</code> index (recommended) or
the <code class="literal">service_tokens</code> file. You can create multiple service tokens for a single
service account, which enables multiple instances of the same service to run
with different credentials.</p>
<p>You must create a service token to use a service account. You can
create a service token using either:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <a class="xref" href="security-api.html#security-api-create-service-token" title="Create service account token API">create service account token API</a>,
which saves the new service token in the <code class="literal">.security</code> index and returns
the bearer token in the HTTP response.
</li>
<li class="listitem">
The <a class="xref" href="service-tokens-command.html" title="elasticsearch-service-tokens">elasticsearch-service-tokens</a> CLI tool, which
saves the new service token in the <code class="literal">$ES_HOME/config/service_tokens</code> file
and outputs the bearer token to your terminal
</li>
</ul>
</div>
<p>We recommend that you create service tokens via the REST API rather than the CLI.
The API stores service tokens within the <code class="literal">.security</code> index which means that the
tokens are available for authentication on all nodes, and will be backed up within
cluster snapshots.
The use of the CLI is intended for cases where there is an external orchestration
process (such as <a href="https://www.elastic.co/guide/en/cloud-enterprise/current" class="ulink" target="_top">Elastic Cloud Enterprise</a> or <a href="https://www.elastic.co/guide/en/cloud-on-k8s/current" class="ulink" target="_top">Elastic Cloud on Kubernetes</a>) that will manage the
creation and distribution of the <code class="literal">service_tokens</code> file.</p>
<p>Both of these methods (API and CLI) create a service token with a guaranteed
secret string length of <code class="literal">22</code>.
The minimal, acceptable length of a secret string for a service token is <code class="literal">10</code>.
If the secret string doesn&#8217;t meet this minimal length, authentication with Elasticsearch
will fail without even checking the value of the service token.</p>
<p>Service tokens never expire. You must actively
<a class="xref" href="security-api.html#security-api-delete-service-token" title="Delete service account tokens API">delete</a> them if they are no longer needed.</p>
<h3><a id="authenticate-with-service-account-token"></a>Authenticate with service tokens<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/service-accounts.asciidoc">edit</a></h3>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Service accounts currently do not support basic authentication.</p>
</div>
</div>
<p>To use a service account token, include the generated token value in a request
with an <code class="literal">Authorization: Bearer</code> header:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -H "Authorization: Bearer AAEAAWVsYXN0aWM...vZmxlZXQtc2VydmVyL3Rva2VuMTo3TFdaSDZ" http://localhost:9200/_security/_authenticate</pre>
</div>
<p>A successful authentication response includes a <code class="literal">token</code> field, which contains a
<code class="literal">name</code> field for the name of the service token and a <code class="literal">type</code> field for the
type of the service token:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "username": "elastic/fleet-server",
  "roles": [],
  "full_name": "Service account - elastic/fleet-server",
  "email": null,
  "token": {
    "name": "token1",                 <a id="CO561-1"></a><i class="conum" data-value="1"></i>
    "type": "_service_account_index"  <a id="CO561-2"></a><i class="conum" data-value="2"></i>
  },
  "metadata": {
    "_elastic_service_account": true
  },
  "enabled": true,
  "authentication_realm": {
    "name": "_service_account",
    "type": "_service_account"
  },
  "lookup_realm": {
    "name": "_service_account",
    "type": "_service_account"
  },
  "authentication_type": "token"
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO561-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Name of the service account token.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO561-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Type of service account token. The value always begins with
<code class="literal">_service_account_</code> and is followed by a string that indicates the service
token backend in use (can be either <code class="literal">file</code> or <code class="literal">index</code>).</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="internal-users"></a>Internal users<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/internal-users.asciidoc">edit</a></h2>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>These users are designed for internal use by Elasticsearch only. Authenticating with these users is not supported.</p>
</div>
</div>
<p>The Elastic Stack security features use six <em>internal</em> users (<code class="literal">_system</code>, <code class="literal">_xpack</code>,
<code class="literal">_xpack_security</code>, <code class="literal">_async_search</code>, <code class="literal">_security_profile</code> and <code class="literal">_storage</code>),
which are responsible for the operations that take place inside an Elasticsearch cluster.</p>
<p>These users are only used by requests that originate from within the cluster.
For this reason, they cannot be used to authenticate against the API and there
is no password to manage or reset.</p>
<p>From time-to-time you may find a reference to one of these users inside your
logs, including <a class="xref" href="enable-audit-logging.html" title="Enable audit logging">audit logs</a>.</p>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="token-authentication-services"></a>Token-based authentication services<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/token-authentication-services.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack security features authenticate users by using realms and one or
more token-based authentication services. The token-based authentication
services are used for authenticating and managing tokens. You can attach these
tokens to requests that are sent to Elasticsearch and use them as credentials. When Elasticsearch
receives a request that must be authenticated, it consults the token-based
authentication services first, and then the realm chain.</p>
<p>The security features provide the following built-in token-based
authentication services, which are listed in the order they are consulted:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>service-accounts</em>
</span>
</dt>
<dd>
<p>The <a class="xref" href="setting-up-authentication.html#service-accounts" title="Service accounts">service accounts</a> use either the
<a class="xref" href="security-api.html#security-api-create-service-token" title="Create service account token API">create service account token API</a>
or the <a class="xref" href="service-tokens-command.html" title="elasticsearch-service-tokens">elasticsearch-service-tokens</a> CLI tool to
generate service account tokens.</p>
<p>To use a service account token, include the generated token value in a request
with an <code class="literal">Authorization: Bearer</code> header:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -H "Authorization: Bearer AAEAAWVsYXN0aWMvZ...mXQtc2VydmMTpyNXdkYmRib1FTZTl2R09Ld2FKR0F3" http://localhost:9200/_cluster/health</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Do not attempt to use service accounts for authenticating individual
users. Service accounts can only be authenticated with service tokens, which are
not applicable to regular users.</p>
</div>
</div>
</dd>
</dl>
</div>
<div class="variablelist">
<a id="token-authentication-access-token"></a>
<dl class="variablelist">
<dt>
<span class="term">
<em>token-service</em>
</span>
</dt>
<dd>
<p>
The token service uses the <a class="xref" href="security-api.html#security-api-get-token" title="Get token API">get token API</a> to
generate access tokens and refresh tokens based on the OAuth2 specification.
The access token is a short-lived token. By default, it expires after 20 minutes
but it can be configured to last a maximum of 1 hour. It can be refreshed by
using a refresh token, which has a lifetime of 24 hours. The access token is a
bearer token. You can use it by sending a request with an <code class="literal">Authorization</code>
header with a value that has the prefix "Bearer " followed by the value of the
access token. For example:
</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -H "Authorization: Bearer dGhpcyBpcyBub3Qx5...F0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==" http://localhost:9200/_cluster/health</pre>
</div>
</dd>
</dl>
</div>
<div class="variablelist">
<a id="token-authentication-api-key"></a>
<dl class="variablelist">
<dt>
<span class="term">
<em>api-key-service</em>
</span>
</dt>
<dd>
<p>
The API key service uses the
<a class="xref" href="security-api.html#security-api-create-api-key" title="Create API key API">create API key API</a> to generate API keys.
By default, the API keys do not expire. When you make a request to create API
keys, you can specify an expiration and permissions for the API key. The
permissions are limited by the authenticated user&#8217;s permissions. You can use the
API key by sending a request with an <code class="literal">Authorization</code> header with a value that
has the prefix "ApiKey " followed by the credentials. The credentials are the
base64 encoding of the API key ID and the API key joined by a colon. For example:
</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -H "Authorization: ApiKey VnVhQ2ZHY0JDZGJrU...W0tZTVhT3g6dWkybHAyYXhUTm1zeWFrd0dk5udw==" http://localhost:9200/_cluster/health</pre>
</div>
</dd>
</dl>
</div>
<p>Depending on your use case, you may want to decide on the lifetime of the tokens
generated by these services. You can then use this information to decide which
service to use to generate and manage the tokens. Non-expiring API keys may seem
like the easy option but you must consider the security implications that come
with non-expiring keys. Both the <em>token-service</em> and <em>api-key-service</em> permit
you to invalidate the tokens. See
<a class="xref" href="security-api.html#security-api-invalidate-token" title="Invalidate token API">invalidate token API</a> and
<a class="xref" href="security-api.html#security-api-invalidate-api-key" title="Invalidate API key API">invalidate API key API</a>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Authentication support for JWT bearer tokens was introduced in Elasticsearch
8.2 through the <a class="xref" href="setting-up-authentication.html#jwt-auth-realm" title="JWT authentication">JWT authentication</a>, which cannot be enabled through
token-authentication services. Realms offer flexible order and configurations of
zero, one, or multiple JWT realms.</p>
</div>
</div>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="user-profile"></a>User profiles<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-profile.asciidoc">edit</a></h2>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The user profile feature is designed only for use by Kibana and
Elastic’s Observability, Enterprise Search, and Elastic Security solutions. Individual
users and external applications should not call this API directly. Elastic reserves
the right to change or remove this feature in future releases without prior notice.</p>
</div>
</div>
<p>Because the Elastic Stack supports externally-managed users (such as users who
authenticate via SAML, or users stored in an LDAP directory), there&#8217;s a
distinction between <em>users</em> and their <em>profile</em>.</p>
<p><em>Users</em> refer to the entities that authenticate requests to the Elastic Stack.
Each user has a username and a set of privileges (represented by <a class="xref" href="authorization.html#roles" title="Role-based access control">roles</a>)
that determine which types of requests they can issue. Users can be ephemeral;
they might exist only for the duration of a request to an Elasticsearch API or for the
lifetime of a session in Kibana. These users cannot be retrieved after the session
ends, and can&#8217;t store preferences across sessions.</p>
<p><em>User profiles</em> provide persistent and stable representations of users.
A user profile exists even if the user is offline, so their profile persists across sessions.
The unique identifier assigned to each profile doesn&#8217;t change
throughout the lifetime of a deployment, providing a stable way of referring
to the associated user. Each profile has a unique identifier, is searchable, and
can store user data such as format and notification preferences.</p>
<p>The capability of uniquely referring to users regardless of whether they&#8217;re
actively online is a critical function that underpins important features like
personalization and collaboration in Kibana.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_user_profiles_in_kibana"></a>User profiles in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-profile.asciidoc">edit</a></h3>
</div></div></div>
<p>A user profile is the persistent record that the Elastic Stack stores for each
interactive user that authenticates to Kibana.</p>
<p>When a user logs in to Kibana, a profile is automatically created for the user,
or an existing profile is updated to reflect the user&#8217;s active session.
By using the unique ID of the user profile, Kibana can store user-level data such as preferences
separately for each user, which is key to fine-grained levels of customization.
Kibana uses this unique ID to route messages and notifications to a distinct user,
regardless of whether they&#8217;re logged in.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_usernames_and_user_profiles"></a>Usernames and user profiles<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-profile.asciidoc">edit</a></h4>
</div></div></div>
<p>You can use the same username across multiple realms for a single user. In Elasticsearch,
it&#8217;s possible for two different realms to authenticate users with the same username
and different roles.
Elasticsearch doesn&#8217;t assume that these users are the same person, and treats
them as separate individuals with distinct user profiles by default.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For use cases where one individual can authenticate against
multiple realms, you can use the <a class="xref" href="setting-up-authentication.html#security-domain" title="Security domains">security domain</a> feature
so that these distinct users are considered to be the same identity
and share a single user profile.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_create_and_manage_user_profiles"></a>Create and manage user profiles<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-profile.asciidoc">edit</a></h3>
</div></div></div>
<p>To create a new user profile or update an existing one, use the
<a class="xref" href="security-api.html#security-api-activate-user-profile" title="Activate user profile API">activate user profile API</a>. When you
submit a request, Elasticsearch attempts to locate an existing profile document for the
specified user. If one doesn&#8217;t exist, Elasticsearch creates a new profile document.</p>
<p>In either case, the profile document captures the user&#8217;s <code class="literal">full_name</code>, <code class="literal">email</code>,
<code class="literal">roles</code>, and <code class="literal">realms</code>, and also includes the profile unique ID and timestamp of
the operation. You can retrieve a user profile with
the <a class="xref" href="security-api.html#security-api-get-user-profile" title="Get user profiles API">get user profile API</a> by including the
profile&#8217;s unique ID (<code class="literal">uid</code>).</p>
<p>In addition to the user&#8217;s basic information, you can add data to a profile document
with the <a class="xref" href="security-api.html#security-api-update-user-profile-data" title="Update user profile data API">update user profile API</a>. For
example, you can add user-specific preferences as part of the profile data.</p>
<p>Use the <a class="xref" href="security-api.html#security-api-suggest-user-profile" title="Suggest user profile API">suggest user profile API</a> to retrieve profiles
that match given criteria. This API is designed to support user-suggestions,
in collaboration with features such as those found in Kibana.
However, the suggest user profile API is not intended to provide a general-purpose search API.</p>
<p>Lastly, you can use the <a class="xref" href="security-api.html#security-api-has-privileges-user-profile" title="Has privileges user profile API">has privileges API for
user profiles</a> to check the privileges of multiple users by specifying their profiles' unique IDs.
This can be used in conjunction with the suggest user profile API in order to restrict the
suggestions only to users that have the necessary permissions to actually perform
the action in the context.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_limitations_11"></a>Limitations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-profile.asciidoc">edit</a></h3>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Creating a new user profile requires a user&#8217;s authentication details
(<code class="literal">username</code> and <code class="literal">password</code> or its
<a class="xref" href="setting-up-authentication.html#token-authentication-services" title="Token-based authentication services">OAuth2 access token</a>).
This means that a user must authenticate at least one time to create a
user profile. Users who have never authenticated to Kibana
(or another profile-aware application) won&#8217;t have a user profile, and the
<a class="xref" href="security-api.html#security-api-suggest-user-profile" title="Suggest user profile API">suggest user profile API</a> won&#8217;t return
any results for those users.
</li>
<li class="listitem">
<p>User profiles are meant for interactive users, such as a human user who
interacts with Kibana. Therefore, user profiles don&#8217;t support API keys or
<a class="xref" href="setting-up-authentication.html#service-accounts" title="Service accounts">service accounts</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><a class="xref" href="setting-up-authentication.html#token-authentication-services" title="Token-based authentication services">OAuth2 tokens</a> that represent an
interactive end-user are supported.</p>
</div>
</div>
</li>
</ul>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="realms"></a>Realms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/realms.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack security features authenticate users by using realms and one or more
<a class="xref" href="setting-up-authentication.html#token-authentication-services" title="Token-based authentication services">token-based authentication services</a>.</p>
<p>A <em>realm</em> is used to resolve and authenticate users based on authentication
tokens. The security features provide the following built-in realms:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>native</em>
</span>
</dt>
<dd>
An internal realm where users are stored in a dedicated Elasticsearch index.
This realm supports an authentication token in the form of username and password,
and is available by default when no realms are explicitly configured. The users
are managed via the <a class="xref" href="security-api.html#security-user-apis" title="Users">user management APIs</a>.
See <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">Native user authentication</a>.
</dd>
<dt>
<span class="term">
<em>ldap</em>
</span>
</dt>
<dd>
A realm that uses an external LDAP server to authenticate the
users. This realm supports an authentication token in the form of username and
password, and requires explicit configuration in order to be used. See
<a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication">LDAP user authentication</a>.
</dd>
<dt>
<span class="term">
<em>active_directory</em>
</span>
</dt>
<dd>
A realm that uses an external Active Directory Server to authenticate the
users. With this realm, users are authenticated by usernames and passwords.
See <a class="xref" href="setting-up-authentication.html#active-directory-realm" title="Active Directory user authentication">Active Directory user authentication</a>.
</dd>
<dt>
<span class="term">
<em>pki</em>
</span>
</dt>
<dd>
A realm that authenticates users using Public Key Infrastructure (PKI). This
realm works in conjunction with SSL/TLS and identifies the users through the
Distinguished Name (DN) of the client&#8217;s X.509 certificates. See <a class="xref" href="setting-up-authentication.html#pki-realm" title="PKI user authentication">PKI user authentication</a>.
</dd>
<dt>
<span class="term">
<em>file</em>
</span>
</dt>
<dd>
An internal realm where users are defined in files stored on each node in the
Elasticsearch cluster. This realm supports an authentication token in the form
of username and password and is always available. See <a class="xref" href="setting-up-authentication.html#file-realm" title="File-based user authentication">File-based user authentication</a>.
</dd>
<dt>
<span class="term">
<em>saml</em>
</span>
</dt>
<dd>
A realm that facilitates authentication using the SAML 2.0 Web SSO protocol.
This realm is designed to support authentication through Kibana and is not
intended for use in the REST API. See <a class="xref" href="setting-up-authentication.html#saml-realm" title="SAML authentication">SAML authentication</a>.
</dd>
<dt>
<span class="term">
<em>kerberos</em>
</span>
</dt>
<dd>
A realm that authenticates a user using Kerberos authentication. Users are
authenticated on the basis of Kerberos tickets. See <a class="xref" href="setting-up-authentication.html#kerberos-realm" title="Kerberos authentication">Kerberos authentication</a>.
</dd>
<dt>
<span class="term">
<em>oidc</em>
</span>
</dt>
<dd>
A realm that facilitates authentication using OpenID Connect. It enables Elasticsearch to serve as an OpenID Connect Relying Party (RP) and provide single sign-on (SSO) support in Kibana. See <a class="xref" href="setting-up-authentication.html#oidc-guide" title="Configuring single sign-on to the Elastic Stack using OpenID Connect">Configuring single sign-on to the Elastic Stack using OpenID Connect</a>.
</dd>
<dt>
<span class="term">
<em>jwt</em>
</span>
</dt>
<dd>
A realm that facilitates using JWT identity tokens as authentication bearer tokens.
Compatible tokens are OpenID Connect ID Tokens, or custom JWTs containing the same claims.
See <a class="xref" href="setting-up-authentication.html#jwt-auth-realm" title="JWT authentication">JWT authentication</a>.
</dd>
</dl>
</div>
<p>The security features also support custom realms. If you need to integrate
with another authentication system, you can build a custom realm plugin. For
more information, see <a class="xref" href="setting-up-authentication.html#custom-realms" title="Integrating with other authentication systems">Integrating with other authentication systems</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_internal_and_external_realms"></a>Internal and external realms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/realms.asciidoc">edit</a></h3>
</div></div></div>
<p>Realm types can roughly be classified in two categories:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Internal
</span>
</dt>
<dd>
Realms that are internal to Elasticsearch and don&#8217;t require any
communication with external parties. They are fully managed by the Elastic Stack
security features. There can only be a maximum of one configured realm per
internal realm type. The security features provide two internal realm
types: <code class="literal">native</code> and <code class="literal">file</code>.
</dd>
<dt>
<span class="term">
External
</span>
</dt>
<dd>
Realms that require interaction with parties/components external to
Elasticsearch, typically, with enterprise grade identity management systems. Unlike
internal realms, there can be as many external realms as one would like - each
with its own unique name and configuration. The security features provide the
following external realm types: <code class="literal">ldap</code>, <code class="literal">active_directory</code>, <code class="literal">saml</code>, <code class="literal">kerberos</code>,
and <code class="literal">pki</code>.
</dd>
</dl>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="realm-chains"></a>Realm chains<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/realm-chains.asciidoc">edit</a></h2>
</div></div></div>
<p><a class="xref" href="setting-up-authentication.html#realms" title="Realms">Realms</a> live within a <em>realm chain</em>. It is essentially a prioritized
list of configured realms (typically of various types). Realms are consulted in
ascending order (that is to say, the realm with the lowest <code class="literal">order</code> value is
consulted first). You must make sure each configured realm has a distinct
<code class="literal">order</code> setting. In the event that two or more realms have the same <code class="literal">order</code>,
the node will fail to start.</p>
<p>During the authentication process, Elastic Stack security features consult and try
to authenticate the request one realm at a time. Once one of the realms
successfully authenticates the request, the authentication is considered to be
successful. The authenticated user is associated with the request, which then
proceeds to the authorization phase. If a realm cannot authenticate the request,
the next realm in the chain is consulted. If all realms in the chain cannot
authenticate the request, the authentication is considered to be unsuccessful
and an authentication error is returned (as HTTP status code <code class="literal">401</code>).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Some systems (e.g. Active Directory) have a temporary lock-out period
after several successive failed login attempts. If the same username exists in
multiple realms, unintentional account lockouts are possible. For more
information, see <a class="xref" href="security-troubleshooting.html#trouble-shoot-active-directory" title="Users are frequently locked out of Active Directory">Users are frequently locked out of Active Directory</a>.</p>
</div>
</div>
<p>The default realm chain contains the <code class="literal">file</code> and <code class="literal">native</code> realms. To explicitly
configure a realm chain, you specify the chain in the <code class="literal">elasticsearch.yml</code> file.
If your realm chain does not contain <code class="literal">file</code> or <code class="literal">native</code> realm or does not disable
them explicitly, <code class="literal">file</code> and <code class="literal">native</code> realms will be added automatically to the
beginning of the realm chain in that order. To opt-out from the automatic behaviour,
you can explicitly configure the <code class="literal">file</code> and <code class="literal">native</code> realms with the <code class="literal">order</code>
and <code class="literal">enabled</code> settings.</p>
<p>The following snippet configures a realm chain that enables the <code class="literal">file</code> realm
as well as two LDAP realms and an Active Directory realm, but disables the
<code class="literal">native</code> realm.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms:
  file.file1:
      order: 0

  ldap.ldap1:
      order: 1
      enabled: false
      url: 'url_to_ldap1'
      ...

  ldap.ldap2:
      order: 2
      url: 'url_to_ldap2'
      ...

  active_directory.ad1:
      order: 3
      url: 'url_to_ad'

  native.native1:
      enabled: false</pre>
</div>
<p>As can be seen above, each realm has a unique name that identifies it. Each type
of realm dictates its own set of required and optional settings. That said,
there are
<a class="xref" href="settings.html#ref-realm-settings" title="Settings valid for all realms">settings that are common to all realms</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="authorization_realms"></a>Delegating authorization to another realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/realm-chains.asciidoc">edit</a></h3>
</div></div></div>
<p>Some realms have the ability to perform <em>authentication</em> internally, but
delegate the lookup and assignment of roles (that is, <em>authorization</em>) to
another realm.</p>
<p>For example, you may wish to use a PKI realm to authenticate your users with
TLS client certificates, then lookup that user in an LDAP realm and use their
LDAP group assignments to determine their roles in Elasticsearch.</p>
<p>Any realm that supports retrieving users (without needing their credentials) can
be used as an <em>authorization realm</em> (that is, its name may appear as one of the
values in the list of <code class="literal">authorization_realms</code>). See <a class="xref" href="setting-up-authentication.html#user-lookup" title="Looking up users without authentication">Looking up users without authentication</a> for
further explanation on which realms support this.</p>
<p>For realms that support this feature, it can be enabled by configuring the
<code class="literal">authorization_realms</code> setting on the authenticating realm. Check the list of
<a class="xref" href="settings.html#realm-settings" title="Realm settings">supported settings</a> for each realm
to see if they support the <code class="literal">authorization_realms</code> setting.</p>
<p>If delegated authorization is enabled for a realm, it authenticates the user in
its standard manner (including relevant caching) then looks for that user in the
configured list of authorization realms. It tries each realm in the order they
are specified in the <code class="literal">authorization_realms</code> setting. The user is retrieved by
principal - the user must have identical usernames in the <em>authentication</em> and
<em>authorization realms</em>. If the user cannot be found in any of the authorization
realms, authentication fails.</p>
<p>See <a class="xref" href="authorization.html#configuring-authorization-delegation" title="Configuring authorization delegation">Configuring authorization delegation</a> for more details.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Delegated authorization requires that you have a
<a href="https://www.elastic.co/subscriptions" class="ulink" target="_top">subscription</a> that includes custom authentication and
authorization realms.</p>
</div>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="security-domain"></a>Security domains<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/security-domain.asciidoc">edit</a></h2>
</div></div></div>
<p>Security domains are a method of grouping multiple <a class="xref" href="setting-up-authentication.html#realms" title="Realms">realms</a> under the
same domain so that the Elastic Stack can recognize when a single user authenticates
with these realms. Users can authenticate with any of the realms in the domain
group, and have access to the same set of resources regardless of which realm
they authenticated with.</p>
<p>For example, a single <a class="xref" href="setting-up-authentication.html#user-profile" title="User profiles">user profile</a> is associated with a user,
enabling preferences, notifications, and other user data to be shared across
realms. The user can view results from an asynchronous search request or a
scrolling search across realms. If the user has the necessary privileges, they
can also view and manage API keys across realms.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="security-domain-resource-sharing"></a>Resource sharing across domains<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/security-domain.asciidoc">edit</a></h3>
</div></div></div>
<p>Some types of resources in Elasticsearch are owned by a single user, such as
<a class="xref" href="search.html#async-search" title="Async search">async search contexts</a>, <a class="xref" href="security-api.html#security-api-create-api-key" title="Create API key API">API keys</a>,
and <a class="xref" href="setting-up-authentication.html#user-profile" title="User profiles">user profiles</a>. When a user creates a resource, Elasticsearch
captures the user&#8217;s username and realm information as part of the resource&#8217;s
metadata. Likewise, if a user updates a resource, such as an API key,
Elasticsearch automatically re-captures the user&#8217;s current realm information.</p>
<p>When a user later attempts to access the resource, Elasticsearch compares
the captured username and realm information against those from the accessing
user. Elasticsearch will deny access unless both the realm and username match.
If Elasticsearch detects that a username from two different realms is
attempting to access a resource, Elasticsearch assumes that these users are distinct and
doesn&#8217;t allow resources to be shared between those users.</p>
<p>However, there are cases where the same user can authenticate with
multiple realms and needs to share the same set of resources across realms.
For example, an <a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication">LDAP realm</a> and a <a class="xref" href="setting-up-authentication.html#saml-realm" title="SAML authentication">SAML realm</a> can
be backed by the same directory service. Additionally,
<a class="xref" href="authorization.html#configuring-authorization-delegation" title="Configuring authorization delegation">authorization delegation</a> allows one
realm to delegate authorization to another realm. If both realms authenticate
users with the same username, it&#8217;s reasonable to treat these users as the
same user from a resource ownership perspective.</p>
<p>Security domains make resource sharing across realms possible by grouping those
realms under the same domain. Elasticsearch always enforces the privileges that are
associated with the currently authenticated user, which remains true with
security domains. Security domains don&#8217;t bypass
<a class="xref" href="authorization.html" title="User authorization">user authorization</a> when resource sharing requires them. For
example, a user requires the <code class="literal">manage_own_api_key</code> privilege to manage their own
API keys. If that user doesn&#8217;t have this privilege when authenticating with one
realm, they won&#8217;t be able to manage API keys while authenticating with another
realm.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="security-domain-realm-roles"></a>Managing roles across realms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/security-domain.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch provides multiple ways to consistently apply roles across realms. For example, you can use
<a class="xref" href="authorization.html#configuring-authorization-delegation" title="Configuring authorization delegation">authorization delegation</a> to
ensure that a user is assigned the same roles from multiple realms. You can also
manually configure multiple realms that are backed by the same directory service.
Though it&#8217;s possible to configure different <a class="xref" href="authorization.html#roles" title="Role-based access control">roles</a> for the same user
when authenticating with different realms, it is <em>not</em> recommended.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="security-domain-configure"></a>Configure a security domain<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/security-domain.asciidoc">edit</a></h3>
</div></div></div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<a id="security-domain-warning"></a>
<p>Security domains are an advanced feature that requires careful configuration.
Misconfiguration or misuse can lead to unexpected behaviors.</p>
</div>
</div>
<p>Security domains must be configured consistently across all nodes in cluster.
Inconsistent configuration can lead to issues such as:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Duplicated user profiles
</li>
<li class="listitem">
Different ownership of resources depending on the authenticating node&#8217;s configuration
</li>
</ul>
</div>
<p>To configure a security domain:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a security domain configuration to <code class="literal">elasticsearch.yml</code> in the
<code class="literal">xpack.security.authc.domains</code> namespace:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      domains:
        my_domain:
          realms: [ 'default_native', 'saml1' ] <a id="CO562-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO562-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This configuration defines a security domain called <code class="literal">my_domain</code>, which
contains two realms named <code class="literal">default_native</code> and <code class="literal">saml1</code>.</p>
</td>
</tr>
</table>
</div>
<p>The specified realms must be defined in <code class="literal">elasticsearch.yml</code>,
but do not need to be enabled.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <a class="xref" href="setting-up-authentication.html#file-realm" title="File-based user authentication">file realm</a> and <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">native realm</a> are
automatically enabled as <code class="literal">default_file</code> and <code class="literal">default_native</code>, respectively,
without any explicit configuration. You can list these realms under domains even
when they are not explicitly defined in <code class="literal">elasticsearch.yml</code>.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Restart Elasticsearch.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Elasticsearch can fail to start if the domain configuration is invalid, such as:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The same realm is configured under multiple domains.
</li>
<li class="listitem">
Any undefined realm, synthetic realm, or the reserved realm is configured to
be under a domain.
</li>
</ul>
</div>
</div>
</div>
</li>
<li class="listitem">
<p>Apply the same configuration across all nodes in the cluster
before performing operations related to security domains,
including creating and managing resources such as
<a class="xref" href="setting-up-authentication.html#user-profile" title="User profiles">user profiles</a>, <a class="xref" href="security-api.html#security-api-create-api-key" title="Create API key API">API keys</a>, and <a class="xref" href="search.html#async-search" title="Async search">async search</a>.</p>
<p>When adding realms to a security domain, avoid authenticating with a newly-added realm until changes are fully applied to all nodes.</p>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="security-domain-remove-realm"></a>Removing realms from a security domain<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/security-domain.asciidoc">edit</a></h3>
</div></div></div>
<p>Removing realms from a security domain can lead to unexpected behaviors
and is not recommended.
Resources created or updated before the removal can be owned by different users depending on the resource type:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#user-profile" title="User profiles">User profiles</a> are owned by the user for whom the profile was last
<a class="xref" href="security-api.html#security-api-activate-user-profile" title="Activate user profile API">activated</a>.
For users whose realms are no longer in the same domain as the owner user, a new user profile
will be created for them next time the activate user profile API is called.
</li>
<li class="listitem">
An API key is owned by the user who originally <a class="xref" href="security-api.html#security-api-create-api-key" title="Create API key API">created</a> or last <a class="xref" href="security-api.html#security-api-update-api-key" title="Update API key API">updated</a> it.
Users, including the original creator of the API key, will lose ownership if their realms are no longer in the same domain as those of the current API key owner.
</li>
<li class="listitem">
Resources such as async search contexts are owned by the user who originally created them.
</li>
</ul>
</div>
<p>Instead of removing realms, consider disabling them and keeping them as part of the security domain.
Under all circumstances, resource sharing across realms is only possible between users with the same username.</p>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="active-directory-realm"></a>Active Directory user authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/active-directory-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>You can configure Elastic Stack security features to communicate with Active
Directory to authenticate users. See <a class="xref" href="setting-up-authentication.html#ad-realm-configuration" title="Configuring an Active Directory realm">Configuring an Active Directory realm</a>.</p>
<p>The security features use LDAP to communicate with Active Directory, so
<code class="literal">active_directory</code> realms are similar to <a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication"><code class="literal">ldap</code> realms</a>. Like
LDAP directories, Active Directory stores users and groups hierarchically. The
directory&#8217;s hierarchy is built from containers such as the <em>organizational unit</em>
(<code class="literal">ou</code>), <em>organization</em> (<code class="literal">o</code>), and <em>domain component</em> (<code class="literal">dc</code>).</p>
<p>The path to an entry is a <em>Distinguished Name</em> (DN) that uniquely identifies a
user or group. User and group names typically have attributes such as a
<em>common name</em> (<code class="literal">cn</code>) or <em>unique ID</em> (<code class="literal">uid</code>). A DN is specified as a string, for
example <code class="literal">"cn=admin,dc=example,dc=com"</code> (white spaces are ignored).</p>
<p>The security features supports only Active Directory security groups. You
cannot map distribution groups to roles.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you use Active Directory for authentication, the username entered by
      the user is expected to match the <code class="literal">sAMAccountName</code> or <code class="literal">userPrincipalName</code>,
      not the common name.</p>
</div>
</div>
<p>The Active Directory realm authenticates users using an LDAP bind request. After
authenticating the user, the realm then searches to find the user&#8217;s entry in
Active Directory. Once the user has been found, the Active Directory realm then
retrieves the user&#8217;s group memberships from the <code class="literal">tokenGroups</code> attribute on the
user&#8217;s entry in Active Directory.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ad-realm-configuration"></a>Configuring an Active Directory realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/active-directory-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>To integrate with Active Directory, you configure an <code class="literal">active_directory</code>
realm and map Active Directory users and groups to roles in the role mapping file.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a realm configuration of type <code class="literal">active_directory</code> to <code class="literal">elasticsearch.yml</code>
under the <code class="literal">xpack.security.authc.realms.active_directory</code> namespace.
At a minimum, you must specify the Active Directory <code class="literal">domain_name</code> and <code class="literal">order</code>.</p>
<p>See <a class="xref" href="settings.html#ref-ad-settings" title="Active Directory realm settings">Active Directory realm settings</a> for all of the options you can set for an
<code class="literal">active_directory</code> realm.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Binding to Active Directory fails if the domain name is not mapped in DNS.
      If DNS is not being provided by a Windows DNS server, add a mapping for
      the domain in the local <code class="literal">/etc/hosts</code> file.</p>
</div>
</div>
<p>For example, the following realm configuration configures Elasticsearch to connect
to <code class="literal">ldaps://example.com:636</code> to authenticate users through Active Directory:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        active_directory:
          my_ad:
            order: 0 <a id="CO563-1"></a><i class="conum" data-value="1"></i>
            domain_name: ad.example.com
            url: ldaps://ad.example.com:636 <a id="CO563-2"></a><i class="conum" data-value="2"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO563-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The realm order controls the order in which the configured realms are checked
when authenticating a user.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO563-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>If you don&#8217;t specify the URL, it defaults to <code class="literal">ldap:&lt;domain_name&gt;:389</code>.</p>
</td>
</tr>
</table>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you configure realms in <code class="literal">elasticsearch.yml</code>, only the
realms you specify are used for authentication. If you also want to use the
<code class="literal">native</code> or <code class="literal">file</code> realms, you must include them in the realm chain.</p>
</div>
</div>
</li>
<li class="listitem">
<p>If you are authenticating users across multiple domains in a forest, extra
steps are required. There are a few minor differences in the configuration and
the way that users authenticate.</p>
<p>Set the <code class="literal">domain_name</code> setting to the forest root domain name.</p>
<p>You must also set the <code class="literal">url</code> setting, since you must authenticate against the
Global Catalog, which uses a different port and might not be running on every
Domain Controller.</p>
<p>For example, the following realm configuration configures Elasticsearch to connect
to specific Domain Controllers on the Global Catalog port with the domain name
set to the forest root:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        active_directory:
          my_ad:
            order: 0
            domain_name: example.com <a id="CO564-1"></a><i class="conum" data-value="1"></i>
            url: ldaps://dc1.ad.example.com:3269, ldaps://dc2.ad.example.com:3269 <a id="CO564-2"></a><i class="conum" data-value="2"></i>
            load_balance:
              type: "round_robin" <a id="CO564-3"></a><i class="conum" data-value="3"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO564-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">domain_name</code> is set to the name of the root domain in the forest.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO564-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">url</code> value used in this example has URLs for two different Domain Controllers,
which are also Global Catalog servers. Port 3268 is the default port for unencrypted
communication with the Global Catalog; port 3269 is the default port for SSL connections.
The servers that are being connected to can be in any domain of the forest as long as
they are also Global Catalog servers.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO564-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>A load balancing setting is provided to indicate the desired behavior when choosing
the server to connect to.</p>
</td>
</tr>
</table>
</div>
<p>In this configuration, users will need to use either their full User Principal
Name (UPN) or their Down-Level Logon Name. A UPN is typically a concatenation of
the username with <code class="literal">@&lt;DOMAIN_NAME</code> such as <code class="literal">johndoe@ad.example.com</code>. The Down-Level
Logon Name is the NetBIOS domain name, followed by a <code class="literal">\</code> and the username, such as
<code class="literal">AD\johndoe</code>. Use of Down-Level Logon Name requires a connection to the regular LDAP
ports (389 or 636) in order to query the configuration container to retrieve the
domain name from the NetBIOS name.</p>
</li>
<li class="listitem">
<p>(Optional) Configure how Elasticsearch should interact with multiple Active
Directory servers.</p>
<p>The <code class="literal">load_balance.type</code> setting can be used at the realm level. Two modes of
operation are supported: failover and load balancing. See <a class="xref" href="settings.html#ref-ad-settings" title="Active Directory realm settings">Active Directory realm settings</a>.</p>
</li>
<li class="listitem">
(Optional) To protect passwords,
<a class="xref" href="setting-up-authentication.html#tls-active-directory" title="Encrypting communications between Elasticsearch and Active Directory">encrypt communications between Elasticsearch and the Active Directory server</a>.
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
<li class="listitem">
<p>(Optional) Configure a bind user.</p>
<p>The Active Directory realm authenticates users using an LDAP bind request. By
default, all of the LDAP operations are run by the user that Elasticsearch is
authenticating. In some cases, regular users may not be able to access all of the
necessary items within Active Directory and a <em>bind user</em> is needed. A bind user
can be configured and is used to perform all operations other than the LDAP bind
request, which is required to authenticate the credentials provided by the user.</p>
<p>The use of a bind user enables the
<a class="xref" href="authorization.html#run-as-privilege" title="Submitting requests on behalf of other users">run as feature</a> to be used with the Active
Directory realm and the ability to maintain a set of pooled connections to
Active Directory. These pooled connection reduce the number of resources that
must be created and destroyed with every user authentication.</p>
<p>The following example shows the configuration of a bind user through the user of
the <code class="literal">bind_dn</code> and <code class="literal">secure_bind_password</code> settings:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        active_directory:
          my_ad:
            order: 0
            domain_name: ad.example.com
            url: ldaps://ad.example.com:636
            bind_dn: es_svc_user@ad.example.com <a id="CO565-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO565-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This is the user that all Active Directory search requests are executed as.
Without a bind user configured, all requests run as the user that is authenticating
with Elasticsearch.</p>
</td>
</tr>
</table>
</div>
<p>The password for the <code class="literal">bind_dn</code> user should be configured by adding the
appropriate <code class="literal">secure_bind_password</code> setting to the Elasticsearch keystore. For example,
the following command adds the password for the example realm above:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add  \
xpack.security.authc.realms.active_directory.my_ad.secure_bind_password</pre>
</div>
<p>When a bind user is configured, connection pooling is enabled by default.
Connection pooling can be disabled using the <code class="literal">user_search.pool.enabled</code> setting.</p>
</li>
<li class="listitem">
<p>Map Active Directory users and groups to roles.</p>
<p>An integral part of a realm authentication process is to resolve the roles
associated with the authenticated user. Roles define the privileges a user has
in the cluster.</p>
<p>Since with the <code class="literal">active_directory</code> realm the users are managed externally in the
Active Directory server, the expectation is that their roles are managed there
as well. In fact, Active Directory supports the notion of groups, which often
represent user roles for different systems in the organization.</p>
<p>The <code class="literal">active_directory</code> realm enables you to map Active Directory users to roles
via their Active Directory groups or other metadata. This role mapping can be
configured via the <a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">role-mapping APIs</a> or by using
a file stored on each node. When a user authenticates against an Active
Directory realm, the privileges for that user are the union of all privileges
defined by the roles to which the user is mapped.</p>
<p>Within a mapping definition, you specify groups using their distinguished
names. For example, the following mapping configuration maps the Active
Directory <code class="literal">admins</code> group to both the <code class="literal">monitoring</code> and <code class="literal">user</code> roles, maps the
<code class="literal">users</code> group to the <code class="literal">user</code> role and maps the <code class="literal">John Doe</code> user to the <code class="literal">user</code>
role.</p>
<p>Configured via the role-mapping API:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/admins
{
  "roles" : [ "monitoring" , "user" ],
  "rules" : { "field" : {
    "groups" : "cn=admins,dc=example,dc=com" <a id="CO566-1"></a><i class="conum" data-value="1"></i>
  } },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1792.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO566-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Active Directory distinguished name (DN) of the <code class="literal">admins</code> group.</p>
</td>
</tr>
</table>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/basic_users
{
  "roles" : [ "user" ],
  "rules" : { "any": [
    { "field" : {
      "groups" : "cn=users,dc=example,dc=com" <a id="CO567-1"></a><i class="conum" data-value="1"></i>
    } },
    { "field" : {
      "dn" : "cn=John Doe,cn=contractors,dc=example,dc=com" <a id="CO567-2"></a><i class="conum" data-value="2"></i>
    } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1793.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO567-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Active Directory distinguished name (DN) of the <code class="literal">users</code> group.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO567-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Active Directory distinguished name (DN) of the user <code class="literal">John Doe</code>.</p>
</td>
</tr>
</table>
</div>
<p>Or, alternatively, configured via the role-mapping file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">monitoring: <a id="CO568-1"></a><i class="conum" data-value="1"></i>
  - "cn=admins,dc=example,dc=com" <a id="CO568-2"></a><i class="conum" data-value="2"></i>
user:
  - "cn=users,dc=example,dc=com" <a id="CO568-3"></a><i class="conum" data-value="3"></i>
  - "cn=admins,dc=example,dc=com"
  - "cn=John Doe,cn=contractors,dc=example,dc=com" <a id="CO568-4"></a><i class="conum" data-value="4"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO568-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the role.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO568-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Active Directory distinguished name (DN) of the <code class="literal">admins</code> group.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO568-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Active Directory distinguished name (DN) of the <code class="literal">users</code> group.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO568-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The Active Directory distinguished name (DN) of the user <code class="literal">John Doe</code>.</p>
</td>
</tr>
</table>
</div>
<p>For more information, see
<a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">Mapping users and groups to roles</a>.</p>
</li>
<li class="listitem">
<p>(Optional) Configure the <code class="literal">metadata</code> setting in the Active Directory realm to
include extra properties in the user&#8217;s metadata.</p>
<p>By default, <code class="literal">ldap_dn</code> and <code class="literal">ldap_groups</code> are populated in the user&#8217;s metadata.
For more information, see
<a class="xref" href="setting-up-authentication.html#ad-user-metadata" title="User metadata in Active Directory realms">User metadata in Active Directory realms</a>.</p>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ad-user-metadata"></a>User metadata in Active Directory realms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/active-directory-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>When a user is authenticated via an Active Directory realm, the following
properties are populated in the user&#8217;s <em>metadata</em>:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Field</p></td>
<td align="left" valign="top"><p>Description</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ldap_dn</code></p></td>
<td align="left" valign="top"><p>The distinguished name of the user.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ldap_groups</code></p></td>
<td align="left" valign="top"><p>The distinguished name of each of the groups that were
                        resolved for the user (regardless of whether those
                        groups were mapped to a role).</p></td>
</tr>
</tbody>
</table>
</div>
<p>This metadata is returned in the
<a class="xref" href="security-api.html#security-api-authenticate" title="Authenticate API">authenticate API</a> and can be used with
<a class="xref" href="authorization.html#templating-role-query" title="Templating a role query">templated queries</a> in roles.</p>
<p>Additional metadata can be extracted from the Active Directory server by configuring
the <code class="literal">metadata</code> setting on the Active Directory realm.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ad-load-balancing"></a>Load balancing and failover<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/active-directory-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">load_balance.type</code> setting can be used at the realm level to configure how
the security features should interact with multiple Active Directory servers.
Two modes of operation are supported: failover and load balancing.</p>
<p>See
<a class="xref" href="settings.html#load-balancing" title="Load balancing and failover">Load balancing and failover</a>.</p>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h3 class="title"><a id="tls-active-directory"></a>Encrypting communications between Elasticsearch and Active Directory<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/securing-communications/tls-ad.asciidoc">edit</a></h3>
</div></div></div>
<p>To protect the user credentials that are sent for authentication, it&#8217;s highly
recommended to encrypt communications between Elasticsearch and your Active Directory
server. Connecting via SSL/TLS ensures that the identity of the Active Directory
server is authenticated before Elasticsearch transmits the user credentials and the
usernames and passwords are encrypted in transit.</p>
<p>Clients and nodes that connect via SSL/TLS to the Active Directory server need
to have the Active Directory server&#8217;s certificate or the server&#8217;s root CA
certificate installed in their keystore or truststore.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Create the realm configuration for the <code class="literal">xpack.security.authc.realms</code> namespace
in the <code class="literal">elasticsearch.yml</code> file. See <a class="xref" href="setting-up-authentication.html#ad-realm-configuration" title="Configuring an Active Directory realm">Configuring an Active Directory realm</a>.
</li>
<li class="listitem">
Set the <code class="literal">url</code> attribute in the realm configuration to specify the LDAPS protocol
and the secure port number. For example, <code class="literal">url: ldaps://ad.example.com:636</code>.
</li>
<li class="listitem">
<p>Configure each node to trust certificates signed by the certificate authority
(CA) that signed your Active Directory server certificates.</p>
<p>The following example demonstrates how to trust a CA certificate (<code class="literal">cacert.pem</code>),
which is located within the configuration directory:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">xpack:
  security:
    authc:
      realms:
        active_directory:
          ad_realm:
            order: 0
            domain_name: ad.example.com
            url: ldaps://ad.example.com:636
            ssl:
              certificate_authorities: [ "ES_PATH_CONF/cacert.pem" ]</pre>
</div>
<p>The CA cert must be a PEM encoded certificate.</p>
<p>For more information about these settings, see <a class="xref" href="settings.html#ref-ad-settings" title="Active Directory realm settings">Active Directory realm settings</a>.</p>
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>By default, when you configure Elasticsearch to connect to Active Directory
      using SSL/TLS, it attempts to verify the hostname or IP address
      specified with the <code class="literal">url</code> attribute in the realm configuration with the
      values in the certificate. If the values in the certificate and realm
      configuration do not match, Elasticsearch does not allow a connection to the
      Active Directory server. This is done to protect against man-in-the-middle
      attacks. If necessary, you can disable this behavior by setting the
      <code class="literal">ssl.verification_mode</code> property to <code class="literal">certificate</code>.</p>
</div>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="file-realm"></a>File-based user authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/file-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>You can manage and authenticate users with the built-in <code class="literal">file</code> realm.
With the <code class="literal">file</code> realm, users are defined in local files on each node in the cluster.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>As the administrator of the cluster, it is your responsibility to
ensure the same users are defined on every node in the cluster. The Elastic Stack
security features do not deliver any mechanism to guarantee this. You should
also be aware that you cannot add or manage users in the <code class="literal">file</code> realm via the
<a class="xref" href="security-api.html#security-user-apis" title="Users">user APIs</a> and you cannot add or manage them in Kibana on the
<span class="strong strong"><strong>Management / Security / Users</strong></span> page</p>
</div>
</div>
<p>The <code class="literal">file</code> realm is very useful as a fallback or recovery realm. For example in cases where
the cluster is unresponsive or the security index is unavailable, or when you forget the
password for your administrative users.
In this type of scenario, the <code class="literal">file</code> realm is a convenient way out - you can
define a new <code class="literal">admin</code> user in the <code class="literal">file</code> realm and use it to log in and reset the
credentials of all other users.</p>
<p>To define users, the security features provide the
<a class="xref" href="users-command.html" title="elasticsearch-users">users</a> command-line tool. This tool enables you to add
and remove users, assign user roles, and manage user passwords.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="file-realm-configuration"></a>Configuring a file realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/file-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>You don&#8217;t need to explicitly configure a <code class="literal">file</code> realm. The <code class="literal">file</code> and <code class="literal">native</code>
realms are added to the realm chain by default. Unless configured otherwise, the
<code class="literal">file</code> realm is added first, followed by the <code class="literal">native</code> realm.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>While it is possible to define multiple instances of some other
realms, you can define only <em>one</em> <code class="literal">file</code> realm per node.</p>
</div>
</div>
<p>All the data about the users for the <code class="literal">file</code> realm is stored in two files on each
node in the cluster: <code class="literal">users</code> and <code class="literal">users_roles</code>. Both files are located in
<code class="literal">ES_PATH_CONF</code> and are read on startup.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">users</code> and <code class="literal">users_roles</code> files are managed locally by the node and are
<span class="strong strong"><strong>not</strong></span> managed globally by the cluster. This means that with a typical
multi-node cluster, the exact same changes need to be applied on each and every
node in the cluster.</p>
<p>A safer approach would be to apply the change on one of the nodes and have the
files distributed or copied to all other nodes in the cluster (either manually
or using a configuration management system such as Puppet or Chef).</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>(Optional) Add a realm configuration to <code class="literal">elasticsearch.yml</code> under the
<code class="literal">xpack.security.authc.realms.file</code> namespace. At a minimum, you must set
the realm&#8217;s <code class="literal">order</code> attribute.</p>
<p>For example, the following snippet shows a <code class="literal">file</code> realm configuration that sets
the <code class="literal">order</code> to zero so the realm is checked first:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        file:
          file1:
            order: 0</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can configure only one file realm on Elasticsearch nodes.</p>
</div>
</div>
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
<li class="listitem">
<p>Add user information to the <code class="literal">ES_PATH_CONF/users</code> file on each node in the
cluster.</p>
<p>The <code class="literal">users</code> file stores all the users and their passwords. Each line in the file
represents a single user entry consisting of the username and <span class="strong strong"><strong>hashed</strong></span> and <span class="strong strong"><strong>salted</strong></span> password.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">rdeniro:$2a$10$BBJ/ILiyJ1eBTYoRKxkqbuDEdYECplvxnqQ47uiowE7yGqvCEgj9W
alpacino:$2a$10$cNwHnElYiMYZ/T3K4PvzGeJ1KbpXZp2PfoQD.gfaVdImnHOwIuBKS
jacknich:{PBKDF2}50000$z1CLJt0MEFjkIK5iEfgvfnA6xq7lF25uasspsTKSo5Q=$XxCVLbaKDimOdyWgLCLJiyoiWpA/XDMe/xtVgn1r5Sg=</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To limit exposure to credential theft and mitigate credential compromise,
the file realm stores passwords and caches user credentials according to
security best practices. By default, a hashed version of user credentials
is stored in memory, using a salted <code class="literal">sha-256</code> hash algorithm and a hashed
version of passwords is stored on disk salted and hashed with the <code class="literal">bcrypt</code>
hash algorithm. To use different hash algorithms, see <a class="xref" href="settings.html#hashing-settings" title="User cache and password hash algorithms">User cache and password hash algorithms</a>.</p>
</div>
</div>
<p>While it is possible to modify the <code class="literal">users</code> files directly using any standard text
editor, we strongly recommend using the <a class="xref" href="users-command.html" title="elasticsearch-users"><em>elasticsearch-users</em></a> tool to apply the
required changes.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>As the administrator of the cluster, it is your responsibility to
            ensure the same users are defined on every node in the cluster.
            The Elasticsearch security features do not deliver any mechanisms to
            guarantee this.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Add role information to the <code class="literal">ES_PATH_CONF/users_roles</code> file on each node
in the cluster.</p>
<p>The <code class="literal">users_roles</code> file stores the roles associated with the users. For example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">admin:rdeniro
power_user:alpacino,jacknich
user:jacknich</pre>
</div>
<p>Each row maps a role to a comma-separated list of all the users that are
associated with that role.</p>
<p>You can use the <a class="xref" href="users-command.html" title="elasticsearch-users"><em>elasticsearch-users</em></a> tool to update this file. You must ensure that
the same changes are made on every node in the cluster.</p>
</li>
<li class="listitem">
<p>(Optional) Change how often the <code class="literal">users</code> and <code class="literal">users_roles</code> files are checked.</p>
<p>By default, Elasticsearch checks these files for changes every 5 seconds. You can
change this default behavior by changing the <code class="literal">resource.reload.interval.high</code>
setting in the <code class="literal">elasticsearch.yml</code> file (as this is a common setting in Elasticsearch,
changing its value may effect other schedules in the system).</p>
</li>
</ol>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ldap-realm"></a>LDAP user authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/ldap-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>You can configure the Elastic Stack security features to communicate with a
Lightweight Directory Access Protocol (LDAP) server to authenticate users. See
<a class="xref" href="setting-up-authentication.html#ldap-realm-configuration" title="Configuring an LDAP realm">Configuring an LDAP realm</a>.</p>
<p>LDAP stores users and groups hierarchically, similar to the way folders are
grouped in a file system. An LDAP directory&#8217;s hierarchy is built from containers
such as the <em>organizational unit</em> (<code class="literal">ou</code>), <em>organization</em> (<code class="literal">o</code>), and
<em>domain component</em> (<code class="literal">dc</code>).</p>
<p>The path to an entry is a <em>Distinguished Name</em> (DN) that uniquely identifies a
user or group. User and group names typically have attributes such as a
<em>common name</em> (<code class="literal">cn</code>) or <em>unique ID</em> (<code class="literal">uid</code>). A DN is specified as a string,
for example  <code class="literal">"cn=admin,dc=example,dc=com"</code> (white spaces are ignored).</p>
<p>The <code class="literal">ldap</code> realm supports two modes of operation, a user search mode
and a mode with specific templates for user DNs.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="mapping-roles-ldap"></a>Mapping LDAP groups to roles<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/ldap-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>An integral part of a realm authentication process is to resolve the roles
associated with the authenticated user. Roles define the privileges a user has
in the cluster.</p>
<p>Since with the <code class="literal">ldap</code> realm the users are managed externally in the LDAP server,
the expectation is that their roles are managed there as well. In fact, LDAP
supports the notion of groups, which often represent user roles for different
systems in the organization.</p>
<p>The <code class="literal">ldap</code> realm enables you to map LDAP users to roles via their LDAP
groups or other metadata. This role mapping can be configured via the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">add role mapping API</a> or by using a
file stored on each node. When a user authenticates with LDAP, the privileges
for that user are the union of all privileges defined by the roles to which
the user is mapped.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ldap-realm-configuration"></a>Configuring an LDAP realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/ldap-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>To integrate with LDAP, you configure an <code class="literal">ldap</code> realm and map LDAP groups to
user roles.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Determine which mode you want to use. The <code class="literal">ldap</code> realm supports two modes of
operation, a user search mode and a mode with specific templates for user DNs.</p>
<p>LDAP user search is the most common mode of operation. In this mode, a specific
user with permission to search the LDAP directory is used to search for the DN
of the authenticating user based on the provided username and an LDAP attribute.
Once found, the user is authenticated by attempting to bind to the LDAP server
using the found DN and the provided password.</p>
<p>If your LDAP environment uses a few specific standard naming conditions for
users, you can use user DN templates to configure the realm. The advantage of
this method is that a search does not have to be performed to find the user DN.
However, multiple bind operations might be needed to find the correct user DN.</p>
</li>
<li class="listitem">
<p>To configure an <code class="literal">ldap</code> realm with user search:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a realm configuration to <code class="literal">elasticsearch.yml</code> under the
<code class="literal">xpack.security.authc.realms.ldap</code> namespace. At a minimum, you must specify
the <code class="literal">url</code> and <code class="literal">order</code> of the LDAP server, and set <code class="literal">user_search.base_dn</code> to the
container DN where the users are searched for.
See <a class="xref" href="settings.html#ref-ldap-settings" title="LDAP realm settings">LDAP realm settings</a> for all of the options you can set for
an <code class="literal">ldap</code> realm.</p>
<p>For example, the following snippet shows an LDAP realm configured with a user search:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        ldap:
          ldap1:
            order: 0
            url: "ldaps://ldap.example.com:636"
            bind_dn: "cn=ldapuser, ou=users, o=services, dc=example, dc=com"
            user_search:
              base_dn: "dc=example,dc=com"
              filter: "(cn={0})"
            group_search:
              base_dn: "dc=example,dc=com"
            files:
              role_mapping: "ES_PATH_CONF/role_mapping.yml"
            unmapped_groups_as_roles: false</pre>
</div>
<p>The password for the <code class="literal">bind_dn</code> user should be configured by adding the appropriate
<code class="literal">secure_bind_password</code> setting to the Elasticsearch keystore.
For example, the following command adds the password for the example realm above:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add \
xpack.security.authc.realms.ldap.ldap1.secure_bind_password</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you configure realms in <code class="literal">elasticsearch.yml</code>, only the
realms you specify are used for authentication. If you also want to use the
<code class="literal">native</code> or <code class="literal">file</code> realms, you must include them in the realm chain.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>To configure an <code class="literal">ldap</code> realm with user DN templates:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a realm configuration to <code class="literal">elasticsearch.yml</code> in the
<code class="literal">xpack.security.authc.realms.ldap</code> namespace. At a minimum, you must specify
the <code class="literal">url</code> and <code class="literal">order</code> of the LDAP server, and specify at least one template
with the <code class="literal">user_dn_templates</code> option.
See <a class="xref" href="settings.html#ref-ldap-settings" title="LDAP realm settings">LDAP realm settings</a> for all of the options you can set for an <code class="literal">ldap</code> realm.</p>
<p>For example, the following snippet shows an LDAP realm configured with user DN
templates:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        ldap:
          ldap1:
            order: 0
            url: "ldaps://ldap.example.com:636"
            user_dn_templates:
              - "cn={0}, ou=users, o=marketing, dc=example, dc=com"
              - "cn={0}, ou=users, o=engineering, dc=example, dc=com"
            group_search:
              base_dn: "dc=example,dc=com"
            files:
              role_mapping: "/mnt/elasticsearch/group_to_role_mapping.yml"
            unmapped_groups_as_roles: false</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">bind_dn</code> setting is not used in template mode.
All LDAP operations run as the authenticating user.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>(Optional) Configure how the security features interact with multiple LDAP
servers.</p>
<p>The <code class="literal">load_balance.type</code> setting can be used at the realm level. The Elasticsearch
security features support both failover and load balancing modes of operation.
See <a class="xref" href="settings.html#ref-ldap-settings" title="LDAP realm settings">LDAP realm settings</a>.</p>
</li>
<li class="listitem">
(Optional) To protect passwords,
<a class="xref" href="setting-up-authentication.html#tls-ldap" title="Encrypting communications between Elasticsearch and LDAP">encrypt communications between Elasticsearch and the LDAP server</a>.
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
<li class="listitem">
<p>Map LDAP groups to roles.</p>
<p>The <code class="literal">ldap</code> realm enables you to map LDAP users to roles via their LDAP
groups, or other metadata. This role mapping can be configured via the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">add role mapping API</a> or by using a file stored
on each node. When a user authenticates with LDAP, the privileges
for that user are the union of all privileges defined by the roles to which
the user is mapped.</p>
<p>Within a mapping definition, you specify groups using their distinguished
names. For example, the following mapping configuration maps the LDAP
<code class="literal">admins</code> group to both the <code class="literal">monitoring</code> and <code class="literal">user</code> roles, and maps the
<code class="literal">users</code> group to the <code class="literal">user</code> role.</p>
<p>Configured via the role-mapping API:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/admins
{
  "roles" : [ "monitoring" , "user" ],
  "rules" : { "field" : {
    "groups" : "cn=admins,dc=example,dc=com" <a id="CO569-1"></a><i class="conum" data-value="1"></i>
  } },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1794.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO569-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The LDAP distinguished name (DN) of the <code class="literal">admins</code> group.</p>
</td>
</tr>
</table>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/basic_users
{
  "roles" : [ "user" ],
  "rules" : { "field" : {
    "groups" : "cn=users,dc=example,dc=com" <a id="CO570-1"></a><i class="conum" data-value="1"></i>
  } },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1795.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO570-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The LDAP distinguished name (DN) of the <code class="literal">users</code> group.</p>
</td>
</tr>
</table>
</div>
<p>Or, alternatively, configured via the role-mapping file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">monitoring: <a id="CO571-1"></a><i class="conum" data-value="1"></i>
  - "cn=admins,dc=example,dc=com" <a id="CO571-2"></a><i class="conum" data-value="2"></i>
user:
  - "cn=users,dc=example,dc=com" <a id="CO571-3"></a><i class="conum" data-value="3"></i>
  - "cn=admins,dc=example,dc=com"</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO571-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the mapped role.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO571-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The LDAP distinguished name (DN) of the <code class="literal">admins</code> group.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO571-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The LDAP distinguished name (DN) of the <code class="literal">users</code> group.</p>
</td>
</tr>
</table>
</div>
<p>For more information, see
<a class="xref" href="setting-up-authentication.html#mapping-roles-ldap" title="Mapping LDAP groups to roles">Mapping LDAP groups to roles</a> and <a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">Mapping users and groups to roles</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The LDAP realm supports
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> as an
alternative to role mapping.</p>
</div>
</div>
</li>
<li class="listitem">
<p>(Optional) Configure the <code class="literal">metadata</code> setting on the LDAP realm to include extra
fields in the user&#8217;s metadata.</p>
<p>By default, <code class="literal">ldap_dn</code> and <code class="literal">ldap_groups</code> are populated in the user&#8217;s metadata.
For more information, see
<a class="xref" href="setting-up-authentication.html#ldap-user-metadata" title="User metadata in LDAP realms">User metadata in LDAP realms</a>.</p>
<p>The example below includes the user&#8217;s common name (<code class="literal">cn</code>) as an additional
field in their metadata.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        ldap:
          ldap1:
            order: 0
            metadata: cn</pre>
</div>
</li>
<li class="listitem">
Set up SSL to encrypt communications between Elasticsearch and LDAP. See <a class="xref" href="setting-up-authentication.html#tls-ldap" title="Encrypting communications between Elasticsearch and LDAP">Encrypting communications between Elasticsearch and LDAP</a>.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ldap-user-metadata"></a>User metadata in LDAP realms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/ldap-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>When a user is authenticated via an LDAP realm, the following properties are
populated in the user&#8217;s <em>metadata</em>:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Field</p></td>
<td align="left" valign="top"><p>Description</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ldap_dn</code></p></td>
<td align="left" valign="top"><p>The distinguished name of the user.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ldap_groups</code></p></td>
<td align="left" valign="top"><p>The distinguished name of each of the groups that were
                        resolved for the user (regardless of whether those
                        groups were mapped to a role).</p></td>
</tr>
</tbody>
</table>
</div>
<p>This metadata is returned in the
<a class="xref" href="security-api.html#security-api-authenticate" title="Authenticate API">authenticate API</a>, and can be used with
<a class="xref" href="authorization.html#templating-role-query" title="Templating a role query">templated queries</a> in roles.</p>
<p>Additional fields can be included in the user&#8217;s metadata by configuring
the <code class="literal">metadata</code> setting on the LDAP realm. This metadata is available for use
with the <a class="xref" href="authorization.html#mapping-roles-api" title="Using the role mapping API">role mapping API</a> or in
<a class="xref" href="authorization.html#templating-role-query" title="Templating a role query">templated role queries</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="ldap-load-balancing"></a>Load balancing and failover<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/ldap-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">load_balance.type</code> setting can be used at the realm level to configure how
the security features should interact with multiple LDAP servers. The
security features support both failover and load balancing modes of operation.</p>
<p>See <a class="xref" href="settings.html#load-balancing" title="Load balancing and failover">Load balancing and failover</a>.</p>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h3 class="title"><a id="tls-ldap"></a>Encrypting communications between Elasticsearch and LDAP<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/securing-communications/tls-ldap.asciidoc">edit</a></h3>
</div></div></div>
<p>To protect the user credentials that are sent for authentication in an LDAP
realm, it&#8217;s highly recommended to encrypt communications between Elasticsearch and your
LDAP server. Connecting via SSL/TLS ensures that the identity of the LDAP server
is authenticated before Elasticsearch transmits the user credentials and the
contents of the connection are encrypted. Clients and nodes that connect via
TLS to the LDAP server need to have the LDAP server&#8217;s certificate or the
server&#8217;s root CA certificate installed in their keystore or truststore.</p>
<p>For more information, see <a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication">LDAP user authentication</a>.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Configure the realm&#8217;s TLS settings on each node to trust certificates signed
by the CA that signed your LDAP server certificates. The following example
demonstrates how to trust a CA certificate, <code class="literal">cacert.pem</code>, located within the
Elasticsearch <a class="xref" href="settings.html#config-files-location" title="Config files location">configuration directory</a>:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">xpack:
  security:
    authc:
      realms:
        ldap:
          ldap1:
            order: 0
            url: "ldaps://ldap.example.com:636"
            ssl:
              certificate_authorities: [ "cacert.pem" ]</pre>
</div>
<p>In the example above, the CA certificate must be PEM encoded.</p>
<p>PKCS#12 and JKS files are also supported - see the description of
<code class="literal">ssl.truststore.path</code> in <a class="xref" href="settings.html#ref-ldap-settings" title="LDAP realm settings">LDAP realm settings</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can also specify the individual server certificates rather than the CA
certificate, but this is only recommended if you have a single LDAP server or
the certificates are self-signed.</p>
</div>
</div>
</li>
<li class="listitem">
Set the <code class="literal">url</code> attribute in the realm configuration to specify the LDAPS
protocol and the secure port number. For example, <code class="literal">url: ldaps://ldap.example.com:636</code>.
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>By default, when you configure Elasticsearch to connect to an LDAP server
      using SSL/TLS, it attempts to verify the hostname or IP address
      specified with the <code class="literal">url</code> attribute in the realm configuration with the
      values in the certificate. If the values in the certificate and realm
      configuration do not match, Elasticsearch does not allow a connection to the
      LDAP server. This is done to protect against man-in-the-middle attacks. If
      necessary, you can disable this behavior by setting the
      <code class="literal">ssl.verification_mode</code> property to <code class="literal">certificate</code>.</p>
</div>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="native-realm"></a>Native user authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/native-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>The easiest way to manage and authenticate users is with the internal <code class="literal">native</code>
realm. You can use the REST APIs or Kibana to add and remove users, assign user
roles, and manage user passwords.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="native-realm-configuration"></a>Configuring a native realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/native-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The native realm is available and enabled by default. You can disable it explicitly with the following snippet.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.native.native1:
  enabled: false</pre>
</div>
<p>You can configure a <code class="literal">native</code> realm in the <code class="literal">xpack.security.authc.realms.native</code>
namespace in <code class="literal">elasticsearch.yml</code>.
Explicitly configuring a native realm enables you to set the order in which it
appears in the realm chain, temporarily disable the realm, and control its
cache options.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a realm configuration to <code class="literal">elasticsearch.yml</code> under the
<code class="literal">xpack.security.authc.realms.native</code> namespace. It is recommended that you
explicitly set the <code class="literal">order</code> attribute for the realm.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can configure only one native realm on Elasticsearch nodes.</p>
</div>
</div>
<p>See <a class="xref" href="settings.html#ref-native-settings" title="Native realm settings">Native realm settings</a> for all of the options you can set for the <code class="literal">native</code> realm.
For example, the following snippet shows a <code class="literal">native</code> realm configuration that
sets the <code class="literal">order</code> to zero so the realm is checked first:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.native.native1:
  order: 0</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To limit exposure to credential theft and mitigate credential compromise,
the native realm stores passwords and caches user credentials according to
security best practices. By default, a hashed version of user credentials
is stored in memory, using a salted <code class="literal">sha-256</code> hash algorithm and a hashed
version of passwords is stored on disk salted and hashed with the <code class="literal">bcrypt</code>
hash algorithm. To use different hash algorithms, see <a class="xref" href="settings.html#hashing-settings" title="User cache and password hash algorithms">User cache and password hash algorithms</a>.</p>
</div>
</div>
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="managing-native-users"></a>Managing native users<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/native-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The Elastic Stack security features enable you to easily manage users in Kibana on the
<span class="strong strong"><strong>Management / Security / Users</strong></span> page.</p>
<p>Alternatively, you can manage users through the <code class="literal">user</code> API. For more
information and examples, see
<a class="xref" href="security-api.html#security-user-apis" title="Users">Users</a>.</p>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="oidc-realm"></a>OpenID Connect authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>The OpenID Connect realm enables Elasticsearch to serve as an OpenID Connect Relying
Party (RP) and provides single sign-on (SSO) support in Kibana.</p>
<p>It is specifically designed to support authentication via an interactive web
browser, so it does not operate as a standard authentication realm. Instead,
there are Kibana and Elasticsearch security features that work together to enable
interactive OpenID Connect sessions.</p>
<p>This means that the OpenID Connect realm is not suitable for use by standard
REST clients. If you configure an OpenID Connect realm for use in Kibana, you
should also configure another realm, such as the <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">native realm</a>
in your authentication chain.</p>
<p>In order to simplify the process of configuring OpenID Connect authentication
within the Elastic Stack, there is a step-by-step guide: <a class="xref" href="setting-up-authentication.html#oidc-guide" title="Configuring single sign-on to the Elastic Stack using OpenID Connect">Configuring single sign-on to the Elastic Stack using OpenID Connect</a>.</p>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="pki-realm"></a>PKI user authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/pki-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>You can configure Elasticsearch to use Public Key Infrastructure (PKI) certificates to
authenticate users. In this scenario, clients connecting directly to Elasticsearch must
present X.509 certificates. First, the certificates must be accepted for
authentication on the SSL/TLS layer on Elasticsearch. Then they are optionally
further validated by a PKI realm. See <a class="xref" href="setting-up-authentication.html#pki-realm-for-direct-clients" title="PKI authentication for clients connecting directly to Elasticsearch">PKI authentication for clients connecting directly to Elasticsearch</a>.</p>
<p>You can also use PKI certificates to authenticate to Kibana, however this
requires some additional configuration. On Elasticsearch, this configuration enables Kibana
to act as a proxy for SSL/TLS authentication and to submit the client
certificates to Elasticsearch for further validation by a PKI realm. See
<a class="xref" href="setting-up-authentication.html#pki-realm-for-proxied-clients" title="PKI authentication for clients connecting to Kibana">PKI authentication for clients connecting to Kibana</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="pki-realm-for-direct-clients"></a>PKI authentication for clients connecting directly to Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>To use PKI in Elasticsearch, you configure a PKI realm, enable client authentication on
the desired network layers (transport or http), and map the Distinguished Names
(DNs) from the Subject field in the user certificates to roles. You create the
mappings in a role mapping file or use the role mappings API.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can use a combination of PKI and username/password authentication. For
example, you can enable SSL/TLS on the transport layer and define a PKI realm to
require transport clients to authenticate with X.509 certificates, while still
authenticating HTTP traffic using username and password credentials.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add a realm configuration for a <code class="literal">pki</code> realm to <code class="literal">elasticsearch.yml</code> under the
<code class="literal">xpack.security.authc.realms.pki</code> namespace. You must explicitly set the <code class="literal">order</code>
attribute. See <a class="xref" href="settings.html#ref-pki-settings" title="PKI realm settings">PKI realm settings</a> for all of the options you can set for a
<code class="literal">pki</code> realm.</p>
<p>For example, the following snippet shows the most basic <code class="literal">pki</code> realm configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        pki:
          pki1:
            order: 1</pre>
</div>
<p>With this configuration, any certificate trusted by the Elasticsearch SSL/TLS layer is
accepted for authentication. The username is the common name (CN) extracted
from the DN in the Subject field of the end-entity certificate. This
configuration is not sufficient to permit PKI authentication to Kibana;
additional steps are required.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you configure realms in <code class="literal">elasticsearch.yml</code>, only the
realms you specify are used for authentication. If you also want to use the
<code class="literal">native</code> or <code class="literal">file</code> realms, you must include them in the realm chain.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Optional: If you want to use something other than the CN of the Subject DN as
the username, you can specify a regex to extract the desired username. The regex
is applied on the Subject DN.</p>
<p>For example, the regex in the following
configuration extracts the email address from the Subject DN:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        pki:
          pki1:
            order: 1
            username_pattern: "EMAILADDRESS=(.*?)(?:,|$)"</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the regex is too restrictive and does not match the Subject DN of the
client&#8217;s certificate, then the realm does not authenticate the certificate.</p>
</div>
</div>
</li>
<li class="listitem">
Optional: If you want the same users to also be authenticated using
certificates when they connect to Kibana, you must configure the Elasticsearch PKI realm
to allow delegation. See <a class="xref" href="setting-up-authentication.html#pki-realm-for-proxied-clients" title="PKI authentication for clients connecting to Kibana">PKI authentication for clients connecting to Kibana</a>.
</li>
<li class="listitem">
Restart Elasticsearch because realm configuration is not reloaded automatically. If
you&#8217;re following through with the next steps, you might wish to hold the
restart for last.
</li>
<li class="listitem">
<a class="xref" href="manually-configure-security.html#encrypt-internode-communication" title="Encrypt internode communications with TLS">Enable SSL/TLS</a>.
</li>
<li class="listitem">
<p>Enable client authentication on the desired network layers (transport or http).</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>To use PKI when clients connect directly to Elasticsearch, you must enable
SSL/TLS with client authentication. That is to say, you must set   <code class="literal">xpack.security.transport.ssl.client_authentication</code> and
<code class="literal">xpack.security.http.ssl.client_authentication</code> to <code class="literal">optional</code> or <code class="literal">required</code>. If
the setting value is <code class="literal">optional</code>, clients without certificates can authenticate
with other credentials.</p>
</div>
</div>
<p>When clients connect directly to Elasticsearch and are not proxy-authenticated, the PKI
realm relies on the TLS settings of the node&#8217;s network interface. The realm can
be configured to be more restrictive than the underlying network connection.
That is, it is possible to configure the node such that some connections
are accepted by the network interface but then fail to be authenticated by the
PKI realm. However, the reverse is not possible. The PKI realm cannot
authenticate a connection that has been refused by the network interface.</p>
<p>In particular this means:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The transport or http interface must request client certificates by setting
<code class="literal">client_authentication</code> to <code class="literal">optional</code> or <code class="literal">required</code>.
</li>
<li class="listitem">
The interface must <em>trust</em> the certificate that is presented by the client
by configuring either the <code class="literal">truststore</code> or <code class="literal">certificate_authorities</code> paths,
or by setting <code class="literal">verification_mode</code> to <code class="literal">none</code>.
</li>
<li class="listitem">
The <em>protocols</em> supported by the interface must be compatible with those
used by the client.
</li>
</ul>
</div>
<p>For an explanation of these settings, see <a class="xref" href="settings.html#ssl-tls-settings" title="General TLS settings">General TLS settings</a>.</p>
<p>The relevant network interface (transport or http) must be configured to trust
any certificate that is to be used within the PKI realm. However, it is possible
to configure the PKI realm to trust only a <em>subset</em> of the certificates accepted
by the network interface. This is useful when the SSL/TLS layer trusts clients
with certificates that are signed by a different CA than the one that signs your
users' certificates.</p>
<p>To configure the PKI realm with its own truststore, specify the
<code class="literal">truststore.path</code> option. The path must be located within the Elasticsearch
configuration directory (<code class="literal">ES_PATH_CONF</code>). For example:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        pki:
          pki1:
            order: 1
            truststore:
              path: "pki1_truststore.jks"</pre>
</div>
<p>If the truststore is password protected, the password should be configured by
adding the appropriate <code class="literal">secure_password</code> setting to the Elasticsearch keystore. For
example, the following command adds the password for the example realm above:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add \
xpack.security.authc.realms.pki.pki1.truststore.secure_password</pre>
</div>
<p>The <code class="literal">certificate_authorities</code> option can be used as an alternative to the
<code class="literal">truststore.path</code> setting, when the certificate files are PEM formatted. The
setting accepts a list. The two options are exclusive, they cannot be both used
simultaneously.</p>
</li>
<li class="listitem">
<p>Map roles for PKI users.</p>
<p>You map roles for PKI users through the
<a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">role mapping APIs</a> or by using a file stored on
each node. Both configuration options are merged together. When a user
authenticates against a PKI realm, the privileges for that user are the union of
all privileges defined by the roles to which the user is mapped.</p>
<p>You identify a user by the distinguished name in their certificate.
For example, the following mapping configuration maps <code class="literal">John Doe</code> to the
<code class="literal">user</code> role using the role mapping API:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/users
{
  "roles" : [ "user" ],
  "rules" : { "field" : {
    "dn" : "cn=John Doe,ou=example,o=com" <a id="CO572-1"></a><i class="conum" data-value="1"></i>
  } },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1796.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO572-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The distinguished name (DN) of a PKI user.</p>
</td>
</tr>
</table>
</div>
<p>Alternatively, use a role-mapping file. For example:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">user: <a id="CO573-1"></a><i class="conum" data-value="1"></i>
  - "cn=John Doe,ou=example,o=com" <a id="CO573-2"></a><i class="conum" data-value="2"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO573-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of a role.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO573-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The distinguished name (DN) of a PKI user.</p>
</td>
</tr>
</table>
</div>
<p>The file&#8217;s path defaults to <code class="literal">ES_PATH_CONF/role_mapping.yml</code>. You can specify a
different path (which must be within <code class="literal">ES_PATH_CONF</code>) by using the
<code class="literal">files.role_mapping</code> realm setting (e.g.
<code class="literal">xpack.security.authc.realms.pki.pki1.files.role_mapping</code>).</p>
<p>The distinguished name for a PKI user follows X.500 naming conventions which
place the most specific fields (like <code class="literal">cn</code> or <code class="literal">uid</code>) at the beginning of the
name and the most general fields (like <code class="literal">o</code> or <code class="literal">dc</code>) at the end of the name.
Some tools, such as <em>openssl</em>, may print out the subject name in a different
format.</p>
<p>One way that you can determine the correct DN for a certificate is to use the
<a class="xref" href="security-api.html#security-api-authenticate" title="Authenticate API">authenticate API</a> (use the relevant PKI
certificate as the means of authentication) and inspect the metadata field in
the result. The user&#8217;s distinguished name will be populated under the <code class="literal">pki_dn</code>
key. You can also use the authenticate API to validate your role mapping.</p>
<p>For more information, see <a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">Mapping users and groups to roles</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The PKI realm supports <a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> as an
alternative to role mapping.</p>
</div>
</div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="pki-realm-for-proxied-clients"></a>PKI authentication for clients connecting to Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>By default, the PKI realm relies on the node&#8217;s network interface to perform the
SSL/TLS handshake and extract the client certificate. This behaviour requires
that clients connect directly to Elasticsearch so that their SSL connection is terminated
by the Elasticsearch node. If SSL/TLS authentication is to be performed by Kibana, the
PKI realm must be configured to permit delegation.</p>
<p>Specifically, when clients presenting X.509 certificates connect to Kibana,
Kibana performs the SSL/TLS authentication. Kibana then forwards the client&#8217;s
certificate chain (by calling an Elasticsearch API) to have them further validated by
the PKI realms that have been configured for delegation.</p>
<p>To permit authentication delegation for a specific Elasticsearch PKI realm, start by
configuring the realm for the usual case, as detailed in the
<a class="xref" href="setting-up-authentication.html#pki-realm-for-direct-clients" title="PKI authentication for clients connecting directly to Elasticsearch">PKI authentication for clients connecting directly to Elasticsearch</a> section. In this scenario, when you enable TLS,
it is mandatory that you <a class="xref" href="manually-configure-security.html#encrypt-http-communication" title="Encrypt HTTP client communications for Elasticsearch">encrypt HTTP client communications</a>.</p>
<p>You must also explicitly configure a <code class="literal">truststore</code> (or, equivalently
<code class="literal">certificate_authorities</code>) even though it is the same trust configuration that
you have configured on the network layer. The
<code class="literal">xpack.security.authc.token.enabled</code> and <code class="literal">delegation.enabled</code> settings must also
be <code class="literal">true</code>. For example:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      token.enabled: true
      realms:
        pki:
          pki1:
            order: 1
            delegation.enabled: true
            truststore:
              path: "pki1_truststore.jks"</pre>
</div>
<p>After you restart Elasticsearch, this realm can validate delegated PKI authentication.
You must then
<a href="https://www.elastic.co/guide/en/kibana/8.9/kibana-authentication.html#pki-authentication" class="ulink" target="_top">configure Kibana to allow PKI certificate authentication</a>.</p>
<p>A PKI realm with <code class="literal">delegation.enabled</code> still works unchanged for clients
connecting directly to Elasticsearch. Directly authenticated users and users that are PKI
authenticated by delegation to Kibana both follow the same
<a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">role mapping rules</a> or
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms configurations</a>.</p>
<p>If you use the <a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">role mapping APIs</a>, however, you
can distinguish between users that are authenticated by delegation and users
that are authenticated directly. The former have the extra fields
<code class="literal">pki_delegated_by_user</code> and <code class="literal">pki_delegated_by_realm</code> in the user&#8217;s metadata. In
the common setup, where authentication is delegated to Kibana, the values of
these fields are <code class="literal">kibana</code> and <code class="literal">reserved</code>, respectively. For example, the
following role mapping rule assigns the <code class="literal">role_for_pki1_direct</code> role to all users
that have been authenticated directly by the <code class="literal">pki1</code> realm, by connecting to Elasticsearch
instead of going through Kibana:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/direct_pki_only
{
  "roles" : [ "role_for_pki1_direct" ],
  "rules" : {
    "all": [
      {
        "field": {"realm.name": "pki1"}
      },
      {
        "field": {
          "metadata.pki_delegated_by_user": null <a id="CO574-1"></a><i class="conum" data-value="1"></i>
        }
      }
    ]
  },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1797.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO574-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>If this metadata field is set (that is to say, it is <span class="strong strong"><strong>not</strong></span> <code class="literal">null</code>), the user
has been authenticated in the delegation scenario.</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="saml-realm"></a>SAML authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack security features support user authentication using SAML
single sign-on (SSO). The security features provide this support using the Web
Browser SSO profile of the SAML 2.0 protocol.</p>
<p>This protocol is specifically designed to support authentication via an
interactive web browser, so it does not operate as a standard authentication
realm. Instead, there are Kibana and Elasticsearch security features that work
together to enable interactive SAML sessions.</p>
<p>This means that the SAML realm is not suitable for use by standard REST clients.
If you configure a SAML realm for use in Kibana, you should also configure
another realm, such as the <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">native realm</a> in your authentication
chain.</p>
<p>In order to simplify the process of configuring SAML authentication within the
Elastic Stack, there is a step-by-step guide to
<a class="xref" href="setting-up-authentication.html#saml-guide-stack" title="Configuring SAML single-sign-on on the Elastic Stack">Configuring SAML single-sign-on on the Elastic Stack</a>.</p>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="kerberos-realm"></a>Kerberos authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/kerberos-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>You can configure the Elastic Stack security features to support Kerberos V5
authentication, an industry standard protocol to authenticate users in Elasticsearch.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use the Kerberos realm to authenticate on the transport network layer.</p>
</div>
</div>
<p>To authenticate users with Kerberos, you need to configure a Kerberos realm and
map users to roles. For more information on realm settings, see
<a class="xref" href="settings.html#ref-kerberos-settings" title="Kerberos realm settings">Kerberos realm settings</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="kerberos-terms"></a>Key concepts<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/kerberos-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>There are a few terms and concepts that you&#8217;ll encounter when you&#8217;re setting up
Kerberos realms:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>kdc</em>
</span>
</dt>
<dd>
Key Distribution Center. A service that issues Kerberos tickets.
</dd>
<dt>
<span class="term">
<em>principal</em>
</span>
</dt>
<dd>
<p>
A Kerberos principal is a unique identity to which Kerberos can assign
tickets. It can be used to identify a user or a service provided by a
server.
</p>
<p>Kerberos V5 principal names are of format <code class="literal">primary/instance@REALM</code>, where
<code class="literal">primary</code> is a user name.</p>
<p><code class="literal">instance</code> is an optional string that qualifies the primary and is separated
by a slash(<code class="literal">/</code>) from the primary. For a user, usually it is not used; for
service hosts, it is the fully qualified domain name of the host.</p>
<p><code class="literal">REALM</code> is the Kerberos realm. Usually it is the domain name in upper case.
An example of a typical user principal is <code class="literal">user@ES.DOMAIN.LOCAL</code>. An example of
a typical service principal is <code class="literal">HTTP/es.domain.local@ES.DOMAIN.LOCAL</code>.</p>
</dd>
<dt>
<span class="term">
<em>realm</em>
</span>
</dt>
<dd>
Realms define the administrative boundary within which the authentication server
has authority to authenticate users and services.
</dd>
<dt>
<span class="term">
<em>keytab</em>
</span>
</dt>
<dd>
A file that stores pairs of principals and encryption keys.
</dd>
</dl>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Anyone with read permissions to this file can use the
credentials in the network to access other services so it is important
to protect it with proper file permissions.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>krb5.conf</em>
</span>
</dt>
<dd>
A file that contains Kerberos configuration information such as the default realm
name, the location of Key distribution centers (KDC), realms information,
mappings from domain names to Kerberos realms, and default configurations for
realm session key encryption types.
</dd>
<dt>
<span class="term">
<em>ticket granting ticket (TGT)</em>
</span>
</dt>
<dd>
A TGT is an authentication ticket generated by the Kerberos authentication
server. It contains an encrypted authenticator.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="kerberos-realm-configuration"></a>Configuring a Kerberos realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/kerberos-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>Kerberos is used to protect services and uses a ticket-based authentication
protocol to authenticate users.
You can configure Elasticsearch to use the Kerberos V5 authentication protocol, which is
an industry standard protocol, to authenticate users.
In this scenario, clients must present Kerberos tickets for authentication.</p>
<p>In Kerberos, users authenticate with an authentication service and later
with a ticket granting service to generate a TGT (ticket-granting ticket).
This ticket is then presented to the service for authentication.
Refer to your Kerberos installation documentation for more information about
obtaining TGT. Elasticsearch clients must first obtain a TGT then initiate the process of
authenticating with Elasticsearch.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="kerberos-realm-prereq"></a>Before you begin<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/configuring-kerberos-realm.asciidoc">edit</a></h4>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Deploy Kerberos.</p>
<p>You must have the Kerberos infrastructure set up in your environment.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Kerberos requires a lot of external services to function properly, such as
time synchronization between all machines and working forward and reverse DNS
mappings in your domain. Refer to your Kerberos documentation for more details.</p>
</div>
</div>
<p>These instructions do not cover setting up and configuring your Kerberos
deployment. Where examples are provided, they pertain to an MIT Kerberos V5
deployment. For more information, see
<a href="http://web.mit.edu/kerberos/www/index.html" class="ulink" target="_top">MIT Kerberos documentation</a></p>
</li>
<li class="listitem">
<p>Configure Java GSS.</p>
<p>Elasticsearch uses Java GSS framework support for Kerberos authentication.
To support Kerberos authentication, Elasticsearch needs the following files:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">krb5.conf</code>, a Kerberos configuration file
</li>
<li class="listitem">
A <code class="literal">keytab</code> file that contains credentials for the Elasticsearch service principal
</li>
</ul>
</div>
<p>The configuration requirements depend on your Kerberos setup. Refer to your
Kerberos documentation to configure the <code class="literal">krb5.conf</code> file.</p>
<p>For more information on Java GSS, see
<a href="https://docs.oracle.com/javase/10/security/kerberos-requirements1.htm" class="ulink" target="_top">Java GSS Kerberos requirements</a></p>
</li>
<li class="listitem">
<p>Enable TLS for HTTP.</p>
<p>If your Elasticsearch cluster is operating in production mode, you must configure the
HTTP interface to use SSL/TLS before you can enable Kerberos authentication. For
more information, see <a class="xref" href="manually-configure-security.html#encrypt-http-communication" title="Encrypt HTTP client communications for Elasticsearch">Encrypt HTTP client communications for Elasticsearch</a>.</p>
<p>This step is necessary to support Kerberos authentication via Kibana.
It is not required for Kerberos authentication directly against the Elasticsearch Rest API.</p>
</li>
<li class="listitem">
<p>Enable the token service</p>
<p>The Elasticsearch Kerberos implementation makes use of the Elasticsearch token service. If you
configure TLS on the HTTP interface, this service is automatically enabled. It
can be explicitly configured by adding the following setting in your
<code class="literal">elasticsearch.yml</code> file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.token.enabled: true</pre>
</div>
<p>This step is necessary to support Kerberos authentication via Kibana.
It is not required for Kerberos authentication directly against the Elasticsearch Rest API.</p>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="kerberos-realm-create"></a>Create a Kerberos realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/configuring-kerberos-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>To configure a Kerberos realm in Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Configure the JVM to find the Kerberos configuration file.</p>
<p>Elasticsearch uses Java GSS and JAAS Krb5LoginModule to support Kerberos authentication
using a Simple and Protected GSSAPI Negotiation Mechanism (SPNEGO) mechanism.
The Kerberos configuration file (<code class="literal">krb5.conf</code>) provides information such as the
default realm, the Key Distribution Center (KDC), and other configuration details
required for Kerberos authentication. When the JVM needs some configuration
properties, it tries to find those values by locating and loading this file. The
JVM system property to configure the file path is <code class="literal">java.security.krb5.conf</code>. To
configure JVM system properties see <a class="xref" href="settings.html#set-jvm-options" title="Set JVM options">Set JVM options</a>.
If this system property is not specified, Java tries to locate the file based on
the conventions.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>It is recommended that this system property be configured for Elasticsearch.
The method for setting this property depends on your Kerberos infrastructure.
Refer to your Kerberos documentation for more details.</p>
</div>
</div>
<p>For more information, see <a href="http://web.mit.edu/kerberos/krb5-latest/doc/admin/conf_files/krb5_conf.html" class="ulink" target="_top">krb5.conf</a></p>
</li>
<li class="listitem">
<p>Create a keytab for the Elasticsearch node.</p>
<p>A keytab is a file that stores pairs of principals and encryption keys. Elasticsearch
uses the keys from the keytab to decrypt the tickets presented by the user. You
must create a keytab for Elasticsearch by using the tools provided by your Kerberos
implementation. For example, some tools that create keytabs are <code class="literal">ktpass.exe</code> on
Windows and <code class="literal">kadmin</code> for MIT Kerberos.</p>
</li>
<li class="listitem">
<p>Put the keytab file in the Elasticsearch configuration directory.</p>
<p>Make sure that this keytab file has read permissions. This file contains
credentials, therefore you must take appropriate measures to protect it.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Elasticsearch uses Kerberos on the HTTP network layer, therefore there must be
a keytab file for the HTTP service principal on every Elasticsearch node. The service
principal name must have the format <code class="literal">HTTP/es.domain.local@ES.DOMAIN.LOCAL</code>.
The keytab files are unique for each node since they include the hostname.
An Elasticsearch node can act as any principal a client requests as long as that
principal and its credentials are found in the configured keytab.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Create a Kerberos realm.</p>
<p>To enable Kerberos authentication in Elasticsearch, you must add a Kerberos realm in the
realm chain.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can configure only one Kerberos realm on Elasticsearch nodes.</p>
</div>
</div>
<p>To configure a Kerberos realm, there are a few mandatory realm settings and
other optional settings that you need to configure in the <code class="literal">elasticsearch.yml</code>
configuration file. Add a realm configuration under the
<code class="literal">xpack.security.authc.realms.kerberos</code> namespace.</p>
<p>The most common configuration for a Kerberos realm is as follows:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.kerberos.kerb1:
  order: 3
  keytab.path: es.keytab
  remove_realm_name: false</pre>
</div>
<p>The <code class="literal">username</code> is extracted from the ticket presented by user and usually has
the format <code class="literal">username@REALM</code>. This <code class="literal">username</code> is used for mapping
roles to the user. If realm setting <code class="literal">remove_realm_name</code> is
set to <code class="literal">true</code>, the realm part (<code class="literal">@REALM</code>) is removed. The resulting <code class="literal">username</code>
is used for role mapping.</p>
<p>For detailed information of available realm settings,
see <a class="xref" href="settings.html#ref-kerberos-settings" title="Kerberos realm settings">Kerberos realm settings</a>.</p>
</li>
<li class="listitem">
Restart Elasticsearch
</li>
<li class="listitem">
<p>Map Kerberos users to roles.</p>
<p>The <code class="literal">kerberos</code> realm enables you to map Kerberos users to roles. You can
configure these role mappings by using the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">create or update role mappings API</a>. You
identify users by their <code class="literal">username</code> field.</p>
<p>The following example uses the role mapping API to map <code class="literal">user@REALM</code> to the roles
<code class="literal">monitoring</code> and <code class="literal">user</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role_mapping/kerbrolemapping
{
  "roles" : [ "monitoring_user" ],
  "enabled": true,
  "rules" : {
    "field" : { "username" : "user@REALM" }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1798.console"></div>
<p>In case you want to support Kerberos cross realm authentication you may
need to map roles based on the Kerberos realm name. For such scenarios
following are the additional user metadata available for role mapping:
- <code class="literal">kerberos_realm</code> will be set to Kerberos realm name.
- <code class="literal">kerberos_user_principal_name</code> will be set to user principal name from the Kerberos ticket.</p>
<p>For more information, see <a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">Mapping users and groups to roles</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The Kerberos realm supports
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> as an
alternative to role mapping.</p>
</div>
</div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="kerberos-realm-kibana"></a>Configure Kibana for Kerberos<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/kerberos-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>If you want to use Kerberos to authenticate via your browser and Kibana, you
need to enable the relevant authentication provider in Kibana configuration. See
<a href="https://www.elastic.co/guide/en/kibana/8.9/kibana-authentication.html#kerberos" class="ulink" target="_top">kerberos single sign-on</a></p>
</div>

</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="jwt-auth-realm"></a>JWT authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>Elasticsearch can be configured to trust JSON Web Tokens (JWTs) issued from an external service
as bearer tokens for authentication.</p>
<p>When a JWT realm is used to authenticate with Elasticsearch, a distinction is made
between the <em>client</em> that is connecting to Elasticsearch, and the <em>user</em> on whose behalf
the request should run. The JWT authenticates the user, and a separate credential
authenticates the client.</p>
<p>The JWT realm supports two token types, <code class="literal">id_token</code> (the default) and <code class="literal">access_token</code>.
They are designed to work for the following two scenarios, respectively:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">id_token</code> - An application authenticates and identifies a user with an authentication flow,
e.g. OpenID Connect (OIDC), and then accesses Elasticsearch on behalf of the authenticated user using
a JSON Web Token (JWT) conforming to OIDC ID Token specification.
</li>
<li class="listitem">
<code class="literal">access_token</code> - An application accesses Elasticsearch using its own identity, encoded as a JWT,
e.g. The application authenticates itself to a central identity platform using an
OAuth2 Client Credentials Flow and then uses the resulting JWT-based access token to connect to Elasticsearch.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>A single JWT realm can only work with a single token type. To handle both token types,
you must configure at least two JWT realms. You should choose the token type carefully based
on the use case because it impacts on how validations are performed.</p>
</div>
</div>
<p>The JWT realm validates the incoming JWT based on its configured token type.
JSON Web Tokens (JWT) of both types must contain the following 5 pieces of information.
While ID Tokens, based on the OIDC specification, have strict rules for what claims should provide these information,
access tokens allow some claims to be configurable.</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p></p></td>
<td align="center" colspan="2" valign="top"><p><span class="strong strong"><strong>Claims</strong></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><span class="strong strong"><strong>Information</strong></span></p></td>
<td align="left" valign="top"><p>ID Token</p></td>
<td align="left" valign="top"><p>Access Token</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Issuer</p></td>
<td align="left" valign="top"><p><code class="literal">iss</code></p></td>
<td align="left" valign="top"><p><code class="literal">iss</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Subject</p></td>
<td align="left" valign="top"><p><code class="literal">sub</code></p></td>
<td align="left" valign="top"><p>Defaults to <code class="literal">sub</code>, but can fall back to another claim if <code class="literal">sub</code> does not exist</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Audiences</p></td>
<td align="left" valign="top"><p><code class="literal">aud</code></p></td>
<td align="left" valign="top"><p>Defaults to <code class="literal">aud</code>, but can fall back to another claim if <code class="literal">aud</code> does not exist</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Issue Time</p></td>
<td align="left" valign="top"><p><code class="literal">iat</code></p></td>
<td align="left" valign="top"><p><code class="literal">iat</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Expiration Time</p></td>
<td align="left" valign="top"><p><code class="literal">exp</code></p></td>
<td align="left" valign="top"><p><code class="literal">exp</code></p></td>
</tr>
</tbody>
</table>
</div>
<p>In addition, Elasticsearch also validates <code class="literal">nbf</code> and <code class="literal">auth_time</code> claims for ID Tokens if these claims are present.
But these claims are ignored for access tokens.</p>
<p>Overall, the access token type has more relaxed validation rules and is suitable for more generic JWTs,
including self-signed ones.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-realm-oidc"></a>ID Tokens from OIDC workflows<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>JWT authentication in Elasticsearch is derived from OIDC user workflows, where different
tokens can be issued by an OIDC Provider (OP), including ID Tokens.
ID Tokens from an OIDC provider are well-defined JSON Web Tokens (JWT) and should be always compatible with
a JWT realm of the <code class="literal">id_token</code> token type. The subject claim of an ID token represents the end-user.
This means that ID tokens will generally have many allowed subjects.
Therefore, a JWT realm of <code class="literal">id_token</code> token type does <em>not</em> mandate the <code class="literal">allowed_subjects</code> validation.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Because JWTs are obtained external to Elasticsearch, you can define a custom workflow
instead of using the OIDC workflow. However, the JWT format must still be JSON
Web Signature (JWS). The JWS header and JWS signature are validated using OIDC
ID token validation rules.</p>
</div>
</div>
<p>Elasticsearch supports a separate <a class="xref" href="setting-up-authentication.html#oidc-realm" title="OpenID Connect authentication">OpenID Connect realm</a>. It is preferred for any
use case where Elasticsearch can act as an OIDC RP. The OIDC realm is the only supported
way to enable OIDC authentication in Kibana.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Users authenticating with a JWT realm can optionally impersonate another user
with the <a class="xref" href="authorization.html#run-as-privilege" title="Submitting requests on behalf of other users"><code class="literal">run_as</code></a> feature. See also <a class="xref" href="setting-up-authentication.html#jwt-realm-runas" title="Applying the run_as privilege to JWT realm users">Applying the <code class="literal">run_as</code> privilege to JWT realm users</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-realm-oauth2"></a>Access Tokens<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>A common method to obtain access tokens is with the OAuth2 Client Credentials Flow.
A typical usage of this flow is for an application to get a credential for itself.
This is the use case that the <code class="literal">access_token</code> token type is designed for.
It is likely that this application also obtains ID Tokens for its end-users.
To prevent end-user ID Tokens being used to authenticate with the JWT realm configured
for the application, we mandate <code class="literal">allowed_subjects</code> validation when a JWT realm
has token type <code class="literal">access_token</code>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Not every access token is formatted as a JSON Web Token (JWT).
For it to be compatible with the JWT realm, it must at least use the JWT format and satisfies
relevant requirements in the above table.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-realm-configuration"></a>Configure Elasticsearch to use a JWT realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>To use JWT authentication, create the realm in the <code class="literal">elasticsearch.yml</code> file
to configure it within the Elasticsearch authentication chain.</p>
<p>The JWT realm has a few mandatory settings, plus optional settings that are
described in <a class="xref" href="settings.html#ref-jwt-settings" title="JWT realm settings">JWT realm settings</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Client authentication is enabled by default for the JWT realms. Disabling
client authentication is possible, but strongly discouraged.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Add your JWT realm to the <code class="literal">elasticsearch.yml</code> file. The following example
includes the most common settings, which are not intended for every use case:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt1:
  order: 3
  token_type: id_token
  client_authentication.type: shared_secret
  allowed_issuer: "https://issuer.example.com/jwt/"
  allowed_audiences: [ "8fb85eba-979c-496c-8ae2-a57fde3f12d0" ]
  allowed_signature_algorithms: [RS256,HS256]
  pkc_jwkset_path: jwt/jwkset.json
  claims.principal: sub</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">order</code>
</span>
</dt>
<dd>
Specifies a realm <code class="literal">order</code> of <code class="literal">3</code>, which indicates the order in which the
configured realm is checked when authenticating a user. Realms are consulted in
ascending order, where the realm with the lowest order value is consulted first.
</dd>
<dt>
<span class="term">
<code class="literal">token_type</code>
</span>
</dt>
<dd>
Instructs the realm to treat and validate incoming JWTs as ID Tokens (<code class="literal">id_token</code>).
</dd>
<dt>
<span class="term">
<code class="literal">client_authentication.type</code>
</span>
</dt>
<dd>
Specifies the client authentication type as <code class="literal">shared_secret</code>, which means that
the client is authenticated using an HTTP request header that must match a
pre-configured secret value. The client must provide this shared secret with
every request in the <code class="literal">ES-Client-Authentication</code> header. The header value must be a
case-sensitive match to the realm&#8217;s <code class="literal">client_authentication.shared_secret</code>.
</dd>
<dt>
<span class="term">
<code class="literal">allowed_issuer</code>
</span>
</dt>
<dd>
Sets a verifiable identifier for your JWT issuer. This value is typically a
URL, UUID, or some other case-sensitive string value.
</dd>
<dt>
<span class="term">
<code class="literal">allowed_audiences</code>
</span>
</dt>
<dd>
Specifies a list of JWT audiences that the realm will allow.
These values are typically URLs, UUIDs, or other case-sensitive string values.
</dd>
<dt>
<span class="term">
<code class="literal">allowed_signature_algorithms</code>
</span>
</dt>
<dd>
Indicates that Elasticsearch should use the <code class="literal">RS256</code> or <code class="literal">HS256</code> signature algorithms to
verify the signature of the JWT from the JWT issuer.
</dd>
<dt>
<span class="term">
<code class="literal">pkc_jwkset_path</code>
</span>
</dt>
<dd>
The file path to a JSON Web Key Set (JWKS) containing the public key material
that the JWT realm uses to verify JWT signatures. If a path is provided,
then it is resolved relative to the Elasticsearch configuration directory. In Elastic Cloud,
use an absolute path starting with <code class="literal">/app/config/</code>.
</dd>
<dt>
<span class="term">
<code class="literal">claims.principal</code>
</span>
</dt>
<dd>
The name of the JWT claim that contains the user&#8217;s principal (username).
</dd>
</dl>
</div>
<p>The following is an example snippet for configure a JWT realm for handling
access tokens:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt2:
  order: 4
  token_type: access_token
  client_authentication.type: shared_secret
  allowed_issuer: "https://issuer.example.com/jwt/"
  allowed_subjects: [ "123456-compute@developer.example.com" ]
  allowed_audiences: [ "elasticsearch" ]
  required_claims:
    token_use: access
    version: ["1.0", "2.0"]
  allowed_signature_algorithms: [RS256,HS256]
  pkc_jwkset_path: "https://idp-42.example.com/.well-known/configuration"
  fallback_claims.sub: client_id
  fallback_claims.aud: scope
  claims.principal: sub</pre>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">token_type</code>
</span>
</dt>
<dd>
Instructs the realm to treat and validate incoming JWTs as access tokens (<code class="literal">access_token</code>).
</dd>
<dt>
<span class="term">
<code class="literal">allowed_subjects</code>
</span>
</dt>
<dd>
Specifies a list of JWT subjects that the realm will allow.
These values are typically URLs, UUIDs, or other case-sensitive string values.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This setting is mandatory for when <code class="literal">token_type</code> is <code class="literal">access_token</code>.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">required_claims</code>
</span>
</dt>
<dd>
Specifies a list of key/value pairs for additional verifications to be performed
against a JWT. The values are either a string or an array of strings.
</dd>
<dt>
<span class="term">
<code class="literal">fallback_claims.sub</code>
</span>
</dt>
<dd>
The name of the JWT claim to extract the subject information if the <code class="literal">sub</code> claim does not exist.
This setting is only available when <code class="literal">token_type</code> is <code class="literal">access_token</code>.
The fallback is applied everywhere the <code class="literal">sub</code> claim is used.
In the above snippet, it means the <code class="literal">claims.principal</code> will also fallback to <code class="literal">client_id</code>
if <code class="literal">sub</code> does not exist.
</dd>
<dt>
<span class="term">
<code class="literal">fallback_claims.aud</code>
</span>
</dt>
<dd>
The name of the JWT claim to extract the audiences information if the <code class="literal">aud</code> claim does not exist.
This setting is only available when <code class="literal">token_type</code> is <code class="literal">access_token</code>.
The fallback is applied everywhere the <code class="literal">aud</code> claim is used.
</dd>
</dl>
</div>
</li>
<li class="listitem">
<p>After defining settings, use the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/elasticsearch-keystore.html" class="ulink" target="_top"><code class="literal">elasticsearch-keystore</code></a> tool to store
values for secure settings in the Elasticsearch keystore.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Store the <code class="literal">shared_secret</code> value for <code class="literal">client_authentication.type</code>:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add xpack.security.authc.realms.jwt.jwt1.client_authentication.shared_secret</pre>
</div>
</li>
<li class="listitem">
<p>Store the HMAC keys for <code class="literal">allowed_signature_algorithms</code>, which use the HMAC
SHA-256 algorithm <code class="literal">HS256</code> in the example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add-file xpack.security.authc.realms.jwt.jwt1.hmac_jwkset &lt;path&gt; <a id="CO575-1"></a><i class="conum" data-value="1"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO575-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Path to a JWKS, which is a resource for a set of JSON-encoded secret keys.
The file can be removed after you load the contents into the Elasticsearch keystore.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using the JWKS is preferred. However, you can add an HMAC key in string format
using the following command. This format is compatible with HMAC UTF-8 keys, but
only supports a single key with no attributes. You can only use one HMAC format
(either <code class="literal">hmac_jwkset</code> or <code class="literal">hmac_key</code>) simultaneously.</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add xpack.security.authc.realms.jwt.jwt1.hmac_key</pre>
</div>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-validation"></a>JWT encoding and validation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>JWTs can be parsed into three pieces:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Header
</span>
</dt>
<dd>
Provides information about how to validate the token.
</dd>
<dt>
<span class="term">
Claims
</span>
</dt>
<dd>
Contains data about the calling user or application.
</dd>
<dt>
<span class="term">
Signature
</span>
</dt>
<dd>
The data that&#8217;s used to validate the token.
</dd>
</dl>
</div>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">Header: {"typ":"JWT","alg":"HS256"}
Claims: {"aud":"aud8","sub":"security_test_user","iss":"iss8","exp":4070908800,"iat":946684800}
Signature: UnnFmsoFKfNmKMsVoDQmKI_3-j95PCaKdgqqau3jPMY</pre>
</div>
<p>This example illustrates a partial decoding of a JWT. The validity period is
from 2000 to 2099 (inclusive), as defined by the issue time (<code class="literal">iat</code>) and
expiration time (<code class="literal">exp</code>). JWTs typically have a validity period shorter than
100 years, such as 1-2 hours or 1-7 days, not an entire human life.</p>
<p>The signature in this example is deterministic because the header, claims, and
HMAC key are fixed. JWTs typically have a <code class="literal">nonce</code> claim to make the signature
non-deterministic. The supported JWT encoding is JSON Web Signature (JWS), and
the JWS <code class="literal">Header</code> and <code class="literal">Signature</code> are validated using OpenID Connect ID Token
validation rules. Some validation is customizable through
<a class="xref" href="settings.html#ref-jwt-settings" title="JWT realm settings">JWT realm settings</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-validation-header"></a>Header claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The header claims indicate the token type and the algorithm used to sign the
token.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">alg</code>
</span>
</dt>
<dd>
(Required, String) Indicates the algorithm that was used to sign the token, such
as <code class="literal">HS256</code>. The algorithm must be in the realm&#8217;s allow list.
</dd>
<dt>
<span class="term">
<code class="literal">typ</code>
</span>
</dt>
<dd>
(Optional, String) Indicates the token type, which must be <code class="literal">JWT</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-validation-payload"></a>Payload claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>Tokens contain several claims, which provide information about the user
who is issuing the token, and the token itself.
Depending on the token type, these information can optionally be identified
by different claims.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_jwt_payload_claims"></a>JWT payload claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h5>
</div></div></div>
<p>The following claims are validated by a subset of OIDC ID token rules.</p>
<p>Elasticsearch doesn&#8217;t validate <code class="literal">nonce</code> claims, but a custom JWT issuer can add a
random <code class="literal">nonce</code> claim to introduce entropy into the signature.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can relax validation of any of the time-based claims by setting
<code class="literal">allowed_clock_skew</code>. This value sets the maximum allowed clock skew before
validating JWTs with respect to their authentication time (<code class="literal">auth_time</code>),
creation (<code class="literal">iat</code>), not before (<code class="literal">nbf</code>), and expiration times (<code class="literal">exp</code>).</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">iss</code>
</span>
</dt>
<dd>
(Required, String) Denotes the issuer that created the ID token. The value must
be an exact, case-sensitive match to the value in the <code class="literal">allowed_issuer</code> setting.
</dd>
<dt>
<span class="term">
<code class="literal">sub</code>
</span>
</dt>
<dd>
(Required*, String) Indicates the subject that the ID token is created for.
If the JWT realm is of the <code class="literal">id_token</code> type, this claim is mandatory.
A JWT realm of the <code class="literal">id_token</code> type by defaults accepts all subjects.
A JWT realm of the access_token type must specify the <code class="literal">allowed_subjects</code> setting and the subject value
must be an exact, case-sensitive match to any of the CSV values in the
allowed_subjects setting.
A JWT realm of the access_token type can specify a fallback claim that will
be used in place where the <code class="literal">sub</code> claim does not exist.
</dd>
<dt>
<span class="term">
<code class="literal">aud</code>
</span>
</dt>
<dd>
(Required*, String) Indicates the audiences that the ID token is for, expressed as a
comma-separated value (CSV). One of the values must be an exact, case-sensitive
match to any of the CSV values in the <code class="literal">allowed_audiences</code> setting.
If the JWT realm is of the <code class="literal">id_token</code> type, this claim is mandatory.
A JWT realm of the <code class="literal">access_token</code> type can specify a fallback claim that will
be used in place where the <code class="literal">aud</code> claim does not exist.
</dd>
<dt>
<span class="term">
<code class="literal">exp</code>
</span>
</dt>
<dd>
(Required, integer) Expiration time for the ID token, expressed in UTC
seconds since epoch.
</dd>
<dt>
<span class="term">
<code class="literal">iat</code>
</span>
</dt>
<dd>
(Required, integer) Time that the ID token was issued, expressed in UTC
seconds since epoch.
</dd>
<dt>
<span class="term">
<code class="literal">nbf</code>
</span>
</dt>
<dd>
(Optional, integer) Indicates the time before which the JWT must not be accepted,
expressed as UTC seconds since epoch.
This claim is optional. If it exists, a JWT realm of <code class="literal">id_token</code> type will verify
it, while a JWT realm of <code class="literal">access_token</code> will just ignore it.
</dd>
<dt>
<span class="term">
<code class="literal">auth_time</code>
</span>
</dt>
<dd>
(Optional, integer) Time when the user authenticated to the JWT issuer,
expressed as UTC seconds since epoch.
This claim is optional. If it exists, a JWT realm of <code class="literal">id_token</code> type will verify
it, while a JWT realm of <code class="literal">access_token</code> will just ignore it.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="jwt-validation-payload-es"></a>Elasticsearch settings for consuming JWT claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h5>
</div></div></div>
<p>Elasticsearch uses JWT claims for the following settings.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">principal</code>
</span>
</dt>
<dd>
(Required, String) Contains the user&#8217;s principal (username). The value is
configurable using the realm setting <code class="literal">claims.principal</code>.
You can configure an optional regular expression using the
<code class="literal">claim_patterns.principal</code> to extract a substring.
</dd>
<dt>
<span class="term">
<code class="literal">groups</code>
</span>
</dt>
<dd>
(Optional, JSON array) Contains the user&#8217;s group membership.
The value is configurable using the realm setting <code class="literal">claims.groups</code>. You can
configure an optional regular expression using the realm setting
<code class="literal">claim_patterns.groups</code> to extract a substring value.
</dd>
<dt>
<span class="term">
<code class="literal">name</code>
</span>
</dt>
<dd>
(Optional, String) Contains a human-readable identifier that identifies the
subject of the token. The value is configurable using the realm setting
<code class="literal">claims.name</code>. You can configure an optional regular expression using the realm
setting <code class="literal">claim_patterns.name</code> to extract a substring value.
</dd>
<dt>
<span class="term">
<code class="literal">mail</code>
</span>
</dt>
<dd>
(Optional, String) Contains the e-mail address to associate with the user. The
value is configurable using the realm setting <code class="literal">claims.mail</code>. You can configure an
optional regular expression using the realm setting <code class="literal">claim_patterns.mail</code> to
extract a substring value.
</dd>
<dt>
<span class="term">
<code class="literal">dn</code>
</span>
</dt>
<dd>
(Optional, String) Contains the user&#8217;s Distinguished Name (DN), which uniquely
identifies a user or group. The value is configurable using the realm setting
<code class="literal">claims.dn</code>. You can configure an optional regular expression using the realm
setting <code class="literal">claim_patterns.dn</code> to extract a substring value.
</dd>
</dl>
</div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="jwt-authorization"></a>JWT realm authorization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The JWT realm supports authorization with the create or update role mappings API,
or delegating authorization to another realm. You cannot use these methods
simultaneously, so choose whichever works best for your environment.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot map roles in the JWT realm using the <code class="literal">role_mapping.yml</code>
file.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-authorization-role-mapping"></a>Authorizing with the role mapping API<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>You can use the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">create or update role mappings API</a> to define
role mappings that determine which roles should be assigned to each user based on
their username, groups, or other metadata.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/jwt1_users?refresh=true
{
  "roles" : [ "user" ],
  "rules" : { "all" : [
      { "field": { "realm.name": "jwt1" } },
      { "field": { "username": "principalname1" } },
      { "field": { "dn": "CN=Principal Name 1,DC=example.com" } },
      { "field": { "groups": "group1" } },
      { "field": { "metadata.jwt_claim_other": "other1" } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1799.console"></div>
<p>If you use this API in the JWT realm, the following claims are available for
role mapping:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">principal</code>
</span>
</dt>
<dd>
(Required, String) Principal claim that is used as the Elasticsearch user&#8217;s username.
</dd>
<dt>
<span class="term">
<code class="literal">dn</code>
</span>
</dt>
<dd>
(Optional, String) Distinguished Name (DN) that is used as the Elasticsearch user&#8217;s DN.
</dd>
<dt>
<span class="term">
<code class="literal">groups</code>
</span>
</dt>
<dd>
(Optional, String) Comma-separated value (CSV) list that is used as the Elasticsearch
user&#8217;s list of groups.
</dd>
<dt>
<span class="term">
<code class="literal">metadata</code>
</span>
</dt>
<dd>
(Optional, object) Additional metadata about the user, such as strings, integers,
boolean values, and collections that are used as the Elasticsearch user&#8217;s metadata.
These values are key value pairs formatted as
<code class="literal">metadata.jwt_claim_&lt;key&gt;</code> = <code class="literal">&lt;value&gt;</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-authorization-delegation"></a>Delegating JWT authorization to another realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>If you <a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">delegate authorization</a> to other realms from the
JWT realm, only the <code class="literal">principal</code> claim is available for role lookup. When
delegating the assignment and lookup of roles to another realm from the JWT
realm, claims for <code class="literal">dn</code>, <code class="literal">groups</code>, <code class="literal">mail</code>, <code class="literal">metadata</code>, and <code class="literal">name</code> are not used
for the Elasticsearch user&#8217;s values. Only the JWT <code class="literal">principal</code> claim is passed to the
delegated authorization realms. The realms that are delegated for authorization
- not the JWT realm - become responsible for populating all of the Elasticsearch user&#8217;s
values.</p>
<p>The following example shows how you define delegation authorization in the
<code class="literal">elasticsearch.yml</code> file to multiple other realms from the JWT realm. A JWT
realm named <code class="literal">jwt2</code> is delegating authorization to multiple realms:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt2.authorization_realms: file1,native1,ldap1,ad1</pre>
</div>
<p>You can then use the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">create or update role mappings API</a> to map
roles to the authorizing realm. The following example maps roles in the <code class="literal">native1</code>
realm for the <code class="literal">principalname1</code> JWT principal.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/native1_users?refresh=true
{
  "roles" : [ "user" ],
  "rules" : { "all" : [
      { "field": { "realm.name": "native1" } },
      { "field": { "username": "principalname1" } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1800.console"></div>
<p>If realm <code class="literal">jwt2</code> successfully authenticates a client with a JWT for principal
<code class="literal">principalname1</code>, and delegates authorization to one of the listed realms
(such as <code class="literal">native1</code>), then that realm can look up the Elasticsearch user&#8217;s values. With
this defined role mapping, the realm can also look up this role mapping rule
linked to realm <code class="literal">native1</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-realm-runas"></a>Applying the <code class="literal">run_as</code> privilege to JWT realm users<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch can retrieve roles for a JWT user through either role mapping or
delegated authorization. Regardless of which option you choose, you can apply the
<a class="xref" href="authorization.html#run-as-privilege-apply" title="Apply the run_as privilege to roles"><code class="literal">run_as</code> privilege</a> to a role so that a user can
submit authenticated requests to "run as" a different user. To submit requests as
another user, include the <code class="literal">es-security-runas-user</code> header in your requests.
Requests run as if they were issued from that user and Elasticsearch uses their roles.</p>
<p>For example, let&#8217;s assume that there&#8217;s a user with the username <code class="literal">user123_runas</code>.
The following request creates a user role named <code class="literal">jwt_role1</code>, which specifies a
<code class="literal">run_as</code> user with the <code class="literal">user123_runas</code> username. Any user with the <code class="literal">jwt_role1</code>
role can issue requests as the specified <code class="literal">run_as</code> user.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role/jwt_role1?refresh=true
{
  "cluster": ["manage"],
  "indices": [ { "names": [ "*" ], "privileges": ["read"] } ],
  "run_as": [ "user123_runas" ],
  "metadata" : { "version" : 1 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1801.console"></div>
<p>You can then map that role to a user in a specific realm. The following request
maps the <code class="literal">jwt_role1</code> role to a user with the username <code class="literal">user2</code> in the <code class="literal">jwt2</code> JWT
realm. This means that Elasticsearch will use the <code class="literal">jwt2</code> realm to authenticate the user
named <code class="literal">user2</code>. Because <code class="literal">user2</code> has a role (the <code class="literal">jwt_role1</code> role) that includes
the <code class="literal">run_as</code> privilege, Elasticsearch retrieves the role mappings for the <code class="literal">user123_runas</code>
user and uses the roles for that user to submit requests.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role_mapping/jwt_user1?refresh=true
{
  "roles": [ "jwt_role1"],
  "rules" : { "all" : [
      { "field": { "realm.name": "jwt2" } },
      { "field": { "username": "user2" } }
  ] },
  "enabled": true,
  "metadata" : { "version" : 1 }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1802.console"></div>
<p>After mapping the roles, you can make an
<a class="xref" href="security-api.html#security-api-authenticate" title="Authenticate API">authenticated call</a> to Elasticsearch using a JWT and include
the <code class="literal">ES-Client-Authentication</code> header:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -s -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOlsiZXMwMSIsImVzMDIiLCJlczAzIl0sInN1YiI6InVzZXIyIiwiaXNzIjoibXktaXNzdWVyIiwiZXhwIjo0MDcwOTA4ODAwLCJpYXQiOjk0NjY4NDgwMCwiZW1haWwiOiJ1c2VyMkBzb21ldGhpbmcuZXhhbXBsZS5jb20ifQ.UgO_9w--EoRyUKcWM5xh9SimTfMzl1aVu6ZBsRWhxQA" -H "ES-Client-Authentication: sharedsecret test-secret" https://localhost:9200/_security/_authenticate</pre>
</div>
<p>The response includes the user who submitted the request (<code class="literal">user2</code>), including
the <code class="literal">jwt_role1</code> role that you mapped to this user in the JWT realm:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{"username":"user2","roles":["jwt_role1"],"full_name":null,"email":"user2@something.example.com",
"metadata":{"jwt_claim_email":"user2@something.example.com","jwt_claim_aud":["es01","es02","es03"],
"jwt_claim_sub":"user2","jwt_claim_iss":"my-issuer"},"enabled":true,"authentication_realm":
{"name":"jwt2","type":"jwt"},"lookup_realm":{"name":"jwt2","type":"jwt"},"authentication_type":"realm"}
%</pre>
</div>
<p>If you want to specify a request as the <code class="literal">run_as</code> user, include the
<code class="literal">es-security-runas-user</code> header with the name of the user that you want to
submit requests as. The following request uses the <code class="literal">user123_runas</code> user:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -s -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOlsiZXMwMSIsImVzMDIiLCJlczAzIl0sInN1YiI6InVzZXIyIiwiaXNzIjoibXktaXNzdWVyIiwiZXhwIjo0MDcwOTA4ODAwLCJpYXQiOjk0NjY4NDgwMCwiZW1haWwiOiJ1c2VyMkBzb21ldGhpbmcuZXhhbXBsZS5jb20ifQ.UgO_9w--EoRyUKcWM5xh9SimTfMzl1aVu6ZBsRWhxQA" -H "ES-Client-Authentication: sharedsecret test-secret" -H "es-security-runas-user: user123_runas" https://localhost:9200/_security/_authenticate</pre>
</div>
<p>In the response, you&#8217;ll see that the <code class="literal">user123_runas</code> user submitted the request,
and Elasticsearch used the <code class="literal">jwt_role1</code> role:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{"username":"user123_runas","roles":["jwt_role1"],"full_name":null,"email":null,"metadata":{},
"enabled":true,"authentication_realm":{"name":"jwt2","type":"jwt"},"lookup_realm":{"name":"native",
"type":"native"},"authentication_type":"realm"}%</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="jwt-realm-jwkset-reloading"></a>PKC JWKS reloading<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>JWT authentication supports signature verification using PKC (Public Key Cryptography)
or HMAC algorithms.</p>
<p>PKC JSON Web Token Key Sets (JWKS) can contain public RSA and EC keys. HMAC JWKS
or an HMAC UTF-8 JWK contain secret keys. JWT issuers typically rotate PKC JWKS
more frequently (such as daily), because RSA and EC public keys are designed to
be easier to distribute than secret keys like HMAC.</p>
<p>JWT realms load a PKC JWKS and an HMAC JWKS or HMAC UTF-8 JWK at startup. JWT
realms can also reload PKC JWKS contents at runtime; a reload is triggered by
signature validation failures.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>HMAC JWKS or HMAC UTF-8 JWK reloading is not supported at this time.</p>
</div>
</div>
<p>Load failures, parse errors, and configuration errors prevent a node from
starting (and restarting). However, runtime PKC reload errors and recoveries are
handled gracefully.</p>
<p>All other JWT realm validations are checked before a signature failure can
trigger a PKC JWKS reload. If multiple JWT authentication signature failures
occur simultaneously with a single Elasticsearch node, reloads are combined to reduce
the reloads that are sent externally.</p>
<p>Separate reload requests cannot be combined if JWT signature failures trigger:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
PKC JWKS reloads in different Elasticsearch nodes
</li>
<li class="listitem">
PKC JWKS reloads in the same Elasticsearch node at different times
</li>
</ul>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Enabling client authentication (<code class="literal">client_authentication.type</code>) is strongly
recommended. Only trusted client applications and realm-specific JWT users can
trigger PKC reload attempts. Additionally, configuring the following
<a class="xref" href="settings.html#ref-jwt-settings" title="JWT realm settings">JWT security settings</a> is recommended:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">allowed_audiences</code>
</li>
<li class="listitem">
<code class="literal">allowed_clock_skew</code>
</li>
<li class="listitem">
<code class="literal">allowed_issuer</code>
</li>
<li class="listitem">
<code class="literal">allowed_signature_algorithms</code>
</li>
</ul>
</div>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="hmac-oidc-example"></a>Authorizing to the JWT realm with an HMAC UTF-8 key<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>The following settings are for a JWT issuer, Elasticsearch, and a client of Elasticsearch. The
example HMAC key is in an OIDC format that&#8217;s compatible with HMAC. The key bytes
are the UTF-8 encoding of the UNICODE characters.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>HMAC UTF-8 keys need to be longer than HMAC random byte keys to
achieve the same key strength.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="hmac-oidc-example-jwt-issuer"></a>JWT issuer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The following values are for the bespoke JWT issuer.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">Issuer:     iss8
Audiences:  aud8
Algorithms: HS256
HMAC UTF-8: hmac-oidc-key-string-for-hs256-algorithm</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="hmac-oidc-example-jwt-realm"></a>JWT realm settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>To define a JWT realm, add the following realm settings to <code class="literal">elasticsearch.yml</code>.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt8.order: 8 <a id="CO576-1"></a><i class="conum" data-value="1"></i>
xpack.security.authc.realms.jwt.jwt8.allowed_issuer: iss8
xpack.security.authc.realms.jwt.jwt8.allowed_audiences: [aud8]
xpack.security.authc.realms.jwt.jwt8.allowed_signature_algorithms: [HS256]
xpack.security.authc.realms.jwt.jwt8.claims.principal: sub
xpack.security.authc.realms.jwt.jwt8.client_authentication.type: shared_secret</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO576-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>In Elastic Cloud, the realm order starts at <code class="literal">2</code>. <code class="literal">0</code> and <code class="literal">1</code> are reserved in the
realm chain on Elastic Cloud.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_jwt_realm_secure_settings"></a>JWT realm secure settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>After defining the realm settings, use the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/elasticsearch-keystore.html" class="ulink" target="_top"><code class="literal">elasticsearch-keystore</code></a> tool to add the
following secure settings to the Elasticsearch keystore. In Elastic Cloud, you define settings
for the Elasticsearch keystore under <span class="strong strong"><strong>Security</strong></span> in your deployment.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.jwt.jwt8.hmac_key: hmac-oidc-key-string-for-hs256-algorithm
xpack.security.authc.realms.jwt.jwt8.client_authentication.shared_secret: client-shared-secret-string</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_jwt_realm_role_mapping_rule"></a>JWT realm role mapping rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The following request creates role mappings for Elasticsearch in the <code class="literal">jwt8</code> realm for
the user <code class="literal">principalname1</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/jwt8_users?refresh=true
{
  "roles" : [ "user" ],
  "rules" : { "all" : [
      { "field": { "realm.name": "jwt8" } },
      { "field": { "username": "principalname1" } }
  ] },
  "enabled": true
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1803.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="hmac-oidc-example-request-headers"></a>Request headers<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/jwt-realm.asciidoc">edit</a></h4>
</div></div></div>
<p>The following header settings are for an Elasticsearch client.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJpc3M4IiwiYXVkIjoiYXVkOCIsInN1YiI6InNlY3VyaXR5X3Rlc3RfdXNlciIsImV4cCI6NDA3MDkwODgwMCwiaWF0Ijo5NDY2ODQ4MDB9.UnnFmsoFKfNmKMsVoDQmKI_3-j95PCaKdgqqau3jPMY
ES-Client-Authentication: SharedSecret client-shared-secret-string</pre>
</div>
<p>You can use this header in a <code class="literal">curl</code> request to make an authenticated call to
Elasticsearch. Both the bearer token and the client authorization token must be
specified as separate headers with the <code class="literal">-H</code> option:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -s -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJpc3M4IiwiYXVkIjoiYXVkOCIsInN1YiI6InNlY3VyaXR5X3Rlc3RfdXNlciIsImV4cCI6NDA3MDkwODgwMCwiaWF0Ijo5NDY2ODQ4MDB9.UnnFmsoFKfNmKMsVoDQmKI_3-j95PCaKdgqqau3jPMY" -H "ES-Client-Authentication: SharedSecret client-shared-secret-string" https://localhost:9200/_security/_authenticate</pre>
</div>
<p>If you used role mapping in the JWT realm, the response includes the user&#8217;s
<code class="literal">username</code>, their <code class="literal">roles</code>, metadata about the user, and the details about the
JWT realm itself.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">{"username":"user2","roles":["jwt_role1"],"full_name":null,"email":"user2@something.example.com",
"metadata":{"jwt_claim_email":"user2@something.example.com","jwt_claim_aud":["es01","es02","es03"],
"jwt_claim_sub":"user2","jwt_claim_iss":"my-issuer"},"enabled":true,"authentication_realm":
{"name":"jwt2","type":"jwt"},"lookup_realm":{"name":"jwt2","type":"jwt"},"authentication_type":"realm"}</pre>
</div>
</div>

</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="custom-realms"></a>Integrating with other authentication systems<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/custom-realm.asciidoc">edit</a></h2>
</div></div></div>
<p>If you are using an authentication system that is not supported out-of-the-box
by the Elasticsearch security features, you can create a custom realm to interact with
it to authenticate users. You implement a custom realm as an SPI loaded security
extension as part of an ordinary elasticsearch plugin.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="implementing-custom-realm"></a>Implementing a custom realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/custom-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>Sample code that illustrates the structure and implementation of a custom realm
is provided in <a href="https://github.com/elastic/elasticsearch/tree/8.9/x-pack/qa/security-example-spi-extension" class="ulink" target="_top">https://github.com/elastic/elasticsearch/tree/8.9/x-pack/qa/security-example-spi-extension</a>. You can use this code as a starting point for creating your
own realm.</p>
<p>To create a custom realm, you need to:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Extend <code class="literal">org.elasticsearch.xpack.security.authc.Realm</code> to communicate with your
authentication system to authenticate users.
</li>
<li class="listitem">
Implement the <code class="literal">org.elasticsearch.xpack.security.authc.Realm.Factory</code> interface in
a class that will be used to create the custom realm.
</li>
<li class="listitem">
Extend <code class="literal">org.elasticsearch.xpack.security.authc.DefaultAuthenticationFailureHandler</code> to
handle authentication failures when using your custom realm.
</li>
</ol>
</div>
<p>To package your custom realm as a plugin:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Implement an extension class for your realm that extends
<code class="literal">org.elasticsearch.xpack.core.security.SecurityExtension</code>. There you need to
override one or more of the following methods:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">@Override
public Map&lt;String, Factory&gt; getRealms() {
    ...
}</pre>
</div>
<p>The <code class="literal">getRealms</code> method is used to provide a map of type names to the <code class="literal">Factory</code> that
will be used to create the realm.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">@Override
public AuthenticationFailureHandler getAuthenticationFailureHandler() {
    ...
}</pre>
</div>
<p>The <code class="literal">getAuthenticationFailureHandler</code> method is used to optionally provide a
custom <code class="literal">AuthenticationFailureHandler</code>, which will control how the
Elasticsearch security features respond in certain authentication failure events.</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">@Override
public List&lt;String&gt; getSettingsFilter() {
    ...
}</pre>
</div>
<p>The <code class="literal">Plugin#getSettingsFilter</code> method returns a list of setting names that should be
filtered from the settings APIs as they may contain sensitive credentials. Note this method is not
part of the <code class="literal">SecurityExtension</code> interface, it&#8217;s available as part of the elasticsearch plugin main class.</p>
</li>
<li class="listitem">
Create a build configuration file for the plugin; Gradle is our recommendation.
</li>
<li class="listitem">
Create a <code class="literal">META-INF/services/org.elasticsearch.xpack.core.security.SecurityExtension</code> descriptor file for the
extension that contains the fully qualified class name of your <code class="literal">org.elasticsearch.xpack.core.security.SecurityExtension</code> implementation
</li>
<li class="listitem">
Bundle all in a single zip file.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="using-custom-realm"></a>Using a custom realm to authenticate users<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/custom-realm.asciidoc">edit</a></h3>
</div></div></div>
<p>To use a custom realm:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Install the realm extension on each node in the cluster. You run
<code class="literal">bin/elasticsearch-plugin</code> with the <code class="literal">install</code> sub-command and specify the URL
pointing to the zip file that contains the extension. For example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">bin/elasticsearch-plugin install file:///&lt;path&gt;/my-realm-1.0.zip</pre>
</div>
</li>
<li class="listitem">
<p>Add a realm configuration of the appropriate realm type to <code class="literal">elasticsearch.yml</code>
under the <code class="literal">xpack.security.authc.realms</code> namespace.
You must define your realm within the namespace that matches the type defined
by the extension.
The options you can set depend on the settings exposed by the custom realm.
At a minimum, you must explicitly set the <code class="literal">order</code> attribute to control the
order in which the realms are consulted during authentication. You must also
make sure each configured realm has a distinct <code class="literal">order</code> setting. In the event
that two or more realms have the same <code class="literal">order</code>, the node will fail to start.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you configure realms in <code class="literal">elasticsearch.yml</code>, only the
realms you specify are used for authentication. If you also want to use the
<code class="literal">native</code> or <code class="literal">file</code> realms, you must include them in the realm chain.</p>
</div>
</div>
</li>
<li class="listitem">
Restart Elasticsearch.
</li>
</ol>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="anonymous-access"></a>Enabling anonymous access<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/anonymous-access.asciidoc">edit</a></h2>
</div></div></div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>To embed Kibana dashboards or grant access to Kibana without requiring
credentials, use Kibana&#8217;s
<a href="https://www.elastic.co/guide/en/kibana/8.9/kibana-authentication.html#anonymous-authentication" class="ulink" target="_top">anonymous
authentication</a> feature instead.</p>
</div>
</div>
<p>Incoming requests are considered to be <em>anonymous</em> if no authentication token
can be extracted from the incoming request. By default, anonymous requests are rejected and an authentication error is returned (status code <code class="literal">401</code>).</p>
<p>To enable anonymous access, you assign one or more roles to anonymous
users in the <code class="literal">elasticsearch.yml</code> configuration file. For example, the following
configuration assigns anonymous users <code class="literal">role1</code> and <code class="literal">role2</code>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc:
  anonymous:
    username: anonymous_user <a id="CO577-1"></a><i class="conum" data-value="1"></i>
    roles: role1, role2 <a id="CO577-2"></a><i class="conum" data-value="2"></i>
    authz_exception: true <a id="CO577-3"></a><i class="conum" data-value="3"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO577-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The username/principal of the anonymous user. Defaults to
<code class="literal">_es_anonymous_user</code> if not specified.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO577-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The roles to associate with the anonymous user. If no roles are specified, anonymous access is disabled&#8212;&#8203;anonymous requests will be rejected and return an authentication error.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO577-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>When <code class="literal">true</code>, a 403 HTTP status code is returned if the anonymous user
does not have the permissions needed to perform the requested action and the
user will NOT be prompted to provide credentials to access the requested
resource. When <code class="literal">false</code>, a 401 HTTP status code is returned if the anonymous user
does not have the necessary permissions and the user is prompted for
credentials to access the requested resource. If you are using anonymous access
in combination with HTTP, you might need to set <code class="literal">authz_exception</code> to <code class="literal">false</code>
if your client does not support preemptive basic authentication. Defaults to
<code class="literal">true</code>.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="user-lookup"></a>Looking up users without authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-lookup.asciidoc">edit</a></h2>
</div></div></div>
<p>Elasticsearch <a class="xref" href="setting-up-authentication.html#realms" title="Realms">realms</a> exist primarily to support
<a class="xref" href="setting-up-authentication.html" title="User authentication">user authentication</a>.
Some realms authenticate users with a password (such as the
<a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication"><code class="literal">native</code></a> and <a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication"><code class="literal">ldap</code></a> realms), and other realms use
more complex authentication protocols (such as the <a class="xref" href="setting-up-authentication.html#saml-realm" title="SAML authentication"><code class="literal">saml</code></a> and
<a class="xref" href="setting-up-authentication.html#oidc-realm" title="OpenID Connect authentication"><code class="literal">oidc</code></a> realms).
In each case, the <em>primary</em> purpose of the realm is to establish the identity of
the user who has made a request to the Elasticsearch API.</p>
<p>However, some Elasticsearch features need to <em>look up</em> a user without using their credentials.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <a class="xref" href="authorization.html#run-as-privilege" title="Submitting requests on behalf of other users"><code class="literal">run_as</code></a> feature executes requests on behalf of
another user. An authenticated user with <code class="literal">run_as</code> privileges can perform
requests on behalf of another unauthenticated user.
</li>
<li class="listitem">
The <a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">delegated authorization</a> feature links two realms
together so that a user who authenticates against one realm can have the roles
and metadata associated with a user from a different realm.
</li>
</ul>
</div>
<p>In each of these cases, a user must first authenticate to one realm and then
Elasticsearch will query the second realm to find another user.
The authenticated user credentials are used to authenticate in the first realm only,
The user in the second realm is retrieved by username, without needing credentials.</p>
<p>When Elasticsearch resolves a user using their credentials (as performed in the first realm),
it is known as <em>user authentication</em>.</p>
<p>When Elasticsearch resolves a user using the username only (as performed in the second realm),
it is known as <em>user lookup</em>.</p>
<p>See the <a class="xref" href="authorization.html#run-as-privilege" title="Submitting requests on behalf of other users">run_as</a> and <a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">delegated authorization</a>
documentation to learn more about these features, including which realms and authentication
methods support <code class="literal">run_as</code> or delegated authorization.
In both cases, only the following realms can be used for the user lookup:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The reserved, <a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication"><code class="literal">native</code></a> and <a class="xref" href="setting-up-authentication.html#file-realm" title="File-based user authentication"><code class="literal">file</code></a> realms always
support user lookup.
</li>
<li class="listitem">
The <a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication"><code class="literal">ldap</code></a> realm supports user lookup when the realm is configured
in <a class="xref" href="setting-up-authentication.html#ldap-realm-configuration" title="Configuring an LDAP realm"><em>user search</em> mode</a>. User lookup is not support
when the realm is configured with <code class="literal">user_dn_templates</code>.
</li>
<li class="listitem">
User lookup support in the <a class="xref" href="setting-up-authentication.html#active-directory-realm" title="Active Directory user authentication"><code class="literal">active_directory</code></a> realm
requires that the realm be configured with a <a class="xref" href="settings.html#ref-ad-settings" title="Active Directory realm settings"><code class="literal">bind_dn</code></a> and a
bind password.
</li>
</ul>
</div>
<p>The <code class="literal">pki</code>, <code class="literal">saml</code>, <code class="literal">oidc</code>, <code class="literal">kerberos</code> and <code class="literal">jwt</code> realms do not support user
lookup.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you want to use a realm only for user lookup and prevent users from
authenticating against that realm, you can <a class="xref" href="settings.html#ref-realm-settings" title="Settings valid for all realms">configure the realm</a>
and set <code class="literal">authentication.enabled</code> to <code class="literal">false</code></p>
</div>
</div>
<p>The user lookup feature is an internal capability that is used to implement the
<code class="literal">run-as</code> and delegated authorization features - there are no APIs for user lookup.
If you wish to test your user lookup configuration, then you can do this with
<code class="literal">run_as</code>. Use the <a class="xref" href="security-api.html#security-api-authenticate" title="Authenticate API">Authenticate</a> API, authenticate as a
<code class="literal">superuser</code> (e.g. the builtin <code class="literal">elastic</code> user) and specify the
<a class="xref" href="authorization.html#run-as-privilege" title="Submitting requests on behalf of other users"><code class="literal">es-security-runas-user</code> request header</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <a class="xref" href="security-api.html#security-api-get-user" title="Get users API">Get users</a> API and <a class="xref" href="setting-up-authentication.html#user-profile" title="User profiles">User profiles</a> feature are alternative
      ways to retrieve information about a Elastic Stack user. Those APIs are not related
      to the user lookup feature.</p>
</div>
</div>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="controlling-user-cache"></a>Controlling the user cache<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-cache.asciidoc">edit</a></h2>
</div></div></div>
<p>User credentials are cached in memory on each node to avoid connecting to a
remote authentication service or hitting the disk for every incoming request.
You can configure characteristics of the user cache with the <code class="literal">cache.ttl</code>,
<code class="literal">cache.max_users</code>, and <code class="literal">cache.hash_algo</code> realm settings.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>JWT realms use <code class="literal">jwt.cache.ttl</code> and <code class="literal">jwt.cache.size</code> realm settings.</p>
</div>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>PKI and JWT realms do not cache user credentials, but do cache the resolved user
object to avoid unnecessarily needing to perform role mapping on each request.</p>
</div>
</div>
<p>The cached user credentials are hashed in memory. By default, the Elasticsearch
security features use a salted <code class="literal">sha-256</code> hash algorithm. You can use a
different hashing algorithm by setting the <code class="literal">cache.hash_algo</code> realm settings. See
<a class="xref" href="settings.html#hashing-settings" title="User cache and password hash algorithms">User cache and password hash algorithms</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="cache-eviction-api"></a>Evicting users from the cache<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/user-cache.asciidoc">edit</a></h3>
</div></div></div>
<p>You can use the <a class="xref" href="security-api.html#security-api-clear-cache" title="Clear cache API">clear cache API</a> to force
the eviction of cached users . For example, the following request evicts all
users from the <code class="literal">ad1</code> realm:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">$ curl -XPOST 'http://localhost:9200/_security/realm/ad1/_clear_cache'</pre>
</div>
<p>To clear the cache for multiple realms, specify the realms as a comma-separated
list:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">$ curl -XPOST 'http://localhost:9200/_security/realm/ad1,ad2/_clear_cache'</pre>
</div>
<p>You can also evict specific users:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">$ curl -XPOST 'http://localhost:9200/_security/realm/ad1/_clear_cache?usernames=rdeniro,alpacino'</pre>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="saml-guide-stack"></a>Configuring SAML single-sign-on on the Elastic Stack<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack supports SAML single-sign-on (SSO) into Kibana, using Elasticsearch as
a backend service. In SAML terminology, the Elastic Stack is operating as a
<em>Service Provider</em>.</p>
<p>The other component that is needed to enable SAML single-sign-on is the
<em>Identity Provider</em>, which is a service that handles your credentials and
performs that actual authentication of users.</p>
<p>If you are interested in configuring SSO into Kibana, then you will need to
provide Elasticsearch with information about your <em>Identity Provider</em>, and you will need
to register the Elastic Stack as a known <em>Service Provider</em> within that
Identity Provider. There are also a few configuration changes that are
required in Kibana to activate the SAML authentication provider.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The SAML support in Kibana is designed on the expectation that it will be
the primary (or sole) authentication method for users of that Kibana instance.
Once you enable SAML authentication in Kibana it will affect all users who try
to login. The <a class="xref" href="setting-up-authentication.html#saml-configure-kibana" title="Configuring Kibana">Configuring Kibana</a> section provides more detail about how
this works.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-guide-idp"></a>The identity provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The Elastic Stack supports the SAML 2.0 <em>Web Browser SSO</em> and the SAML
2.0 <em>Single Logout</em> profiles and can integrate with any Identity Provider (IdP)
that supports at least the SAML 2.0 <em>Web Browser SSO Profile</em>.
It has been tested with a number of popular IdP implementations, such as
<a href="https://www.elastic.co/blog/how-to-configure-elasticsearch-saml-authentication-with-adfs" class="ulink" target="_top">Microsoft Active Directory Federation Services (ADFS)</a>,
<a href="https://www.elastic.co/blog/saml-based-single-sign-on-with-elasticsearch-and-azure-active-directory" class="ulink" target="_top">Azure Active Directory (AAD)</a>,
and <a href="https://www.elastic.co/blog/setting-up-saml-for-elastic-enterprise-search-okta-edition" class="ulink" target="_top">Okta</a>.</p>
<p>This guide assumes that you have an existing IdP and wish to add Kibana as a
Service Provider.</p>
<p>The Elastic Stack uses a standard SAML <em>metadata</em> document, in XML format that
defines the capabilities and features of your IdP. You should be able to
download or generate such a document within your IdP administration interface.</p>
<p>Download the IdP metadata document and store it within the <code class="literal">config</code> directory on
each Elasticsearch node. For the purposes of this guide, we will assume that you are
storing it as <code class="literal">config/saml/idp-metadata.xml</code>.</p>
<p>The IdP will have been assigned an identifier (<em>EntityID</em> in SAML terminology)
which is most commonly expressed in <em>Uniform Resource Identifier</em> (URI) form.
Your admin interface may tell you what this is, or you might need to
read the metadata document to find it - look for the <code class="literal">entityID</code> attribute on the
<code class="literal">EntityDescriptor</code> element.</p>
<p>Most IdPs will provide an appropriate metadata file with all the features that
the Elastic Stack requires, and should only require the configuration steps
described below. For completeness sake, the minimum requirements that the Elastic
Stack has for the IdP&#8217;s metadata are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
An <code class="literal">&lt;EntityDescriptor&gt;</code> with an <code class="literal">entityID</code> that matches the Elasticsearch
<a class="xref" href="setting-up-authentication.html#saml-create-realm" title="Create a SAML realm">configuration</a>
</li>
<li class="listitem">
An <code class="literal">&lt;IDPSSODescriptor&gt;</code> that supports the SAML 2.0 protocol
(<code class="literal">urn:oasis:names:tc:SAML:2.0:protocol</code>).
</li>
<li class="listitem">
At least one <code class="literal">&lt;KeyDescriptor&gt;</code> that is configured for <em>signing</em> (that is, it
has <code class="literal">use="signing"</code> or leaves the <code class="literal">use</code> unspecified)
</li>
<li class="listitem">
A <code class="literal">&lt;SingleSignOnService&gt;</code> with binding of HTTP-Redirect
(<code class="literal">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</code>)
</li>
<li class="listitem">
If you wish to support <a class="xref" href="setting-up-authentication.html#saml-logout" title="SAML logout">Single Logout</a>, a <code class="literal">&lt;SingleLogoutService&gt;</code>
with binding of HTTP-Redirect
(<code class="literal">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</code>)
</li>
</ul>
</div>
<p>The Elastic Stack requires that all messages from the IdP are signed.
For authentication <code class="literal">&lt;Response&gt;</code> messages, the signature may be applied to either
the response itself, or to the individual assertions.
For <code class="literal">&lt;LogoutRequest&gt;</code> messages, the message itself must be signed, and the
signature should be provided as a URL parameter, as required by the HTTP-Redirect
binding.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-elasticsearch-authentication"></a>Configure Elasticsearch for SAML authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>There are five configuration steps to enable SAML authentication in Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#saml-enable-http" title="Enable TLS for HTTP">Enable SSL/TLS for HTTP</a>
</li>
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#saml-enable-token" title="Enable the token service">Enable the Token Service</a>
</li>
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#saml-create-realm" title="Create a SAML realm">Create one or more SAML realms</a>
</li>
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#saml-role-mapping" title="Configuring role mappings">Configure role mappings</a>
</li>
<li class="listitem">
Generate a SAML Metadata file for use by your Identity Provider <em>(optional)</em>
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-enable-http"></a>Enable TLS for HTTP<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>If your Elasticsearch cluster is operating in production mode, then you must
configure the HTTP interface to use SSL/TLS before you can enable SAML
authentication.</p>
<p>For more information, see
<a class="xref" href="manually-configure-security.html#encrypt-http-communication" title="Encrypt HTTP client communications for Elasticsearch">Encrypt HTTP client communications for Elasticsearch</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-enable-token"></a>Enable the token service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elasticsearch SAML implementation makes use of the Elasticsearch Token Service. This service
is automatically enabled if you configure TLS on the HTTP interface, and can be
explicitly configured by including the following in your <code class="literal">elasticsearch.yml</code> file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.token.enabled: true</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-create-realm"></a>Create a SAML realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>SAML authentication is enabled by configuring a SAML realm within the
authentication chain for Elasticsearch.</p>
<p>This realm has a few mandatory settings, and a number of optional settings.
The available settings are described in detail in <a class="xref" href="settings.html#security-settings" title="Security settings in Elasticsearch">Security settings</a>. For
example, <a class="xref" href="settings.html#ref-saml-settings" title="SAML realm settings">SAML realm settings</a>, <a class="xref" href="settings.html#ref-saml-signing-settings" title="SAML realm signing settings">SAML realm signing settings</a>,
<a class="xref" href="settings.html#ref-saml-encryption-settings" title="SAML realm encryption settings">SAML realm encryption settings</a>, <a class="xref" href="settings.html#ref-saml-ssl-settings" title="SAML realm SSL settings">SAML realm SSL settings</a>.
This guide will walk you through the most common settings.</p>
<p>Create a realm by adding the following to your <code class="literal">elasticsearch.yml</code>
configuration file. Each configuration value is explained below.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."</pre>
</div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>SAML is used when authenticating via Kibana, but it is not an
effective means of authenticating directly to the Elasticsearch REST API. For this reason
we recommend that you include at least one additional realm such as the
<a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">native realm</a> in your authentication chain for use by API
clients.</p>
</div>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
xpack.security.authc.realms.saml.saml1
</span>
</dt>
<dd>
This defines a new <code class="literal">saml</code> authentication realm named "saml1".
See <a class="xref" href="setting-up-authentication.html#realms" title="Realms">Realms</a> for more explanation of realms.
</dd>
<dt>
<span class="term">
order
</span>
</dt>
<dd>
The order of the realm within the realm chain. Realms with a lower order
have highest priority and are consulted first. We recommend giving
password-based realms such as file, native, LDAP, and Active Directory the
lowest order (highest priority), followed by SSO realms such as SAML and
OpenID Connect. If you have multiple realms of the same type, give the most
frequently accessed realm the lowest order to have it consulted first.
</dd>
<dt>
<span class="term">
idp.metadata.path
</span>
</dt>
<dd>
This is the path to the metadata file that you saved for your Identity Provider.
The path that you enter here is relative to your <code class="literal">config/</code> directory.
Elasticsearch will automatically monitor this file for changes and will
reload the configuration whenever it is updated.
</dd>
<dt>
<span class="term">
idp.entity_id
</span>
</dt>
<dd>
This is the identifier (SAML EntityID) that your IdP uses.
It should match the <code class="literal">entityID</code> attribute within the metadata file.
</dd>
<dt>
<span class="term">
sp.entity_id
</span>
</dt>
<dd>
This is a unique identifier for your Kibana instance, expressed as a URI.
You will use this value when you add Kibana as a service provider within your IdP.
We recommend that you use the base URL for your Kibana instance as the entity ID.
</dd>
<dt>
<span class="term">
sp.acs
</span>
</dt>
<dd>
The <em>Assertion Consumer Service</em> (ACS) endpoint is the URL within Kibana that accepts
authentication messages from the IdP.
This ACS endpoint supports the SAML HTTP-POST binding only.
It must be a URL that is accessible from the web browser of the user who is
attempting to login to Kibana, it does not need to be directly accessible by Elasticsearch
or the IdP.
The correct value may vary depending on how you have installed Kibana and
whether there are any proxies involved, but it will typically be
<code class="literal">${kibana-url}/api/security/saml/callback</code> where <em>${kibana-url}</em> is the base URL for
your Kibana instance.
</dd>
<dt>
<span class="term">
sp.logout
</span>
</dt>
<dd>
This is the URL within Kibana that accepts logout messages from the IdP.
Like the <code class="literal">sp.acs</code> URL, it must be accessible from the web browser, but does
not need to be directly accessible by Elasticsearch or the IdP. The correct value may
vary depending on how you have installed Kibana and whether there are any
proxies involved, but it will typically be <code class="literal">${kibana-url}/logout</code> where
<em>${kibana-url}</em> is the base URL for your Kibana instance.
</dd>
<dt>
<span class="term">
attributes.principal
</span>
</dt>
<dd>
See <a class="xref" href="setting-up-authentication.html#saml-attributes-mapping" title="Attribute mapping">Attribute mapping</a>.
</dd>
<dt>
<span class="term">
attributes.groups
</span>
</dt>
<dd>
See <a class="xref" href="setting-up-authentication.html#saml-attributes-mapping" title="Attribute mapping">Attribute mapping</a>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-attributes-mapping"></a>Attribute mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>When a user connects to Kibana through your Identity Provider, the Identity
Provider will supply a SAML Assertion about the user. The assertion will contain
an <em>Authentication Statement</em> indicating that the user has successfully
authenticated to the IdP and one or more <em>Attribute Statements</em> that will
include <em>Attributes</em> for the user.</p>
<p>These attributes may include such things as:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
the user&#8217;s username
</li>
<li class="listitem">
the user&#8217;s email address
</li>
<li class="listitem">
the user&#8217;s groups or roles
</li>
</ul>
</div>
<p>Attributes in SAML are named using a URI such as
<code class="literal">urn:oid:0.9.2342.19200300.100.1.1</code> or
<code class="literal">http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn</code>, and have one or
more values associated with them.</p>
<p>These attribute identifiers vary between IdPs, and most IdPs offer ways to
customize the URIs and their associated value.</p>
<p>Elasticsearch uses these attributes to infer information about the user who has
logged in, and they can be used for role mapping (below).</p>
<p>In order for these attributes to be useful, Elasticsearch and the IdP need to have a
common value for the names of the attributes. This is done manually, by
configuring the IdP and the SAML realm to use the same URI name for
each logical user attribute.</p>
<p>The recommended steps for configuring these SAML attributes are as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Consult your IdP to see what user attributes it can provide.
This varies greatly between providers, but you should be able to obtain a list
from the documentation, or from your local admin.
</li>
<li class="listitem">
Read through the list of <a class="xref" href="setting-up-authentication.html#saml-es-user-properties" title="Elasticsearch user properties">user properties</a> that Elasticsearch
supports, and decide which of them are useful to you, and can be provided by
your IdP. At a <em>minimum</em>, the <code class="literal">principal</code> attribute is required.
</li>
<li class="listitem">
Configure your IdP to "release" those attributes to your Kibana SAML service
provider. This process varies by provider - some will provide a user interface
for this, while others may require that you edit configuration files.
Usually the IdP (or your local administrator) will have suggestions about what
URI to use for each attribute. You can simply accept those suggestions, as the
Elasticsearch service is entirely configurable and does not require that any specific
URIs are used.
</li>
<li class="listitem">
Configure the SAML realm in Elasticsearch to associate the Elasticsearch user properties (see
<a class="xref" href="setting-up-authentication.html#saml-es-user-properties" title="Elasticsearch user properties">the listing</a> below), to the URIs that you configured
in your IdP. In the example above, we have configured the <code class="literal">principal</code> and
<code class="literal">groups</code> attributes.
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="saml-attribute-mapping-nameid"></a>Special attribute names<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>In general, Elasticsearch expects that the configured value for an attribute will be a
URI such as <code class="literal">urn:oid:0.9.2342.19200300.100.1.1</code>, however there are some
additional names that can be used:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">nameid</code>
</span>
</dt>
<dd>
This uses the SAML <code class="literal">NameID</code> value (all leading and trailing whitespace removed)
instead of a SAML attribute. SAML
<code class="literal">NameID</code> elements are an optional, but frequently provided, field within a
SAML Assertion that the IdP may use to identify the Subject of that
Assertion. In some cases the <code class="literal">NameID</code> will relate to the user&#8217;s login
identifier (username) within the IdP, but in many cases they will be
internally generated identifiers that have no obvious meaning outside
of the IdP.
</dd>
<dt>
<span class="term">
<code class="literal">nameid:persistent</code>
</span>
</dt>
<dd>
This uses the SAML <code class="literal">NameID</code> value (all leading and trailing whitespace removed),
but only if the NameID format is
<code class="literal">urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</code>.
A SAML <code class="literal">NameID</code> element has an optional <code class="literal">Format</code> attribute that indicates
the semantics of the provided name. It is common for IdPs to be configured
with "transient" NameIDs that present a new identifier for each session.
Since it is rarely useful to use a transient NameID as part of an attribute
mapping, the "nameid:persistent" attribute name can be used as a safety
mechanism that will cause an error if you attempt to map from a <code class="literal">NameID</code>
that does not have a persistent value.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Identity Providers can be either statically configured to release a <code class="literal">NameID</code>
with a specific format, or they can be configured to try to conform with the
requirements of the SP. The SP declares its requirements as part of the
Authentication Request, using an element which is called the <code class="literal">NameIDPolicy</code>. If
this is needed, you can set the relevant <a class="xref" href="settings.html#ref-saml-settings" title="SAML realm settings">settings</a> named
<code class="literal">nameid_format</code> in order to request that the IdP releases a <code class="literal">NameID</code> with a
specific format.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>friendlyName</em>
</span>
</dt>
<dd>
A SAML attribute may have a <em>friendlyName</em> in addition to its URI based name.
For example the attribute with a name of <code class="literal">urn:oid:0.9.2342.19200300.100.1.1</code>
might also have a friendlyName of <code class="literal">uid</code>.
You may use these friendly names within an attribute mapping, but it is
recommended that you use the URI based names, as friendlyNames are neither
standardized or mandatory.
</dd>
</dl>
</div>
<p>The example below configures a realm to use a persistent nameid for the principal,
and the attribute with the friendlyName "roles" for the user&#8217;s groups.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  attributes.principal: "nameid:persistent"
  attributes.groups: "roles"
  nameid_format: "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="saml-es-user-properties"></a>Elasticsearch user properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch SAML realm can be configured to map SAML <code class="literal">attributes</code> to the
following properties on the authenticated user:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
principal
</span>
</dt>
<dd>
<em>(Required)</em>
This is the <em>username</em> that will be applied to a user that authenticates
against this realm.
The <code class="literal">principal</code> appears in places such as the Elasticsearch audit logs.
</dd>
<dt>
<span class="term">
groups
</span>
</dt>
<dd>
<p>
<em>(Recommended)</em>
If you wish to use your IdP&#8217;s concept of groups or roles as the basis for a
user&#8217;s Elasticsearch privileges, you should map them with this attribute.
The <code class="literal">groups</code> are passed directly to your
<a class="xref" href="setting-up-authentication.html#saml-role-mapping" title="Configuring role mappings">role mapping rules</a>.
</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Some IdPs are configured to send the <code class="literal">groups</code> list as a comma-separated string,
but Elasticsearch can&#8217;t parse this string into an array of groups. To map this SAML
attribute to the <code class="literal">attributes.groups</code> setting in the Elasticsearch realm, a cluster
security administrator can use a wildcard when
<a class="xref" href="setting-up-authentication.html#saml-role-mapping" title="Configuring role mappings">configuring role mappings</a>. While flexible, wildcards are
less accurate and can match on unwanted patterns. Instead, a cluster security
administrator can use a regular expression to create a role mapping rule that
matches only a single group. For example, the following regular expression
matches only on the <code class="literal">elasticsearch-admins</code> group:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">/^(.*,)?elasticsearch-admins(,.*)?$/</pre>
</div>
<p>These regular expressions are based on Lucene’s
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.9/regexp-syntax.html" class="ulink" target="_top">regular expression syntax</a>, and can match more complex
patterns. All regular expressions must start and end with a forward slash.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
name
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s full name.
</dd>
<dt>
<span class="term">
mail
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s email address.
</dd>
<dt>
<span class="term">
dn
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s X.500 <em>Distinguished Name</em>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_extracting_partial_values_from_saml_attributes"></a>Extracting partial values from SAML attributes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>There are some occasions where the IdP&#8217;s attribute may contain more information
than you wish to use within Elasticsearch. A common example of this is one where the
IdP works exclusively with email addresses, but you would like the user&#8217;s
<code class="literal">principal</code> to use the <em>local-name</em> part of the email address.
For example if their email address was <code class="literal">james.wong@staff.example.com</code>, then you
would like their principal to simply be <code class="literal">james.wong</code>.</p>
<p>This can be achieved using the <code class="literal">attribute_patterns</code> setting in the Elasticsearch
realm, as demonstrated in the realm configuration below:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
  attribute_patterns.principal: "^([^@]+)@staff\\.example\\.com$"</pre>
</div>
<p>In this case, the user&#8217;s <code class="literal">principal</code> is mapped from an email attribute, but a
regular expression is applied to the value before it is assigned to the user.
If the regular expression matches, then the result of the first group is used as
effective value. If the regular expression does not match then the attribute
mapping fails.</p>
<p>In this example, the email address must belong to the <code class="literal">staff.example.com</code> domain,
and then the local-part (anything before the <code class="literal">@</code>) is used as the principal.
Any users who try to login using a different email domain will fail because the
regular expression will not match against their email address, and thus their
principal attribute - which is mandatory - will not be populated.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Small mistakes in these regular expressions can have significant
security consequences. For example, if we accidentally left off the trailing
<code class="literal">$</code> from the example above, then we would match any email address where the
domain starts with <code class="literal">staff.example.com</code>, and this would accept an email
address such as <code class="literal">admin@staff.example.com.attacker.net</code>. It is important that
you make sure your regular expressions are as precise as possible so that
you do not inadvertently open an avenue for user impersonation attacks.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="req-authn-context"></a>Requesting specific authentication methods<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>It is sometimes necessary for a SAML SP to be able to impose specific
restrictions regarding the authentication that will take place at an IdP,
in order to assess the level of confidence that it can place in
the corresponding authentication response. The restrictions might have to do
with the authentication method (password, client certificates, etc), the
user identification method during registration, and other details. Elasticsearch implements
<a href="https://docs.oasis-open.org/security/saml/v2.0/saml-authn-context-2.0-os.pdf" class="ulink" target="_top">SAML 2.0 Authentication Context</a>, which can be used for this purpose as defined in SAML 2.0 Core
Specification.</p>
<p>In short, the SAML SP defines a set of Authentication Context Class Reference
values, which describe the restrictions to be imposed on the IdP, and sends these
in the Authentication Request. The IdP attempts to grant these restrictions.
If it cannot grant them, the authentication attempt fails. If the user is
successfully authenticated, the Authentication Statement of the SAML Response
contains an indication of the restrictions that were satisfied.</p>
<p>You can define the Authentication Context Class Reference values by using the <code class="literal">req_authn_context_class_ref</code> option in the SAML realm configuration. See
<a class="xref" href="settings.html#ref-saml-settings" title="SAML realm settings">SAML realm settings</a>.</p>
<p>Elasticsearch supports only the <code class="literal">exact</code> comparison method for the Authentication Context.
When it receives the Authentication Response from the IdP, Elasticsearch examines the
value of the Authentication Context Class Reference that is part of the
Authentication Statement of the SAML Assertion. If it matches one of the
requested values, the authentication is considered successful. Otherwise, the
authentication attempt fails.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-logout"></a>SAML logout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The SAML protocol supports the concept of Single Logout (SLO).
The level of support for SLO varies between Identity Providers.
You should consult the documentation for your IdP to determine what Logout
services it offers.</p>
<p>By default the Elastic Stack will support SAML SLO if the following are true:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Your IdP metadata specifies that the IdP offers a SLO service
</li>
<li class="listitem">
Your IdP releases a NameID in the subject of the SAML assertion that it issues for your users
</li>
<li class="listitem">
You configure <code class="literal">sp.logout</code>
</li>
<li class="listitem">
The setting <code class="literal">idp.use_single_logout</code> is not <code class="literal">false</code>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_idp_slo_service"></a>IdP SLO service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>One of the values that Elasticsearch reads from the IdP&#8217;s SAML metadata is the
<code class="literal">&lt;SingleLogoutService&gt;</code>. In order for Single Logout to work with the Elastic
stack, Elasticsearch requires that this exist and support a binding of
<code class="literal">urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</code>.</p>
<p>The Elastic Stack will send both <code class="literal">&lt;LogoutRequest&gt;</code> and <code class="literal">&lt;LogoutResponse&gt;</code>
messages to this service as appropriate.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_the_sp_logout_setting"></a>The sp.logout setting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch realm setting <code class="literal">sp.logout</code> specifies a URL in Kibana to which the IdP can
send both <code class="literal">&lt;LogoutRequest&gt;</code> and <code class="literal">&lt;LogoutResponse&gt;</code> messages. This service uses
the SAML HTTP-Redirect binding.</p>
<p>Elasticsearch will process <code class="literal">&lt;LogoutRequest&gt;</code> messages, and perform a global signout that
invalidates any existing Elasticsearch security tokens that are associated with the
provided SAML session.</p>
<p>If you do not configure a value for <code class="literal">sp.logout</code>, Elasticsearch will refuse all
<code class="literal">&lt;LogoutRequest&gt;</code> messages.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>It is common for IdPs to require that <code class="literal">LogoutRequest</code> messages be signed,
so you may need to configure <a class="xref" href="setting-up-authentication.html#saml-enc-sign" title="Encryption and signing">signing credentials</a>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_the_idp_use_single_logout_setting"></a>The idp.use_single_logout setting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>If your IdP provides a <code class="literal">&lt;SingleLogoutService&gt;</code> but you do not wish to use it,
you can configure <code class="literal">idp.use_single_logout: false</code> in your SAML realm, and Elasticsearch
will ignore the SLO service that your IdP provides. In this case, when a user
logs out of Kibana it will invalidate their Elasticsearch session (security token), but
will not perform any logout at the IdP.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_using_kibana_without_single_logout"></a>Using Kibana without single logout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>If your IdP does not support Single Logout, or you choose not to use it, then
Kibana will perform a "local logout" only.</p>
<p>This means that Kibana will invalidate the session token it is using to
communicate with Elasticsearch, but will not be able to perform any sort of invalidation
of the Identity Provider session. In most cases this will mean that Kibana users
are still considered to be logged in to the IdP. Consequently, if the user
navigates to the Kibana landing page, they will be automatically reauthenticated,
and will commence a new Kibana session without needing to enter any credentials.</p>
<p>The possible solutions to this problem are:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Ask your IdP administrator or vendor to provide a Single Logout service
</li>
<li class="listitem">
If your Idp does provide a Single Logout Service, make sure it is included in
the IdP metadata file, and do <em>not</em> set <code class="literal">idp.use_single_logout</code> to <code class="literal">false</code>.
</li>
<li class="listitem">
Advise your users to close their browser after logging out of Kibana
</li>
<li class="listitem">
Enable the <code class="literal">force_authn</code> setting on your SAML realm. This setting causes the
Elastic Stack to request fresh authentication from the IdP every time a user
attempts to log in to Kibana.
This setting defaults to <code class="literal">false</code> because it can be a more cumbersome user
experience, but it can also be an effective protection to stop users
piggy-backing on existing IdP sessions.
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-enc-sign"></a>Encryption and signing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elastic Stack supports generating signed SAML messages (for authentication
and/or logout), verifying signed SAML messages from the IdP (for both
authentication and logout) and can process encrypted content.</p>
<p>You can configure Elasticsearch for signing, encryption or both, with the same
or separate keys used for each of those.</p>
<p>The Elastic Stack uses X.509 certificates with RSA private keys for SAML
cryptography. These keys can be generated using any standard SSL tool, including
the <code class="literal">elasticsearch-certutil</code> tool.</p>
<p>Your IdP may require that the Elastic Stack have a cryptographic key for signing
SAML messages, and that you provide the corresponding signing certificate within
the Service Provider configuration (either within the Elastic Stack SAML
metadata file or manually configured within the IdP administration interface).
While most IdPs do not expected authentication requests to be signed, it is
commonly the case that signatures are required for logout requests. Your IdP
will validate these signatures against the signing certificate that has been
configured for the Elastic Stack Service Provider.</p>
<p>Encryption certificates are rarely needed, but the Elastic Stack supports them
for cases where IdPs or local policies mandate their use.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_generating_certificates_and_keys"></a>Generating certificates and keys<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>Elasticsearch supports certificates and keys in either PEM, PKCS#12 or JKS format.
Some Identity Providers are more restrictive in the formats they support, and
will require you to provide the certificates as a file in a particular format.
You should consult the documentation for your IdP to determine what formats they
support. Since PEM format is the most commonly supported format, the examples
below will generate certificates in that format.</p>
<p>Using the <a class="xref" href="certutil.html" title="elasticsearch-certutil"><code class="literal">elasticsearch-certutil</code> tool</a>, you can generate a
signing certificate with the following command:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-certutil cert --self-signed --pem --days 1100 --name saml-sign --out saml-sign.zip</pre>
</div>
<p>This will</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
generate a certificate and key pair (the <code class="literal">cert</code> subcommand)
</li>
<li class="listitem">
create the files in PEM format (<code class="literal">-pem</code> option)
</li>
<li class="listitem">
generate a certificate that is valid for 3 years (<code class="literal">-days 1100</code>)
</li>
<li class="listitem">
name the certificate <code class="literal">saml-sign</code> (<code class="literal">-name</code> option)
</li>
<li class="listitem">
save the certificate and key in the <code class="literal">saml-sign.zip</code> file (<code class="literal">-out</code> option)
</li>
</ul>
</div>
<p>The generated zip archive will contain 3 files:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">saml-sign.crt</code>, the public certificate to be used for signing
</li>
<li class="listitem">
<code class="literal">saml-sign.key</code>, the private key for the certificate
</li>
<li class="listitem">
<code class="literal">ca.crt</code>, a CA certificate that is not need, and can be ignored.
</li>
</ul>
</div>
<p>Encryption certificates can be generated with the same process.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_configuring_elasticsearch_for_signing"></a>Configuring Elasticsearch for signing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>By default, Elasticsearch will sign <em>all</em> outgoing SAML messages if a signing
key has been configured.</p>
<p>If you wish to use <span class="strong strong"><strong>PEM formatted</strong></span> keys and certificates for signing, then
you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">signing.certificate</code>
</span>
</dt>
<dd>
The path to the PEM formatted certificate file. e.g. <code class="literal">saml/saml-sign.crt</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.key</code>
</span>
</dt>
<dd>
The path to the PEM formatted key file. e.g. <code class="literal">saml/saml-sign.key</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.secure_key_passphrase</code>
</span>
</dt>
<dd>
The passphrase for the key, if the file is encrypted. This is a
<a class="xref" href="settings.html#secure-settings" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
<p>If you wish to use <span class="strong strong"><strong>PKCS#12 formatted</strong></span> files or a <span class="strong strong"><strong>Java Keystore</strong></span> for
signing, then you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">signing.keystore.path</code>
</span>
</dt>
<dd>
The path to the PKCS#12 or JKS keystore. e.g. <code class="literal">saml/saml-sign.p12</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.keystore.alias</code>
</span>
</dt>
<dd>
The alias of the key within the keystore. e.g. <code class="literal">signing-key</code>
</dd>
<dt>
<span class="term">
<code class="literal">signing.keystore.secure_password</code>
</span>
</dt>
<dd>
The passphrase for the keystore, if the file is encrypted. This is a
<a class="xref" href="settings.html#secure-settings" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
<p>If you wish to sign some, but not all outgoing <span class="strong strong"><strong>SAML messages</strong></span>, then you
should configure the following setting on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">signing.saml_messages</code>
</span>
</dt>
<dd>
A list of message types to sign. A message type is identified by the
<em>local name</em> of the XML element used for the message. Supported values
are: <code class="literal">AuthnRequest</code>, <code class="literal">LogoutRequest</code> and <code class="literal">LogoutResponse</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_configuring_elasticsearch_for_encrypted_messages"></a>Configuring Elasticsearch for encrypted messages<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch security features support a single key for message decryption. If a
key is configured, then Elasticsearch attempts to use it to decrypt
<code class="literal">EncryptedAssertion</code> and <code class="literal">EncryptedAttribute</code> elements in Authentication
responses, and <code class="literal">EncryptedID</code> elements in Logout requests.</p>
<p>Elasticsearch rejects any SAML message that contains an <code class="literal">EncryptedAssertion</code>
that cannot be decrypted.</p>
<p>If an <code class="literal">Assertion</code> contains both encrypted and plain-text attributes, then
failure to decrypt the encrypted attributes will not cause an automatic
rejection. Rather, Elasticsearch processes the available plain-text attributes
(and any <code class="literal">EncryptedAttributes</code> that could be decrypted).</p>
<p>If you wish to use <span class="strong strong"><strong>PEM formatted</strong></span> keys and certificates for SAML encryption,
then you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">encryption.certificate</code>
</span>
</dt>
<dd>
The path to the PEM formatted certificate file. e.g. <code class="literal">saml/saml-crypt.crt</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.key</code>
</span>
</dt>
<dd>
The path to the PEM formatted key file. e.g. <code class="literal">saml/saml-crypt.key</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.secure_key_passphrase</code>
</span>
</dt>
<dd>
The passphrase for the key, if the file is encrypted. This is a
<a class="xref" href="settings.html#secure-settings" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
<p>If you wish to use <span class="strong strong"><strong>PKCS#12 formatted</strong></span> files or a <span class="strong strong"><strong>Java Keystore</strong></span> for SAML
encryption, then you should configure the following settings on the SAML realm:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">encryption.keystore.path</code>
</span>
</dt>
<dd>
The path to the PKCS#12 or JKS keystore. e.g. <code class="literal">saml/saml-crypt.p12</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.keystore.alias</code>
</span>
</dt>
<dd>
The alias of the key within the keystore. e.g. <code class="literal">encryption-key</code>
</dd>
<dt>
<span class="term">
<code class="literal">encryption.keystore.secure_password</code>
</span>
</dt>
<dd>
The passphrase for the keystore, if the file is encrypted. This is a
<a class="xref" href="settings.html#secure-settings" title="Secure settings">secure setting</a> that must be set with the
<code class="literal">elasticsearch-keystore</code> tool.
</dd>
</dl>
</div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-sp-metadata"></a>Generating SP metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>Some Identity Providers support importing a metadata file from the Service
Provider. This will automatically configure many of the integration options
between the IdP and the SP.</p>
<p>The Elastic Stack supports generating such a metadata file using the
<a class="xref" href="saml-metadata.html" title="elasticsearch-saml-metadata"><code class="literal">bin/elasticsearch-saml-metadata</code> command</a> or the
<a class="xref" href="security-api.html#security-api-saml-sp-metadata" title="SAML service provider metadata API">SAML service provider metadata API</a>.</p>
<p>You can generate the SAML metadata by issuing the API request to Elasticsearch and store
it as an XML file using tools like <code class="literal">jq</code>. For example, the following command
generates the metadata for the SAML realm <code class="literal">realm1</code> and saves it to a
<code class="literal">metadata.xml</code> file:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">curl -u user_name:password  -X GET http://localhost:9200/_security/saml/metadata/saml1 -H 'Content-Type: application/json' | jq -r '.[]' &gt; metadata.xml</pre>
</div>
<div class="console_widget" data-snippet="snippets/1804.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-role-mapping"></a>Configuring role mappings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>When a user authenticates using SAML, they are identified to the Elastic Stack,
but this does not automatically grant them access to perform any actions or
access any data.</p>
<p>Your SAML users cannot do anything until they are assigned roles. This can be done
through either the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">add role mapping API</a> or with
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use <a class="xref" href="authorization.html#mapping-roles-file" title="Using role mapping files">role mapping files</a>
to grant roles to users authenticating via SAML.</p>
</div>
</div>
<p>This is an example of a simple role mapping that grants the <code class="literal">example_role</code> role
to any user who authenticates against the <code class="literal">saml1</code> realm:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/saml-example
{
  "roles": [ "example_role" ], <a id="CO578-1"></a><i class="conum" data-value="1"></i>
  "enabled": true,
  "rules": {
    "field": { "realm.name": "saml1" }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1805.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO578-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">example_role</code> role is <span class="strong strong"><strong>not</strong></span> a builtin Elasticsearch role.
This example assumes that you have created a custom role of your own, with
appropriate access to your <a class="xref" href="authorization.html#roles-indices-priv" title="Indices Privileges">data streams, indices,</a> and
<a href="https://www.elastic.co/guide/en/kibana/8.9/kibana-privileges.html#kibana-feature-privileges" class="ulink" target="_top">Kibana features</a>.</p>
</td>
</tr>
</table>
</div>
<p>The attributes that are mapped via the realm configuration are used to process
role mapping rules, and these rules determine which roles a user is granted.</p>
<p>The user fields that are provided to the role
mapping are derived from the SAML attributes as follows:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">username</code>: The <code class="literal">principal</code> attribute
</li>
<li class="listitem">
<code class="literal">dn</code>: The <code class="literal">dn</code> attribute
</li>
<li class="listitem">
<code class="literal">groups</code>: The <code class="literal">groups</code> attribute
</li>
<li class="listitem">
<code class="literal">metadata</code>: See <a class="xref" href="setting-up-authentication.html#saml-user-metadata" title="User metadata">User metadata</a>
</li>
</ul>
</div>
<p>For more information, see <a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">Mapping users and groups to roles</a> and
<a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">Role mappings</a>.</p>
<p>If your IdP has the ability to provide groups or roles to Service Providers,
then you should map this SAML attribute to the <code class="literal">attributes.groups</code> setting in
the Elasticsearch realm, and then make use of it in a role mapping as per the example
below.</p>
<p>This mapping grants the Elasticsearch <code class="literal">finance_data</code> role, to any users who authenticate
via the <code class="literal">saml1</code> realm with the <code class="literal">finance-team</code> group.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/saml-finance
{
  "roles": [ "finance_data" ],
  "enabled": true,
  "rules": { "all": [
        { "field": { "realm.name": "saml1" } },
        { "field": { "groups": "finance-team" } } <a id="CO579-1"></a><i class="conum" data-value="1"></i>
  ] }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1806.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO579-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">groups</code> attribute supports using wildcards (<code class="literal">*</code>). Refer to the
<a class="xref" href="security-api.html#security-api-put-role-mapping-example" title="Examples">create or update role mappings API</a> for
more information.</p>
</td>
</tr>
</table>
</div>
<p>If your users also exist in a repository that can be directly accessed by Elasticsearch
(such as an LDAP directory) then you can use
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> instead of role mappings.</p>
<p>In this case, you perform the following steps:
1. In your SAML realm, assigned a SAML attribute to act as the lookup userid,
   by configuring the <code class="literal">attributes.principal</code> setting.
2. Create a new realm that can lookup users from your local repository (e.g. an
   <code class="literal">ldap</code> realm)
3. In your SAML realm, set <code class="literal">authorization_realms</code> to the name of the realm you
   created in step 2.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-user-metadata"></a>User metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>By default users who authenticate via SAML will have some additional metadata
fields.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">saml_nameid</code> will be set to the value of the <code class="literal">NameID</code> element in the SAML
authentication response
</li>
<li class="listitem">
<code class="literal">saml_nameid_format</code> will be set to the full URI of the NameID&#8217;s <code class="literal">format</code>
attribute
</li>
<li class="listitem">
Every SAML Attribute that is provided in the authentication response
(regardless of whether it is mapped to an Elasticsearch user property), will be added
as the metadata field <code class="literal">saml(name)</code> where "name" is the full URI name of the
attribute. For example <code class="literal">saml(urn:oid:0.9.2342.19200300.100.1.3)</code>.
</li>
<li class="listitem">
For every SAML Attribute that has a <em>friendlyName</em>, will also be added as the
metadata field <code class="literal">saml_friendlyName</code> where "name" is the full URI name of the
attribute. For example <code class="literal">saml_mail</code>.
</li>
</ul>
</div>
<p>This behaviour can be disabled by adding <code class="literal">populate_user_metadata: false</code> to as
a setting in the saml realm.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-configure-kibana"></a>Configuring Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>SAML authentication in Kibana requires a small number of additional settings
in addition to the standard Kibana security configuration. The
<a href="https://www.elastic.co/guide/en/kibana/8.9/using-kibana-with-security.html" class="ulink" target="_top">Kibana security documentation</a>
provides details on the available configuration options that you can apply.</p>
<p>In particular, since your Elasticsearch nodes have been configured to use TLS on the HTTP
interface, you must configure Kibana to use a <code class="literal">https</code> URL to connect to Elasticsearch, and
you may need to configure <code class="literal">elasticsearch.ssl.certificateAuthorities</code> to trust
the certificates that Elasticsearch has been configured to use.</p>
<p>SAML authentication in Kibana is subject to the following timeout settings in
<code class="literal">kibana.yml</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.elastic.co/guide/en/kibana/8.9/xpack-security-session-management.html#session-idle-timeout" class="ulink" target="_top"><code class="literal">xpack.security.session.idleTimeout</code></a>
</li>
<li class="listitem">
<a href="https://www.elastic.co/guide/en/kibana/8.9/xpack-security-session-management.html#session-lifespan" class="ulink" target="_top"><code class="literal">xpack.security.session.lifespan</code></a>
</li>
</ul>
</div>
<p>You may want to adjust these timeouts based on your security requirements.</p>
<p>The three additional settings that are required for SAML support are shown below:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  saml.saml1:
    order: 0
    realm: "saml1"</pre>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers</code>
</span>
</dt>
<dd>
Add <code class="literal">saml</code> provider to instruct Kibana to use SAML SSO as the authentication
method.
</dd>
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers.saml.&lt;provider-name&gt;.realm</code>
</span>
</dt>
<dd>
Set this to the name of the SAML realm that you have used in your <a class="xref" href="setting-up-authentication.html#saml-create-realm" title="Create a SAML realm">Elasticsearch realm configuration</a>, for instance: <code class="literal">saml1</code>
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-kibana-basic"></a>Supporting SAML and basic authentication in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The SAML support in Kibana is designed on the expectation that it will be the
primary (or sole) authentication method for users of that Kibana instance.
However, it is possible to support both SAML and Basic authentication within a
single Kibana instance by setting <code class="literal">xpack.security.authc.providers</code> as per the
example below:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  saml.saml1:
    order: 0
    realm: "saml1"
  basic.basic1:
    order: 1</pre>
</div>
<p>If Kibana is configured in this way, users are presented with a choice
at the Login Selector UI. They log in with SAML or they provide a username and password and rely on one
of the other security realms within Elasticsearch. Only users who have
a username and password for a configured Elasticsearch authentication realm can
log in via Kibana login form.</p>
<p>Alternatively, when the <code class="literal">basic</code> authentication provider is enabled, you can
place a reverse proxy in front of Kibana, and configure it to send a basic
authentication header (<code class="literal">Authorization: Basic ....</code>) for each request.
If this header is present and valid, Kibana will not initiate the SAML
authentication process.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_operating_multiple_kibana_instances"></a>Operating multiple Kibana instances<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>If you wish to have multiple Kibana instances that authenticate against the same
Elasticsearch cluster, then each Kibana instance that is configured for SAML authentication,
requires its own SAML realm.</p>
<p>Each SAML realm must have its own unique Entity ID (<code class="literal">sp.entity_id</code>), and its own
<em>Assertion Consumer Service</em> (<code class="literal">sp.acs</code>). Each Kibana instance will be mapped to
the correct realm by looking up the matching <code class="literal">sp.acs</code> value.</p>
<p>These realms may use the same Identity Provider, but are not required to.</p>
<p>The following is example of having 3 difference Kibana instances, 2 of which
use the same internal IdP, and another which uses a different IdP.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.saml.saml_finance:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.finance.example.com/"
  sp.acs: "https://kibana.finance.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.finance.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."
xpack.security.authc.realms.saml.saml_sales:
  order: 3
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.sales.example.com/"
  sp.acs: "https://kibana.sales.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.sales.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."
xpack.security.authc.realms.saml.saml_eng:
  order: 4
  idp.metadata.path: saml/idp-external.xml
  idp.entity_id: "https://engineering.sso.example.net/"
  sp.entity_id:  "https://kibana.engineering.example.com/"
  sp.acs: "https://kibana.engineering.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.engineering.example.com/logout"
  attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"</pre>
</div>
<p>It is possible to have one or more Kibana instances that use SAML, while other
instances use basic authentication against another realm type (e.g.
<a class="xref" href="setting-up-authentication.html#native-realm" title="Native user authentication">Native</a> or <a class="xref" href="setting-up-authentication.html#ldap-realm" title="LDAP user authentication">LDAP</a>).</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-troubleshooting"></a>Troubleshooting SAML Realm Configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The SAML 2.0 specification offers a lot of options and flexibility for the implementers
of the standard which in turn adds to the complexity and the number of configuration options
that are available both at the Service Provider (Elastic Stack) and at the Identity Provider.
Additionally, different security domains have different security requirements that need
specific configuration to be satisfied.
A conscious effort has been made to mask this complexity with sane defaults and the detailed
documentation above but in case you encounter issues while configuring a SAML realm, you can
look through our <a class="xref" href="security-troubleshooting.html#trb-security-saml" title="Common SAML issues">SAML troubleshooting documentation</a> that has
suggestions and resolutions for common issues.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="saml-no-kibana"></a>SAML without Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The SAML realm in Elasticsearch is designed to allow users to authenticate to Kibana and as
such, most of the parts of the guide above make the assumption that Kibana is used.
This section describes how a custom web application could use the relevant SAML
REST APIs in order to authenticate the users to Elasticsearch with SAML.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This section assumes that the reader is familiar with the SAML 2.0 standard
and more specifically with the SAML 2.0 Web Browser Single Sign On profile.</p>
</div>
</div>
<p>Single sign-on realms such as OpenID Connect and SAML make use of the Token Service in
Elasticsearch and in principle exchange a SAML or OpenID Connect Authentication response for
an Elasticsearch access token and a refresh token. The access token is used as credentials
for subsequent calls to Elasticsearch. The refresh token enables the user to get new Elasticsearch
access tokens after the current one expires.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-realm"></a>SAML realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>You must create a SAML realm and configure it accordingly
in Elasticsearch. See <a class="xref" href="setting-up-authentication.html#saml-elasticsearch-authentication" title="Configure Elasticsearch for SAML authentication">Configure Elasticsearch for SAML authentication</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-user"></a>Service Account user for accessing the APIs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The realm is designed with the assumption that there needs to be a privileged entity
acting as an authentication proxy. In this case, the custom web application is the
authentication proxy handling the authentication of end users (more correctly,
"delegating" the authentication to the SAML Identity Provider). The SAML related
APIs require authentication and the necessary authorization level for the authenticated
user. For this reason, you must create a Service Account user and assign it a role
that gives it the <code class="literal">manage_saml</code> cluster privilege. The use of the <code class="literal">manage_token</code>
cluster privilege will be necessary after the authentication takes place, so that
the service account user can maintain access in order refresh access tokens on
behalf of the authenticated users or to subsequently log them out.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role/saml-service-role
{
  "cluster" : ["manage_saml", "manage_token"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1807.console"></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/user/saml-service-user
{
  "password" : "&lt;somePasswordHere&gt;",
  "roles"    : ["saml-service-role"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1808.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-sp-init-sso"></a>Handling the SP-initiated authentication flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>On a high level, the custom web application would need to perform the
following steps in order to authenticate a user with SAML against Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Make an HTTP POST request to <code class="literal">_security/saml/prepare</code>, authenticating as
the <code class="literal">saml-service-user</code> user. Use either the name of the SAML realm in the Elasticsearch configuration or the value for
the Assertion Consumer Service URL in the request body.
See the <a class="xref" href="security-api.html#security-api-saml-prepare-authentication" title="SAML prepare authentication API">SAML prepare authentication API</a> for more details.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/saml/prepare
{
  "realm" : "saml1"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1809.console"></div>
</li>
<li class="listitem">
Handle the response from <code class="literal">/_security/saml/prepare</code>. The response from Elasticsearch will contain 3 parameters:
  <code class="literal">redirect</code>, <code class="literal">realm</code> and <code class="literal">id</code>. The custom web application would need to store the value for <code class="literal">id</code>
 in the user&#8217;s session (client side in a cookie or server side if session information is
persisted this way). It must also redirect the user&#8217;s browser to the URL that was returned in the
  <code class="literal">redirect</code> parameter. The <code class="literal">id</code> value should not be disregarded as it is used as a nonce in SAML in
order to mitigate against replay attacks.
</li>
<li class="listitem">
<p>Handle a subsequent response from the SAML IdP. After the user is successfully authenticated with the
Identity Provider they will be redirected back to the Assertion Consumer Service URL. This <code class="literal">sp.acs</code> needs to be
defined as a URL which the custom web application handles. When it receives this HTTP POST request, the
custom web application must parse it and make an HTTP POST request itself to the
<code class="literal">_security/saml/authenticate</code> API. It must authenticate as the <code class="literal">saml-service-user</code> user and pass
the Base64 encoded SAML Response that was sent as the body of the request. It must also pass the value for <code class="literal">id</code> that it had saved in the user&#8217;s session previously.</p>
<p>See <a class="xref" href="security-api.html#security-api-saml-authenticate" title="SAML authenticate API">SAML authenticate API</a> for more details.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/saml/authenticate
{
  "content" : "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMD.....",
  "ids" : ["4fee3b046395c4e751011e97f8900b5273d56685"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1810.console"></div>
<p>Elasticsearch will validate this and if all is correct will respond with an access token that can be used
as a <code class="literal">Bearer</code> token for subsequent requests. It also supplies a refresh token that can be later used to refresh the given
access token as described in <a class="xref" href="security-api.html#security-api-get-token" title="Get token API">get token API</a>.</p>
</li>
<li class="listitem">
The response to calling <code class="literal">/_security/saml/authenticate</code> will contain only the username of the authenticated
user. If you need to get the values for the SAML Attributes that were contained in the SAML
Response for that user, you can call the Authenticate API <code class="literal">/_security/_authenticate/</code> using the access token as a <code class="literal">Bearer</code> token
and the SAML attribute values will be contained in the response as part of the <a class="xref" href="setting-up-authentication.html#saml-user-metadata" title="User metadata">User metadata</a>.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-idp-init-sso"></a>Handling the IdP-initiated authentication flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>Elasticsearch can also handle the IdP-initiated Single Sign On flow of the SAML 2 Web Browser SSO profile. In this
case the authentication starts with an unsolicited authentication response from the SAML Identity
Provider. The difference with the <a class="xref" href="setting-up-authentication.html#saml-no-kibana-sp-init-sso" title="Handling the SP-initiated authentication flow">SP initiated SSO</a> is that the web application needs to handle
requests to the <code class="literal">sp.acs</code> that will not come as responses to previous redirections. As such, it will not have a session
for the user already, and it will not have any stored values for the <code class="literal">id</code> parameter. The request to the
<code class="literal">_security/saml/authenticate</code> API will look like the one below in this case:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/saml/authenticate
{
  "content" : "PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMD.....",
  "ids" : []
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1811.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="saml-no-kibana-slo"></a>Handling the logout flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/saml-guide.asciidoc">edit</a></h4>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>At some point, if necessary, the custom web application can log the user out by using the
<a class="xref" href="security-api.html#security-api-saml-logout" title="SAML logout API">SAML logout API</a> and passing the access token and refresh token as parameters. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/saml/logout
{
  "token" : "46ToAxZVaXVVZTVKOVF5YU04ZFJVUDVSZlV3",
  "refresh_token": "mJdXLtmvTUSpoLwMvdBt_w"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1812.console"></div>
<p>If the SAML realm is configured accordingly and the IdP supports it (see <a class="xref" href="setting-up-authentication.html#saml-logout" title="SAML logout">SAML logout</a>), this request will trigger a SAML
SP-initiated Single Logout. In this case, the response will include a <code class="literal">redirect</code>
parameter indicating where the user needs to be redirected at the IdP in order to complete the logout.</p>
</li>
<li class="listitem">
<p>Alternatively, the IdP might initiate the Single Logout flow at some point. In order to handle this,
the Logout URL (<code class="literal">sp.logout</code>) needs to be handled by the custom web app. The query part of the URL that the
user will be redirected to will contain a SAML Logout request and this query part needs to be relayed to Elasticsearch
using the <a class="xref" href="security-api.html#security-api-saml-invalidate" title="SAML invalidate API">SAML invalidate API</a></p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/saml/invalidate
{
  "query" : "SAMLRequest=nZFda4MwFIb%2FiuS%2BmviRpqFaClKQdbvo2g12M2KMraCJ9cRR9utnW4Wyi13sMie873MeznJ1aWrnS3VQGR0j4mLkKC1NUeljjA77zYyhVbIE0dR%2By7fmaHq7U%2BdegXWGpAZ%2B%2F4pR32luBFTAtWgUcCv56%2Fp5y30X87Yz1khTIycdgpUW9kY7WdsC9zxoXTvMvWuVV98YyMnSGH2SYE5pwALBIr9QKiwDGpW0oGVUznGeMyJZKFkQ4jBf5HnhUymjIhzCAL3KNFihbYx8TBYzzGaY7EnIyZwHzCWMfiDnbRIftkSjJr%2BFu0e9v%2B0EgOquRiiZjKpiVFp6j50T4WXoyNJ%2FEWC9fdqc1t%2F1%2B2F3aUpjzhPiXpqMz1%2FHSn4A&amp;SigAlg=http%3A%2F%2Fwww.w3.org%2F2001%2F04%2Fxmldsig-more%23rsa-sha256&amp;Signature=MsAYz2NFdovMG2mXf6TSpu5vlQQyEJAg%2B4KCwBqJTmrb3yGXKUtIgvjqf88eCAK32v3eN8vupjPC8LglYmke1ZnjK0%2FKxzkvSjTVA7mMQe2AQdKbkyC038zzRq%2FYHcjFDE%2Bz0qISwSHZY2NyLePmwU7SexEXnIz37jKC6NMEhus%3D",
  "realm" : "saml1"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1813.console"></div>
<p>The custom web application will then need to also handle the response, which will include a <code class="literal">redirect</code>
parameter with a URL in the IdP that contains the SAML Logout response. The application should redirect the user
there to complete the logout.</p>
</li>
</ol>
</div>
<p>For SP-initiated Single Logout, the IdP may send back a logout response which can be verified by Elasticsearch
using the <a class="xref" href="security-api.html#security-api-saml-complete-logout" title="SAML complete logout API">SAML complete logout API</a>.</p>
</div>

</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="oidc-guide"></a>Configuring single sign-on to the Elastic Stack using OpenID Connect<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h2>
</div></div></div>
<p>The Elastic Stack supports single sign-on (SSO) using OpenID Connect via Kibana using
Elasticsearch as the backend service that holds most of the functionality. Kibana and Elasticsearch
together represent an OpenID Connect Relying Party (RP) that supports the authorization code flow and implicit flow as these are defined in the OpenID Connect specification.</p>
<p>This guide assumes that you have an OpenID Connect Provider where the
Elastic Stack Relying Party will be registered.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The OpenID Connect realm support in Kibana is designed with the expectation that it
will be the primary authentication method for the users of that Kibana instance. The
<a class="xref" href="setting-up-authentication.html#oidc-configure-kibana" title="Configuring Kibana">Configuring Kibana</a> section describes what this entails and how you can set it up to support
other realms if necessary.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-guide-op"></a>The OpenID Connect Provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The OpenID Connect Provider (OP) is the entity in OpenID Connect that is responsible for
authenticating the user and for granting the necessary tokens with the authentication and
user information to be consumed by the Relying Parties.</p>
<p>In order for the Elastic Stack to be able use your OpenID Connect Provider for authentication,
a trust relationship needs to be established between the OP and the RP. In the OpenID Connect
Provider, this means registering the RP as a client. OpenID Connect defines a dynamic client
registration protocol but this is usually geared towards real-time client registration and
not the trust establishment process for cross security domain single sign on. All OPs will
also allow for the manual registration of an RP as a client, via a user interface or (less often)
via the consumption of a metadata document.</p>
<p>The process for registering the Elastic Stack RP will be different from OP to OP and following
the provider&#8217;s relevant documentation is prudent. The information for the
RP that you commonly need to provide for registration are the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Relying Party Name</code>: An arbitrary identifier for the relying party. Neither the specification
nor the Elastic Stack implementation impose any constraints on this value.
</li>
<li class="listitem">
<code class="literal">Redirect URI</code>: This is the URI where the OP will redirect the user&#8217;s browser after authentication. The
appropriate value for this will depend on your setup and whether or not Kibana sits behind a proxy or
load balancer. It will typically be <code class="literal">${kibana-url}/api/security/oidc/callback</code> (for the authorization code flow) or <code class="literal">${kibana-url}/api/security/oidc/implicit</code> (for the implicit flow) where <em>${kibana-url}</em> is the base URL for your Kibana instance. You might also see this
called <code class="literal">Callback URI</code>.
</li>
</ul>
</div>
<p>At the end of the registration process, the OP will assign a Client Identifier and a Client Secret for the RP (Elastic Stack) to use.
Note these two values as they will be used in the Elasticsearch configuration.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-elasticsearch-authentication"></a>Configure Elasticsearch for OpenID Connect authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The following is a summary of the configuration steps required in order to enable authentication
using OpenID Connect in Elasticsearch:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#oidc-enable-http" title="Enable TLS for HTTP">Enable SSL/TLS for HTTP</a>
</li>
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#oidc-enable-token" title="Enable the token service">Enable the Token Service</a>
</li>
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#oidc-create-realm" title="Create an OpenID Connect realm">Create one or more OpenID Connect realms</a>
</li>
<li class="listitem">
<a class="xref" href="setting-up-authentication.html#oidc-role-mappings" title="Configuring role mappings">Configure role mappings</a>
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-enable-http"></a>Enable TLS for HTTP<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>If your Elasticsearch cluster is operating in production mode, then you must
configure the HTTP interface to use SSL/TLS before you can enable OpenID Connect
authentication.</p>
<p>For more information, see
<a class="xref" href="manually-configure-security.html#encrypt-http-communication" title="Encrypt HTTP client communications for Elasticsearch">Encrypt HTTP client communications for Elasticsearch</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-enable-token"></a>Enable the token service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elasticsearch OpenID Connect implementation makes use of the Elasticsearch Token Service. This service
is automatically enabled if you configure TLS on the HTTP interface, and can be
explicitly configured by including the following in your <code class="literal">elasticsearch.yml</code> file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.token.enabled: true</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-create-realm"></a>Create an OpenID Connect realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>OpenID Connect based authentication is enabled by configuring the appropriate realm within
the authentication chain for Elasticsearch.</p>
<p>This realm has a few mandatory settings, and a number of optional settings.
The available settings are described in detail in
<a class="xref" href="settings.html#ref-oidc-settings" title="OpenID Connect realm settings">OpenID Connect realm settings</a>. This
guide will explore the most common settings.</p>
<p>Create an OpenID Connect (the realm type is <code class="literal">oidc</code>) realm in your <code class="literal">elasticsearch.yml</code> file
similar to what is shown below:</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The values used below are meant to be an example and are not intended to apply to
every use case. The details below the configuration snippet provide insights and suggestions
to help you pick the proper values, depending on your OP configuration.</p>
</div>
</div>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.oidc.oidc1:
  order: 2
  rp.client_id: "the_client_id"
  rp.response_type: code
  rp.redirect_uri: "https://kibana.example.org:5601/api/security/oidc/callback"
  op.issuer: "https://op.example.org"
  op.authorization_endpoint: "https://op.example.org/oauth2/v1/authorize"
  op.token_endpoint: "https://op.example.org/oauth2/v1/token"
  op.jwkset_path: oidc/jwkset.json
  op.userinfo_endpoint: "https://op.example.org/oauth2/v1/userinfo"
  op.endsession_endpoint: "https://op.example.org/oauth2/v1/logout"
  rp.post_logout_redirect_uri: "https://kibana.example.org:5601/security/logged_out"
  claims.principal: sub
  claims.groups: "http://example.info/claims/groups"</pre>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
xpack.security.authc.realms.oidc.oidc1
</span>
</dt>
<dd>
This defines a new <code class="literal">oidc</code> authentication realm named "oidc1".
See <a class="xref" href="setting-up-authentication.html#realms" title="Realms">Realms</a> for more explanation of realms.
</dd>
<dt>
<span class="term">
order
</span>
</dt>
<dd>
You should define a unique order on each realm in your authentication chain.
It is recommended that the OpenID Connect realm be at the bottom of your authentication
chain (that is, that it has the <em>highest</em> order).
</dd>
<dt>
<span class="term">
rp.client_id
</span>
</dt>
<dd>
This, usually opaque, arbitrary string, is the Client Identifier that was assigned to the Elastic Stack RP by the OP upon
registration.
</dd>
<dt>
<span class="term">
rp.response_type
</span>
</dt>
<dd>
<p>
This is an identifier that controls which OpenID Connect authentication flow this RP supports and also
which flow this RP requests the OP should follow. Supported values are
</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">code</code>, which means that the RP wants to use the Authorization Code flow. If your OP supports the
Authorization Code flow, you should select this instead of the Implicit Flow.
</li>
<li class="listitem">
<code class="literal">id_token token</code> which means that the RP wants to use the Implicit flow and we also request an oAuth2
access token from the OP, that we can potentially use for follow up requests ( UserInfo ). This
should be selected if the OP offers a UserInfo endpoint in its configuration, or if you know that
the claims you will need to use for role mapping are not available in the ID Token.
</li>
<li class="listitem">
<code class="literal">id_token</code> which means that the RP wants to use the Implicit flow, but is not interested in getting
an oAuth2 token too. Select this if you are certain that all necessary claims will be contained in
the ID Token or if the OP doesn&#8217;t offer a User Info endpoint.
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
rp.redirect_uri
</span>
</dt>
<dd>
The redirect URI where the OP will redirect the browser after authentication. This needs to be
<em>exactly</em> the same as the one <a class="xref" href="setting-up-authentication.html#oidc-guide-op" title="The OpenID Connect Provider">configured with the OP upon registration</a> and will
typically be <code class="literal">${kibana-url}/api/security/oidc/callback</code> where <em>${kibana-url}</em> is the base URL for your Kibana instance
</dd>
<dt>
<span class="term">
op.issuer
</span>
</dt>
<dd>
A verifiable Identifier for your OpenID Connect Provider. An Issuer Identifier is usually a case sensitive URL.
The value for this setting should be provided by your OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.authorization_endpoint
</span>
</dt>
<dd>
The URL for the Authorization Endpoint in the OP. This is where the user&#8217;s browser
will be redirected to start the authentication process. The value for this setting should be provided by your
OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.token_endpoint
</span>
</dt>
<dd>
The URL for the Token Endpoint in the OpenID Connect Provider. This is the endpoint where
Elasticsearch will send a request to exchange the code for an ID Token. This setting is optional when
you use the implicit flow. The value for this setting should be provided by your OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.jwkset_path
</span>
</dt>
<dd>
The path to a file or a URL containing a JSON Web Key Set with the key material that the OpenID Connect
Provider uses for signing tokens and claims responses. If a path is set, it is resolved relative to the Elasticsearch
config directory.
Elasticsearch will automatically monitor this file for changes and will reload the configuration whenever
it is updated. Your OpenID Connect Provider should provide you with this file or a URL where it is available.
</dd>
<dt>
<span class="term">
op.userinfo_endpoint
</span>
</dt>
<dd>
(Optional) The URL for the UserInfo Endpoint in the OpenID Connect Provider. This is the endpoint of the OP that
can be queried to get further user information, if required. The value for this setting should be provided by your
 OpenID Connect Provider.
</dd>
<dt>
<span class="term">
op.endsession_endpoint
</span>
</dt>
<dd>
(Optional) The URL to the End Session Endpoint in the OpenID Connect Provider. This is the endpoint where the user&#8217;s
browser will be redirected after local logout, if the realm is configured for RP initiated Single Logout and
the OP supports it. The value for this setting should be provided by your OpenID Connect Provider.
</dd>
<dt>
<span class="term">
rp.post_logout_redirect_uri
</span>
</dt>
<dd>
(Optional) The Redirect URL where the OpenID Connect Provider should redirect the user after a
successful Single Logout (assuming <code class="literal">op.endsession_endpoint</code> above is also set). This should be set to a value that
will not trigger a new OpenID Connect Authentication, such as <code class="literal">${kibana-url}/security/logged_out</code>  or
<code class="literal">${kibana-url}/login?msg=LOGGED_OUT</code> where <em>${kibana-url}</em> is the base URL for your Kibana instance.
</dd>
<dt>
<span class="term">
claims.principal
</span>
</dt>
<dd>
See <a class="xref" href="setting-up-authentication.html#oidc-claims-mappings" title="Claims mapping">Claims mapping</a>.
</dd>
<dt>
<span class="term">
claims.groups
</span>
</dt>
<dd>
See <a class="xref" href="setting-up-authentication.html#oidc-claims-mappings" title="Claims mapping">Claims mapping</a>.
</dd>
</dl>
</div>
<p>A final piece of configuration of the OpenID Connect realm is to set the <code class="literal">Client Secret</code> that was assigned
to the RP during registration in the OP. This is a secure setting and as such is not defined in the realm
configuration in <code class="literal">elasticsearch.yml</code> but added to the
<a class="xref" href="settings.html#secure-settings" title="Secure settings">elasticsearch keystore</a>.
For instance</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-keystore add xpack.security.authc.realms.oidc.oidc1.rp.client_secret</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>According to the OpenID Connect specification, the OP should also make their configuration
available at a well known URL, which is the concatenation of their <code class="literal">Issuer</code> value with the
<code class="literal">.well-known/openid-configuration</code> string. For example: <code class="literal">https://op.org.com/.well-known/openid-configuration</code>
That document should contain all the necessary information to configure the OpenID Connect realm in Elasticsearch.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-claims-mappings"></a>Claims mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_claims_and_scopes"></a>Claims and scopes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>When authenticating to Kibana using OpenID Connect, the OP will provide information about the user
in the form of OpenID Connect Claims, that can be included either in the ID Token, or be retrieved from the
UserInfo endpoint of the OP. The claim is defined as a piece of information asserted by the OP
for the authenticated user. Simply put, a claim is a name/value pair that contains information about
the user. Related to claims, we also have the notion of OpenID Connect Scopes. Scopes are identifiers
that are used to request access to specific lists of claims. The standard defines a set of scope
identifiers that can be requested. The only mandatory one is <code class="literal">openid</code>, while commonly used ones are
<code class="literal">profile</code> and <code class="literal">email</code>. The <code class="literal">profile</code> scope requests access to the <code class="literal">name</code>,<code class="literal">family_name</code>,<code class="literal">given_name</code>,<code class="literal">middle_name</code>,<code class="literal">nickname</code>,
<code class="literal">preferred_username</code>,<code class="literal">profile</code>,<code class="literal">picture</code>,<code class="literal">website</code>,<code class="literal">gender</code>,<code class="literal">birthdate</code>,<code class="literal">zoneinfo</code>,<code class="literal">locale</code>, and <code class="literal">updated_at</code> claims.
The <code class="literal">email</code> scope requests access to the <code class="literal">email</code> and <code class="literal">email_verified</code> claims. The process is that
the RP requests specific scopes during the authentication request. If the OP Privacy Policy
allows it and the authenticating user consents to it, the related claims are returned to the
RP (either in the ID Token or as a UserInfo response).</p>
<p>The list of the supported claims will vary depending on the OP you are using, but you can expect
the <a href="https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims" class="ulink" target="_top">Standard Claims</a> to be
largely supported.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="oidc-claim-to-property"></a>Mapping claims to user properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The goal of claims mapping is to configure Elasticsearch in such a way as to be able to map the values of
specified returned claims to one of the <a class="xref" href="setting-up-authentication.html#oidc-user-properties" title="Elasticsearch user properties">user properties</a> that are supported
by Elasticsearch. These user properties are then utilized to identify the user in the Kibana UI or the audit
logs, and can also be used to create <a class="xref" href="setting-up-authentication.html#oidc-role-mappings" title="Configuring role mappings">role mapping</a> rules.</p>
<p>The recommended steps for configuring OpenID Claims mapping are as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Consult your OP configuration to see what claims it might support. Note that
the list provided in the OP&#8217;s metadata or in the configuration page of the OP
is a list of potentially supported claims. However, for privacy reasons it might
not be a complete one, or not all supported claims will be available for all
authenticated users.
</li>
<li class="listitem">
Read through the list of <a class="xref" href="setting-up-authentication.html#oidc-user-properties" title="Elasticsearch user properties">user properties</a> that Elasticsearch
supports, and decide which of them are useful to you, and can be provided by
your OP in the form of claims. At a <em>minimum</em>, the <code class="literal">principal</code> user property
is required.
</li>
<li class="listitem">
<p>Configure your OP to "release" those claims to your Elastic Stack Relying
party. This process greatly varies by provider. You can use a static
configuration while others will support that the RP requests the scopes that
correspond to the claims to be "released" on authentication time. See
<a class="xref" href="settings.html#ref-oidc-settings" title="OpenID Connect realm settings"><code class="literal">rp.requested_scopes</code></a> for details about how
to configure the scopes to request. To ensure interoperability and minimize
the errors, you should only request scopes that the OP supports, and which you
intend to map to Elasticsearch user properties.</p>
<pre class="literallayout">NOTE: You can only map claims with values that are strings, numbers, boolean values or an array
of the aforementioned.</pre>

</li>
<li class="listitem">
<p>Configure the OpenID Connect realm in Elasticsearch to associate the Elasticsearch user properties (see
<a class="xref" href="setting-up-authentication.html#oidc-user-properties" title="Elasticsearch user properties">the listing</a> below), to the name of the claims that your
OP will release. In the example above, we have configured the <code class="literal">principal</code> and
<code class="literal">groups</code> user properties as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">claims.principal: sub</code> : This instructs Elasticsearch to look for the OpenID Connect claim named <code class="literal">sub</code>
in the ID Token that the OP issued for the user ( or in the UserInfo response ) and assign the
value of this claim to the <code class="literal">principal</code> user property. <code class="literal">sub</code> is a commonly used claim for the
principal property as it is an identifier of the user in the OP and it is also a required
claim of the ID Token, thus offering guarantees that it will be available. It is, however,
only used as an example here, the OP may provide another claim that is a better fit for your needs.
</li>
<li class="listitem">
<code class="literal">claims.groups: "http://example.info/claims/groups"</code> : Similarly, this instructs Elasticsearch to look
for the claim with the name <code class="literal">http://example.info/claims/groups</code> (note that this is a URI - an
identifier, treated as a string and not a URL pointing to a location that will be retrieved)
either in the ID Token or in the UserInfo response, and map the value(s) of it to the user
property <code class="literal">groups</code> in Elasticsearch. There is no standard claim in the specification that is used for
expressing roles or group memberships of the authenticated user in the OP, so the name of the
claim that should be mapped here, will vary greatly between providers. Consult your OP
documentation for more details.
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="oidc-user-properties"></a>Elasticsearch user properties<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>The Elasticsearch OpenID Connect realm can be configured to map OpenID Connect claims to the
following properties on the authenticated user:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
principal
</span>
</dt>
<dd>
<em>(Required)</em>
This is the <em>username</em> that will be applied to a user that authenticates
against this realm.
The <code class="literal">principal</code> appears in places such as the Elasticsearch audit logs.
</dd>
</dl>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If the principal property fails to be mapped from a claim, the authentication fails.</p>
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
groups
</span>
</dt>
<dd>
<em>(Recommended)</em>
If you wish to use your OP&#8217;s concept of groups or roles as the basis for a
user&#8217;s Elasticsearch privileges, you should map them with this property.
The <code class="literal">groups</code> are passed directly to your <a class="xref" href="setting-up-authentication.html#oidc-role-mappings" title="Configuring role mappings">role mapping rules</a>.
</dd>
<dt>
<span class="term">
name
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s full name.
</dd>
<dt>
<span class="term">
mail
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s email address.
</dd>
<dt>
<span class="term">
dn
</span>
</dt>
<dd>
<em>(Optional)</em> The user&#8217;s X.500 <em>Distinguished Name</em>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_extracting_partial_values_from_openid_connect_claims"></a>Extracting partial values from OpenID Connect claims<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h5>
</div></div></div>
<p>There are some occasions where the value of a claim may contain more information
than you wish to use within Elasticsearch. A common example of this is one where the
OP works exclusively with email addresses, but you would like the user&#8217;s
<code class="literal">principal</code> to use the <em>local-name</em> part of the email address.
For example if their email address was <code class="literal">james.wong@staff.example.com</code>, then you
would like their principal to simply be <code class="literal">james.wong</code>.</p>
<p>This can be achieved using the <code class="literal">claim_patterns</code> setting in the Elasticsearch
realm, as demonstrated in the realm configuration below:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.oidc.oidc1:
  order: 2
  rp.client_id: "the_client_id"
  rp.response_type: code
  rp.redirect_uri: "https://kibana.example.org:5601/api/security/oidc/callback"
  op.authorization_endpoint: "https://op.example.org/oauth2/v1/authorize"
  op.token_endpoint: "https://op.example.org/oauth2/v1/token"
  op.userinfo_endpoint: "https://op.example.org/oauth2/v1/userinfo"
  op.endsession_endpoint: "https://op.example.org/oauth2/v1/logout"
  op.issuer: "https://op.example.org"
  op.jwkset_path: oidc/jwkset.json
  claims.principal: email_verified
  claim_patterns.principal: "^([^@]+)@staff\\.example\\.com$"</pre>
</div>
<p>In this case, the user&#8217;s <code class="literal">principal</code> is mapped from the <code class="literal">email_verified</code> claim, but a
regular expression is applied to the value before it is assigned to the user.
If the regular expression matches, then the result of the first group is used as the
effective value. If the regular expression does not match then the claim
mapping fails.</p>
<p>In this example, the email address must belong to the <code class="literal">staff.example.com</code> domain,
and then the local-part (anything before the <code class="literal">@</code>) is used as the principal.
Any users who try to login using a different email domain will fail because the
regular expression will not match against their email address, and thus their
principal user property - which is mandatory - will not be populated.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Small mistakes in these regular expressions can have significant
security consequences. For example, if we accidentally left off the trailing
<code class="literal">$</code> from the example above, then we would match any email address where the
domain starts with <code class="literal">staff.example.com</code>, and this would accept an email
address such as <code class="literal">admin@staff.example.com.attacker.net</code>. It is important that
you make sure your regular expressions are as precise as possible so that
you do not inadvertently open an avenue for user impersonation attacks.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="third-party-login"></a>Third party initiated single sign-on<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Open ID Connect realm in Elasticsearch supports 3rd party initiated login as described in the
<a href="https://openid.net/specs/openid-connect-core-1_0.html#ThirdPartyInitiatedLogin" class="ulink" target="_top">relevant specification</a>.</p>
<p>This allows the OP itself or another, third party other than the RP, to initiate the authentication
process while requesting the OP to be used for the authentication. Please note that the Elastic
Stack RP should already be configured for this OP, in order for this process to succeed.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-logout"></a>OpenID Connect Logout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The OpenID Connect realm in Elasticsearch supports RP-Initiated Logout Functionality as
described in the
<a href="https://openid.net/specs/openid-connect-session-1_0.html#RPLogout" class="ulink" target="_top">relevant part of the specification</a></p>
<p>In this process, the OpenID Connect RP (the Elastic Stack in this case) will redirect the user&#8217;s
browser to predefined URL of the OP after successfully completing a local logout. The OP can then
logout the user also, depending on the configuration, and should finally redirect the user back to the
RP. The <code class="literal">op.endsession_endpoint</code> in the realm configuration determines the URL in the OP that the browser
will be redirected to. The <code class="literal">rp.post_logout_redirect_uri</code> setting determines the URL to redirect
the user back to after the OP logs them out.</p>
<p>When configuring <code class="literal">rp.post_logout_redirect_uri</code>, care should be taken to not point this to a URL that
will trigger re-authentication of the user. For instance, when using OpenID Connect to support
single sign-on to Kibana, this could be set to either <code class="literal">${kibana-url}/security/logged_out</code>, which will show a
user-friendly message to the user or <code class="literal">${kibana-url}/login?msg=LOGGED_OUT</code> which will take the user to the login selector in Kibana.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="oidc-ssl-config"></a>OpenID Connect Realm SSL Configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>OpenID Connect depends on TLS to provide security properties such as encryption in transit and endpoint authentication. The RP
is required to establish back-channel communication with the OP in order to exchange the code for an ID Token during the
Authorization code grant flow and in order to get additional user information from the UserInfo endpoint. Furthermore, if
you configure <code class="literal">op.jwks_path</code> as a URL, Elasticsearch will need to get the OP&#8217;s signing keys from the file hosted there. As such, it is
important that Elasticsearch can validate and trust the server certificate that the OP uses for TLS. Since the system truststore is
used for the client context of outgoing https connections, if your OP is using a certificate from a trusted CA, no additional
configuration is needed.</p>
<p>However, if the issuer of your OP&#8217;s certificate is not trusted by the JVM on which Elasticsearch is running (e.g it uses a organization CA), then you must configure
Elasticsearch to trust that CA. Assuming that you have the CA certificate that has signed the certificate that the OP uses for TLS
stored in the /oidc/company-ca.pem` file stored in the configuration directory of Elasticsearch, you need to set the following
property in the realm configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.oidc.oidc1:
  order: 1
  ...
  ssl.certificate_authorities: ["/oidc/company-ca.pem"]</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-role-mappings"></a>Configuring role mappings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>When a user authenticates using OpenID Connect, they are identified to the Elastic Stack,
but this does not automatically grant them access to perform any actions or
access any data.</p>
<p>Your OpenID Connect users cannot do anything until they are assigned roles. This can be done
through either the
<a class="xref" href="security-api.html#security-api-put-role-mapping" title="Create or update role mappings API">add role mapping API</a> or with
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use <a class="xref" href="authorization.html#mapping-roles-file" title="Using role mapping files">role mapping files</a>
to grant roles to users authenticating via OpenID Connect.</p>
</div>
</div>
<p>This is an example of a simple role mapping that grants the <code class="literal">example_role</code> role
to any user who authenticates against the <code class="literal">oidc1</code> OpenID Connect realm:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/oidc-example
{
  "roles": [ "example_role" ], <a id="CO580-1"></a><i class="conum" data-value="1"></i>
  "enabled": true,
  "rules": {
    "field": { "realm.name": "oidc1" }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1814.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO580-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">example_role</code> role is <span class="strong strong"><strong>not</strong></span> a builtin Elasticsearch role.
This example assumes that you have created a custom role of your own, with
appropriate access to your <a class="xref" href="authorization.html#roles-indices-priv" title="Indices Privileges">data streams, indices,</a> and
<a href="https://www.elastic.co/guide/en/kibana/8.9/kibana-privileges.html#kibana-feature-privileges" class="ulink" target="_top">Kibana features</a>.</p>
</td>
</tr>
</table>
</div>
<p>The user properties that are mapped via the realm configuration are used to process
role mapping rules, and these rules determine which roles a user is granted.</p>
<p>The user fields that are provided to the role
mapping are derived from the OpenID Connect claims as follows:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">username</code>: The <code class="literal">principal</code> user property
</li>
<li class="listitem">
<code class="literal">dn</code>: The <code class="literal">dn</code> user property
</li>
<li class="listitem">
<code class="literal">groups</code>: The <code class="literal">groups</code> user property
</li>
<li class="listitem">
<code class="literal">metadata</code>: See <a class="xref" href="setting-up-authentication.html#oidc-user-metadata" title="User metadata">User metadata</a>
</li>
</ul>
</div>
<p>For more information, see <a class="xref" href="authorization.html#mapping-roles" title="Mapping users and groups to roles">Mapping users and groups to roles</a> and
<a class="xref" href="security-api.html#security-role-mapping-apis" title="Role mappings">Role mappings</a>.</p>
<p>If your OP has the ability to provide groups or roles to RPs via tha use of
an OpenID Claim, then you should map this claim to the <code class="literal">claims.groups</code> setting in
the Elasticsearch realm (see <a class="xref" href="setting-up-authentication.html#oidc-claim-to-property" title="Mapping claims to user properties">Mapping claims to user properties</a>), and then make use of it in a role mapping
as per the example below.</p>
<p>This mapping grants the Elasticsearch <code class="literal">finance_data</code> role, to any users who authenticate
via the <code class="literal">oidc1</code> realm with the <code class="literal">finance-team</code> group membership.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/oidc-finance
{
  "roles": [ "finance_data" ],
  "enabled": true,
  "rules": { "all": [
        { "field": { "realm.name": "oidc1" } },
        { "field": { "groups": "finance-team" } }
  ] }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1815.console"></div>
<p>If your users also exist in a repository that can be directly accessed by Elasticsearch
(such as an LDAP directory) then you can use
<a class="xref" href="setting-up-authentication.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> instead of role mappings.</p>
<p>In this case, you perform the following steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In your OpenID Connect realm, assign a claim to act as the lookup userid,
by configuring the <code class="literal">claims.principal</code> setting.
</li>
<li class="listitem">
Create a new realm that can look up users from your local repository (e.g. an
<code class="literal">ldap</code> realm)
</li>
<li class="listitem">
In your OpenID Connect realm, set <code class="literal">authorization_realms</code> to the name of the
realm you created in step 2.
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-user-metadata"></a>User metadata<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>By default users who authenticate via OpenID Connect will have some additional metadata
fields. These fields will include every OpenID Claim that is provided in the authentication response
(regardless of whether it is mapped to an Elasticsearch user property). For example,
in the metadata field <code class="literal">oidc(claim_name)</code>, "claim_name" is the name of the
claim as it was contained in the ID Token or in the User Info response. Note that these will
include all the <a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken" class="ulink" target="_top">ID Token claims</a>
that pertain to the authentication event, rather than the user themselves.</p>
<p>This behaviour can be disabled by adding <code class="literal">populate_user_metadata: false</code> as
a setting in the oidc realm.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-configure-kibana"></a>Configuring Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>OpenID Connect authentication in Kibana requires a small number of additional settings
in addition to the standard Kibana security configuration. The
<a href="https://www.elastic.co/guide/en/kibana/8.9/using-kibana-with-security.html" class="ulink" target="_top">Kibana security documentation</a>
provides details on the available configuration options that you can apply.</p>
<p>In particular, since your Elasticsearch nodes have been configured to use TLS on the HTTP
interface, you must configure Kibana to use a <code class="literal">https</code> URL to connect to Elasticsearch, and
you may need to configure <code class="literal">elasticsearch.ssl.certificateAuthorities</code> to trust
the certificates that Elasticsearch has been configured to use.</p>
<p>OpenID Connect authentication in Kibana is subject to the following timeout settings in
<code class="literal">kibana.yml</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="https://www.elastic.co/guide/en/kibana/8.9/xpack-security-session-management.html#session-idle-timeout" class="ulink" target="_top"><code class="literal">xpack.security.session.idleTimeout</code></a>
</li>
<li class="listitem">
<a href="https://www.elastic.co/guide/en/kibana/8.9/xpack-security-session-management.html#session-lifespan" class="ulink" target="_top"><code class="literal">xpack.security.session.lifespan</code></a>
</li>
</ul>
</div>
<p>You may want to adjust these timeouts based on your security requirements.</p>
<p>The three additional settings that are required for OpenID Connect support are shown below:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  oidc.oidc1:
    order: 0
    realm: "oidc1"</pre>
</div>
<p>The configuration values used in the example above are:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers</code>
</span>
</dt>
<dd>
Add <code class="literal">oidc</code> provider to instruct Kibana to use OpenID Connect single sign-on as the
authentication method. This instructs Kibana to attempt to initiate an SSO flow
everytime a user attempts to access a URL in Kibana, if the user is not already
authenticated. If you also want to allow users to login with a username and password,
you must enable the <code class="literal">basic</code> authentication provider too. For example:
</dd>
</dl>
</div>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.providers:
  oidc.oidc1:
    order: 0
    realm: "oidc1"
  basic.basic1:
    order: 1</pre>
</div>
<p>This will allow users that haven&#8217;t already authenticated with OpenID Connect to
log in using the Kibana login form.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">xpack.security.authc.providers.oidc.&lt;provider-name&gt;.realm</code>
</span>
</dt>
<dd>
The name of the OpenID Connect realm in Elasticsearch that should handle authentication
for this Kibana instance.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="oidc-without-kibana"></a>OpenID Connect without Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h3>
</div></div></div>
<p>The OpenID Connect realm is designed to allow users to authenticate to Kibana and as
such, most of the parts of the guide above make the assumption that Kibana is used.
This section describes how a custom web application could use the relevant OpenID
Connect REST APIs in order to authenticate the users to Elasticsearch, with OpenID Connect.</p>
<p>Single sign-on realms such as OpenID Connect and SAML make use of the Token Service in
Elasticsearch and in principle exchange a SAML or OpenID Connect Authentication response for
an Elasticsearch access token and a refresh token. The access token is used as credentials for subsequent calls to Elasticsearch. The
refresh token enables the user to get new Elasticsearch access tokens after the current one
expires.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The Elasticsearch Token Service can be seen as a minimal oAuth2 authorization server
and the access token and refresh token mentioned above are tokens that pertain
<em>only</em> to this authorization server. They are generated and consumed <em>only</em> by Elasticsearch
and are in no way related to the tokens ( access token and ID Token ) that the
OpenID Connect Provider issues.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_register_the_rp_with_an_openid_connect_provider"></a>Register the RP with an OpenID Connect Provider<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The Relying Party ( Elasticsearch and the custom web app ) will need to be registered as
client with the OpenID Connect Provider. Note that when registering the
<code class="literal">Redirect URI</code>, it needs to be a URL in the custom web app.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_openid_connect_realm"></a>OpenID Connect Realm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>An OpenID Connect realm needs to be created and configured accordingly
in Elasticsearch. See <a class="xref" href="setting-up-authentication.html#oidc-elasticsearch-authentication" title="Configure Elasticsearch for OpenID Connect authentication">Configure Elasticsearch for OpenID Connect authentication</a></p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_service_account_user_for_accessing_the_apis"></a>Service Account user for accessing the APIs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>The realm is designed with the assumption that there needs to be a privileged entity
acting as an authentication proxy. In this case, the custom web application is the
authentication proxy handling the authentication of end users ( more correctly,
"delegating" the authentication to the OpenID Connect Provider ). The OpenID Connect
APIs require authentication and the necessary authorization level for the authenticated
user. For this reason, a Service Account user needs to be created and assigned a role
that gives them the <code class="literal">manage_oidc</code> cluster privilege. The use of the <code class="literal">manage_token</code>
cluster privilege will be necessary after the authentication takes place, so that the
user can maintain access or be subsequently logged out.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/role/facilitator-role
{
  "cluster" : ["manage_oidc", "manage_token"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1816.console"></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/user/facilitator
{
  "password" : "&lt;somePasswordHere&gt;",
  "roles"    : [ "facilitator-role"]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1817.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_handling_the_authentication_flow"></a>Handling the authentication flow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.9/x-pack/docs/en/security/authentication/oidc-guide.asciidoc">edit</a></h4>
</div></div></div>
<p>On a high level, the custom web application would need to perform the following steps in order to
authenticate a user with OpenID Connect:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Make an HTTP POST request to <code class="literal">_security/oidc/prepare</code>, authenticating as the <code class="literal">facilitator</code> user, using the name of the
OpenID Connect realm in the Elasticsearch configuration in the request body. For more
details, see
<a class="xref" href="security-api.html#security-api-oidc-prepare-authentication" title="OpenID Connect prepare authentication API">OpenID Connect prepare authentication</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/oidc/prepare
{
  "realm" : "oidc1"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1818.console"></div>
</li>
<li class="listitem">
Handle the response to <code class="literal">/_security/oidc/prepare</code>. The response from Elasticsearch will contain 3 parameters:
<code class="literal">redirect</code>, <code class="literal">state</code>, <code class="literal">nonce</code>. The custom web application would need to store the values for <code class="literal">state</code>
and <code class="literal">nonce</code> in the user&#8217;s session (client side in a cookie or server side if session information is
 persisted this way) and redirect the user&#8217;s browser to the URL that will be contained in the
<code class="literal">redirect</code> value.
</li>
<li class="listitem">
<p>Handle a subsequent response from the OP. After the user is successfully authenticated with the
OpenID Connect Provider, they will be redirected back to the callback/redirect URI. Upon receiving
this HTTP GET request, the custom web app will need to make an HTTP POST request to
<code class="literal">_security/oidc/authenticate</code>, again - authenticating as the <code class="literal">facilitator</code> user - passing the URL
where the user&#8217;s browser was redirected to, as a parameter, along with the
values for <code class="literal">nonce</code> and <code class="literal">state</code> it had saved in the user&#8217;s session previously. If more than one
OpenID Connect realms are configured, the custom web app can specify the name of the realm to be
used for handling this, but this parameter is optional. For more details, see
<a class="xref" href="security-api.html#security-api-oidc-authenticate" title="OpenID Connect authenticate API">OpenID Connect authenticate</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/oidc/authenticate
{
  "redirect_uri" : "https://oidc-kibana.elastic.co:5603/api/security/oidc/callback?code=jtI3Ntt8v3_XvcLzCFGq&amp;state=4dbrihtIAt3wBTwo6DxK-vdk-sSyDBV8Yf0AjdkdT5I",
  "state" : "4dbrihtIAt3wBTwo6DxK-vdk-sSyDBV8Yf0AjdkdT5I",
  "nonce" : "WaBPH0KqPVdG5HHdSxPRjfoZbXMCicm5v1OiAj0DUFM",
  "realm" : "oidc1"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1819.console"></div>
<p>Elasticsearch will validate this and if all is correct will respond with an access token that can be used
as a <code class="literal">Bearer</code> token for subsequent requests and a refresh token that can be later used to refresh the given
access token as described in <a class="xref" href="security-api.html#security-api-get-token" title="Get token API">Get token</a>.</p>
</li>
<li class="listitem">
<p>At some point, if necessary, the custom web application can log the user out by using the
<a class="xref" href="security-api.html#security-api-oidc-logout" title="OpenID Connect logout API">OIDC logout API</a> passing the access token and refresh token as parameters. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_security/oidc/logout
{
  "token" : "dGhpcyBpcyBub3QgYSByZWFsIHRva2VuIGJ1dCBpdCBpcyBvbmx5IHRlc3QgZGF0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==",
  "refresh_token": "vLBPvmAB6KvwvJZr27cS"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1820.console"></div>
<p>If the realm is configured accordingly, this may result in a response with a <code class="literal">redirect</code> parameter indicating where
the user needs to be redirected in the OP in order to complete the logout process.</p>
</li>
</ol>
</div>
</div>

</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="update-node-certs.html">« Updating node security certificates</a>
</span>
<span class="next">
<a href="authorization.html">User authorization »</a>
</span>
</div>
</div>
</body>
</html>
