<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Specialized queries | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Specialized queries | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="query-dsl.html" title="Query DSL"/>
<link rel="prev" href="span-queries.html" title="Span queries"/>
<link rel="next" href="term-level-queries.html" title="Term-level queries"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="span-queries.html">« Span queries</a>
</span>
<span class="next">
<a href="term-level-queries.html">Term-level queries »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="specialized-queries"></a>Specialized queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/special-queries.asciidoc">edit</a></h2>
</div></div></div>
<p>This group contains queries which do not fit into the other groups:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-distance-feature-query" title="Distance feature query"><code class="literal">distance_feature</code> query</a>
</span>
</dt>
<dd>
A query that computes scores based on the dynamically computed distances
between the origin and documents' date, date_nanos and geo_point fields.
It is able to efficiently skip non-competitive hits.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-mlt-query" title="More like this query"><code class="literal">more_like_this</code> query</a>
</span>
</dt>
<dd>
This query finds documents which are similar to the specified text, document,
or collection of documents.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-percolate-query" title="Percolate query"><code class="literal">percolate</code> query</a>
</span>
</dt>
<dd>
This query finds queries that are stored as documents that match with
the specified document.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-rank-feature-query" title="Rank feature query"><code class="literal">rank_feature</code> query</a>
</span>
</dt>
<dd>
A query that computes scores based on the values of numeric features and is
able to efficiently skip non-competitive hits.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-script-query" title="Script query"><code class="literal">script</code> query</a>
</span>
</dt>
<dd>
This query allows a script to act as a filter.  Also see the
<a class="xref" href="compound-queries.html#query-dsl-function-score-query" title="Function score query"><code class="literal">function_score</code> query</a>.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-script-score-query" title="Script score query"><code class="literal">script_score</code> query</a>
</span>
</dt>
<dd>
A query that allows to modify the score of a sub-query with a script.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-wrapper-query" title="Wrapper query"><code class="literal">wrapper</code> query</a>
</span>
</dt>
<dd>
A query that accepts other queries as json or yaml string.
</dd>
<dt>
<span class="term">
<a class="xref" href="specialized-queries.html#query-dsl-pinned-query" title="Pinned Query"><code class="literal">pinned</code> query</a>
</span>
</dt>
<dd>
A query that promotes selected documents over others matching a given query.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-distance-feature-query"></a>Distance feature query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Boosts the <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> of documents closer to a
provided <code class="literal">origin</code> date or point. For example, you can use this query to give
more weight to documents closer to a certain date or location.</p>
<p>You can use the <code class="literal">distance_feature</code> query to find the nearest neighbors to a
location. You can also use the query in a <a class="xref" href="compound-queries.html#query-dsl-bool-query" title="Boolean query"><code class="literal">bool</code></a>
search&#8217;s <code class="literal">should</code> filter to add boosted relevance scores to the <code class="literal">bool</code> query&#8217;s
scores.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="distance-feature-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="distance-feature-index-setup"></a>Index setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>To use the <code class="literal">distance_feature</code> query, your index must include a <a class="xref" href="mapping-types.html#date" title="Date field type"><code class="literal">date</code></a>,
<a class="xref" href="mapping-types.html#date_nanos" title="Date nanoseconds field type"><code class="literal">date_nanos</code></a> or <a class="xref" href="mapping-types.html#geo-point" title="Geo-point field type"><code class="literal">geo_point</code></a> field.</p>
<p>To see how you can set up an index for the <code class="literal">distance_feature</code> query, try the
following example.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Create an <code class="literal">items</code> index with the following field mapping:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">name</code>, a <a class="xref" href="mapping-types.html#keyword" title="Keyword type family"><code class="literal">keyword</code></a> field
</li>
<li class="listitem">
<code class="literal">production_date</code>, a <a class="xref" href="mapping-types.html#date" title="Date field type"><code class="literal">date</code></a> field
</li>
<li class="listitem">
<code class="literal">location</code>, a <a class="xref" href="mapping-types.html#geo-point" title="Geo-point field type"><code class="literal">geo_point</code></a> field
</li>
</ul>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /items
{
  "mappings": {
    "properties": {
      "name": {
        "type": "keyword"
      },
      "production_date": {
        "type": "date"
      },
      "location": {
        "type": "geo_point"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/874.console"></div>
</li>
<li class="listitem">
<p>Index several documents to this index.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /items/_doc/1?refresh
{
  "name" : "chocolate",
  "production_date": "2018-02-01",
  "location": [-71.34, 41.12]
}

PUT /items/_doc/2?refresh
{
  "name" : "chocolate",
  "production_date": "2018-01-01",
  "location": [-71.3, 41.15]
}


PUT /items/_doc/3?refresh
{
  "name" : "chocolate",
  "production_date": "2017-12-01",
  "location": [-71.3, 41.12]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/875.console"></div>
</li>
</ol>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="distance-feature-query-ex-query"></a>Example queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="distance-feature-query-date-ex"></a>Boost documents based on date<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h5>
</div></div></div>
<p>The following <code class="literal">bool</code> search returns documents with a <code class="literal">name</code> value of
<code class="literal">chocolate</code>. The search also uses the <code class="literal">distance_feature</code> query to increase the
relevance score of documents with a <code class="literal">production_date</code> value closer to <code class="literal">now</code>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /items/_search
{
  "query": {
    "bool": {
      "must": {
        "match": {
          "name": "chocolate"
        }
      },
      "should": {
        "distance_feature": {
          "field": "production_date",
          "pivot": "7d",
          "origin": "now"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/876.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="distance-feature-query-distance-ex"></a>Boost documents based on location<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h5>
</div></div></div>
<p>The following <code class="literal">bool</code> search returns documents with a <code class="literal">name</code> value of
<code class="literal">chocolate</code>. The search also uses the <code class="literal">distance_feature</code> query to increase the
relevance score of documents with a <code class="literal">location</code> value closer to <code class="literal">[-71.3, 41.15]</code>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /items/_search
{
  "query": {
    "bool": {
      "must": {
        "match": {
          "name": "chocolate"
        }
      },
      "should": {
        "distance_feature": {
          "field": "location",
          "pivot": "1000m",
          "origin": [-71.3, 41.15]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/877.console"></div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="distance-feature-top-level-params"></a>Top-level parameters for <code class="literal">distance_feature</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
<p>
(Required, string) Name of the field used to calculate distances. This field
must meet the following criteria:
</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Be a <a class="xref" href="mapping-types.html#date" title="Date field type"><code class="literal">date</code></a>, <a class="xref" href="mapping-types.html#date_nanos" title="Date nanoseconds field type"><code class="literal">date_nanos</code></a> or
<a class="xref" href="mapping-types.html#geo-point" title="Geo-point field type"><code class="literal">geo_point</code></a> field
</li>
<li class="listitem">
Have an <a class="xref" href="mapping-params.html#mapping-index" title="index"><code class="literal">index</code></a> mapping parameter value of <code class="literal">true</code>, which is
the default
</li>
<li class="listitem">
Have an <a class="xref" href="mapping-params.html#doc-values" title="doc_values"><code class="literal">doc_values</code></a> mapping parameter value of <code class="literal">true</code>, which
is the default
</li>
</ul>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">origin</code>
</span>
</dt>
<dd>
<p>(Required, string) Date or point of origin used to calculate distances.</p>
<p>If the <code class="literal">field</code> value is a <a class="xref" href="mapping-types.html#date" title="Date field type"><code class="literal">date</code></a> or <a class="xref" href="mapping-types.html#date_nanos" title="Date nanoseconds field type"><code class="literal">date_nanos</code></a>
field, the <code class="literal">origin</code> value must be a <a class="xref" href="search-aggregations-bucket.html#date-format-pattern" title="Date Format/Pattern">date</a>.
<a class="xref" href="api-conventions.html#date-math" title="Date Math">Date Math</a>, such as <code class="literal">now-1h</code>, is supported.</p>
<p>If the <code class="literal">field</code> value is a <a class="xref" href="mapping-types.html#geo-point" title="Geo-point field type"><code class="literal">geo_point</code></a> field, the <code class="literal">origin</code> value
must be a geopoint.</p>
</dd>
<dt>
<span class="term">
<code class="literal">pivot</code>
</span>
</dt>
<dd>
<p>(Required, <a class="xref" href="api-conventions.html#time-units" title="Time units">time unit</a> or <a class="xref" href="api-conventions.html#distance-units" title="Distance Units">distance unit</a>)
Distance from the <code class="literal">origin</code> at which relevance scores receive half of the <code class="literal">boost</code>
value.</p>
<p>If the <code class="literal">field</code> value is a <a class="xref" href="mapping-types.html#date" title="Date field type"><code class="literal">date</code></a> or <a class="xref" href="mapping-types.html#date_nanos" title="Date nanoseconds field type"><code class="literal">date_nanos</code></a>
field, the <code class="literal">pivot</code> value must be a <a class="xref" href="api-conventions.html#time-units" title="Time units">time unit</a>, such as <code class="literal">1h</code> or
<code class="literal">10d</code>.</p>
<p>If the <code class="literal">field</code> value is a <a class="xref" href="mapping-types.html#geo-point" title="Geo-point field type"><code class="literal">geo_point</code></a> field, the <code class="literal">pivot</code> value
must be a <a class="xref" href="api-conventions.html#distance-units" title="Distance Units">distance unit</a>, such as <code class="literal">1km</code> or <code class="literal">12m</code>.</p>
</dd>
<dt>
<span class="term">
<code class="literal">boost</code>
</span>
</dt>
<dd>
<p>(Optional, float) Floating point number used to multiply the
<a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> of matching documents. This value
cannot be negative. Defaults to <code class="literal">1.0</code>.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="distance-feature-notes"></a>Notes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="distance-feature-calculation"></a>How the <code class="literal">distance_feature</code> query calculates relevance scores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">distance_feature</code> query dynamically calculates the distance between the
<code class="literal">origin</code> value and a document&#8217;s field values. It then uses this distance as a
feature to boost the <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> of closer
documents.</p>
<p>The <code class="literal">distance_feature</code> query calculates a document&#8217;s
<a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> as follows:</p>
<pre class="screen">relevance score = boost * pivot / (pivot + distance)</pre>
<p>The <code class="literal">distance</code> is the absolute difference between the <code class="literal">origin</code> value and a
document&#8217;s field value.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="distance-feature-skip-hits"></a>Skip non-competitive hits<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/distance-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>Unlike the <a class="xref" href="compound-queries.html#query-dsl-function-score-query" title="Function score query"><code class="literal">function_score</code></a> query or other
ways to change <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a>, the
<code class="literal">distance_feature</code> query efficiently skips non-competitive hits when the
<a class="xref" href="getting-started-modify-data.html#search-uri-request" title="URI search"><code class="literal">track_total_hits</code></a> parameter is <span class="strong strong"><strong>not</strong></span> <code class="literal">true</code>.</p>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-mlt-query"></a>More like this query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h2>
</div></div></div>

<p>The More Like This Query finds documents that are "like" a given
set of documents. In order to do so, MLT selects a set of representative terms
of these input documents, forms a query using these terms, executes the query
and returns the results. The user controls the input documents, how the terms
should be selected and how the query is formed.</p>
<p>The simplest use case consists of asking for documents that are similar to a
provided piece of text. Here, we are asking for all movies that have some text
similar to "Once upon a time" in their "title" and in their "description"
fields, limiting the number of selected terms to 12.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "more_like_this" : {
      "fields" : ["title", "description"],
      "like" : "Once upon a time",
      "min_term_freq" : 1,
      "max_query_terms" : 12
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/878.console"></div>
<p>A more complicated use case consists of mixing texts with documents already
existing in the index. In this case, the syntax to specify a document is
similar to the one used in the <a class="xref" href="docs.html#docs-multi-get" title="Multi get (mget) API">Multi GET API</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "more_like_this": {
      "fields": [ "title", "description" ],
      "like": [
        {
          "_index": "imdb",
          "_id": "1"
        },
        {
          "_index": "imdb",
          "_id": "2"
        },
        "and potentially some more text here as well"
      ],
      "min_term_freq": 1,
      "max_query_terms": 12
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/879.console"></div>
<p>Finally, users can mix some texts, a chosen set of documents but also provide
documents not necessarily present in the index. To provide documents not
present in the index, the syntax is similar to <a class="xref" href="docs.html#docs-termvectors-artificial-doc" title="Artificial documents">artificial documents</a>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "more_like_this": {
      "fields": [ "name.first", "name.last" ],
      "like": [
        {
          "_index": "marvel",
          "doc": {
            "name": {
              "first": "Ben",
              "last": "Grimm"
            },
            "_doc": "You got no idea what I'd... what I'd give to be invisible."
          }
        },
        {
          "_index": "marvel",
          "_id": "2"
        }
      ],
      "min_term_freq": 1,
      "max_query_terms": 12
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/880.console"></div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_how_it_works"></a>How it Works<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h3>
</div></div></div>
<p>Suppose we wanted to find all documents similar to a given input document.
Obviously, the input document itself should be its best match for that type of
query. And the reason would be mostly, according to
<a href="https://lucene.apache.org/core/4_9_0/core/org/apache/lucene/search/similarities/TFIDFSimilarity.html" class="ulink" target="_top">Lucene scoring formula</a>,
due to the terms with the highest tf-idf. Therefore, the terms of the input
document that have the highest tf-idf are good representatives of that
document, and could be used within a disjunctive query (or <code class="literal">OR</code>) to retrieve similar
documents. The MLT query simply extracts the text from the input document,
analyzes it, usually using the same analyzer at the field, then selects the
top K terms with highest tf-idf to form a disjunctive query of these terms.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>The fields on which to perform MLT must be indexed and of type
<code class="literal">text</code> or <code class="literal">keyword`</code>. Additionally, when using <code class="literal">like</code> with documents, either
<code class="literal">_source</code> must be enabled or the fields must be <code class="literal">stored</code> or store
<code class="literal">term_vector</code>. In order to speed up analysis, it could help to store term
vectors at index time.</p>
</div>
</div>
<p>For example, if we wish to perform MLT on the "title" and "tags.raw" fields,
we can explicitly store their <code class="literal">term_vector</code> at index time. We can still
perform MLT on the "description" and "tags" fields, as <code class="literal">_source</code> is enabled by
default, but there will be no speed up on analysis for these fields.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /imdb
{
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "term_vector": "yes"
      },
      "description": {
        "type": "text"
      },
      "tags": {
        "type": "text",
        "fields": {
          "raw": {
            "type": "text",
            "analyzer": "keyword",
            "term_vector": "yes"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/881.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_parameters_2"></a>Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h3>
</div></div></div>
<p>The only required parameter is <code class="literal">like</code>, all other parameters have sensible
defaults. There are three types of parameters: one to specify the document
input, the other one for term selection and for query formation.</p>
<h4><a id="_document_input_parameters"></a>Document Input Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h4>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">like</code>
</p>
</td>
<td valign="top">
<p>
The only <span class="strong strong"><strong>required</strong></span> parameter of the MLT query is <code class="literal">like</code> and follows a
versatile syntax, in which the user can specify free form text and/or a single
or multiple documents (see examples above). The syntax to specify documents is
similar to the one used by the <a class="xref" href="docs.html#docs-multi-get" title="Multi get (mget) API">Multi GET API</a>. When
specifying documents, the text is fetched from <code class="literal">fields</code> unless overridden in
each document request. The text is analyzed by the analyzer at the field, but
could also be overridden. The syntax to override the analyzer at the field
follows a similar syntax to the <code class="literal">per_field_analyzer</code> parameter of the
<a class="xref" href="docs.html#docs-termvectors-per-field-analyzer" title="Per-field analyzer">Term Vectors API</a>.
Additionally, to provide documents not necessarily present in the index,
<a class="xref" href="docs.html#docs-termvectors-artificial-doc" title="Artificial documents">artificial documents</a> are also supported.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">unlike</code>
</p>
</td>
<td valign="top">
<p>
The <code class="literal">unlike</code> parameter is used in conjunction with <code class="literal">like</code> in order not to
select terms found in a chosen set of documents. In other words, we could ask
for documents <code class="literal">like: "Apple"</code>, but <code class="literal">unlike: "cake crumble tree"</code>. The syntax
is the same as <code class="literal">like</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">fields</code>
</p>
</td>
<td valign="top">
<p>
A list of fields to fetch and analyze the text from.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<h4><a id="mlt-query-term-selection"></a>Term Selection Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h4>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">max_query_terms</code>
</p>
</td>
<td valign="top">
<p>
The maximum number of query terms that will be selected. Increasing this value
gives greater accuracy at the expense of query execution speed. Defaults to
<code class="literal">25</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">min_term_freq</code>
</p>
</td>
<td valign="top">
<p>
The minimum term frequency below which the terms will be ignored from the
input document. Defaults to <code class="literal">2</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">min_doc_freq</code>
</p>
</td>
<td valign="top">
<p>
The minimum document frequency below which the terms will be ignored from the
input document. Defaults to <code class="literal">5</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">max_doc_freq</code>
</p>
</td>
<td valign="top">
<p>
The maximum document frequency above which the terms will be ignored from the
input document. This could be useful in order to ignore highly frequent words
such as stop words. Defaults to unbounded (<code class="literal">Integer.MAX_VALUE</code>, which is <code class="literal">2^31-1</code>
or 2147483647).
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">min_word_length</code>
</p>
</td>
<td valign="top">
<p>
The minimum word length below which the terms will be ignored. Defaults to <code class="literal">0</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">max_word_length</code>
</p>
</td>
<td valign="top">
<p>
The maximum word length above which the terms will be ignored. Defaults to
unbounded (<code class="literal">0</code>).
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">stop_words</code>
</p>
</td>
<td valign="top">
<p>
An array of stop words. Any word in this set is considered "uninteresting" and
ignored. If the analyzer allows for stop words, you might want to tell MLT to
explicitly ignore them, as for the purposes of document similarity it seems
reasonable to assume that "a stop word is never interesting".
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">analyzer</code>
</p>
</td>
<td valign="top">
<p>
The analyzer that is used to analyze the free form text. Defaults to the
analyzer associated with the first field in <code class="literal">fields</code>.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<h4><a id="_query_formation_parameters"></a>Query Formation Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h4>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">minimum_should_match</code>
</p>
</td>
<td valign="top">
<p>
After the disjunctive query has been formed, this parameter controls the
number of terms that must match.
The syntax is the same as the <a class="xref" href="query-dsl-minimum-should-match.html" title="minimum_should_match parameter">minimum should match</a>.
(Defaults to <code class="literal">"30%"</code>).
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">fail_on_unsupported_field</code>
</p>
</td>
<td valign="top">
<p>
Controls whether the query should fail (throw an exception) if any of the
specified fields are not of the supported types
(<code class="literal">text</code> or <code class="literal">keyword</code>). Set this to <code class="literal">false</code> to ignore the field and continue
processing. Defaults to <code class="literal">true</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">boost_terms</code>
</p>
</td>
<td valign="top">
<p>
Each term in the formed query could be further boosted by their tf-idf score.
This sets the boost factor to use when using this feature. Defaults to
deactivated (<code class="literal">0</code>). Any other positive value activates terms boosting with the
given boost factor.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">include</code>
</p>
</td>
<td valign="top">
<p>
Specifies whether the input documents should also be included in the search
results returned. Defaults to <code class="literal">false</code>.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">boost</code>
</p>
</td>
<td valign="top">
<p>
Sets the boost value of the whole query. Defaults to <code class="literal">1.0</code>.
</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_alternative"></a>Alternative<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/mlt-query.asciidoc">edit</a></h3>
</div></div></div>
<p>To take more control over the construction of a query for similar documents it is worth considering writing custom client code to assemble selected terms from an example document into a Boolean query with the desired settings. The logic in <code class="literal">more_like_this</code> that selects "interesting" words from a piece of text is also accessible via the <a class="xref" href="docs.html#docs-termvectors" title="Term vectors API">TermVectors API</a>. For example, using the termvectors API it would be possible to present users with a selection of topical keywords found in a document&#8217;s text, allowing them to select words of interest to drill down on, rather than using the more "black-box" approach of matching used by <code class="literal">more_like_this</code>.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-percolate-query"></a>Percolate query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h2>
</div></div></div>

<p>The <code class="literal">percolate</code> query can be used to match queries
stored in an index. The <code class="literal">percolate</code> query itself
contains the document that will be used as query
to match with the stored queries.</p>
<h3><a id="_sample_usage"></a>Sample Usage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h3>
<p>Create an index with two fields:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-00001
{
  "mappings": {
    "properties": {
      "message": {
        "type": "text"
      },
      "query": {
        "type": "percolator"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/882.console"></div>
<p>The <code class="literal">message</code> field is the field used to preprocess the document defined in
the <code class="literal">percolator</code> query before it gets indexed into a temporary index.</p>
<p>The <code class="literal">query</code> field is used for indexing the query documents. It will hold a
json object that represents an actual Elasticsearch query. The <code class="literal">query</code> field
has been configured to use the <a class="xref" href="mapping-types.html#percolator" title="Percolator field type">percolator field type</a>. This field
type understands the query dsl and stores the query in such a way that it can be
used later on to match documents defined on the <code class="literal">percolate</code> query.</p>
<p>Register a query in the percolator:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-00001/_doc/1?refresh
{
  "query": {
    "match": {
      "message": "bonsai tree"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/883.console"></div>
<p>Match a document to the registered percolator queries:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "percolate": {
      "field": "query",
      "document": {
        "message": "A new bonsai tree in the office"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/884.console"></div>
<p>The above request will yield the following response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 13,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped" : 0,
    "failed": 0
  },
  "hits": {
    "total" : {
        "value": 1,
        "relation": "eq"
    },
    "max_score": 0.26152915,
    "hits": [
      { <a id="CO210-1"></a><i class="conum" data-value="1"></i>
        "_index": "my-index-00001",
        "_type": "_doc",
        "_id": "1",
        "_score": 0.26152915,
        "_source": {
          "query": {
            "match": {
              "message": "bonsai tree"
            }
          }
        },
        "fields" : {
          "_percolator_document_slot" : [0] <a id="CO210-2"></a><i class="conum" data-value="2"></i>
        }
      }
    ]
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO210-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The query with id <code class="literal">1</code> matches our document.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO210-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">_percolator_document_slot</code> field indicates which document has matched with this query.
Useful when percolating multiple document simultaneously.</p>
</td>
</tr>
</table>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>To provide a simple example, this documentation uses one index <code class="literal">my-index-00001</code> for both the percolate queries and documents.
This set-up can work well when there are just a few percolate queries registered. However, with heavier usage it is recommended
to store queries and documents in separate indices. Please see <a class="xref" href="specialized-queries.html#how-it-works" title="How it Works Under the Hood">How it Works Under the Hood</a> for more details.</p>
</div>
</div>
<h4><a id="_parameters_3"></a>Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>The following parameters are required when percolating a document:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">field</code>
</p>
</td>
<td valign="top">
<p>
The field of type <code class="literal">percolator</code> that holds the indexed queries. This is a required parameter.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">name</code>
</p>
</td>
<td valign="top">
<p>
The suffix to be used for the <code class="literal">_percolator_document_slot</code> field in case multiple <code class="literal">percolate</code> queries have been specified.
This is an optional parameter.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">document</code>
</p>
</td>
<td valign="top">
<p>
The source of the document being percolated.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">documents</code>
</p>
</td>
<td valign="top">
<p>
Like the <code class="literal">document</code> parameter, but accepts multiple documents via a json array.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">document_type</code>
</p>
</td>
<td valign="top">
<p>
The type / mapping of the document being percolated. This parameter is deprecated and will be removed in Elasticsearch 8.0.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Instead of specifying the source of the document being percolated, the source can also be retrieved from an already
stored document. The <code class="literal">percolate</code> query will then internally execute a get request to fetch that document.</p>
<p>In that case the <code class="literal">document</code> parameter can be substituted with the following parameters:</p>
<div class="informaltable">
<table border="0" cellpadding="4px">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody valign="top">
<tr>
<td valign="top">
<p>
<code class="literal">index</code>
</p>
</td>
<td valign="top">
<p>
The index the document resides in. This is a required parameter.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">type</code>
</p>
</td>
<td valign="top">
<p>
The type of the document to fetch. This parameter is deprecated and will be removed in Elasticsearch 8.0.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">id</code>
</p>
</td>
<td valign="top">
<p>
The id of the document to fetch. This is a required parameter.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">routing</code>
</p>
</td>
<td valign="top">
<p>
Optionally, routing to be used to fetch document to percolate.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">preference</code>
</p>
</td>
<td valign="top">
<p>
Optionally, preference to be used to fetch document to percolate.
</p>
</td>
</tr>
<tr>
<td valign="top">
<p>
<code class="literal">version</code>
</p>
</td>
<td valign="top">
<p>
Optionally, the expected version of the document to be fetched.
</p>
</td>
</tr>
</tbody>
</table>
</div>
<h4><a id="_percolating_in_a_filter_context"></a>Percolating in a filter context<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>In case you are not interested in the score, better performance can be expected by wrapping
the percolator query in a <code class="literal">bool</code> query&#8217;s filter clause or in a <code class="literal">constant_score</code> query:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "constant_score": {
      "filter": {
        "percolate": {
          "field": "query",
          "document": {
            "message": "A new bonsai tree in the office"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/885.console"></div>
<p>At index time terms are extracted from the percolator query and the percolator
can often determine whether a query matches just by looking at those extracted
terms. However, computing scores requires to deserialize each matching query
and run it against the percolated document, which is a much more expensive
operation. Hence if computing scores is not required the <code class="literal">percolate</code> query
should be wrapped in a <code class="literal">constant_score</code> query or a <code class="literal">bool</code> query&#8217;s filter clause.</p>
<p>Note that the <code class="literal">percolate</code> query never gets cached by the query cache.</p>
<h4><a id="_percolating_multiple_documents"></a>Percolating multiple documents<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>The <code class="literal">percolate</code> query can match multiple documents simultaneously with the indexed percolator queries.
Percolating multiple documents in a single request can improve performance as queries only need to be parsed and
matched once instead of multiple times.</p>
<p>The <code class="literal">_percolator_document_slot</code> field that is being returned with each matched percolator query is important when percolating
multiple documents simultaneously. It indicates which documents matched with a particular percolator query. The numbers
correlate with the slot in the <code class="literal">documents</code> array specified in the <code class="literal">percolate</code> query.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "percolate": {
      "field": "query",
      "documents": [ <a id="CO211-1"></a><i class="conum" data-value="1"></i>
        {
          "message": "bonsai tree"
        },
        {
          "message": "new tree"
        },
        {
          "message": "the office"
        },
        {
          "message": "office tree"
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/886.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO211-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The documents array contains 4 documents that are going to be percolated at the same time.</p>
</td>
</tr>
</table>
</div>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 13,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped" : 0,
    "failed": 0
  },
  "hits": {
    "total" : {
        "value": 1,
        "relation": "eq"
    },
    "max_score": 0.7093853,
    "hits": [
      {
        "_index": "my-index-00001",
        "_type": "_doc",
        "_id": "1",
        "_score": 0.7093853,
        "_source": {
          "query": {
            "match": {
              "message": "bonsai tree"
            }
          }
        },
        "fields" : {
          "_percolator_document_slot" : [0, 1, 3] <a id="CO212-1"></a><i class="conum" data-value="1"></i>
        }
      }
    ]
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO212-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">_percolator_document_slot</code> indicates that the first, second and last documents specified in the <code class="literal">percolate</code> query
are matching with this query.</p>
</td>
</tr>
</table>
</div>
<h4><a id="_percolating_an_existing_document"></a>Percolating an Existing Document<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>In order to percolate a newly indexed document, the <code class="literal">percolate</code> query can be used. Based on the response
from an index request, the <code class="literal">_id</code> and other meta information can be used to immediately percolate the newly added
document.</p>
<h5><a id="_example_3"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h5>
<p>Based on the previous example.</p>
<p>Index the document we want to percolate:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-00001/_doc/2
{
  "message" : "A new bonsai tree in the office"
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/887.console"></div>
<p>Index response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "_index": "my-index-00001",
  "_type": "_doc",
  "_id": "2",
  "_version": 1,
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "result": "created",
  "_seq_no" : 1,
  "_primary_term" : 1
}</pre>
</div>
<p>Percolating an existing document, using the index response as basis to build to new search request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "percolate": {
      "field": "query",
      "index": "my-index-00001",
      "id": "2",
      "version": 1 <a id="CO213-1"></a><i class="conum" data-value="1"></i>
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/888.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO213-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The version is optional, but useful in certain cases. We can ensure that we are trying to percolate
the document we just have indexed. A change may be made after we have indexed, and if that is the
case the search request would fail with a version conflict error.</p>
</td>
</tr>
</table>
</div>
<p>The search response returned is identical as in the previous example.</p>
<h4><a id="_percolate_query_and_highlighting"></a>Percolate query and highlighting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>The <code class="literal">percolate</code> query is handled in a special way when it comes to highlighting. The queries hits are used
to highlight the document that is provided in the <code class="literal">percolate</code> query. Whereas with regular highlighting the query in
the search request is used to highlight the hits.</p>
<h5><a id="_example_4"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h5>
<p>This example is based on the mapping of the first example.</p>
<p>Save a query:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-00001/_doc/3?refresh
{
  "query": {
    "match": {
      "message": "brown fox"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/889.console"></div>
<p>Save another query:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /my-index-00001/_doc/4?refresh
{
  "query": {
    "match": {
      "message": "lazy dog"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/890.console"></div>
<p>Execute a search request with the <code class="literal">percolate</code> query and highlighting enabled:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "percolate": {
      "field": "query",
      "document": {
        "message": "The quick brown fox jumps over the lazy dog"
      }
    }
  },
  "highlight": {
    "fields": {
      "message": {}
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/891.console"></div>
<p>This will yield the following response.</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 7,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped" : 0,
    "failed": 0
  },
  "hits": {
    "total" : {
        "value": 2,
        "relation": "eq"
    },
    "max_score": 0.26152915,
    "hits": [
      {
        "_index": "my-index-00001",
        "_type": "_doc",
        "_id": "3",
        "_score": 0.26152915,
        "_source": {
          "query": {
            "match": {
              "message": "brown fox"
            }
          }
        },
        "highlight": {
          "message": [
            "The quick &lt;em&gt;brown&lt;/em&gt; &lt;em&gt;fox&lt;/em&gt; jumps over the lazy dog" <a id="CO214-1"></a><i class="conum" data-value="1"></i>
          ]
        },
        "fields" : {
          "_percolator_document_slot" : [0]
        }
      },
      {
        "_index": "my-index-00001",
        "_type": "_doc",
        "_id": "4",
        "_score": 0.26152915,
        "_source": {
          "query": {
            "match": {
              "message": "lazy dog"
            }
          }
        },
        "highlight": {
          "message": [
            "The quick brown fox jumps over the &lt;em&gt;lazy&lt;/em&gt; &lt;em&gt;dog&lt;/em&gt;" <a id="CO214-2"></a><i class="conum" data-value="1"></i>
          ]
        },
        "fields" : {
          "_percolator_document_slot" : [0]
        }
      }
    ]
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO214-1"><i class="conum" data-value="1"></i></a><a href="#CO214-2"></a></p>
</td>
<td align="left" valign="top">
<p>The terms from each query have been highlighted in the document.</p>
</td>
</tr>
</table>
</div>
<p>Instead of the query in the search request highlighting the percolator hits, the percolator queries are highlighting
the document defined in the <code class="literal">percolate</code> query.</p>
<p>When percolating multiple documents at the same time like the request below then the highlight response is different:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "percolate": {
      "field": "query",
      "documents": [
        {
          "message": "bonsai tree"
        },
        {
          "message": "new tree"
        },
        {
          "message": "the office"
        },
        {
          "message": "office tree"
        }
      ]
    }
  },
  "highlight": {
    "fields": {
      "message": {}
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/892.console"></div>
<p>The slightly different response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 13,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped" : 0,
    "failed": 0
  },
  "hits": {
    "total" : {
        "value": 1,
        "relation": "eq"
    },
    "max_score": 0.7093853,
    "hits": [
      {
        "_index": "my-index-00001",
        "_type": "_doc",
        "_id": "1",
        "_score": 0.7093853,
        "_source": {
          "query": {
            "match": {
              "message": "bonsai tree"
            }
          }
        },
        "fields" : {
          "_percolator_document_slot" : [0, 1, 3]
        },
        "highlight" : { <a id="CO215-1"></a><i class="conum" data-value="1"></i>
          "0_message" : [
              "&lt;em&gt;bonsai&lt;/em&gt; &lt;em&gt;tree&lt;/em&gt;"
          ],
          "3_message" : [
              "office &lt;em&gt;tree&lt;/em&gt;"
          ],
          "1_message" : [
              "new &lt;em&gt;tree&lt;/em&gt;"
          ]
        }
      }
    ]
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO215-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The highlight fields have been prefixed with the document slot they belong to,
in order to know which highlight field belongs to what document.</p>
</td>
</tr>
</table>
</div>
<h4><a id="_specifying_multiple_percolate_queries"></a>Specifying multiple percolate queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>It is possible to specify multiple <code class="literal">percolate</code> queries in a single search request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-00001/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "percolate": {
            "field": "query",
            "document": {
              "message": "bonsai tree"
            },
            "name": "query1" <a id="CO216-1"></a><i class="conum" data-value="1"></i>
          }
        },
        {
          "percolate": {
            "field": "query",
            "document": {
              "message": "tulip flower"
            },
            "name": "query2" <a id="CO216-2"></a><i class="conum" data-value="1"></i>
          }
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/893.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO216-1"><i class="conum" data-value="1"></i></a><a href="#CO216-2"></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">name</code> parameter will be used to identify which percolator document slots belong to what <code class="literal">percolate</code> query.</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">_percolator_document_slot</code> field name will be suffixed with what is specified in the <code class="literal">_name</code> parameter.
If that isn&#8217;t specified then the <code class="literal">field</code> parameter will be used, which in this case will result in ambiguity.</p>
<p>The above search request returns a response similar to this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "took": 13,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped" : 0,
    "failed": 0
  },
  "hits": {
    "total" : {
        "value": 1,
        "relation": "eq"
    },
    "max_score": 0.26152915,
    "hits": [
      {
        "_index": "my-index-00001",
        "_type": "_doc",
        "_id": "1",
        "_score": 0.26152915,
        "_source": {
          "query": {
            "match": {
              "message": "bonsai tree"
            }
          }
        },
        "fields" : {
          "_percolator_document_slot_query1" : [0] <a id="CO217-1"></a><i class="conum" data-value="1"></i>
        }
      }
    ]
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO217-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">_percolator_document_slot_query1</code> percolator slot field indicates that these matched slots are from the <code class="literal">percolate</code>
query with <code class="literal">_name</code> parameter set to <code class="literal">query1</code>.</p>
</td>
</tr>
</table>
</div>
<h4><a id="how-it-works"></a>How it Works Under the Hood<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
<p>When indexing a document into an index that has the <a class="xref" href="mapping-types.html#percolator" title="Percolator field type">percolator field type</a> mapping configured, the query
part of the document gets parsed into a Lucene query and is stored into the Lucene index. A binary representation
of the query gets stored, but also the query&#8217;s terms are analyzed and stored into an indexed field.</p>
<p>At search time, the document specified in the request gets parsed into a Lucene document and is stored in a in-memory
temporary Lucene index. This in-memory index can just hold this one document and it is optimized for that. After this
a special query is built based on the terms in the in-memory index that select candidate percolator queries based on
their indexed query terms. These queries are then evaluated by the in-memory index if they actually match.</p>
<p>The selecting of candidate percolator queries matches is an important performance optimization during the execution
of the <code class="literal">percolate</code> query as it can significantly reduce the number of candidate matches the in-memory index needs to
evaluate. The reason the <code class="literal">percolate</code> query can do this is because during indexing of the percolator queries the query
terms are being extracted and indexed with the percolator query. Unfortunately the percolator cannot extract terms from
all queries (for example the <code class="literal">wildcard</code> or <code class="literal">geo_shape</code> query) and as a result of that in certain cases the percolator
can&#8217;t do the selecting optimization (for example if an unsupported query is defined in a required clause of a boolean query
or the unsupported query is the only query in the percolator document).  These queries are marked by the percolator and
can be found by running the following search:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "term" : {
      "query.extraction_result" : "failed"
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/894.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The above example assumes that there is a <code class="literal">query</code> field of type
<code class="literal">percolator</code> in the mappings.</p>
</div>
</div>
<p>Given the design of percolation, it often makes sense to use separate indices for the percolate queries and documents
being percolated, as opposed to a single index as we do in examples. There are a few benefits to this approach:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Because percolate queries contain a different set of fields from the percolated documents, using two separate indices
allows for fields to be stored in a denser, more efficient way.
</li>
<li class="listitem">
Percolate queries do not scale in the same way as other queries, so percolation performance may benefit from using
a different index configuration, like the number of primary shards.
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="percolate-query-notes"></a>Notes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_allow_expensive_queries_3"></a>Allow expensive queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/percolate-query.asciidoc">edit</a></h4>
</div></div></div>
<p>Percolate queries will not be executed if <a class="xref" href="query-dsl.html#query-dsl-allow-expensive-queries"><code class="literal">search.allow_expensive_queries</code></a>
is set to false.</p>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-rank-feature-query"></a>Rank feature query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Boosts the <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance score</a> of documents based on the
numeric value of a <a class="xref" href="mapping-types.html#rank-feature" title="Rank feature field type"><code class="literal">rank_feature</code></a> or
<a class="xref" href="mapping-types.html#rank-features" title="Rank features field type"><code class="literal">rank_features</code></a> field.</p>
<p>The <code class="literal">rank_feature</code> query is typically used in the <code class="literal">should</code> clause of a
<a class="xref" href="compound-queries.html#query-dsl-bool-query" title="Boolean query"><code class="literal">bool</code></a> query so its relevance scores are added to other
scores from the <code class="literal">bool</code> query.</p>
<p>Unlike the <a class="xref" href="compound-queries.html#query-dsl-function-score-query" title="Function score query"><code class="literal">function_score</code></a> query or other
ways to change <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a>, the
<code class="literal">rank_feature</code> query efficiently skips non-competitive hits when the
<a class="xref" href="getting-started-modify-data.html#search-uri-request" title="URI search"><code class="literal">track_total_hits</code></a> parameter is <span class="strong strong"><strong>not</strong></span> <code class="literal">true</code>. This can
dramatically improve query speed.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rank-feature-query-functions"></a>Rank feature functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<p>To calculate relevance scores based on rank feature fields, the <code class="literal">rank_feature</code>
query supports the following mathematical functions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="specialized-queries.html#rank-feature-query-saturation" title="Saturation">Saturation</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#rank-feature-query-logarithm" title="Logarithm">Logarithm</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#rank-feature-query-sigmoid" title="Sigmoid">Sigmoid</a>
</li>
</ul>
</div>
<p>If you don&#8217;t know where to start, we recommend using the <code class="literal">saturation</code> function.
If no function is provided, the <code class="literal">rank_feature</code> query uses the <code class="literal">saturation</code>
function by default.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rank-feature-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="rank-feature-query-index-setup"></a>Index setup<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>To use the <code class="literal">rank_feature</code> query, your index must include a
<a class="xref" href="mapping-types.html#rank-feature" title="Rank feature field type"><code class="literal">rank_feature</code></a> or <a class="xref" href="mapping-types.html#rank-features" title="Rank features field type"><code class="literal">rank_features</code></a> field
mapping. To see how you can set up an index for the <code class="literal">rank_feature</code> query, try
the following example.</p>
<p>Create a <code class="literal">test</code> index with the following field mappings:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">pagerank</code>, a <a class="xref" href="mapping-types.html#rank-feature" title="Rank feature field type"><code class="literal">rank_feature</code></a> field which measures the
importance of a website
</li>
<li class="listitem">
<code class="literal">url_length</code>, a <a class="xref" href="mapping-types.html#rank-feature" title="Rank feature field type"><code class="literal">rank_feature</code></a> field which contains the
length of the website&#8217;s URL. For this example, a long URL correlates negatively
to relevance, indicated by a <code class="literal">positive_score_impact</code> value of <code class="literal">false</code>.
</li>
<li class="listitem">
<code class="literal">topics</code>, a <a class="xref" href="mapping-types.html#rank-features" title="Rank features field type"><code class="literal">rank_features</code></a> field which contains a list of
topics and a measure of how well each document is connected to this topic
</li>
</ul>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /test
{
  "mappings": {
    "properties": {
      "pagerank": {
        "type": "rank_feature"
      },
      "url_length": {
        "type": "rank_feature",
        "positive_score_impact": false
      },
      "topics": {
        "type": "rank_features"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/895.console"></div>
<p>Index several documents to the <code class="literal">test</code> index.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /test/_doc/1?refresh
{
  "url": "https://en.wikipedia.org/wiki/2016_Summer_Olympics",
  "content": "Rio 2016",
  "pagerank": 50.3,
  "url_length": 42,
  "topics": {
    "sports": 50,
    "brazil": 30
  }
}

PUT /test/_doc/2?refresh
{
  "url": "https://en.wikipedia.org/wiki/2016_Brazilian_Grand_Prix",
  "content": "Formula One motor race held on 13 November 2016",
  "pagerank": 50.3,
  "url_length": 47,
  "topics": {
    "sports": 35,
    "formula one": 65,
    "brazil": 20
  }
}

PUT /test/_doc/3?refresh
{
  "url": "https://en.wikipedia.org/wiki/Deadpool_(film)",
  "content": "Deadpool is a 2016 American superhero film",
  "pagerank": 50.3,
  "url_length": 37,
  "topics": {
    "movies": 60,
    "super hero": 65
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/896.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="rank-feature-query-ex-query"></a>Example query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The following query searches for <code class="literal">2016</code> and boosts relevance scores based on
<code class="literal">pagerank</code>, <code class="literal">url_length</code>, and the <code class="literal">sports</code> topic.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /test/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "content": "2016"
          }
        }
      ],
      "should": [
        {
          "rank_feature": {
            "field": "pagerank"
          }
        },
        {
          "rank_feature": {
            "field": "url_length",
            "boost": 0.1
          }
        },
        {
          "rank_feature": {
            "field": "topics.sports",
            "boost": 0.4
          }
        }
      ]
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/897.console"></div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rank-feature-top-level-params"></a>Top-level parameters for <code class="literal">rank_feature</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">field</code>
</span>
</dt>
<dd>
(Required, string) <a class="xref" href="mapping-types.html#rank-feature" title="Rank feature field type"><code class="literal">rank_feature</code></a> or
<a class="xref" href="mapping-types.html#rank-features" title="Rank features field type"><code class="literal">rank_features</code></a> field used to boost
<a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a>.
</dd>
<dt>
<span class="term">
<code class="literal">boost</code>
</span>
</dt>
<dd>
<p>(Optional, float) Floating point number used to decrease or increase
<a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a>. Defaults to <code class="literal">1.0</code>.</p>
<p>Boost values are relative to the default value of <code class="literal">1.0</code>. A boost value between
<code class="literal">0</code> and <code class="literal">1.0</code> decreases the relevance score. A value greater than <code class="literal">1.0</code>
increases the relevance score.</p>
</dd>
<dt>
<span class="term">
<code class="literal">saturation</code>
</span>
</dt>
<dd>
<p>(Optional, <a class="xref" href="specialized-queries.html#rank-feature-query-saturation" title="Saturation">function object</a>) Saturation
function used to boost <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a> based on the
value of the rank feature <code class="literal">field</code>. If no function is provided, the <code class="literal">rank_feature</code>
query defaults to the <code class="literal">saturation</code> function. See
<a class="xref" href="specialized-queries.html#rank-feature-query-saturation" title="Saturation">Saturation</a> for more information.</p>
<p>Only one function <code class="literal">saturation</code>, <code class="literal">log</code>, or <code class="literal">sigmoid</code> can be provided.</p>
</dd>
<dt>
<span class="term">
<code class="literal">log</code>
</span>
</dt>
<dd>
<p>(Optional, <a class="xref" href="specialized-queries.html#rank-feature-query-logarithm" title="Logarithm">function object</a>) Logarithmic
function used to boost <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a> based on the
value of the rank feature <code class="literal">field</code>. See
<a class="xref" href="specialized-queries.html#rank-feature-query-logarithm" title="Logarithm">Logarithm</a> for more information.</p>
<p>Only one function <code class="literal">saturation</code>, <code class="literal">log</code>, or <code class="literal">sigmoid</code> can be provided.</p>
</dd>
<dt>
<span class="term">
<code class="literal">sigmoid</code>
</span>
</dt>
<dd>
<p>(Optional, <a class="xref" href="specialized-queries.html#rank-feature-query-sigmoid" title="Sigmoid">function object</a>) Sigmoid function used
to boost <a class="xref" href="query-filter-context.html#relevance-scores" title="Relevance scores">relevance scores</a> based on the value of the
rank feature <code class="literal">field</code>. See <a class="xref" href="specialized-queries.html#rank-feature-query-sigmoid" title="Sigmoid">Sigmoid</a> for more
information.</p>
<p>Only one function <code class="literal">saturation</code>, <code class="literal">log</code>, or <code class="literal">sigmoid</code> can be provided.</p>
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="rank-feature-query-notes"></a>Notes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="rank-feature-query-saturation"></a>Saturation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">saturation</code> function gives a score equal to <code class="literal">S / (S + pivot)</code>, where <code class="literal">S</code> is
the value of the rank feature field and <code class="literal">pivot</code> is a configurable pivot value so
that the result will be less than <code class="literal">0.5</code> if <code class="literal">S</code> is less than pivot and greater
than <code class="literal">0.5</code> otherwise. Scores are always <code class="literal">(0,1)</code>.</p>
<p>If the rank feature has a negative score impact then the function will be
computed as <code class="literal">pivot / (S + pivot)</code>, which decreases when <code class="literal">S</code> increases.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /test/_search
{
  "query": {
    "rank_feature": {
      "field": "pagerank",
      "saturation": {
        "pivot": 8
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/898.console"></div>
<p>If a <code class="literal">pivot</code> value is not provided, Elasticsearch computes a default value equal to the
approximate geometric mean of all rank feature values in the index. We recommend
using this default value if you haven&#8217;t had the opportunity to train a good
pivot value.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /test/_search
{
  "query": {
    "rank_feature": {
      "field": "pagerank",
      "saturation": {}
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/899.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="rank-feature-query-logarithm"></a>Logarithm<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">log</code> function gives a score equal to <code class="literal">log(scaling_factor + S)</code>, where <code class="literal">S</code>
is the value of the rank feature field and <code class="literal">scaling_factor</code> is a configurable
scaling factor. Scores are unbounded.</p>
<p>This function only supports rank features that have a positive score impact.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /test/_search
{
  "query": {
    "rank_feature": {
      "field": "pagerank",
      "log": {
        "scaling_factor": 4
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/900.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="rank-feature-query-sigmoid"></a>Sigmoid<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/rank-feature-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">sigmoid</code> function is an extension of <code class="literal">saturation</code> which adds a configurable
exponent. Scores are computed as <code class="literal">S^exp^ / (S^exp^ + pivot^exp^)</code>. Like for the
<code class="literal">saturation</code> function, <code class="literal">pivot</code> is the value of <code class="literal">S</code> that gives a score of <code class="literal">0.5</code>
and scores are <code class="literal">(0,1)</code>.</p>
<p>The <code class="literal">exponent</code> must be positive and is typically in <code class="literal">[0.5, 1]</code>. A
good value should be computed via training. If you don&#8217;t have the opportunity to
do so, we recommend you use the <code class="literal">saturation</code> function instead.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /test/_search
{
  "query": {
    "rank_feature": {
      "field": "pagerank",
      "sigmoid": {
        "pivot": 7,
        "exponent": 0.6
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/901.console"></div>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-script-query"></a>Script query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Filters documents based on a provided <a class="xref" href="modules-scripting-using.html" title="How to use scripts">script</a>. The
<code class="literal">script</code> query is typically used in a <a class="xref" href="query-filter-context.html" title="Query and filter context">filter context</a>.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using scripts can result in slower search speeds. See
<a class="xref" href="modules-scripting-using.html#scripts-and-search-speed" title="Scripts and search speed">Scripts and search speed</a>.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="script-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "bool": {
      "filter": {
        "script": {
          "script": {
            "source": "doc['num1'].value &gt; 1",
            "lang": "painless"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/902.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="script-top-level-params"></a>Top-level parameters for <code class="literal">script</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">script</code>
</span>
</dt>
<dd>
(Required, <a class="xref" href="modules-scripting-using.html" title="How to use scripts">script object</a>) Contains a script to run
as a query. This script must return a boolean value, <code class="literal">true</code> or <code class="literal">false</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="script-query-notes"></a>Notes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="script-query-custom-params"></a>Custom Parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-query.asciidoc">edit</a></h4>
</div></div></div>
<p>Like <a class="xref" href="query-filter-context.html" title="Query and filter context">filters</a>, scripts are cached for faster execution.
If you frequently change the arguments of a script, we recommend you store them
in the script&#8217;s <code class="literal">params</code> parameter. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "bool": {
      "filter": {
        "script": {
          "script": {
            "source": "doc['num1'].value &gt; params.param1",
            "lang": "painless",
            "params": {
              "param1": 5
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/903.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_allow_expensive_queries_4"></a>Allow expensive queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-query.asciidoc">edit</a></h4>
</div></div></div>
<p>Script queries will not be executed if <a class="xref" href="query-dsl.html#query-dsl-allow-expensive-queries"><code class="literal">search.allow_expensive_queries</code></a>
is set to false.</p>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-script-score-query"></a>Script score query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h2>
</div></div></div>

<p>Uses a <a class="xref" href="modules-scripting.html" title="Scripting">script</a> to provide a custom score for returned
documents.</p>
<p>The <code class="literal">script_score</code> query is useful if, for example, a scoring function is expensive and you only need to calculate the score of a filtered set of documents.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="script-score-query-ex-request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h3>
</div></div></div>
<p>The following <code class="literal">script_score</code> query assigns each returned document a score equal to the <code class="literal">my-int</code> field value divided by <code class="literal">10</code>.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "elasticsearch" }
      },
      "script": {
        "source": "doc['my-int'].value / 10 "
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/904.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="script-score-top-level-params"></a>Top-level parameters for <code class="literal">script_score</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">query</code>
</span>
</dt>
<dd>
(Required, query object) Query used to return documents.
</dd>
<dt>
<span class="term">
<code class="literal">script</code>
</span>
</dt>
<dd>
<p>(Required, <a class="xref" href="modules-scripting-using.html" title="How to use scripts">script object</a>) Script used to compute the score of documents returned by the <code class="literal">query</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Final relevance scores from the <code class="literal">script_score</code> query cannot be
negative. To support certain search optimizations, Lucene requires
scores be positive or <code class="literal">0</code>.</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<code class="literal">min_score</code>
</span>
</dt>
<dd>
(Optional, float) Documents with a score lower
than this floating point number are excluded from the search results.
</dd>
<dt>
<span class="term">
<code class="literal">boost</code>
</span>
</dt>
<dd>
(Optional, float) Documents' scores produced by <code class="literal">script</code> are
multiplied by <code class="literal">boost</code> to produce final documents' scores. Defaults to <code class="literal">1.0</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="script-score-query-notes"></a>Notes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="script-score-access-scores"></a>Use relevance scores in a script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>Within a script, you can
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/modules-scripting-fields.html#scripting-score" class="ulink" target="_top">access</a>
the <code class="literal">_score</code> variable which represents the current relevance score of a
document.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="script-score-predefined-functions"></a>Predefined functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>You can use any of the available <a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.10/painless-contexts.html" class="ulink" target="_top">painless
functions</a> in your <code class="literal">script</code>. You can also use the following predefined functions
to customize scoring:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="specialized-queries.html#script-score-saturation" title="Saturation">Saturation</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#script-score-sigmoid" title="Sigmoid">Sigmoid</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#random-score-function" title="Random score function">Random score function</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#decay-functions-numeric-fields" title="Decay functions for numeric fields">Decay functions for numeric fields</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#decay-functions-geo-fields" title="Decay functions for geo fields">Decay functions for geo fields</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#decay-functions-date-fields" title="Decay functions for date fields">Decay functions for date fields</a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#script-score-functions-vector-fields" title="Functions for vector fields">Functions for vector fields</a>
</li>
</ul>
</div>
<p>We suggest using these predefined functions instead of writing your own.
These functions take advantage of efficiencies from Elasticsearch' internal mechanisms.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="script-score-saturation"></a>Saturation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p><code class="literal">saturation(value,k) = value/(k + value)</code></p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "saturation(doc['my-int'].value, 1)"
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="script-score-sigmoid"></a>Sigmoid<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p><code class="literal">sigmoid(value, k, a) = value^a/ (k^a + value^a)</code></p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "sigmoid(doc['my-int'].value, 2, 1)"
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="random-score-function"></a>Random score function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p><code class="literal">random_score</code> function generates scores that are uniformly distributed
from 0 up to but not including 1.</p>
<p><code class="literal">randomScore</code> function has the following syntax:
<code class="literal">randomScore(&lt;seed&gt;, &lt;fieldName&gt;)</code>.
It has a required parameter - <code class="literal">seed</code> as an integer value,
and an optional parameter - <code class="literal">fieldName</code> as a string value.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "randomScore(100, '_seq_no')"
}</pre>
</div>
<p>If the <code class="literal">fieldName</code> parameter is omitted, the internal Lucene
document ids will be used as a source of randomness. This is very efficient,
but unfortunately not reproducible since documents might be renumbered
by merges.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "randomScore(100)"
}</pre>
</div>
<p>Note that documents that are within the same shard and have the
same value for field will get the same score, so it is usually desirable
to use a field that has unique values for all documents across a shard.
A good default choice might be to use the <code class="literal">_seq_no</code>
field, whose only drawback is that scores will change if the document is
updated since update operations also update the value of the <code class="literal">_seq_no</code> field.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="decay-functions-numeric-fields"></a>Decay functions for numeric fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p>You can read more about decay functions
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/query-dsl-function-score-query.html#function-decay" class="ulink" target="_top">here</a>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">double decayNumericLinear(double origin, double scale, double offset, double decay, double docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayNumericExp(double origin, double scale, double offset, double decay, double docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayNumericGauss(double origin, double scale, double offset, double decay, double docValue)</code>
</li>
</ul>
</div>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "decayNumericLinear(params.origin, params.scale, params.offset, params.decay, doc['dval'].value)",
    "params": { <a id="CO218-1"></a><i class="conum" data-value="1"></i>
        "origin": 20,
        "scale": 10,
        "decay" : 0.5,
        "offset" : 0
    }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO218-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Using <code class="literal">params</code> allows to compile the script only once, even if params change.</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="decay-functions-geo-fields"></a>Decay functions for geo fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">double decayGeoLinear(String originStr, String scaleStr, String offsetStr, double decay, GeoPoint docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayGeoExp(String originStr, String scaleStr, String offsetStr, double decay, GeoPoint docValue)</code>
</li>
<li class="listitem">
<code class="literal">double decayGeoGauss(String originStr, String scaleStr, String offsetStr, double decay, GeoPoint docValue)</code>
</li>
</ul>
</div>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "decayGeoExp(params.origin, params.scale, params.offset, params.decay, doc['location'].value)",
    "params": {
        "origin": "40, -70.12",
        "scale": "200km",
        "offset": "0km",
        "decay" : 0.2
    }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="decay-functions-date-fields"></a>Decay functions for date fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">double decayDateLinear(String originStr, String scaleStr, String offsetStr, double decay, JodaCompatibleZonedDateTime docValueDate)</code>
</li>
<li class="listitem">
<code class="literal">double decayDateExp(String originStr, String scaleStr, String offsetStr, double decay, JodaCompatibleZonedDateTime docValueDate)</code>
</li>
<li class="listitem">
<code class="literal">double decayDateGauss(String originStr, String scaleStr, String offsetStr, double decay, JodaCompatibleZonedDateTime docValueDate)</code>
</li>
</ul>
</div>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "decayDateGauss(params.origin, params.scale, params.offset, params.decay, doc['date'].value)",
    "params": {
        "origin": "2008-01-01T01:00:00Z",
        "scale": "1h",
        "offset" : "0",
        "decay" : 0.5
    }
}</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Decay functions on dates are limited to dates in the default format
and default time zone. Also calculations with <code class="literal">now</code> are not supported.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="script-score-functions-vector-fields"></a>Functions for vector fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p><a class="xref" href="specialized-queries.html#vector-functions" title="Functions for vector fields">Functions for vector fields</a> are accessible through
<code class="literal">script_score</code> query.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_allow_expensive_queries_5"></a>Allow expensive queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>Script score queries will not be executed if <a class="xref" href="query-dsl.html#query-dsl-allow-expensive-queries"><code class="literal">search.allow_expensive_queries</code></a>
is set to false.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="script-score-faster-alt"></a>Faster alternatives<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">script_score</code> query calculates the score for
every matching document, or hit. There are faster alternative query types that
can efficiently skip non-competitive hits:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If you want to boost documents on some static fields, use the
<a class="xref" href="specialized-queries.html#query-dsl-rank-feature-query" title="Rank feature query"><code class="literal">rank_feature</code></a> query.
</li>
<li class="listitem">
If you want to boost documents closer to a date or geographic point, use the
<a class="xref" href="specialized-queries.html#query-dsl-distance-feature-query" title="Distance feature query"><code class="literal">distance_feature</code></a> query.
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="script-score-function-score-transition"></a>Transition from the function score query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h4>
</div></div></div>
<p>We are deprecating the <a class="xref" href="compound-queries.html#query-dsl-function-score-query" title="Function score query"><code class="literal">function_score</code></a>
query. We recommend using the <code class="literal">script_score</code> query instead.</p>
<p>You can implement the following functions from the <code class="literal">function_score</code> query using
the <code class="literal">script_score</code> query:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="specialized-queries.html#script-score" title="script_score"><code class="literal">script_score</code></a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#weight" title="weight"><code class="literal">weight</code></a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#random-score" title="random_score"><code class="literal">random_score</code></a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#field-value-factor" title="field_value_factor"><code class="literal">field_value_factor</code></a>
</li>
<li class="listitem">
<a class="xref" href="specialized-queries.html#decay-functions" title="decay functions"><code class="literal">decay</code> functions</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="script-score"></a><code class="literal">script_score</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p>What you used in <code class="literal">script_score</code> of the Function Score query, you
can copy into the Script Score query. No changes here.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="weight"></a><code class="literal">weight</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p><code class="literal">weight</code> function can be implemented in the Script Score query through
the following script:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "params.weight * _score",
    "params": {
        "weight": 2
    }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="random-score"></a><code class="literal">random_score</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p>Use <code class="literal">randomScore</code> function
as described in <a class="xref" href="specialized-queries.html#random-score-function" title="Random score function">random score function</a>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="field-value-factor"></a><code class="literal">field_value_factor</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p><code class="literal">field_value_factor</code> function can be easily implemented through script:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "Math.log10(doc['field'].value * params.factor)",
    "params" : {
        "factor" : 5
    }
}</pre>
</div>
<p>For checking if a document has a missing value, you can use
<code class="literal">doc['field'].size() == 0</code>. For example, this script will use
a value <code class="literal">1</code> if a document doesn&#8217;t have a field <code class="literal">field</code>:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script" : {
    "source" : "Math.log10((doc['field'].size() == 0 ? 1 : doc['field'].value()) * params.factor)",
    "params" : {
        "factor" : 5
    }
}</pre>
</div>
<p>This table lists how <code class="literal">field_value_factor</code> modifiers can be implemented
through a script:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Modifier</th>
<th align="left" valign="top">Implementation in Script Score</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">none</code></p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log10(doc['f'].value)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log1p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log10(doc['f'].value + 1)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">log2p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log10(doc['f'].value + 2)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log(doc['f'].value)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln1p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log(doc['f'].value + 1)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ln2p</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.log(doc['f'].value + 2)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">square</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.pow(doc['f'].value, 2)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqrt</code></p></td>
<td align="left" valign="top"><p><code class="literal">Math.sqrt(doc['f'].value)</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">reciprocal</code></p></td>
<td align="left" valign="top"><p><code class="literal">1.0 / doc['f'].value</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="decay-functions"></a><code class="literal">decay</code> functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p>The <code class="literal">script_score</code> query has equivalent <a class="xref" href="specialized-queries.html#decay-functions" title="decay functions">decay functions</a>
that can be used in script.</p>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h4 class="title"><a id="vector-functions"></a>Functions for vector fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/vectors/vector-functions.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h4>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>During vector functions' calculation, all matched documents are
linearly scanned. Thus, expect the query time grow linearly
with the number of matched documents. For this reason, we recommend
to limit the number of matched documents with a <code class="literal">query</code> parameter.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_dense_vector_functions"></a><code class="literal">dense_vector</code> functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/vectors/vector-functions.asciidoc">edit</a></h5>
</div></div></div>
<p>Let&#8217;s create an index with a <code class="literal">dense_vector</code> mapping and index a couple
of documents into it.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index-000001
{
  "mappings": {
    "properties": {
      "my_dense_vector": {
        "type": "dense_vector",
        "dims": 3
      },
      "status" : {
        "type" : "keyword"
      }
    }
  }
}

PUT my-index-000001/_doc/1
{
  "my_dense_vector": [0.5, 10, 6],
  "status" : "published"
}

PUT my-index-000001/_doc/2
{
  "my_dense_vector": [-0.5, 10, 10],
  "status" : "published"
}

POST my-index-000001/_refresh</pre>
</div>
<div class="console_widget" data-snippet="snippets/905.console"></div>
<p>The <code class="literal">cosineSimilarity</code> function calculates the measure of
cosine similarity between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published" <a id="CO219-1"></a><i class="conum" data-value="1"></i>
            }
          }
        }
      },
      "script": {
        "source": "cosineSimilarity(params.query_vector, 'my_dense_vector') + 1.0", <a id="CO219-2"></a><i class="conum" data-value="2"></i>
        "params": {
          "query_vector": [4, 3.4, -0.2]  <a id="CO219-3"></a><i class="conum" data-value="3"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/906.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO219-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>To restrict the number of documents on which script score calculation is applied, provide a filter.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO219-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The script adds 1.0 to the cosine similarity to prevent the score from being negative.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO219-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>To take advantage of the script optimizations, provide a query vector as a script parameter.</p>
</td>
</tr>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If a document&#8217;s dense vector field has a number of dimensions
different from the query&#8217;s vector, an error will be thrown.</p>
</div>
</div>
<p>The <code class="literal">dotProduct</code> function calculates the measure of
dot product between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": """
          double value = dotProduct(params.query_vector, 'my_dense_vector');
          return sigmoid(1, Math.E, -value); <a id="CO220-1"></a><i class="conum" data-value="1"></i>
        """,
        "params": {
          "query_vector": [4, 3.4, -0.2]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/907.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO220-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Using the standard sigmoid function prevents scores from being negative.</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">l1norm</code> function calculates L<sup>1</sup> distance
(Manhattan distance) between a given query vector and
document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "1 / (1 + l1norm(params.queryVector, 'my_dense_vector'))", <a id="CO221-1"></a><i class="conum" data-value="1"></i>
        "params": {
          "queryVector": [4, 3.4, -0.2]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/908.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO221-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Unlike <code class="literal">cosineSimilarity</code> that represent similarity, <code class="literal">l1norm</code> and
<code class="literal">l2norm</code> shown below represent distances or differences. This means, that
the more similar the vectors are, the lower the scores will be that are
produced by the <code class="literal">l1norm</code> and <code class="literal">l2norm</code> functions.
Thus, as we need more similar vectors to score higher,
we reversed the output from <code class="literal">l1norm</code> and <code class="literal">l2norm</code>. Also, to avoid
division by 0 when a document vector matches the query exactly,
we added <code class="literal">1</code> in the denominator.</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">l2norm</code> function calculates L<sup>2</sup> distance
(Euclidean distance) between a given query vector and
document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index-000001/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "1 / (1 + l2norm(params.queryVector, 'my_dense_vector'))",
        "params": {
          "queryVector": [4, 3.4, -0.2]
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/909.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If a document doesn&#8217;t have a value for a vector field on which
a vector function is executed, an error will be thrown.</p>
</div>
</div>
<p>You can check if a document has a value for the field <code class="literal">my_vector</code> by
<code class="literal">doc['my_vector'].size() == 0</code>. Your overall script can look like this:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"source": "doc['my_vector'].size() == 0 ? 0 : cosineSimilarity(params.queryVector, 'my_vector')"</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_sparse_vector_functions"></a><code class="literal">sparse_vector</code> functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/vectors/vector-functions.asciidoc">edit</a></h5>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Deprecated in 7.6.</h3>
<p>The <code class="literal">sparse_vector</code> type is deprecated and will be removed in 8.0.</p>
</div>
</div>
<p>Let&#8217;s create an index with a <code class="literal">sparse_vector</code> mapping and index a couple
of documents into it.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my_sparse_index
{
  "mappings": {
    "properties": {
      "my_sparse_vector": {
        "type": "sparse_vector"
      },
      "status" : {
        "type" : "keyword"
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/910.console"></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my_sparse_index/_doc/1
{
  "my_sparse_vector": {"2": 1.5, "15" : 2, "50": -1.1, "4545": 1.1},
  "status" : "published"
}

PUT my_sparse_index/_doc/2
{
  "my_sparse_vector": {"2": 2.5, "10" : 1.3, "55": -2.3, "113": 1.6},
  "status" : "published"
}

POST my_sparse_index/_refresh</pre>
</div>
<div class="console_widget" data-snippet="snippets/911.console"></div>
<p>The <code class="literal">cosineSimilaritySparse</code> function calculates cosine similarity
between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my_sparse_index/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "cosineSimilaritySparse(params.query_vector, 'my_sparse_vector') + 1.0",
        "params": {
          "query_vector": {"2": 0.5, "10" : 111.3, "50": -1.3, "113": 14.8, "4545": 156.0}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/912.console"></div>
<p>The <code class="literal">dotProductSparse</code> function calculates dot product
between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my_sparse_index/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": """
          double value = dotProductSparse(params.query_vector, 'my_sparse_vector');
          return sigmoid(1, Math.E, -value);
        """,
         "params": {
          "query_vector": {"2": 0.5, "10" : 111.3, "50": -1.3, "113": 14.8, "4545": 156.0}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/913.console"></div>
<p>The <code class="literal">l1normSparse</code> function calculates L<sup>1</sup> distance
between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my_sparse_index/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "1 / (1 + l1normSparse(params.queryVector, 'my_sparse_vector'))",
        "params": {
          "queryVector": {"2": 0.5, "10" : 111.3, "50": -1.3, "113": 14.8, "4545": 156.0}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/914.console"></div>
<p>The <code class="literal">l2normSparse</code> function calculates L<sup>2</sup> distance
between a given query vector and document vectors.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my_sparse_index/_search
{
  "query": {
    "script_score": {
      "query" : {
        "bool" : {
          "filter" : {
            "term" : {
              "status" : "published"
            }
          }
        }
      },
      "script": {
        "source": "1 / (1 + l2normSparse(params.queryVector, 'my_sparse_vector'))",
        "params": {
          "queryVector": {"2": 0.5, "10" : 111.3, "50": -1.3, "113": 14.8, "4545": 156.0}
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/915.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="score-explanation"></a>Explain request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/script-score-query.asciidoc">edit</a></h5>
</div></div></div>
<p>Using an <a class="xref" href="search.html#search-explain" title="Explain API">explain request</a> provides an explanation of how the parts of a score were computed. The <code class="literal">script_score</code> query can add its own explanation by setting the <code class="literal">explanation</code> parameter:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /my-index-000001/_explain/0
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "elasticsearch" }
      },
      "script": {
        "source": """
          long count = doc['count'].value;
          double normalizedCount = count / 10;
          if (explanation != null) {
            explanation.set('normalized count = count / 10 = ' + count + ' / 10 = ' + normalizedCount);
          }
          return normalizedCount;
        """
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/916.console"></div>
<p>Note that the <code class="literal">explanation</code> will be null when using in a normal <code class="literal">_search</code> request, so having a conditional guard is best practice.</p>
</div>

</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-wrapper-query"></a>Wrapper query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/wrapper-query.asciidoc">edit</a></h2>
</div></div></div>

<p>A query that accepts any other query as base64 encoded string.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "wrapper": {
      "query": "eyJ0ZXJtIiA6IHsgInVzZXIuaWQiIDogImtpbWNoeSIgfX0=" <a id="CO222-1"></a><i class="conum" data-value="1"></i>
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/917.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO222-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Base64 encoded string:  <code class="literal">{"term" : { "user.id" : "kimchy" }}</code></p>
</td>
</tr>
</table>
</div>
<p>This query is more useful in the context of the Java high-level REST client or
transport client to also accept queries as json formatted string.
In these cases queries can be specified as a json or yaml formatted string or
as a query builder (which is a available in the Java high-level REST client).</p>
</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="query-dsl-pinned-query"></a>Pinned Query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/pinned-query.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<p>Promotes selected documents to rank higher than those matching a given query.
This feature is typically used to guide searchers to curated documents that are
promoted over and above any "organic" matches for a search.
The promoted or "pinned" documents are identified using the document IDs stored in
the <a class="xref" href="mapping-fields.html#mapping-id-field" title="_id field"><code class="literal">_id</code></a> field.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_example_request"></a>Example request<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/pinned-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "pinned": {
      "ids": [ "1", "4", "100" ],
      "organic": {
        "match": {
          "description": "iphone"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/918.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="pinned-query-top-level-parameters"></a>Top-level parameters for <code class="literal">pinned</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/query-dsl/pinned-query.asciidoc">edit</a></h3>
</div></div></div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">ids</code>
</span>
</dt>
<dd>
An array of <a class="xref" href="mapping-fields.html#mapping-id-field" title="_id field">document IDs</a> listed in the order they are to appear in results.
</dd>
<dt>
<span class="term">
<code class="literal">organic</code>
</span>
</dt>
<dd>
Any choice of query used to rank documents which will be ranked below the "pinned" document ids.
</dd>
</dl>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="span-queries.html">« Span queries</a>
</span>
<span class="next">
<a href="term-level-queries.html">Term-level queries »</a>
</span>
</div>
</div>
</body>
</html>
