<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Pipeline aggregations | Elasticsearch Guide | Elastic</title>
<meta class="elastic" name="content" content="Pipeline aggregations | Elasticsearch Guide">

<link rel="home" href="index.html" title="Elasticsearch Guide"/>
<link rel="up" href="search-aggregations.html" title="Aggregations"/>
<link rel="prev" href="search-aggregations-metrics.html" title="Metrics aggregations"/>
<link rel="next" href="eql.html" title="EQL search"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="search-aggregations-metrics.html">« Metrics aggregations</a>
</span>
<span class="next">
<a href="eql.html">EQL search »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline"></a>Pipeline aggregations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline.asciidoc">edit</a></h2>
</div></div></div>
<p>Pipeline aggregations work on the outputs produced from other aggregations rather than from document sets, adding
information to the output tree. There are many different types of pipeline aggregation, each computing different information from
other aggregations, but these types can be broken down into two families:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>Parent</em>
</span>
</dt>
<dd>
A family of pipeline aggregations that is provided with the output of its parent aggregation and is able
to compute new buckets or new aggregations to add to existing buckets.
</dd>
<dt>
<span class="term">
<em>Sibling</em>
</span>
</dt>
<dd>
Pipeline aggregations that are provided with the output of a sibling aggregation and are able to compute a
new aggregation which will be at the same level as the sibling aggregation.
</dd>
</dl>
</div>
<p>Pipeline aggregations can reference the aggregations they need to perform their computation by using the <code class="literal">buckets_path</code>
parameter to indicate the paths to the required metrics. The syntax for defining these paths can be found in the
<a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> section below.</p>
<p>Pipeline aggregations cannot have sub-aggregations but depending on the type it can reference another pipeline in the <code class="literal">buckets_path</code>
allowing pipeline aggregations to be chained.  For example, you can chain together two derivatives to calculate the second derivative
(i.e. a derivative of a derivative).</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Because pipeline aggregations only add to the output, when chaining pipeline aggregations the output of each pipeline aggregation
will be included in the final output.</p>
</div>
</div>
<h3><a id="buckets-path-syntax"></a><code class="literal">buckets_path</code> Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline.asciidoc">edit</a></h3>
<p>Most pipeline aggregations require another aggregation as their input.  The input aggregation is defined via the <code class="literal">buckets_path</code>
parameter, which follows a specific format:</p>
<div class="pre_wrapper lang-ebnf">
<pre class="programlisting prettyprint lang-ebnf">AGG_SEPARATOR       =  `&gt;` ;
METRIC_SEPARATOR    =  `.` ;
AGG_NAME            =  &lt;the name of the aggregation&gt; ;
METRIC              =  &lt;the name of the metric (in case of multi-value metrics aggregation)&gt; ;
MULTIBUCKET_KEY     =  `[&lt;KEY_NAME&gt;]`
PATH                =  &lt;AGG_NAME&gt;&lt;MULTIBUCKET_KEY&gt;? (&lt;AGG_SEPARATOR&gt;, &lt;AGG_NAME&gt; )* ( &lt;METRIC_SEPARATOR&gt;, &lt;METRIC&gt; ) ;</pre>
</div>
<p>For example, the path <code class="literal">"my_bucket&gt;my_stats.avg"</code> will path to the <code class="literal">avg</code> value in the <code class="literal">"my_stats"</code> metric, which is
contained in the <code class="literal">"my_bucket"</code> bucket aggregation.</p>
<p>Paths are relative from the position of the pipeline aggregation; they are not absolute paths, and the path cannot go back "up" the
aggregation tree. For example, this moving average is embedded inside a date_histogram and refers to a "sibling"
metric <code class="literal">"the_sum"</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "lemmings" } <a id="CO303-3"></a><i class="conum" data-value="1"></i>
        },
        "the_movavg": {
          "moving_avg": { "buckets_path": "the_sum" } <a id="CO303-4"></a><i class="conum" data-value="2"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1200.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO303-1"><i class="conum" data-value="1"></i></a><a href="#CO303-2"></a><a href="#CO303-3"></a></p>
</td>
<td align="left" valign="top">
<p>The metric is called <code class="literal">"the_sum"</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO303-4"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">buckets_path</code> refers to the metric via a relative path <code class="literal">"the_sum"</code></p>
</td>
</tr>
</table>
</div>
<p><code class="literal">buckets_path</code> is also used for Sibling pipeline aggregations, where the aggregation is "next" to a series of buckets
instead of embedded "inside" them.  For example, the <code class="literal">max_bucket</code> aggregation uses the <code class="literal">buckets_path</code> to specify
a metric embedded inside a sibling aggregation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "max_monthly_sales": {
      "max_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO304-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1201.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO304-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this max_bucket aggregation that we want the maximum value of the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>If a Sibling pipeline agg references a multi-bucket aggregation, such as a <code class="literal">terms</code> agg, it also has the option to
select specific keys from the multi-bucket.  For example, a <code class="literal">bucket_script</code> could select two specific buckets (via
their bucket keys) to perform the calculation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sale_type": {
          "terms": {
            "field": "type"
          },
          "aggs": {
            "sales": {
              "sum": {
                "field": "price"
              }
            }
          }
        },
        "hat_vs_bag_ratio": {
          "bucket_script": {
            "buckets_path": {
              "hats": "sale_type['hat']&gt;sales",   <a id="CO305-1"></a><i class="conum" data-value="1"></i>
              "bags": "sale_type['bag']&gt;sales"    <a id="CO305-2"></a><i class="conum" data-value="1"></i>
            },
            "script": "params.hats / params.bags"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1202.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO305-1"><i class="conum" data-value="1"></i></a><a href="#CO305-2"></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> selects the hats and bags buckets (via <code class="literal">['hat']</code>/<code class="literal">['bag']`</code>) to use in the script specifically,
instead of fetching all the buckets from <code class="literal">sale_type</code> aggregation</p>
</td>
</tr>
</table>
</div>
<h3><a id="_special_paths"></a>Special Paths<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline.asciidoc">edit</a></h3>
<p>Instead of pathing to a metric, <code class="literal">buckets_path</code> can use a special <code class="literal">"_count"</code> path.  This instructs
the pipeline aggregation to use the document count as its input.  For example, a moving average can be calculated on the document count of each bucket, instead of a specific metric:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "the_movavg": {
          "moving_avg": { "buckets_path": "_count" } <a id="CO306-1"></a><i class="conum" data-value="1"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1203.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO306-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>By using <code class="literal">_count</code> instead of a metric name, we can calculate the moving average of document counts in the histogram</p>
</td>
</tr>
</table>
</div>
<p>The <code class="literal">buckets_path</code> can also use <code class="literal">"_bucket_count"</code> and path to a multi-bucket aggregation to use the number of buckets
returned by that aggregation in the pipeline aggregation instead of a metric. for example a <code class="literal">bucket_selector</code> can be
used here to filter out buckets which contain no buckets for an inner terms aggregation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "day"
      },
      "aggs": {
        "categories": {
          "terms": {
            "field": "category"
          }
        },
        "min_bucket_selector": {
          "bucket_selector": {
            "buckets_path": {
              "count": "categories._bucket_count" <a id="CO307-1"></a><i class="conum" data-value="1"></i>
            },
            "script": {
              "source": "params.count != 0"
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1204.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO307-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>By using <code class="literal">_bucket_count</code> instead of a metric name, we can filter out <code class="literal">histo</code> buckets where they contain no buckets
for the <code class="literal">categories</code> aggregation</p>
</td>
</tr>
</table>
</div>
<h3><a id="dots-in-agg-names"></a>Dealing with dots in agg names<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline.asciidoc">edit</a></h3>
<p>An alternate syntax is supported to cope with aggregations or metrics which
have dots in the name, such as the <code class="literal">99.9</code>th
<a class="xref" href="search-aggregations-metrics.html#search-aggregations-metrics-percentile-aggregation" title="Percentiles aggregation">percentile</a>. This metric
may be referred to as:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"buckets_path": "my_percentile[99.9]"</pre>
</div>
<h3><a id="gap-policy"></a>Dealing with gaps in the data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline.asciidoc">edit</a></h3>
<p>Data in the real world is often noisy and sometimes contains <span class="strong strong"><strong>gaps</strong></span>&#8201;&#8212;&#8201;places where data simply doesn&#8217;t exist.  This can
occur for a variety of reasons, the most common being:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Documents falling into a bucket do not contain a required field
</li>
<li class="listitem">
There are no documents matching the query for one or more buckets
</li>
<li class="listitem">
The metric being calculated is unable to generate a value, likely because another dependent bucket is missing a value.
Some pipeline aggregations have specific requirements that must be met (e.g. a derivative cannot calculate a metric for the
first value because there is no previous value, HoltWinters moving average need "warmup" data to begin calculating, etc)
</li>
</ul>
</div>
<p>Gap policies are a mechanism to inform the pipeline aggregation about the desired behavior when "gappy" or missing
data is encountered.  All pipeline aggregations accept the <code class="literal">gap_policy</code> parameter.  There are currently two gap policies
to choose from:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>skip</em>
</span>
</dt>
<dd>
This option treats missing data as if the bucket does not exist.  It will skip the bucket and continue
calculating using the next available value.
</dd>
<dt>
<span class="term">
<em>insert_zeros</em>
</span>
</dt>
<dd>
This option will replace missing values with a zero (<code class="literal">0</code>) and pipeline aggregation computation will
proceed as normal.
</dd>
</dl>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-avg-bucket-aggregation"></a>Avg bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/avg-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which calculates the (mean) average value of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="avg-bucket-agg-syntax"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/avg-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>An <code class="literal">avg_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "avg_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="avg-bucket-params"></a>
<p class="title"><strong>Table 44. <code class="literal">avg_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="avg_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the average for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the average of the total monthly <code class="literal">sales</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "avg_monthly_sales": {
      "avg_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO308-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1205.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO308-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this avg_bucket aggregation that we want the (mean) average value of the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "avg_monthly_sales": {
          "value": 328.33333333333333
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-bucket-script-aggregation"></a>Bucket script aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-script-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A parent pipeline aggregation which executes a script which can perform per bucket computations on specified metrics
in the parent multi-bucket aggregation. The specified metric must be numeric and the script must return a numeric value.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="bucket-script-agg-syntax"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-script-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">bucket_script</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "bucket_script": {
    "buckets_path": {
      "my_var1": "the_sum",                     <a id="CO309-1"></a><i class="conum" data-value="1"></i>
      "my_var2": "the_value_count"
    },
    "script": "params.my_var1 / params.my_var2"
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO309-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Here, <code class="literal">my_var1</code> is the name of the variable for this buckets path to use in the script, <code class="literal">the_sum</code> is the path to
the metrics to use for that variable.</p>
</td>
</tr>
</table>
</div>
<div class="table">
<a id="bucket-script-params"></a>
<p class="title"><strong>Table 45. <code class="literal">bucket_script</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="bucket_script Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">script</code></p></td>
<td align="left" valign="top"><p>The script to run for this aggregation. The script can be inline, file or indexed. (see <a class="xref" href="modules-scripting.html" title="Scripting">Scripting</a>
for more details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>A map of script variables and their associated path to the buckets we wish to use for the variable
(see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the ratio percentage of t-shirt sales compared to total sales each month:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "t-shirts": {
          "filter": {
            "term": {
              "type": "t-shirt"
            }
          },
          "aggs": {
            "sales": {
              "sum": {
                "field": "price"
              }
            }
          }
        },
        "t-shirt-percentage": {
          "bucket_script": {
            "buckets_path": {
              "tShirtSales": "t-shirts&gt;sales",
              "totalSales": "total_sales"
            },
            "script": "params.tShirtSales / params.totalSales * 100"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1206.console"></div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "total_sales": {
                   "value": 550.0
               },
               "t-shirts": {
                   "doc_count": 1,
                   "sales": {
                       "value": 200.0
                   }
               },
               "t-shirt-percentage": {
                   "value": 36.36363636363637
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "total_sales": {
                   "value": 60.0
               },
               "t-shirts": {
                   "doc_count": 1,
                   "sales": {
                       "value": 10.0
                   }
               },
               "t-shirt-percentage": {
                   "value": 16.666666666666664
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "total_sales": {
                   "value": 375.0
               },
               "t-shirts": {
                   "doc_count": 1,
                   "sales": {
                       "value": 175.0
                   }
               },
               "t-shirt-percentage": {
                   "value": 46.666666666666664
               }
            }
         ]
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-bucket-selector-aggregation"></a>Bucket selector aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-selector-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A parent pipeline aggregation which executes a script which determines whether the current bucket will be retained
in the parent multi-bucket aggregation. The specified metric must be numeric and the script must return a boolean value.
If the script language is <code class="literal">expression</code> then a numeric return value is permitted. In this case 0.0 will be evaluated as <code class="literal">false</code>
and all other values will evaluate to true.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The bucket_selector aggregation, like all pipeline aggregations, executes after all other sibling aggregations. This means that
using the bucket_selector aggregation to filter the returned buckets in the response does not save on execution time running the aggregations.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_5"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-selector-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">bucket_selector</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "bucket_selector": {
    "buckets_path": {
      "my_var1": "the_sum",                     <a id="CO310-1"></a><i class="conum" data-value="1"></i>
      "my_var2": "the_value_count"
    },
    "script": "params.my_var1 &gt; params.my_var2"
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO310-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Here, <code class="literal">my_var1</code> is the name of the variable for this buckets path to use in the script, <code class="literal">the_sum</code> is the path to
the metrics to use for that variable.</p>
</td>
</tr>
</table>
</div>
<div class="table">
<a id="bucket-selector-params"></a>
<p class="title"><strong>Table 46. <code class="literal">bucket_selector</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="bucket_selector Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">script</code></p></td>
<td align="left" valign="top"><p>The script to run for this aggregation. The script can be inline, file or indexed. (see <a class="xref" href="modules-scripting.html" title="Scripting">Scripting</a>
for more details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>A map of script variables and their associated path to the buckets we wish to use for the variable
(see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet only retains buckets where the total sales for the month is more than 200:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_bucket_filter": {
          "bucket_selector": {
            "buckets_path": {
              "totalSales": "total_sales"
            },
            "script": "params.totalSales &gt; 200"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1207.console"></div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "total_sales": {
                   "value": 550.0
               }
            },<a id="CO311-1"></a><i class="conum" data-value="1"></i>
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "total_sales": {
                   "value": 375.0
               },
            }
         ]
      }
   }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO311-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Bucket for <code class="literal">2015/02/01 00:00:00</code> has been removed as its total sales was less than 200</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-bucket-sort-aggregation"></a>Bucket sort aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-sort-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A parent pipeline aggregation which sorts the buckets of its parent multi-bucket aggregation.
Zero or more sort fields may be specified together with the corresponding sort order.
Each bucket may be sorted based on its <code class="literal">_key</code>, <code class="literal">_count</code> or its sub-aggregations.
In addition, parameters <code class="literal">from</code> and <code class="literal">size</code> may be set in order to truncate the result buckets.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">bucket_sort</code> aggregation, like all pipeline aggregations, is executed after all other non-pipeline aggregations.
This means the sorting only applies to whatever buckets are already returned from the parent aggregation. For example,
if the parent aggregation is <code class="literal">terms</code> and its <code class="literal">size</code> is set to <code class="literal">10</code>, the <code class="literal">bucket_sort</code> will only sort over those 10
returned term buckets.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_6"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-sort-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">bucket_sort</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "bucket_sort": {
    "sort": [
      { "sort_field_1": { "order": "asc" } },   <a id="CO312-1"></a><i class="conum" data-value="1"></i>
      { "sort_field_2": { "order": "desc" } },
      "sort_field_3"
    ],
    "from": 1,
    "size": 3
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO312-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Here, <code class="literal">sort_field_1</code> is the bucket path to the variable to be used as the primary sort and its order
is ascending.</p>
</td>
</tr>
</table>
</div>
<div class="table">
<a id="bucket-sort-params"></a>
<p class="title"><strong>Table 47. <code class="literal">bucket_sort</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="bucket_sort Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">sort</code></p></td>
<td align="left" valign="top"><p>The list of fields to sort on. See <a class="xref" href="sort-search-results.html" title="Sort search results"><code class="literal">sort</code></a> for more details.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">from</code></p></td>
<td align="left" valign="top"><p>Buckets in positions prior to the set value will be truncated.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">0</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">size</code></p></td>
<td align="left" valign="top"><p>The number of buckets to return. Defaults to all buckets of the parent aggregation.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet returns the buckets corresponding to the 3 months with the highest total sales in descending order:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_bucket_sort": {
          "bucket_sort": {
            "sort": [
              { "total_sales": { "order": "desc" } } <a id="CO313-1"></a><i class="conum" data-value="1"></i>
            ],
            "size": 3                                <a id="CO313-2"></a><i class="conum" data-value="2"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1208.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO313-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">sort</code> is set to use the values of <code class="literal">total_sales</code> in descending order</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO313-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">size</code> is set to <code class="literal">3</code> meaning only the top 3 months in <code class="literal">total_sales</code> will be returned</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 82,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "total_sales": {
                   "value": 550.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "total_sales": {
                   "value": 375.0
               },
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "total_sales": {
                   "value": 60.0
               },
            }
         ]
      }
   }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_truncating_without_sorting"></a>Truncating without sorting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/bucket-sort-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>It is also possible to use this aggregation in order to truncate the result buckets
without doing any sorting. To do so, just use the <code class="literal">from</code> and/or <code class="literal">size</code> parameters
without specifying <code class="literal">sort</code>.</p>
<p>The following example simply truncates the result so that only the second bucket is returned:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "bucket_truncate": {
          "bucket_sort": {
            "from": 1,
            "size": 1
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1209.console"></div>
<p>Response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2
            }
         ]
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-cumulative-cardinality-aggregation"></a>Cumulative cardinality aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/cumulative-cardinality-aggregation.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<p>A parent pipeline aggregation which calculates the Cumulative Cardinality in a parent histogram (or date_histogram)
aggregation. The specified metric must be a cardinality aggregation and the enclosing histogram
must have <code class="literal">min_doc_count</code> set to <code class="literal">0</code> (default for <code class="literal">histogram</code> aggregations).</p>
<p>The <code class="literal">cumulative_cardinality</code> agg is useful for finding "total new items", like the number of new visitors to your
website each day.  A regular cardinality aggregation will tell you how many unique visitors came each day, but doesn&#8217;t
differentiate between "new" or "repeat" visitors.  The Cumulative Cardinality aggregation can be used to determine
how many of each day&#8217;s unique visitors are "new".</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_7"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/cumulative-cardinality-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">cumulative_cardinality</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "cumulative_cardinality": {
    "buckets_path": "my_cardinality_agg"
  }
}</pre>
</div>
<div class="table">
<a id="cumulative-cardinality-params"></a>
<p class="title"><strong>Table 48. <code class="literal">cumulative_cardinality</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="cumulative_cardinality Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the cardinality aggregation we wish to find the cumulative cardinality for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the cumulative cardinality of the total daily <code class="literal">users</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /user_hits/_search
{
  "size": 0,
  "aggs": {
    "users_per_day": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "distinct_users": {
          "cardinality": {
            "field": "user_id"
          }
        },
        "total_new_users": {
          "cumulative_cardinality": {
            "buckets_path": "distinct_users" <a id="CO314-1"></a><i class="conum" data-value="1"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1210.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO314-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this aggregation to use the output of the <code class="literal">distinct_users</code> aggregation for the cumulative cardinality</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "users_per_day": {
         "buckets": [
            {
               "key_as_string": "2019-01-01T00:00:00.000Z",
               "key": 1546300800000,
               "doc_count": 2,
               "distinct_users": {
                  "value": 2
               },
               "total_new_users": {
                  "value": 2
               }
            },
            {
               "key_as_string": "2019-01-02T00:00:00.000Z",
               "key": 1546387200000,
               "doc_count": 2,
               "distinct_users": {
                  "value": 2
               },
               "total_new_users": {
                  "value": 3
               }
            },
            {
               "key_as_string": "2019-01-03T00:00:00.000Z",
               "key": 1546473600000,
               "doc_count": 3,
               "distinct_users": {
                  "value": 3
               },
               "total_new_users": {
                  "value": 4
               }
            }
         ]
      }
   }
}</pre>
</div>
<p>Note how the second day, <code class="literal">2019-01-02</code>, has two distinct users but the <code class="literal">total_new_users</code> metric generated by the
cumulative pipeline agg only increments to three.  This means that only one of the two users that day were
new, the other had already been seen in the previous day.  This happens again on the third day, where only
one of three users is completely new.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_incremental_cumulative_cardinality"></a>Incremental cumulative cardinality<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/cumulative-cardinality-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">cumulative_cardinality</code> agg will show you the total, distinct count since the beginning of the time period
being queried.  Sometimes, however, it is useful to see the "incremental" count.  Meaning, how many new users
are added each day, rather than the total cumulative count.</p>
<p>This can be accomplished by adding a <code class="literal">derivative</code> aggregation to our query:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /user_hits/_search
{
  "size": 0,
  "aggs": {
    "users_per_day": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "distinct_users": {
          "cardinality": {
            "field": "user_id"
          }
        },
        "total_new_users": {
          "cumulative_cardinality": {
            "buckets_path": "distinct_users"
          }
        },
        "incremental_new_users": {
          "derivative": {
            "buckets_path": "total_new_users"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1211.console"></div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "users_per_day": {
         "buckets": [
            {
               "key_as_string": "2019-01-01T00:00:00.000Z",
               "key": 1546300800000,
               "doc_count": 2,
               "distinct_users": {
                  "value": 2
               },
               "total_new_users": {
                  "value": 2
               }
            },
            {
               "key_as_string": "2019-01-02T00:00:00.000Z",
               "key": 1546387200000,
               "doc_count": 2,
               "distinct_users": {
                  "value": 2
               },
               "total_new_users": {
                  "value": 3
               },
               "incremental_new_users": {
                  "value": 1.0
               }
            },
            {
               "key_as_string": "2019-01-03T00:00:00.000Z",
               "key": 1546473600000,
               "doc_count": 3,
               "distinct_users": {
                  "value": 3
               },
               "total_new_users": {
                  "value": 4
               },
               "incremental_new_users": {
                  "value": 1.0
               }
            }
         ]
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-cumulative-sum-aggregation"></a>Cumulative sum aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/cumulative-sum-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A parent pipeline aggregation which calculates the cumulative sum of a specified metric in a parent histogram (or date_histogram)
aggregation. The specified metric must be numeric and the enclosing histogram must have <code class="literal">min_doc_count</code> set to <code class="literal">0</code> (default
for <code class="literal">histogram</code> aggregations).</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_8"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/cumulative-sum-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">cumulative_sum</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "cumulative_sum": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="cumulative-sum-params"></a>
<p class="title"><strong>Table 49. <code class="literal">cumulative_sum</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="cumulative_sum Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the cumulative sum for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the cumulative sum of the total monthly <code class="literal">sales</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "cumulative_sales": {
          "cumulative_sum": {
            "buckets_path": "sales" <a id="CO315-1"></a><i class="conum" data-value="1"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1212.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO315-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this cumulative sum aggregation to use the output of the <code class="literal">sales</code> aggregation for the cumulative sum</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               },
               "cumulative_sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "cumulative_sales": {
                  "value": 610.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "cumulative_sales": {
                  "value": 985.0
               }
            }
         ]
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-derivative-aggregation"></a>Derivative aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A parent pipeline aggregation which calculates the derivative of a specified metric in a parent histogram (or date_histogram)
aggregation. The specified metric must be numeric and the enclosing histogram must have <code class="literal">min_doc_count</code> set to <code class="literal">0</code> (default
for <code class="literal">histogram</code> aggregations).</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_9"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">derivative</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"derivative": {
  "buckets_path": "the_sum"
}</pre>
</div>
<div class="table">
<a id="derivative-params"></a>
<p class="title"><strong>Table 50. <code class="literal">derivative</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="derivative Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the derivative for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_first_order_derivative"></a>First Order Derivative<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The following snippet calculates the derivative of the total monthly <code class="literal">sales</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_deriv": {
          "derivative": {
            "buckets_path": "sales" <a id="CO316-1"></a><i class="conum" data-value="1"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1213.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO316-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this derivative aggregation to use the output of the <code class="literal">sales</code> aggregation for the derivative</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <a id="CO317-1"></a><i class="conum" data-value="1"></i>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0 <a id="CO317-2"></a><i class="conum" data-value="2"></i>
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2, <a id="CO317-3"></a><i class="conum" data-value="3"></i>
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0
               }
            }
         ]
      }
   }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO317-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>No derivative for the first bucket since we need at least 2 data points to calculate the derivative</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO317-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Derivative value units are implicitly defined by the <code class="literal">sales</code> aggregation and the parent histogram so in this case the units
would be $/month assuming the <code class="literal">price</code> field has units of $.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO317-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The number of documents in the bucket are represented by the <code class="literal">doc_count</code></p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_second_order_derivative"></a>Second Order Derivative<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A second order derivative can be calculated by chaining the derivative pipeline aggregation onto the result of another derivative
pipeline aggregation as in the following example which will calculate both the first and the second order derivative of the total
monthly sales:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_deriv": {
          "derivative": {
            "buckets_path": "sales"
          }
        },
        "sales_2nd_deriv": {
          "derivative": {
            "buckets_path": "sales_deriv" <a id="CO318-1"></a><i class="conum" data-value="1"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1214.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO318-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> for the second derivative points to the name of the first derivative</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 50,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <a id="CO319-1"></a><i class="conum" data-value="1"></i>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0
               } <a id="CO319-2"></a><i class="conum" data-value="1"></i>
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0
               },
               "sales_2nd_deriv": {
                  "value": 805.0
               }
            }
         ]
      }
   }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO319-1"><i class="conum" data-value="1"></i></a><a href="#CO319-2"></a></p>
</td>
<td align="left" valign="top">
<p>No second derivative for the first two buckets since we need at least 2 data points from the first derivative to calculate the
second derivative</p>
</td>
</tr>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_units"></a>Units<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The derivative aggregation allows the units of the derivative values to be specified. This returns an extra field in the response
<code class="literal">normalized_value</code> which reports the derivative value in the desired x-axis units.  In the below example we calculate the derivative
of the total sales per month but ask for the derivative of the sales as in the units of sales per day:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_deriv": {
          "derivative": {
            "buckets_path": "sales",
            "unit": "day" <a id="CO320-1"></a><i class="conum" data-value="1"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1215.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO320-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">unit</code> specifies what unit to use for the x-axis of the derivative calculation</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 50,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <a id="CO321-1"></a><i class="conum" data-value="1"></i>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0, <a id="CO321-2"></a><i class="conum" data-value="1"></i>
                  "normalized_value": -15.806451612903226 <a id="CO321-3"></a><i class="conum" data-value="2"></i>
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0,
                  "normalized_value": 11.25
               }
            }
         ]
      }
   }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO321-1"><i class="conum" data-value="1"></i></a><a href="#CO321-2"></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">value</code> is reported in the original units of <em>per month</em></p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO321-3"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">normalized_value</code> is reported in the desired units of <em>per day</em></p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-extended-stats-bucket-aggregation"></a>Extended stats bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/extended-stats-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which calculates a variety of stats across all bucket of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
<p>This aggregation provides a few more statistics (sum of squares, standard deviation, etc) compared to the <code class="literal">stats_bucket</code> aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_10"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/extended-stats-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">extended_stats_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "extended_stats_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="extended-stats-bucket-params"></a>
<p class="title"><strong>Table 51. <code class="literal">extended_stats_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="extended_stats_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to calculate stats for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sigma</code></p></td>
<td align="left" valign="top"><p>The number of standard deviations above/below the mean to display</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p>2</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the extended stats for monthly <code class="literal">sales</code> bucket:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "stats_monthly_sales": {
      "extended_stats_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO322-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1216.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO322-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">bucket_paths</code> instructs this <code class="literal">extended_stats_bucket</code> aggregation that we want the calculate stats for the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "stats_monthly_sales": {
         "count": 3,
         "min": 60.0,
         "max": 550.0,
         "avg": 328.3333333333333,
         "sum": 985.0,
         "sum_of_squares": 446725.0,
         "variance": 41105.55555555556,
         "variance_population": 41105.55555555556,
         "variance_sampling": 61658.33333333334,
         "std_deviation": 202.74505063146563,
         "std_deviation_population": 202.74505063146563,
         "std_deviation_sampling": 248.3109609609156,
         "std_deviation_bounds": {
           "upper": 733.8234345962646,
           "lower": -77.15676792959795,
           "upper_population" : 733.8234345962646,
           "lower_population" : -77.15676792959795,
           "upper_sampling" : 824.9552552551645,
           "lower_sampling" : -168.28858858849787
         }
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-inference-bucket-aggregation"></a>Inference bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/inference-bucket-aggregation.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>A parent pipeline aggregation which loads a pre-trained model and performs
inference on the collated result fields from the parent bucket aggregation.</p>
<p>To use the inference bucket aggregation, you need to have the same security
privileges that are required for using the <a class="xref" href="ml-df-analytics-apis.html#get-trained-models" title="Get trained models API">Get trained models</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="inference-bucket-agg-syntax"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/inference-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">inference</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "inference": {
    "model_id": "a_model_for_inference", <a id="CO323-1"></a><i class="conum" data-value="1"></i>
    "inference_config": { <a id="CO323-2"></a><i class="conum" data-value="2"></i>
      "regression_config": {
        "num_top_feature_importance_values": 2
      }
    },
    "buckets_path": {
      "avg_cost": "avg_agg", <a id="CO323-3"></a><i class="conum" data-value="3"></i>
      "max_cost": "max_agg"
    }
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO323-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The ID of model to use.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO323-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The optional inference config which overrides the model&#8217;s default settings</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO323-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Map the value of <code class="literal">avg_agg</code> to the model&#8217;s input field <code class="literal">avg_cost</code></p>
</td>
</tr>
</table>
</div>
<div class="table">
<a id="inference-bucket-params"></a>
<p class="title"><strong>Table 52. <code class="literal">inference</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="inference Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">model_id</code></p></td>
<td align="left" valign="top"><p>The ID of the model to load and infer against</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">inference_config</code></p></td>
<td align="left" valign="top"><p>Contains the inference type and its options. There are two types: <a class="xref" href="search-aggregations-pipeline.html#inference-agg-regression-opt" title="Configuration options for regression models"><code class="literal">regression</code></a> and <a class="xref" href="search-aggregations-pipeline.html#inference-agg-classification-opt" title="Configuration options for classification models"><code class="literal">classification</code></a></p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>Defines the paths to the input aggregations and maps the aggregation names to the field names expected by the model.
See <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p>-</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_configuration_options_for_inference_models"></a>Configuration options for inference models<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/inference-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">inference_config</code> setting is optional and usually isn&#8217;t required as the
pre-trained models come equipped with sensible defaults. In the context of
aggregations some options can be overridden for each of the two types of model.</p>
<h5><a id="inference-agg-regression-opt"></a>Configuration options for regression models<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/inference-bucket-aggregation.asciidoc">edit</a></h5>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">num_top_feature_importance_values</code>
</span>
</dt>
<dd>
(Optional, integer)
Specifies the maximum number of
<a href="https://www.elastic.co/guide/en/machine-learning/7.10/ml-feature-importance.html" class="ulink" target="_top">feature importance</a> values per document.
By default, it is zero and no feature importance calculation occurs.
</dd>
</dl>
</div>
<h5><a id="inference-agg-classification-opt"></a>Configuration options for classification models<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/inference-bucket-aggregation.asciidoc">edit</a></h5>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">num_top_classes</code>
</span>
</dt>
<dd>
(Optional, integer)
Specifies the number of top class predictions to return. Defaults to 0.
</dd>
<dt>
<span class="term">
<code class="literal">num_top_feature_importance_values</code>
</span>
</dt>
<dd>
(Optional, integer)
Specifies the maximum number of
<a href="https://www.elastic.co/guide/en/machine-learning/7.10/ml-feature-importance.html" class="ulink" target="_top">feature importance</a> values per document. By
default, it is zero and no feature importance calculation occurs.
</dd>
<dt>
<span class="term">
<code class="literal">prediction_field_type</code>
</span>
</dt>
<dd>
(Optional, string)
Specifies the type of the predicted field to write.
Acceptable values are: <code class="literal">string</code>, <code class="literal">number</code>, <code class="literal">boolean</code>. When <code class="literal">boolean</code> is provided
<code class="literal">1.0</code> is transformed to <code class="literal">true</code> and <code class="literal">0.0</code> to <code class="literal">false</code>.
</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="inference-bucket-agg-example"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/inference-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The following snippet aggregates a web log by <code class="literal">client_ip</code> and extracts a number
of features via metric and bucket sub-aggregations as input to the inference
aggregation configured with a model trained to identify suspicious client IPs:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET kibana_sample_data_logs/_search
{
  "size": 0,
  "aggs": {
    "client_ip": { <a id="CO324-1"></a><i class="conum" data-value="1"></i>
      "composite": {
        "sources": [
          {
            "client_ip": {
              "terms": {
                "field": "clientip"
              }
            }
          }
        ]
      },
      "aggs": { <a id="CO324-2"></a><i class="conum" data-value="2"></i>
        "url_dc": {
          "cardinality": {
            "field": "url.keyword"
          }
        },
        "bytes_sum": {
          "sum": {
            "field": "bytes"
          }
        },
        "geo_src_dc": {
          "cardinality": {
            "field": "geo.src"
          }
        },
        "geo_dest_dc": {
          "cardinality": {
            "field": "geo.dest"
          }
        },
        "responses_total": {
          "value_count": {
            "field": "timestamp"
          }
        },
        "success": {
          "filter": {
            "term": {
              "response": "200"
            }
          }
        },
        "error404": {
          "filter": {
            "term": {
              "response": "404"
            }
          }
        },
        "error503": {
          "filter": {
            "term": {
              "response": "503"
            }
          }
        },
        "malicious_client_ip": { <a id="CO324-3"></a><i class="conum" data-value="3"></i>
          "inference": {
            "model_id": "malicious_clients_model",
            "buckets_path": {
              "response_count": "responses_total",
              "url_dc": "url_dc",
              "bytes_sum": "bytes_sum",
              "geo_src_dc": "geo_src_dc",
              "geo_dest_dc": "geo_dest_dc",
              "success": "success._count",
              "error404": "error404._count",
              "error503": "error503._count"
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1217.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO324-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>A composite bucket aggregation that aggregates the data by <code class="literal">client_ip</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO324-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>A series of metrics and bucket sub-aggregations.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO324-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Inference bucket aggregation that contains the model ID and maps the
aggregation names to the model&#8217;s input fields.</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-max-bucket-aggregation"></a>Max bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/max-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which identifies the bucket(s) with the maximum value of a specified metric in a sibling aggregation
and outputs both the value and the key(s) of the bucket(s). The specified metric must be numeric and the sibling aggregation must
be a multi-bucket aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_11"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/max-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">max_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "max_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="max-bucket-params"></a>
<p class="title"><strong>Table 53. <code class="literal">max_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="max_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the maximum for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the maximum of the total monthly <code class="literal">sales</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "max_monthly_sales": {
      "max_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO325-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1218.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO325-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this max_bucket aggregation that we want the maximum value of the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "max_monthly_sales": {
          "keys": ["2015/01/01 00:00:00"], <a id="CO326-1"></a><i class="conum" data-value="1"></i>
          "value": 550.0
      }
   }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO326-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">keys</code> is an array of strings since the maximum value may be present in multiple buckets</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-min-bucket-aggregation"></a>Min bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/min-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which identifies the bucket(s) with the minimum value of a specified metric in a sibling aggregation
and outputs both the value and the key(s) of the bucket(s). The specified metric must be numeric and the sibling aggregation must
be a multi-bucket aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_12"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/min-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">min_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "min_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="min-bucket-params"></a>
<p class="title"><strong>Table 54. <code class="literal">min_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="min_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the minimum for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the minimum of the total monthly <code class="literal">sales</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "min_monthly_sales": {
      "min_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO327-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1219.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO327-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this min_bucket aggregation that we want the minimum value of the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "min_monthly_sales": {
          "keys": ["2015/02/01 00:00:00"], <a id="CO328-1"></a><i class="conum" data-value="1"></i>
          "value": 60.0
      }
   }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO328-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">keys</code> is an array of strings since the minimum value may be present in multiple buckets</p>
</td>
</tr>
</table>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-movavg-aggregation"></a>Moving average aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p><span class="Admonishment Admonishment--change">
[<span class="Admonishment-version u-mono u-strikethrough">6.4.0</span>]
<span class="Admonishment-detail">
Deprecated in 6.4.0. The Moving Average aggregation has been deprecated in favor of the more general <a class="xref" href="search-aggregations-pipeline.html#search-aggregations-pipeline-movfn-aggregation" title="Moving function aggregation">Moving Function Aggregation</a>.  The new Moving Function aggregation provides all the same functionality as the Moving Average aggregation, but also provides more flexibility.
</span>
</span></p>
<p>Given an ordered series of data, the Moving Average aggregation will slide a window across the data and emit the average
value of that window.  For example, given the data <code class="literal">[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code>, we can calculate a simple moving
average with windows size of <code class="literal">5</code> as follows:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
(1 + 2 + 3 + 4 + 5) / 5  = 3
</li>
<li class="listitem">
(2 + 3 + 4 + 5 + 6) / 5  = 4
</li>
<li class="listitem">
(3 + 4 + 5 + 6 + 7) / 5 = 5
</li>
<li class="listitem">
etc
</li>
</ul>
</div>
<p>Moving averages are a simple method to smooth sequential data.  Moving averages are typically applied to time-based data,
such as stock prices or server metrics.  The smoothing can be used to eliminate high frequency fluctuations or random noise,
which allows the lower frequency trends to be more easily visualized, such as seasonality.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_13"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">moving_avg</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "moving_avg": {
    "buckets_path": "the_sum",
    "model": "holt",
    "window": 5,
    "gap_policy": "insert_zeros",
    "settings": {
      "alpha": 0.8
    }
  }
}</pre>
</div>
<div class="table">
<p class="title"><strong>Table 55. <code class="literal">moving_avg</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="moving_avg Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Parameter Name</p></td>
<td align="left" valign="top"><p>Description</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p>Default Value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>Path to the metric of interest (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">model</code></p></td>
<td align="left" valign="top"><p>The moving average weighting model that we wish to use</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">simple</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data. See <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a>.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">window</code></p></td>
<td align="left" valign="top"><p>The size of window to "slide" across the histogram.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">5</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">minimize</code></p></td>
<td align="left" valign="top"><p>If the model should be algorithmically minimized.  See <a class="xref" href="search-aggregations-pipeline.html#movavg-minimizer" title="Minimization">Minimization</a> for more
 details</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">false</code> for most models</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">settings</code></p></td>
<td align="left" valign="top"><p>Model-specific settings, contents which differ depending on the model specified.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code class="literal">moving_avg</code> aggregations must be embedded inside of a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> aggregation.  They can be
embedded like any other metric aggregation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {                                <a id="CO329-1"></a><i class="conum" data-value="1"></i>
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }                 <a id="CO329-2"></a><i class="conum" data-value="2"></i>
        },
        "the_movavg": {
          "moving_avg": { "buckets_path": "the_sum" } <a id="CO329-3"></a><i class="conum" data-value="3"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1220.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO329-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO329-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">sum</code> metric is used to calculate the sum of a field.  This could be any metric (sum, min, max, etc)</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO329-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Finally, we specify a <code class="literal">moving_avg</code> aggregation which uses "the_sum" metric as its input.</p>
</td>
</tr>
</table>
</div>
<p>Moving averages are built by first specifying a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> over a field.  You can then optionally
add normal metrics, such as a <code class="literal">sum</code>, inside of that histogram.  Finally, the <code class="literal">moving_avg</code> is embedded inside the histogram.
The <code class="literal">buckets_path</code> parameter is then used to "point" at one of the sibling metrics inside of the histogram (see
<a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for a description of the syntax for <code class="literal">buckets_path</code>.</p>
<p>An example response from the above aggregation may look like:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "took": 11,
  "timed_out": false,
  "_shards": ...,
  "hits": ...,
  "aggregations": {
    "my_date_histo": {
      "buckets": [
        {
          "key_as_string": "2015/01/01 00:00:00",
          "key": 1420070400000,
          "doc_count": 3,
          "the_sum": {
            "value": 550.0
          }
        },
        {
          "key_as_string": "2015/02/01 00:00:00",
          "key": 1422748800000,
          "doc_count": 2,
          "the_sum": {
            "value": 60.0
          },
          "the_movavg": {
            "value": 550.0
          }
        },
        {
          "key_as_string": "2015/03/01 00:00:00",
          "key": 1425168000000,
          "doc_count": 2,
          "the_sum": {
            "value": 375.0
          },
          "the_movavg": {
            "value": 305.0
          }
        }
      ]
    }
  }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_models"></a>Models<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">moving_avg</code> aggregation includes four different moving average "models".  The main difference is how the values in the
window are weighted.  As data-points become "older" in the window, they may be weighted differently.  This will
affect the final average for that window.</p>
<p>Models are specified using the <code class="literal">model</code> parameter.  Some models may have optional configurations which are specified inside
the <code class="literal">settings</code> parameter.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_simple"></a>Simple<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">simple</code> model calculates the sum of all values in the window, then divides by the size of the window.  It is effectively
a simple arithmetic mean of the window.  The simple model does not perform any time-dependent weighting, which means
the values from a <code class="literal">simple</code> moving average tend to "lag" behind the real data.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "simple"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1221.console"></div>
<p>A <code class="literal">simple</code> model has no special settings to configure</p>
<p>The window size can change the behavior of the moving average.  For example, a small window (<code class="literal">"window": 10</code>) will closely
track the data and only smooth out small scale fluctuations:</p>
<div id="movavg_10window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/movavg_10window.png" alt="movavg 10window">
</div>
<div class="title">Figure 3. Moving average with window of size 10</div>
</div>
<p>In contrast, a <code class="literal">simple</code> moving average with larger window (<code class="literal">"window": 100</code>) will smooth out all higher-frequency fluctuations,
leaving only low-frequency, long term trends.  It also tends to "lag" behind the actual data by a substantial amount:</p>
<div id="movavg_100window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/movavg_100window.png" alt="movavg 100window">
</div>
<div class="title">Figure 4. Moving average with window of size 100</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_linear"></a>Linear<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">linear</code> model assigns a linear weighting to points in the series, such that "older" datapoints (e.g. those at
the beginning of the window) contribute a linearly less amount to the total average.  The linear weighting helps reduce
the "lag" behind the data&#8217;s mean, since older points have less influence.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "linear"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1222.console"></div>
<p>A <code class="literal">linear</code> model has no special settings to configure</p>
<p>Like the <code class="literal">simple</code> model, window size can change the behavior of the moving average.  For example, a small window (<code class="literal">"window": 10</code>)
will closely track the data and only smooth out small scale fluctuations:</p>
<div id="linear_10window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/linear_10window.png" alt="linear 10window">
</div>
<div class="title">Figure 5. Linear moving average with window of size 10</div>
</div>
<p>In contrast, a <code class="literal">linear</code> moving average with larger window (<code class="literal">"window": 100</code>) will smooth out all higher-frequency fluctuations,
leaving only low-frequency, long term trends.  It also tends to "lag" behind the actual data by a substantial amount,
although typically less than the <code class="literal">simple</code> model:</p>
<div id="linear_100window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/linear_100window.png" alt="linear 100window">
</div>
<div class="title">Figure 6. Linear moving average with window of size 100</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_ewma_exponentially_weighted"></a>EWMA (Exponentially Weighted)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">ewma</code> model (aka "single-exponential") is similar to the <code class="literal">linear</code> model, except older data-points become exponentially less important,
rather than linearly less important.  The speed at which the importance decays can be controlled with an <code class="literal">alpha</code>
setting.  Small values make the weight decay slowly, which provides greater smoothing and takes into account a larger
portion of the window.  Larger values make the weight decay quickly, which reduces the impact of older values on the
moving average.  This tends to make the moving average track the data more closely but with less smoothing.</p>
<p>The default value of <code class="literal">alpha</code> is <code class="literal">0.3</code>, and the setting accepts any float from 0-1 inclusive.</p>
<p>The EWMA model can be <a class="xref" href="search-aggregations-pipeline.html#movavg-minimizer" title="Minimization">Minimized</a></p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "ewma",
            "settings": {
              "alpha": 0.5
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1223.console"></div>
<div id="single_0.2alpha" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/single_0.2alpha.png" alt="single 0.2alpha">
</div>
<div class="title">Figure 7. EWMA with window of size 10, alpha = 0.2</div>
</div>
<div id="single_0.7alpha" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/single_0.7alpha.png" alt="single 0.7alpha">
</div>
<div class="title">Figure 8. EWMA with window of size 10, alpha = 0.7</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_holt_linear"></a>Holt-Linear<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">holt</code> model (aka "double exponential") incorporates a second exponential term which
tracks the data&#8217;s trend.  Single exponential does not perform well when the data has an underlying linear trend.  The
double exponential model calculates two values internally: a "level" and a "trend".</p>
<p>The level calculation is similar to <code class="literal">ewma</code>, and is an exponentially weighted view of the data.  The difference is
that the previously smoothed value is used instead of the raw value, which allows it to stay close to the original series.
The trend calculation looks at the difference between the current and last value (e.g. the slope, or trend, of the
smoothed data).  The trend value is also exponentially weighted.</p>
<p>Values are produced by multiplying the level and trend components.</p>
<p>The default value of <code class="literal">alpha</code> is <code class="literal">0.3</code> and <code class="literal">beta</code> is <code class="literal">0.1</code>. The settings accept any float from 0-1 inclusive.</p>
<p>The Holt-Linear model can be <a class="xref" href="search-aggregations-pipeline.html#movavg-minimizer" title="Minimization">Minimized</a></p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "holt",
            "settings": {
              "alpha": 0.5,
              "beta": 0.5
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1224.console"></div>
<p>In practice, the <code class="literal">alpha</code> value behaves very similarly in <code class="literal">holt</code> as <code class="literal">ewma</code>: small values produce more smoothing
and more lag, while larger values produce closer tracking and less lag.  The value of <code class="literal">beta</code> is often difficult
to see.  Small values emphasize long-term trends (such as a constant linear trend in the whole series), while larger
values emphasize short-term trends.  This will become more apparently when you are predicting values.</p>
<div id="double_0.2beta" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_0.2beta.png" alt="double 0.2beta">
</div>
<div class="title">Figure 9. Holt-Linear moving average with window of size 100, alpha = 0.5, beta = 0.2</div>
</div>
<div id="double_0.7beta" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_0.7beta.png" alt="double 0.7beta">
</div>
<div class="title">Figure 10. Holt-Linear moving average with window of size 100, alpha = 0.5, beta = 0.7</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_holt_winters"></a>Holt-Winters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">holt_winters</code> model (aka "triple exponential") incorporates a third exponential term which
tracks the seasonal aspect of your data.  This aggregation therefore smooths based on three components: "level", "trend"
and "seasonality".</p>
<p>The level and trend calculation is identical to <code class="literal">holt</code> The seasonal calculation looks at the difference between
the current point, and the point one period earlier.</p>
<p>Holt-Winters requires a little more handholding than the other moving averages.  You need to specify the "periodicity"
of your data: e.g. if your data has cyclic trends every 7 days, you would set <code class="literal">period: 7</code>.  Similarly if there was
a monthly trend, you would set it to <code class="literal">30</code>.  There is currently no periodicity detection, although that is planned
for future enhancements.</p>
<p>There are two varieties of Holt-Winters: additive and multiplicative.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_cold_start"></a>"Cold Start"<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>Unfortunately, due to the nature of Holt-Winters, it requires two periods of data to "bootstrap" the algorithm.  This
means that your <code class="literal">window</code> must always be <span class="strong strong"><strong>at least</strong></span> twice the size of your period.  An exception will be thrown if it
isn&#8217;t.  It also means that Holt-Winters will not emit a value for the first <code class="literal">2 * period</code> buckets; the current algorithm
does not backcast.</p>
<div id="holt_winters_cold_start" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/triple_untruncated.png" alt="triple untruncated">
</div>
<div class="title">Figure 11. Holt-Winters showing a "cold" start where no values are emitted</div>
</div>
<p>Because the "cold start" obscures what the moving average looks like, the rest of the Holt-Winters images are truncated
to not show the "cold start".  Just be aware this will always be present at the beginning of your moving averages!</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_additive_holt_winters"></a>Additive Holt-Winters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>Additive seasonality is the default; it can also be specified by setting <code class="literal">"type": "add"</code>.  This variety is preferred
when the seasonal affect is additive to your data. E.g. you could simply subtract the seasonal effect to "de-seasonalize"
your data into a flat trend.</p>
<p>The default values of <code class="literal">alpha</code> and <code class="literal">gamma</code> are <code class="literal">0.3</code> while <code class="literal">beta</code> is <code class="literal">0.1</code>.  The settings accept any float from 0-1 inclusive.
The default value of <code class="literal">period</code> is <code class="literal">1</code>.</p>
<p>The additive Holt-Winters model can be <a class="xref" href="search-aggregations-pipeline.html#movavg-minimizer" title="Minimization">Minimized</a></p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "holt_winters",
            "settings": {
              "type": "add",
              "alpha": 0.5,
              "beta": 0.5,
              "gamma": 0.5,
              "period": 7
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1225.console"></div>
<div id="holt_winters_add" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/triple.png" alt="triple">
</div>
<div class="title">Figure 12. Holt-Winters moving average with window of size 120, alpha = 0.5, beta = 0.7, gamma = 0.3, period = 30</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_multiplicative_holt_winters"></a>Multiplicative Holt-Winters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>Multiplicative is specified by setting <code class="literal">"type": "mult"</code>.  This variety is preferred when the seasonal affect is
multiplied against your data. E.g. if the seasonal affect is x5 the data, rather than simply adding to it.</p>
<p>The default values of <code class="literal">alpha</code> and <code class="literal">gamma</code> are <code class="literal">0.3</code> while <code class="literal">beta</code> is <code class="literal">0.1</code>.  The settings accept any float from 0-1 inclusive.
The default value of <code class="literal">period</code> is <code class="literal">1</code>.</p>
<p>The multiplicative Holt-Winters model can be <a class="xref" href="search-aggregations-pipeline.html#movavg-minimizer" title="Minimization">Minimized</a></p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Multiplicative Holt-Winters works by dividing each data point by the seasonal value.  This is problematic if any of
your data is zero, or if there are gaps in the data (since this results in a divid-by-zero).  To combat this, the
<code class="literal">mult</code> Holt-Winters pads all values by a very small amount (1*10<sup>-10</sup>) so that all values are non-zero.  This affects
the result, but only minimally.  If your data is non-zero, or you prefer to see <code class="literal">NaN</code> when zero&#8217;s are encountered,
you can disable this behavior with <code class="literal">pad: false</code></p>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "holt_winters",
            "settings": {
              "type": "mult",
              "alpha": 0.5,
              "beta": 0.5,
              "gamma": 0.5,
              "period": 7,
              "pad": true
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1226.console"></div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_prediction"></a>Prediction<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>All the moving average model support a "prediction" mode, which will attempt to extrapolate into the future given the
current smoothed, moving average.  Depending on the model and parameter, these predictions may or may not be accurate.</p>
<p>Predictions are enabled by adding a <code class="literal">predict</code> parameter to any moving average aggregation, specifying the number of
predictions you would like appended to the end of the series.  These predictions will be spaced out at the same interval
as your buckets:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "simple",
            "predict": 10
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1227.console"></div>
<p>The <code class="literal">simple</code>, <code class="literal">linear</code> and <code class="literal">ewma</code> models all produce "flat" predictions: they essentially converge on the mean
of the last value in the series, producing a flat:</p>
<div id="simple_prediction" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/simple_prediction.png" alt="simple prediction">
</div>
<div class="title">Figure 13. Simple moving average with window of size 10, predict = 50</div>
</div>
<p>In contrast, the <code class="literal">holt</code> model can extrapolate based on local or global constant trends.  If we set a high <code class="literal">beta</code>
value, we can extrapolate based on local constant trends (in this case the predictions head down, because the data at the end
of the series was heading in a downward direction):</p>
<div id="double_prediction_local" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_prediction_local.png" alt="double prediction local">
</div>
<div class="title">Figure 14. Holt-Linear moving average with window of size 100, predict = 20, alpha = 0.5, beta = 0.8</div>
</div>
<p>In contrast, if we choose a small <code class="literal">beta</code>, the predictions are based on the global constant trend.  In this series, the
global trend is slightly positive, so the prediction makes a sharp u-turn and begins a positive slope:</p>
<div id="double_prediction_global" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_prediction_global.png" alt="double prediction global">
</div>
<div class="title">Figure 15. Double Exponential moving average with window of size 100, predict = 20, alpha = 0.5, beta = 0.1</div>
</div>
<p>The <code class="literal">holt_winters</code> model has the potential to deliver the best predictions, since it also incorporates seasonal
fluctuations into the model:</p>
<div id="holt_winters_prediction_global" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/triple_prediction.png" alt="triple prediction">
</div>
<div class="title">Figure 16. Holt-Winters moving average with window of size 120, predict = 25, alpha = 0.8, beta = 0.2, gamma = 0.7, period = 30</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="movavg-minimizer"></a>Minimization<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movavg-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>Some of the models (EWMA, Holt-Linear, Holt-Winters) require one or more parameters to be configured.  Parameter choice
can be tricky and sometimes non-intuitive.  Furthermore, small deviations in these parameters can sometimes have a drastic
effect on the output moving average.</p>
<p>For that reason, the three "tunable" models can be algorithmically <span class="strong strong"><strong>minimized</strong></span>.  Minimization is a process where parameters
are tweaked until the predictions generated by the model closely match the output data.  Minimization is not fullproof
and can be susceptible to overfitting, but it often gives better results than hand-tuning.</p>
<p>Minimization is disabled by default for <code class="literal">ewma</code> and <code class="literal">holt_linear</code>, while it is enabled by default for <code class="literal">holt_winters</code>.
Minimization is most useful with Holt-Winters, since it helps improve the accuracy of the predictions.  EWMA and
Holt-Linear are not great predictors, and mostly used for smoothing data, so minimization is less useful on those
models.</p>
<p>Minimization is enabled/disabled via the <code class="literal">minimize</code> parameter:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "model": "holt_winters",
            "window": 30,
            "minimize": true,  <a id="CO330-1"></a><i class="conum" data-value="1"></i>
            "settings": {
              "period": 7
            }
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1228.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO330-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Minimization is enabled with the <code class="literal">minimize</code> parameter</p>
</td>
</tr>
</table>
</div>
<p>When enabled, minimization will find the optimal values for <code class="literal">alpha</code>, <code class="literal">beta</code> and <code class="literal">gamma</code>.  The user should still provide
appropriate values for <code class="literal">window</code>, <code class="literal">period</code> and <code class="literal">type</code>.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Minimization works by running a stochastic process called <span class="strong strong"><strong>simulated annealing</strong></span>.  This process will usually generate
a good solution, but is not guaranteed to find the global optimum.  It also requires some amount of additional
computational power, since the model needs to be re-run multiple times as the values are tweaked.  The run-time of
minimization is linear to the size of the window being processed: excessively large windows may cause latency.</p>
<p>Finally, minimization fits the model to the last <code class="literal">n</code> values, where <code class="literal">n = window</code>.  This generally produces
better forecasts into the future, since the parameters are tuned around the end of the series.  It can, however, generate
poorer fitting moving averages at the beginning of the series.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-movfn-aggregation"></a>Moving function aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>Given an ordered series of data, the Moving Function aggregation will slide a window across the data and allow the user to specify a custom
script that is executed on each window of data.  For convenience, a number of common functions are predefined such as min/max, moving averages,
etc.</p>
<p>This is conceptually very similar to the <a class="xref" href="search-aggregations-pipeline.html#search-aggregations-pipeline-movavg-aggregation" title="Moving average aggregation">Moving Average</a> pipeline aggregation, except
it provides more functionality.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_14"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">moving_fn</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "moving_fn": {
    "buckets_path": "the_sum",
    "window": 10,
    "script": "MovingFunctions.min(values)"
  }
}</pre>
</div>
<div class="table">
<a id="moving-fn-params"></a>
<p class="title"><strong>Table 56. <code class="literal">moving_fn</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="moving_fn Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>Path to the metric of interest (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">window</code></p></td>
<td align="left" valign="top"><p>The size of window to "slide" across the histogram.</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">script</code></p></td>
<td align="left" valign="top"><p>The script that should be executed on each window of data</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data. See <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a>.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">shift</code></p></td>
<td align="left" valign="top"><p><a class="xref" href="search-aggregations-pipeline.html#shift-parameter" title="shift parameter">Shift</a> of window position.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p>0</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code class="literal">moving_fn</code> aggregations must be embedded inside of a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> aggregation.  They can be
embedded like any other metric aggregation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {                  <a id="CO331-1"></a><i class="conum" data-value="1"></i>
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }   <a id="CO331-2"></a><i class="conum" data-value="2"></i>
        },
        "the_movfn": {
          "moving_fn": {
            "buckets_path": "the_sum",  <a id="CO331-3"></a><i class="conum" data-value="3"></i>
            "window": 10,
            "script": "MovingFunctions.unweightedAvg(values)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1229.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO331-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO331-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">sum</code> metric is used to calculate the sum of a field.  This could be any numeric metric (sum, min, max, etc)</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO331-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Finally, we specify a <code class="literal">moving_fn</code> aggregation which uses "the_sum" metric as its input.</p>
</td>
</tr>
</table>
</div>
<p>Moving averages are built by first specifying a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> over a field.  You can then optionally
add numeric metrics, such as a <code class="literal">sum</code>, inside of that histogram.  Finally, the <code class="literal">moving_fn</code> is embedded inside the histogram.
The <code class="literal">buckets_path</code> parameter is then used to "point" at one of the sibling metrics inside of the histogram (see
<a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for a description of the syntax for <code class="literal">buckets_path</code>.</p>
<p>An example response from the above aggregation may look like:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "my_date_histo": {
         "buckets": [
             {
                 "key_as_string": "2015/01/01 00:00:00",
                 "key": 1420070400000,
                 "doc_count": 3,
                 "the_sum": {
                    "value": 550.0
                 },
                 "the_movfn": {
                    "value": null
                 }
             },
             {
                 "key_as_string": "2015/02/01 00:00:00",
                 "key": 1422748800000,
                 "doc_count": 2,
                 "the_sum": {
                    "value": 60.0
                 },
                 "the_movfn": {
                    "value": 550.0
                 }
             },
             {
                 "key_as_string": "2015/03/01 00:00:00",
                 "key": 1425168000000,
                 "doc_count": 2,
                 "the_sum": {
                    "value": 375.0
                 },
                 "the_movfn": {
                    "value": 305.0
                 }
             }
         ]
      }
   }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_custom_user_scripting"></a>Custom user scripting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The Moving Function aggregation allows the user to specify any arbitrary script to define custom logic.  The script is invoked each time a
new window of data is collected.  These values are provided to the script in the <code class="literal">values</code> variable.  The script should then perform some
kind of calculation and emit a single <code class="literal">double</code> as the result.  Emitting <code class="literal">null</code> is not permitted, although <code class="literal">NaN</code> and +/- <code class="literal">Inf</code> are allowed.</p>
<p>For example, this script will simply return the first value from the window, or <code class="literal">NaN</code> if no values are available:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "return values.length &gt; 0 ? values[0] : Double.NaN"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1230.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="shift-parameter"></a>shift parameter<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>By default (with <code class="literal">shift = 0</code>), the window that is offered for calculation is the last <code class="literal">n</code> values excluding the current bucket.
Increasing <code class="literal">shift</code> by 1 moves starting window position by <code class="literal">1</code> to the right.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
To include current bucket to the window, use <code class="literal">shift = 1</code>.
</li>
<li class="listitem">
For center alignment (<code class="literal">n / 2</code> values before and after the current bucket), use <code class="literal">shift = window / 2</code>.
</li>
<li class="listitem">
For right alignment (<code class="literal">n</code> values after the current bucket), use <code class="literal">shift = window</code>.
</li>
</ul>
</div>
<p>If either of window edges moves outside the borders of data series, the window shrinks to include available values only.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_pre_built_functions"></a>Pre-built Functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>For convenience, a number of functions have been prebuilt and are available inside the <code class="literal">moving_fn</code> script context:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">max()</code>
</li>
<li class="listitem">
<code class="literal">min()</code>
</li>
<li class="listitem">
<code class="literal">sum()</code>
</li>
<li class="listitem">
<code class="literal">stdDev()</code>
</li>
<li class="listitem">
<code class="literal">unweightedAvg()</code>
</li>
<li class="listitem">
<code class="literal">linearWeightedAvg()</code>
</li>
<li class="listitem">
<code class="literal">ewma()</code>
</li>
<li class="listitem">
<code class="literal">holt()</code>
</li>
<li class="listitem">
<code class="literal">holtWinters()</code>
</li>
</ul>
</div>
<p>The functions are available from the <code class="literal">MovingFunctions</code> namespace.  E.g. <code class="literal">MovingFunctions.max()</code></p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_max_function"></a>max Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>This function accepts a collection of doubles and returns the maximum value in that window. <code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the maximum
is only calculated over the real values. If the window is empty, or all values are <code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.</p>
<div class="table">
<a id="max-params"></a>
<p class="title"><strong>Table 57. <code class="literal">max(double[] values)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="max(double[] values) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the maximum</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_max": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.max(values)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1231.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_min_function"></a>min Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>This function accepts a collection of doubles and returns the minimum value in that window.  <code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the minimum
is only calculated over the real values. If the window is empty, or all values are <code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.</p>
<div class="table">
<a id="min-params"></a>
<p class="title"><strong>Table 58. <code class="literal">min(double[] values)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="min(double[] values) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the minimum</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_min": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.min(values)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1232.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_sum_function"></a>sum Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>This function accepts a collection of doubles and returns the sum of the values in that window.  <code class="literal">null</code> and <code class="literal">NaN</code> values are ignored;
the sum is only calculated over the real values.  If the window is empty, or all values are <code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">0.0</code> is returned as the result.</p>
<div class="table">
<a id="sum-params"></a>
<p class="title"><strong>Table 59. <code class="literal">sum(double[] values)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="sum(double[] values) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the sum of</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_sum": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.sum(values)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1233.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_stddev_function"></a>stdDev Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>This function accepts a collection of doubles and average, then returns the standard deviation of the values in that window.
<code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the sum is only calculated over the real values.  If the window is empty, or all values are
<code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">0.0</code> is returned as the result.</p>
<div class="table">
<a id="stddev-params"></a>
<p class="title"><strong>Table 60. <code class="literal">stdDev(double[] values)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="stdDev(double[] values) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the standard deviation of</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">avg</code></p></td>
<td align="left" valign="top"><p>The average of the window</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_sum": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.stdDev(values, MovingFunctions.unweightedAvg(values))"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1234.console"></div>
<p>The <code class="literal">avg</code> parameter must be provided to the standard deviation function because different styles of averages can be computed on the window
(simple, linearly weighted, etc).  The various moving averages that are detailed below can be used to calculate the average for the
standard deviation function.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_unweightedavg_function"></a>unweightedAvg Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>The <code class="literal">unweightedAvg</code> function calculates the sum of all values in the window, then divides by the size of the window.  It is effectively
a simple arithmetic mean of the window.  The simple moving average does not perform any time-dependent weighting, which means
the values from a <code class="literal">simple</code> moving average tend to "lag" behind the real data.</p>
<p><code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code class="literal">null</code>,non-<code class="literal">NaN</code>
values.</p>
<div class="table">
<a id="unweightedavg-params"></a>
<p class="title"><strong>Table 61. <code class="literal">unweightedAvg(double[] values)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="unweightedAvg(double[] values) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the sum of</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.unweightedAvg(values)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1235.console"></div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_linearweightedavg_function"></a>linearWeightedAvg Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">linearWeightedAvg</code> function assigns a linear weighting to points in the series, such that "older" datapoints (e.g. those at
the beginning of the window) contribute a linearly less amount to the total average.  The linear weighting helps reduce
the "lag" behind the data&#8217;s mean, since older points have less influence.</p>
<p>If the window is empty, or all values are <code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.</p>
<div class="table">
<a id="linearweightedavg-params"></a>
<p class="title"><strong>Table 62. <code class="literal">linearWeightedAvg(double[] values)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="linearWeightedAvg(double[] values) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the sum of</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.linearWeightedAvg(values)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1236.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_ewma_function"></a>ewma Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">ewma</code> function (aka "single-exponential") is similar to the <code class="literal">linearMovAvg</code> function,
except older data-points become exponentially less important,
rather than linearly less important.  The speed at which the importance decays can be controlled with an <code class="literal">alpha</code>
setting.  Small values make the weight decay slowly, which provides greater smoothing and takes into account a larger
portion of the window.  Larger values make the weight decay quickly, which reduces the impact of older values on the
moving average.  This tends to make the moving average track the data more closely but with less smoothing.</p>
<p><code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code class="literal">null</code>,non-<code class="literal">NaN</code>
values.</p>
<div class="table">
<a id="ewma-params"></a>
<p class="title"><strong>Table 63. <code class="literal">ewma(double[] values, double alpha)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="ewma(double[] values, double alpha) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the sum of</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">alpha</code></p></td>
<td align="left" valign="top"><p>Exponential decay</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.ewma(values, 0.3)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1237.console"></div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_holt_function"></a>holt Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">holt</code> function (aka "double exponential") incorporates a second exponential term which
tracks the data&#8217;s trend.  Single exponential does not perform well when the data has an underlying linear trend.  The
double exponential model calculates two values internally: a "level" and a "trend".</p>
<p>The level calculation is similar to <code class="literal">ewma</code>, and is an exponentially weighted view of the data.  The difference is
that the previously smoothed value is used instead of the raw value, which allows it to stay close to the original series.
The trend calculation looks at the difference between the current and last value (e.g. the slope, or trend, of the
smoothed data).  The trend value is also exponentially weighted.</p>
<p>Values are produced by multiplying the level and trend components.</p>
<p><code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code class="literal">null</code>,non-<code class="literal">NaN</code>
values.</p>
<div class="table">
<a id="holt-params"></a>
<p class="title"><strong>Table 64. <code class="literal">holt(double[] values, double alpha)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="holt(double[] values, double alpha) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the sum of</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">alpha</code></p></td>
<td align="left" valign="top"><p>Level decay value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">beta</code></p></td>
<td align="left" valign="top"><p>Trend decay value</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.holt(values, 0.3, 0.1)"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1238.console"></div>
<p>In practice, the <code class="literal">alpha</code> value behaves very similarly in <code class="literal">holtMovAvg</code> as <code class="literal">ewmaMovAvg</code>: small values produce more smoothing
and more lag, while larger values produce closer tracking and less lag.  The value of <code class="literal">beta</code> is often difficult
to see.  Small values emphasize long-term trends (such as a constant linear trend in the whole series), while larger
values emphasize short-term trends.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_holtwinters_function"></a>holtWinters Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">holtWinters</code> function (aka "triple exponential") incorporates a third exponential term which
tracks the seasonal aspect of your data.  This aggregation therefore smooths based on three components: "level", "trend"
and "seasonality".</p>
<p>The level and trend calculation is identical to <code class="literal">holt</code> The seasonal calculation looks at the difference between
the current point, and the point one period earlier.</p>
<p>Holt-Winters requires a little more handholding than the other moving averages.  You need to specify the "periodicity"
of your data: e.g. if your data has cyclic trends every 7 days, you would set <code class="literal">period = 7</code>.  Similarly if there was
a monthly trend, you would set it to <code class="literal">30</code>.  There is currently no periodicity detection, although that is planned
for future enhancements.</p>
<p><code class="literal">null</code> and <code class="literal">NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code class="literal">null</code>/<code class="literal">NaN</code>, <code class="literal">NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code class="literal">null</code>,non-<code class="literal">NaN</code>
values.</p>
<div class="table">
<a id="holtwinters-params"></a>
<p class="title"><strong>Table 65. <code class="literal">holtWinters(double[] values, double alpha)</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="holtWinters(double[] values, double alpha) Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">values</code></p></td>
<td align="left" valign="top"><p>The window of values to find the sum of</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">alpha</code></p></td>
<td align="left" valign="top"><p>Level decay value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">beta</code></p></td>
<td align="left" valign="top"><p>Trend decay value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gamma</code></p></td>
<td align="left" valign="top"><p>Seasonality decay value</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">period</code></p></td>
<td align="left" valign="top"><p>The periodicity of the data</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">multiplicative</code></p></td>
<td align="left" valign="top"><p>True if you wish to use multiplicative holt-winters, false to use additive</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "if (values.length &gt; 5*2) {MovingFunctions.holtWinters(values, 0.3, 0.1, 0.1, 5, false)}"
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1239.console"></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Multiplicative Holt-Winters works by dividing each data point by the seasonal value.  This is problematic if any of
your data is zero, or if there are gaps in the data (since this results in a divid-by-zero).  To combat this, the
<code class="literal">mult</code> Holt-Winters pads all values by a very small amount (1*10<sup>-10</sup>) so that all values are non-zero.  This affects
the result, but only minimally.  If your data is non-zero, or you prefer to see <code class="literal">NaN</code> when zero&#8217;s are encountered,
you can disable this behavior with <code class="literal">pad: false</code></p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_cold_start_2"></a>"Cold Start"<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/movfn-aggregation.asciidoc">edit</a></h4>
</div></div></div>
<p>Unfortunately, due to the nature of Holt-Winters, it requires two periods of data to "bootstrap" the algorithm.  This
means that your <code class="literal">window</code> must always be <span class="strong strong"><strong>at least</strong></span> twice the size of your period.  An exception will be thrown if it
isn&#8217;t.  It also means that Holt-Winters will not emit a value for the first <code class="literal">2 * period</code> buckets; the current algorithm
does not backcast.</p>
<p>You&#8217;ll notice in the above example we have an <code class="literal">if ()</code> statement checking the size of values.  This is checking to make sure
we have two periods worth of data (<code class="literal">5 * 2</code>, where 5 is the period specified in the <code class="literal">holtWintersMovAvg</code> function) before calling
the holt-winters function.</p>
</div>

</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-moving-percentiles-aggregation"></a>Moving percentiles aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/moving-percentiles-aggregation.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<p>Given an ordered series of <a class="xref" href="search-aggregations-metrics.html#search-aggregations-metrics-percentile-aggregation" title="Percentiles aggregation">percentiles</a>, the Moving Percentile aggregation
will slide a window across those percentiles and allow the user to compute the cumulative percentile.</p>
<p>This is conceptually very similar to the <a class="xref" href="search-aggregations-pipeline.html#search-aggregations-pipeline-movfn-aggregation" title="Moving function aggregation">Moving Function</a> pipeline aggregation,
except it works on the percentiles sketches instead of the actual buckets values.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_15"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/moving-percentiles-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">moving_percentiles</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "moving_percentiles": {
    "buckets_path": "the_percentile",
    "window": 10
  }
}</pre>
</div>
<div class="table">
<a id="moving-percentiles-params"></a>
<p class="title"><strong>Table 66. <code class="literal">moving_percentiles</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="moving_percentiles Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>Path to the percentile of interest (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">window</code></p></td>
<td align="left" valign="top"><p>The size of window to "slide" across the histogram.</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">shift</code></p></td>
<td align="left" valign="top"><p><a class="xref" href="search-aggregations-pipeline.html#shift-parameter" title="shift parameter">Shift</a> of window position.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p>0</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code class="literal">moving_percentiles</code> aggregations must be embedded inside of a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> aggregation.  They can be
embedded like any other metric aggregation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {                          <a id="CO332-1"></a><i class="conum" data-value="1"></i>
        "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_percentile": {                     <a id="CO332-2"></a><i class="conum" data-value="2"></i>
            "percentiles": {
            "field": "price",
            "percents": [ 1.0, 99.0 ]
          }
        },
        "the_movperc": {
          "moving_percentiles": {
            "buckets_path": "the_percentile",   <a id="CO332-3"></a><i class="conum" data-value="3"></i>
            "window": 10
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1240.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO332-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO332-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">percentile</code> metric is used to calculate the percentiles of a field.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO332-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Finally, we specify a <code class="literal">moving_percentiles</code> aggregation which uses "the_percentile" sketch as its input.</p>
</td>
</tr>
</table>
</div>
<p>Moving percentiles are built by first specifying a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> over a field.  You  then add
a percentile metric inside of that histogram.  Finally, the <code class="literal">moving_percentiles</code> is embedded inside the histogram.
The <code class="literal">buckets_path</code> parameter is then used to "point" at the percentiles aggregation inside of the histogram (see
<a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for a description of the syntax for <code class="literal">buckets_path</code>).</p>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "my_date_histo": {
         "buckets": [
             {
                 "key_as_string": "2015/01/01 00:00:00",
                 "key": 1420070400000,
                 "doc_count": 3,
                 "the_percentile": {
                     "values": {
                       "1.0": 150.0,
                       "99.0": 200.0
                     }
                 }
             },
             {
                 "key_as_string": "2015/02/01 00:00:00",
                 "key": 1422748800000,
                 "doc_count": 2,
                 "the_percentile": {
                     "values": {
                       "1.0": 10.0,
                       "99.0": 50.0
                     }
                 },
                 "the_movperc": {
                   "values": {
                     "1.0": 150.0,
                     "99.0": 200.0
                   }
                 }
             },
             {
                 "key_as_string": "2015/03/01 00:00:00",
                 "key": 1425168000000,
                 "doc_count": 2,
                 "the_percentile": {
                    "values": {
                      "1.0": 175.0,
                      "99.0": 200.0
                    }
                 },
                 "the_movperc": {
                    "values": {
                      "1.0": 10.0,
                      "99.0": 200.0
                    }
                 }
             }
         ]
      }
   }
}</pre>
</div>
<p>The output format of the <code class="literal">moving_percentiles</code> aggregation is inherited from the format of the referenced
<a class="xref" href="search-aggregations-metrics.html#search-aggregations-metrics-percentile-aggregation" title="Percentiles aggregation"><code class="literal">percentiles</code></a> aggregation.</p>
<p>Moving percentiles pipeline aggregations always run with <code class="literal">skip</code> gap policy.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="moving-percentiles-shift-parameter"></a>shift parameter<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/moving-percentiles-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>By default (with <code class="literal">shift = 0</code>), the window that is offered for calculation is the last <code class="literal">n</code> values excluding the current bucket.
Increasing <code class="literal">shift</code> by 1 moves starting window position by <code class="literal">1</code> to the right.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
To include current bucket to the window, use <code class="literal">shift = 1</code>.
</li>
<li class="listitem">
For center alignment (<code class="literal">n / 2</code> values before and after the current bucket), use <code class="literal">shift = window / 2</code>.
</li>
<li class="listitem">
For right alignment (<code class="literal">n</code> values after the current bucket), use <code class="literal">shift = window</code>.
</li>
</ul>
</div>
<p>If either of window edges moves outside the borders of data series, the window shrinks to include available values only.</p>
</div>

</div>

<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-normalize-aggregation"></a>Normalize aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/normalize-aggregation.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<p>A parent pipeline aggregation which calculates the specific normalized/rescaled value for a specific bucket value.
Values that cannot be normalized, will be skipped using the <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">skip gap policy</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_16"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/normalize-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">normalize</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "normalize": {
    "buckets_path": "normalized",
    "method": "percent_of_sum"
  }
}</pre>
</div>
<div class="table">
<a id="normalize_pipeline-params"></a>
<p class="title"><strong>Table 67. <code class="literal">normalize_pipeline</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="normalize_pipeline Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to normalize (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> syntax</a> for more details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">method</code></p></td>
<td align="left" valign="top"><p>The specific <a class="xref" href="search-aggregations-pipeline.html#normalize_pipeline-method">method</a> to apply</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_methods"></a>Methods<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/normalize-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p><a id="normalize_pipeline-method"></a>The Normalize Aggregation supports multiple methods to transform the bucket values. Each method definition will use
the following original set of bucket values as examples: <code class="literal">[5, 5, 10, 50, 10, 20]</code>.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<em>rescale_0_1</em>
</span>
</dt>
<dd>
<p>
This method rescales the data such that the minimum number is zero, and the maximum number is 1, with the rest normalized
linearly in-between.
</p>
<pre class="literallayout">x' = (x - min_x) / (max_x - min_x)</pre>

<pre class="literallayout">[0, 0, .1111, 1, .1111, .3333]</pre>

</dd>
<dt>
<span class="term">
<em>rescale_0_100</em>
</span>
</dt>
<dd>
<p>
This method rescales the data such that the minimum number is zero, and the maximum number is 100, with the rest normalized
linearly in-between.
</p>
<pre class="literallayout">x' = 100 * (x - min_x) / (max_x - min_x)</pre>

<pre class="literallayout">[0, 0, 11.11, 100, 11.11, 33.33]</pre>

</dd>
<dt>
<span class="term">
<em>percent_of_sum</em>
</span>
</dt>
<dd>
<p>
This method normalizes each value so that it represents a percentage of the total sum it attributes to.
</p>
<pre class="literallayout">x' = x / sum_x</pre>

<pre class="literallayout">[5%, 5%, 10%, 50%, 10%, 20%]</pre>

</dd>
<dt>
<span class="term">
<em>mean</em>
</span>
</dt>
<dd>
<p>
This method normalizes such that each value is normalized by how much it differs from the average.
</p>
<pre class="literallayout">x' = (x - mean_x) / (max_x - min_x)</pre>

<pre class="literallayout">[4.63, 4.63, 9.63, 49.63, 9.63, 9.63, 19.63]</pre>

</dd>
<dt>
<span class="term">
<em>zscore</em>
</span>
</dt>
<dd>
<p>
This method normalizes such that each value represents how far it is from the mean relative to the standard deviation
</p>
<pre class="literallayout">x' = (x - mean_x) / stdev_x</pre>

<pre class="literallayout">[-0.68, -0.68, -0.39, 1.94, -0.39, 0.19]</pre>

</dd>
<dt>
<span class="term">
<em>softmax</em>
</span>
</dt>
<dd>
<p>
This method normalizes such that each value is exponentiated and relative to the sum of the exponents of the original values.
</p>
<pre class="literallayout">x' = e^x / sum_e_x</pre>

<pre class="literallayout">[2.862E-20, 2.862E-20, 4.248E-18, 0.999, 9.357E-14, 4.248E-18]</pre>

</dd>
</dl>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_example_7"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/normalize-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The following snippet calculates the percent of total sales for each month:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "percent_of_total_sales": {
          "normalize": {
            "buckets_path": "sales",          <a id="CO333-1"></a><i class="conum" data-value="1"></i>
            "method": "percent_of_sum",       <a id="CO333-2"></a><i class="conum" data-value="2"></i>
            "format": "00.00%"                <a id="CO333-3"></a><i class="conum" data-value="3"></i>
          }
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1241.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO333-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this normalize aggregation to use the output of the <code class="literal">sales</code> aggregation for rescaling</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO333-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">method</code> sets which rescaling to apply. In this case, <code class="literal">percent_of_sum</code> will calculate the sales value as a percent of all sales
in the parent bucket</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO333-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">format</code> influences how to format the metric as a string using Java&#8217;s <code class="literal">DecimalFormat</code> pattern. In this case, multiplying by 100
and adding a <em>%</em></p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               },
               "percent_of_total_sales": {
                  "value": 0.5583756345177665,
                  "value_as_string": "55.84%"
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "percent_of_total_sales": {
                  "value": 0.06091370558375635,
                  "value_as_string": "06.09%"
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "percent_of_total_sales": {
                  "value": 0.38071065989847713,
                  "value_as_string": "38.07%"
               }
            }
         ]
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-percentiles-bucket-aggregation"></a>Percentiles bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/percentiles-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which calculates percentiles across all bucket of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_17"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/percentiles-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">percentiles_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "percentiles_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="percentiles-bucket-params"></a>
<p class="title"><strong>Table 68. <code class="literal">percentiles_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="percentiles_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the percentiles for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">percents</code></p></td>
<td align="left" valign="top"><p>The list of percentiles to calculate</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">[ 1, 5, 25, 50, 75, 95, 99 ]</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">keyed</code></p></td>
<td align="left" valign="top"><p>Flag which returns the range as an hash instead of an array of key-value pairs</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">true</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the percentiles for the total monthly <code class="literal">sales</code> buckets:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "percentiles_monthly_sales": {
      "percentiles_bucket": {
        "buckets_path": "sales_per_month&gt;sales", <a id="CO334-1"></a><i class="conum" data-value="1"></i>
        "percents": [ 25.0, 50.0, 75.0 ]         <a id="CO334-2"></a><i class="conum" data-value="2"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1242.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO334-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this percentiles_bucket aggregation that we want to calculate percentiles for
the <code class="literal">sales</code> aggregation in the <code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO334-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">percents</code> specifies which percentiles we wish to calculate, in this case, the 25th, 50th and 75th percentiles.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "percentiles_monthly_sales": {
        "values" : {
            "25.0": 375.0,
            "50.0": 375.0,
            "75.0": 550.0
         }
      }
   }
}</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_percentiles_bucket_implementation"></a>Percentiles_bucket implementation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/percentiles-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>The Percentile Bucket returns the nearest input data point that is not greater than the requested percentile; it does not
interpolate between data points.</p>
<p>The percentiles are calculated exactly and is not an approximation (unlike the Percentiles Metric). This means
the implementation maintains an in-memory, sorted list of your data to compute the percentiles, before discarding the
data.  You may run into memory pressure issues if you attempt to calculate percentiles over many millions of
data-points in a single <code class="literal">percentiles_bucket</code>.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-serialdiff-aggregation"></a>Serial differencing aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/serial-diff-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>Serial differencing is a technique where values in a time series are subtracted from itself at
different time lags or periods. For example, the datapoint f(x) = f(x<sub>t</sub>) - f(x<sub>t-n</sub>), where n is the period being used.</p>
<p>A period of 1 is equivalent to a derivative with no time normalization: it is simply the change from one point to the
next. Single periods are useful for removing constant, linear trends.</p>
<p>Single periods are also useful for transforming data into a stationary series. In this example, the Dow Jones is
plotted over ~250 days. The raw data is not stationary, which would make it difficult to use with some techniques.</p>
<p>By calculating the first-difference, we de-trend the data (e.g. remove a constant, linear trend).  We can see that the
data becomes a stationary series (e.g. the first difference is randomly distributed around zero, and doesn&#8217;t seem to
exhibit any pattern/behavior). The transformation reveals that the dataset is following a random-walk; the value is the
previous value +/- a random amount.  This insight allows selection of further tools for analysis.</p>
<div id="serialdiff_dow" class="imageblock">
<div class="content">
<img src="images/pipeline_serialdiff/dow.png" alt="dow">
</div>
<div class="title">Figure 17. Dow Jones plotted and made stationary with first-differencing</div>
</div>
<p>Larger periods can be used to remove seasonal / cyclic behavior. In this example, a population of lemmings was
synthetically generated with a sine wave + constant linear trend + random noise. The sine wave has a period of 30 days.</p>
<p>The first-difference removes the constant trend, leaving just a sine wave. The 30th-difference is then applied to the
first-difference to remove the cyclic behavior, leaving a stationary series which is amenable to other analysis.</p>
<div id="serialdiff_lemmings" class="imageblock">
<div class="content">
<img src="images/pipeline_serialdiff/lemmings.png" alt="lemmings">
</div>
<div class="title">Figure 18. Lemmings data plotted made stationary with 1st and 30th difference</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_18"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/serial-diff-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">serial_diff</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "serial_diff": {
    "buckets_path": "the_sum",
    "lag": "7"
  }
}</pre>
</div>
<div class="table">
<a id="serial-diff-params"></a>
<p class="title"><strong>Table 69. <code class="literal">serial_diff</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="serial_diff Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>Path to the metric of interest (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more details</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">lag</code></p></td>
<td align="left" valign="top"><p>The historical bucket to subtract from the current value. E.g. a lag of 7 will subtract the current value from
 the value 7 buckets ago. Must be a positive, non-zero integer</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">1</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>Determines what should happen when a gap in the data is encountered.</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">insert_zero</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>Format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code class="literal">serial_diff</code> aggregations must be embedded inside of a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> aggregation:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_search
{
   "size": 0,
   "aggs": {
      "my_date_histo": {                  <a id="CO335-1"></a><i class="conum" data-value="1"></i>
         "date_histogram": {
            "field": "timestamp",
            "calendar_interval": "day"
         },
         "aggs": {
            "the_sum": {
               "sum": {
                  "field": "lemmings"     <a id="CO335-2"></a><i class="conum" data-value="2"></i>
               }
            },
            "thirtieth_difference": {
               "serial_diff": {                <a id="CO335-3"></a><i class="conum" data-value="3"></i>
                  "buckets_path": "the_sum",
                  "lag" : 30
               }
            }
         }
      }
   }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1243.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO335-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO335-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>A <code class="literal">sum</code> metric is used to calculate the sum of a field.  This could be any metric (sum, min, max, etc)</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO335-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Finally, we specify a <code class="literal">serial_diff</code> aggregation which uses "the_sum" metric as its input.</p>
</td>
</tr>
</table>
</div>
<p>Serial differences are built by first specifying a <code class="literal">histogram</code> or <code class="literal">date_histogram</code> over a field.  You can then optionally
add normal metrics, such as a <code class="literal">sum</code>, inside of that histogram.  Finally, the <code class="literal">serial_diff</code> is embedded inside the histogram.
The <code class="literal">buckets_path</code> parameter is then used to "point" at one of the sibling metrics inside of the histogram (see
<a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for a description of the syntax for <code class="literal">buckets_path</code>.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-stats-bucket-aggregation"></a>Stats bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/stats-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which calculates a variety of stats across all bucket of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_19"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/stats-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">stats_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "stats_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="stats-bucket-params"></a>
<p class="title"><strong>Table 70. <code class="literal">stats_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="stats_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to calculate stats for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the stats for monthly <code class="literal">sales</code>:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "stats_monthly_sales": {
      "stats_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO336-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1244.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO336-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">bucket_paths</code> instructs this <code class="literal">stats_bucket</code> aggregation that we want the calculate stats for the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "stats_monthly_sales": {
         "count": 3,
         "min": 60.0,
         "max": 550.0,
         "avg": 328.3333333333333,
         "sum": 985.0
      }
   }
}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="search-aggregations-pipeline-sum-bucket-aggregation"></a>Sum bucket aggregation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/sum-bucket-aggregation.asciidoc">edit</a></h2>
</div></div></div>

<p>A sibling pipeline aggregation which calculates the sum across all buckets of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_syntax_20"></a>Syntax<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.10/docs/reference/aggregations/pipeline/sum-bucket-aggregation.asciidoc">edit</a></h3>
</div></div></div>
<p>A <code class="literal">sum_bucket</code> aggregation looks like this in isolation:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "sum_bucket": {
    "buckets_path": "the_sum"
  }
}</pre>
</div>
<div class="table">
<a id="sum-bucket-params"></a>
<p class="title"><strong>Table 71. <code class="literal">sum_bucket</code> Parameters</strong></p>
<div class="table-contents">
<table border="1" cellpadding="4px" summary="sum_bucket Parameters">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter Name</th>
<th align="left" valign="top">Description</th>
<th align="left" valign="top">Required</th>
<th align="left" valign="top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td>
<td align="left" valign="top"><p>The path to the buckets we wish to find the sum for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntax"><code class="literal">buckets_path</code> Syntax</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Required</p></td>
<td align="left" valign="top"><p></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td>
<td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the data">Dealing with gaps in the data</a> for more
 details)</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">skip</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">format</code></p></td>
<td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td>
<td align="left" valign="top"><p>Optional</p></td>
<td align="left" valign="top"><p><code class="literal">null</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following snippet calculates the sum of all the total monthly <code class="literal">sales</code> buckets:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "sum_monthly_sales": {
      "sum_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <a id="CO337-1"></a><i class="conum" data-value="1"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1245.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO337-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p><code class="literal">buckets_path</code> instructs this sum_bucket aggregation that we want the sum of the <code class="literal">sales</code> aggregation in the
<code class="literal">sales_per_month</code> date histogram.</p>
</td>
</tr>
</table>
</div>
<p>And the following may be the response:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "sum_monthly_sales": {
          "value": 985.0
      }
   }
}</pre>
</div>
</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="search-aggregations-metrics.html">« Metrics aggregations</a>
</span>
<span class="next">
<a href="eql.html">EQL search »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
